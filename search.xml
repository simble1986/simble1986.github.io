<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>使用国内资源（备忘）</title>
    <url>/2019/01/15/cn_resources/</url>
    <content><![CDATA[<h2 id="使用阿里云镜像安装docker-ce"><a class="markdownIt-Anchor" href="#使用阿里云镜像安装docker-ce"></a> 使用阿里云镜像安装Docker-CE</h2>
<blockquote>
<p>docker.com越来越难访问了</p>
</blockquote>
<a id="more"></a>
<ol>
<li>
<p>安装必要工具</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get update sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>安装阿里云的GPG证书</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>添加软件源</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ add-apt-repository <span class="string">"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="variable">$(lsb_release -cs)</span> stable"</span></span><br></pre></td></tr></table></figure>
</li>
<li>
<p>拉取更新</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt update</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>安装docker-ce</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get -y install docker-ce</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="使用阿里云的pip源"><a class="markdownIt-Anchor" href="#使用阿里云的pip源"></a> 使用阿里云的pip源</h2>
<ol>
<li>
<p>安装pip</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py</span><br><span class="line">$ python get-pip.py</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>修改pip源为阿里云（永久修改）</p>
<p>在用户根目录创建 <code>.pip/pip.conf</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = http://mirrors.aliyun.com/pypi/simple</span><br><span class="line"></span><br><span class="line">[install]</span><br><span class="line">trusted-host=mirrors.aliyun.com</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="mac使用清华homebrew源"><a class="markdownIt-Anchor" href="#mac使用清华homebrew源"></a> MAC使用清华homebrew源</h2>
<blockquote>
<p>可直接访问<a href="https://mirror.tuna.tsinghua.edu.cn/help/homebrew/" target="_blank" rel="noopener">清华大学开源软件镜像站</a>获取</p>
</blockquote>
<ul>
<li>
<p>替换现有的git</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>"</span></span><br><span class="line">$ git remote <span class="built_in">set</span>-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/brew.git</span><br><span class="line"></span><br><span class="line">$ <span class="built_in">cd</span> <span class="string">"<span class="variable">$(brew --repo)</span>/Library/Taps/homebrew/homebrew-core"</span></span><br><span class="line">$ git remote <span class="built_in">set</span>-url origin https://mirrors.tuna.tsinghua.edu.cn/git/homebrew/homebrew-core.git</span><br><span class="line"></span><br><span class="line">$ brew update</span><br></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      <categories>
        <category>tech</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>docker</tag>
        <tag>Linux</tag>
        <tag>Mac</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker中无密码apt安装mysql</title>
    <url>/2018/03/30/docker-install-mysql-server-no-passwd/</url>
    <content><![CDATA[<h3 id="问题出现"><a class="markdownIt-Anchor" href="#问题出现"></a> 问题出现</h3>
<p>Linux在第一次安装有些软件时会有交互的输入的需求，比如mysql在首次安装时需要设置root的密码。这在正常配置过程中没什么问题，但在使用DockerFile创建docker镜像时，则遇到了麻烦。</p>
<a id="more"></a>
<h3 id="解决思路"><a class="markdownIt-Anchor" href="#解决思路"></a> 解决思路</h3>
<p>如果将安装好的mysql-server使用apt remove从系统中卸载后，再次重新安装，则不再需要输入密码。另外当安装完一些软件后，可以使用dpkg-config来重新配置。</p>
<p>这样，就可以在安装软件前先对系统做好相关配置。接下来，就是需要获取软件的必要配置项</p>
<h3 id="获取软件必要配置项"><a class="markdownIt-Anchor" href="#获取软件必要配置项"></a> 获取软件必要配置项</h3>
<h4 id="下载软件包"><a class="markdownIt-Anchor" href="#下载软件包"></a> 下载软件包</h4>
<p>可以通过网上搜索方式下载相关的deb包，但众所周知，Linux的软件包版本多，很多情况下并不知道需要安装哪个版本。但可以使用apt来下载相应的软件包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get -d install -y mysql-server</span><br></pre></td></tr></table></figure>
<p>使用apt-get的-d参数，将只会下载，不进行安装。下载完毕后，软件包位于<code>/var/cache/apt/archives</code>目录下。</p>
<h4 id="获取配置项"><a class="markdownIt-Anchor" href="#获取配置项"></a> 获取配置项</h4>
<p>进入软件包的存放目录，然后执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">dpkg-preconfigure mysql-server-5.1_5.1.49-3_amd64.deb</span><br></pre></td></tr></table></figure>
<p>使用<code>debconfig-show</code>来查看相应的配置项</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ debconf-show mysql-server</span><br><span class="line">  mysql-server/root_password: (password omitted)</span><br><span class="line">  mysql-server/root_password_again: (password omitted)</span><br><span class="line">  mysql-server/error_setting_password:</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<p>可以看到，有两项是必须配置的：<code>mysql-server/root_password</code>和<code>mysql-server/root_password_again</code></p>
<h4 id="预配置"><a class="markdownIt-Anchor" href="#预配置"></a> 预配置</h4>
<ul>
<li>创建配置文件</li>
</ul>
<p>在合适的目录下创建一个文件，例如<code>mysql-passwd</code>，输入以下内容</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">debconf mysql-server/root_password password <span class="number">123456</span></span><br><span class="line">debconf mysql-server/root_password_again password <span class="number">123456</span></span><br></pre></td></tr></table></figure>
<ul>
<li>加载配置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ debconf-set-selections mysql-passwd</span><br></pre></td></tr></table></figure>
<h4 id="测试结果"><a class="markdownIt-Anchor" href="#测试结果"></a> 测试结果</h4>
<p>再次安装mysql-server，将不再需要输入密码</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get install -y mysql-server</span><br></pre></td></tr></table></figure>
<h3 id="dockerfile处理"><a class="markdownIt-Anchor" href="#dockerfile处理"></a> DockerFile处理</h3>
<p>DockerFile应当尽量避免不需要的操作，所以，获取配置项的操作可以提前在实验环境中完成。</p>
<p>可将获取的命令行保存为本地文件，使用时copy过去。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="bash"> ./mysql-passwd /tmp/mysql-passwd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; debconf-set-selections /tmp/mysql-passwd &amp;&amp; apt-get install -yqq mysql-server  &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure>
<p>或者是在DockerFile中直接生成，这时则可以将mysql passwd设置为参数</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">echo</span> debconf mysql-server/root_password password 123456 &gt; /tmp/mysql-passwd &amp;&amp; <span class="built_in">echo</span> debconf mysql-server/root_password_again password 123456 &gt;&gt; /tmp/mysql-passwd</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apt-get update &amp;&amp; debconf-set-selections /tmp/mysql-passwd &amp;&amp; apt-get install -yqq mysql-server  &amp;&amp; rm -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>DockerFile</tag>
        <tag>mysql-server</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker + ovs，原来如此简单</title>
    <url>/2019/08/07/docker-ovs-basic/</url>
    <content><![CDATA[<p>一直没敢下手尝试docker的网络使用ovs，总觉得可能很复杂。所以，人往往都是自己把自己拒之门外的。</p>
<blockquote>
<p>我整整折腾了一天，容器内以二层方式访问外部的IP始终不通。最后发现原来是网卡<strong>混杂模式</strong>惹的祸</p>
</blockquote>
<a id="more"></a>
<h2 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h2>
<h3 id="安装docker"><a class="markdownIt-Anchor" href="#安装docker"></a> 安装docker</h3>
<p>在我的其他博文里有国内源安装docker的内容，原样照搬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get update &amp;&amp; sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line">$ curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">$ add-apt-repository <span class="string">"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="variable">$(lsb_release -cs)</span> stable"</span></span><br><span class="line">$ apt update</span><br><span class="line">$ apt-get -y install docker-ce</span><br></pre></td></tr></table></figure>
<h3 id="安装ovs"><a class="markdownIt-Anchor" href="#安装ovs"></a> 安装ovs</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ sudo apt-get install openvswitch-switch</span><br></pre></td></tr></table></figure>
<h3 id="安装ovs-docker"><a class="markdownIt-Anchor" href="#安装ovs-docker"></a> 安装ovs-docker</h3>
<p>简单介绍一下，ovs-docker实际上是一个shell脚本，封装了ovs和docker的一些操作。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /usr/bin</span><br><span class="line">$ wget https://raw.githubusercontent.com/openvswitch/ovs/master/utilities/ovs-docker</span><br><span class="line">$ chmod a+rwx ovs-docker</span><br></pre></td></tr></table></figure>
<h2 id="实验"><a class="markdownIt-Anchor" href="#实验"></a> 实验</h2>
<p>两个docker容器经过ovs网桥进行访问及访问外部网络</p>
<h3 id="容器互访"><a class="markdownIt-Anchor" href="#容器互访"></a> 容器互访</h3>
<ul>
<li>创建ovs网桥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl add-br br0</span><br></pre></td></tr></table></figure>
<ul>
<li>创建两个容器</li>
</ul>
<blockquote>
<p>注：实验使用了busybox的镜像，需要提前pull到本地</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull busybox</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it --net=none --privileged=<span class="literal">true</span> --name=h1 busybox</span><br></pre></td></tr></table></figure>
<p>在另外一个shell中执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it --net=none --privileged=<span class="literal">true</span> --name=h2 busybox</span><br></pre></td></tr></table></figure>
<ul>
<li>查看当前网络</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/ <span class="comment"># ifconfig</span></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p>可以看到当前仅有一个loopback接口</p>
<ul>
<li>连接容器到网桥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-docker add-port br0 eth0 h1</span><br><span class="line">$ ovs-docker add-port br0 eth0 h2</span><br></pre></td></tr></table></figure>
<ul>
<li>配置IP地址</li>
</ul>
<p>分别在两个docker容器中配置eth0的IP地址为同一个网段</p>
<p><strong>h1</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig eth0 192.168.1.2</span><br></pre></td></tr></table></figure>
<p><strong>h2</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig eth0 192.168.1.3</span><br></pre></td></tr></table></figure>
<ul>
<li>测试连通性</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping 192.168.1.3</span><br><span class="line">PING 192.168.1.2 (192.168.1.3): 56 data bytes</span><br><span class="line">64 bytes from 192.168.1.3: seq=0 ttl=64 time=1.065 ms</span><br><span class="line">64 bytes from 192.168.1.3: seq=1 ttl=64 time=0.139 ms</span><br></pre></td></tr></table></figure>
<p><strong>没错</strong>，就是这么简单</p>
<h3 id="访问外部网络"><a class="markdownIt-Anchor" href="#访问外部网络"></a> 访问外部网络</h3>
<p>当我解决了<strong>混杂模式</strong>的问题之后，原来一切都是那么简单</p>
<blockquote>
<p>在外部另外一个PC上配置了192.168.1.1</p>
</blockquote>
<ul>
<li>为br0增加物理接口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl add-port br0 ens192</span><br></pre></td></tr></table></figure>
<ul>
<li>测试</li>
</ul>
<p>从容器中ping 192.168.1.1</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ping 192.168.1.1</span><br><span class="line">PING 192.168.1.1 (192.168.1.1): 56 data bytes</span><br><span class="line">64 bytes from 192.168.1.1: seq=30 ttl=64 time=1.319 ms</span><br><span class="line">64 bytes from 192.168.1.1: seq=31 ttl=64 time=0.461 ms</span><br></pre></td></tr></table></figure>
<p><strong>大功告成</strong></p>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>ovs</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker API一种连接到PTY的交互方法</title>
    <url>/2018/05/04/docker-pexpect/</url>
    <content><![CDATA[<p>折腾了一周多，终于搞定了在docker的python API下，当执行exec_run时，如何连接container的PTY。</p>
<p>当弄明白之后，才发现原来是那么简单。之前几乎搜遍了google和百度，都没有找到相关的文章</p>
<a id="more"></a>
<h2 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h2>
<p>这两年，docker的发展如火如荼，作为网络测试，我们也在尝试着将docker引入测试中，来更多的模拟真实用户，并实现自动化。</p>
<p>Pexpect是一个非常强大且好用的工具，当需要与设备和PC连接时，基本上都会用到。而之前都直接使用spawn一个命令行来进行连接</p>
<p>本篇博文将介绍一种使用pexpect的fdspawn，通过socket方式连接到container的方法，以便与远程的container进行交互</p>
<h2 id="自动化思路"><a class="markdownIt-Anchor" href="#自动化思路"></a> 自动化思路</h2>
<ol>
<li>client通过python API连接到docker</li>
<li>创建一个container并保持运行</li>
<li>使用exec_run()新建一个连接，运行<code>/bin/bash</code>，并开启socket方式</li>
<li>使用pexpect的fdspawn连接exec_run()返回的socket</li>
</ol>
<h3 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h3>
<ul>
<li>Docker开启remote API</li>
</ul>
<p>参见之前博文</p>
<ul>
<li>Docker Client</li>
</ul>
<p>安装必要的包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip install docker</span><br><span class="line">$ pip install pexpect</span><br></pre></td></tr></table></figure>
<h2 id="开始使用"><a class="markdownIt-Anchor" href="#开始使用"></a> 开始使用</h2>
<ul>
<li>创建container</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> docker</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>client=docker.DockerClient(base_url=<span class="string">'tcp://10.0.0.10:1234'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>c1 = client.containers.run(<span class="string">"ubuntu"</span>, detach=<span class="literal">True</span>, tty=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>连接container</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>res = c1.exec_run(<span class="string">"/bin/bash"</span>, socket=<span class="literal">True</span>, stdin=<span class="literal">True</span>, tty=<span class="literal">True</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>res</span><br><span class="line">ExecResult(exit_code=<span class="literal">None</span>, output=&lt;socket object, fd=<span class="number">15</span>, family=<span class="number">1</span>, type=<span class="number">1</span>, protocol=<span class="number">0</span>&gt;)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sock = res.output</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sock</span><br><span class="line">&lt;socket object, fd=<span class="number">15</span>, family=<span class="number">1</span>, type=<span class="number">1</span>, protocol=<span class="number">0</span>&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>使用pexpect连接</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> pexpect.fdpexpect</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session=pexpect.fdpexpect.fdspawn(sock.fileno(),timeout=<span class="number">10</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>&gt;&gt;&gt; session.send(<span class="string">"ls\n"</span>)</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.expect(<span class="string">"#"</span>)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.before</span><br><span class="line"><span class="string">' ls\r\n\x1b[0m\x1b[01;34mbin\x1b[0m   \x1b[01;34mdev\x1b[0m  \x1b[01;34mhome\x1b[0m  \x1b[01;34mlib64\x1b[0m  \x1b[01;34mmnt\x1b[0m  \x1b[01;34mproc\x1b[0m  \x1b[01;34mrun\x1b[0m   \x1b[01;34msrv\x1b[0m  \x1b[30;42mtmp\x1b[0m  \x1b[01;34mvar\x1b[0m\r\n\x1b[01;34mboot\x1b[0m  \x1b[01;34metc\x1b[0m  \x1b[01;34mlib\x1b[0m   \x1b[01;34mmedia\x1b[0m  \x1b[01;34mopt\x1b[0m  \x1b[01;34mroot\x1b[0m  \x1b[01;34msbin\x1b[0m  \x1b[01;34msys\x1b[0m  \x1b[01;34musr\x1b[0m\r\n\x1b]0;root@6a097ddbe55d: /\x07root@6a097ddbe55d:/'</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>session.after</span><br><span class="line"><span class="string">'#'</span></span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
<h3 id="注意事项"><a class="markdownIt-Anchor" href="#注意事项"></a> 注意事项</h3>
<ul>
<li>在使用exec_run()执行开启命令时，需要指定<code>stdin=True</code>，否则，pexpect的send()将无法将命令发送至container</li>
<li>同样，在使用exec_run()时，需要指定<code>tty=True</code>，否则，将没有命令行提示符，无法进行匹配</li>
</ul>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>pexpect</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>docker基本操作（一）</title>
    <url>/2018/03/23/docker_study_cmd1/</url>
    <content><![CDATA[<p>本文作为docker使用笔记供小伙伴们参考</p>
<h2 id="准备工作"><a class="markdownIt-Anchor" href="#准备工作"></a> 准备工作</h2>
<p>安装最新版的docker-ce，会将自动命令行补齐安装在<code>/usr/share/bash-completion/completions/docker</code>目录</p>
<a id="more"></a>
<p>为了方便操作，在ubuntu上打开docker命令行自动补齐功能</p>
<p>编辑/etc/bash.bashrc文件，查找completion段，将该段内容前的#删除即可</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># enable bash completion in interactive shells</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">shopt</span> -oq posix; <span class="keyword">then</span></span><br><span class="line">  <span class="keyword">if</span> [ -f /usr/share/bash-completion/bash_completion ]; <span class="keyword">then</span></span><br><span class="line">    . /usr/share/bash-completion/bash_completion</span><br><span class="line">  <span class="keyword">elif</span> [ -f /etc/bash_completion ]; <span class="keyword">then</span></span><br><span class="line">    . /etc/bash_completion</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<h2 id="image操作"><a class="markdownIt-Anchor" href="#image操作"></a> image操作</h2>
<ul>
<li>build image</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t mytest:latest .</span><br></pre></td></tr></table></figure>
<ul>
<li>查看image</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker images</span><br><span class="line">REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">nginx                 &lt;none&gt;              73acd1f0cfad        8 days ago          109MB</span><br><span class="line">mongo                 3                   5b1317f8158f        8 days ago          366MB</span><br><span class="line">$ dockeer image ls</span><br></pre></td></tr></table></figure>
<ul>
<li>删除image</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker image rm &lt;id/name&gt;</span><br><span class="line">$ docker rmi &lt;id/name&gt;</span><br></pre></td></tr></table></figure>
<h3 id="从docker-hub上获取image"><a class="markdownIt-Anchor" href="#从docker-hub上获取image"></a> 从docker hub上获取image</h3>
<p><em>国内访问docker hub较慢，可使用阿里云的docker镜像服务</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull nginx</span><br></pre></td></tr></table></figure>
<h2 id="continer相关"><a class="markdownIt-Anchor" href="#continer相关"></a> continer相关</h2>
<h3 id="创建docker"><a class="markdownIt-Anchor" href="#创建docker"></a> 创建docker</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -d --name mytest -p 80:80 mynginx</span><br></pre></td></tr></table></figure>
<p>常用参数说明</p>
<blockquote>
<p>–rm 当运行结束（<mark>当CMD或entrypoint或docker run命令行指定的命令运行结束时，容器停止</mark>）时自动删除docker<br><br />
-it 重定向docker终端<br><br />
-d 在后台执行<br><br />
-e 添加运行时的参数，常被用于docker CMD执行时增加参数</p>
</blockquote>
<p><strong>docker支持长id和短id方式索引，亦可通过名称进行索引</strong></p>
<ul>
<li>stop/start/restart容器</li>
</ul>
<ol>
<li>通过docker stop可以停止运行的容器，也可以使用docker kill来快速停止一个容器</li>
<li>docker start会保留容器的第一次启动时的所有参数</li>
<li>docker restart可以重启容器</li>
<li>可以在启动容器时设置–restart来自动重启容器</li>
</ol>
<ul>
<li>删除容器</li>
</ul>
<ol>
<li>可以使用docker ps列出当前正在运行的容器</li>
<li>容器停止运行不代表容器已经被删除，可以使用docker ps -a</li>
<li>使用docker rm来删除一个容器</li>
<li>使用docker rmi则会删除docker的image</li>
</ol>
<h3 id="查看及操作"><a class="markdownIt-Anchor" href="#查看及操作"></a> 查看及操作</h3>
<ul>
<li>查看容器状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                    COMMAND                   CREATED             STATUS              PORTS                        NAMES</span><br><span class="line">30c8e35f1292        portainer/portainer      <span class="string">"/portainer"</span>              10 days ago         Up 2 days           0.0.0.0:9000-&gt;9000/tcp       clever_murdock</span><br></pre></td></tr></table></figure>
<p>使用docker ps -a查看所有容器（包含休眠状态）</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                    COMMAND                   CREATED             STATUS              PORTS                        NAMES</span><br><span class="line">30c8e35f1292        portainer/portainer      <span class="string">"/portainer"</span>              10 days ago         Up 2 days           0.0.0.0:9000-&gt;9000/tcp       clever_murdock</span><br><span class="line">ef58155f9957        registry:2               <span class="string">"/entrypoint.sh /etc…"</span>    2 days ago          Exited (137) 41 hours ago                                sltregistry</span><br></pre></td></tr></table></figure>
<ul>
<li>连接到容器的终端</li>
</ul>
<p><em>尽量使用exec方法，attach连入后可查看当前容器命令运行的日志，但不当的操作容易使运行中的容器退出</em></p>
<ol>
<li>使用attach</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker attach &lt;id/name&gt;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用exec</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it &lt;id/name&gt; /bin/sh</span><br></pre></td></tr></table></figure>
<ul>
<li>查看容器运行的日志</li>
</ul>
<p>容器以<code>-d</code>参数运行时，可以使用docker logs查看运行过程中的日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker logs mytest_haproxy</span><br><span class="line">[WARNING] 079/100555 (1) : [haproxy.main()] Cannot raise FD <span class="built_in">limit</span> to 200000011, <span class="built_in">limit</span> is 1048576.</span><br><span class="line">[WARNING] 079/100555 (1) : [haproxy.main()] FD <span class="built_in">limit</span> (1048576) too low <span class="keyword">for</span> maxconn=100000000/maxsock=200000011. Please raise <span class="string">'ulimit-n'</span> to 200000011 or more to avoid any trouble.</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
      </tags>
  </entry>
  <entry>
    <title>dockerpty使用</title>
    <url>/2018/05/03/dockerpty-usage/</url>
    <content><![CDATA[<p>本篇博客将介绍在使用docker API时，如何监管container的PTY实现交互</p>
<h2 id="问题引入"><a class="markdownIt-Anchor" href="#问题引入"></a> 问题引入</h2>
<p>docker官方已经提供了API用来管理client，container，image，network等，基本的操作覆盖了docker CLI相关功能，但docker的API现在只能使用exec_run来执行一条命令，中间无法进行交互，希望能有一个类似于<code>-it</code>的方式来完成交互操作。</p>
<p>经过几天的学习和测试，发现其实docker的<code>containers.run()</code>和<code>containers.exec_run()</code>都是可以设置<code>stdin=True</code>, <code>tty=True</code>。但开启这些之后，将返回一个socket，需要自己来进行处理。</p>
<p>google大法后，找到了一个<strong>dockerpty</strong>的python lib，可以完成这件事情</p>
<a id="more"></a>
<h2 id="环境搭建"><a class="markdownIt-Anchor" href="#环境搭建"></a> 环境搭建</h2>
<p>根据<a href="https://github.com/d11wtq/dockerpty" target="_blank" rel="noopener">dockerpty</a>的github上提到的安装过程，只需要<code>pip install dockerpty</code>即可完成安装。</p>
<p>但源码已经有两年没有更新了，该版本无法在新的docker API上正常工作</p>
<p>fork了工程后，对其中的代码涉及到的docker API进行更新后，测试可以正常工作，最新的代码已经上传到git上<a href="https://github.com/simble1986/dockerpty" target="_blank" rel="noopener">simble1986/dockerpty</a></p>
<h4 id="依赖"><a class="markdownIt-Anchor" href="#依赖"></a> 依赖</h4>
<p>原有的project上提到依赖的docker api为<code>docker-py&gt;=0.3.2</code>，但docker的python API已经更新</p>
<ul>
<li>安装docker API</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install docker</span><br></pre></td></tr></table></figure>
<h4 id="安装步骤"><a class="markdownIt-Anchor" href="#安装步骤"></a> 安装步骤</h4>
<ul>
<li>获取源码</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/simble1986/dockerpty.git</span><br></pre></td></tr></table></figure>
<ul>
<li>安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pip uninstall dockerpty</span><br><span class="line">$ <span class="built_in">cd</span> dockerpty</span><br><span class="line">$ python setup.py install</span><br></pre></td></tr></table></figure>
<h2 id="相关api"><a class="markdownIt-Anchor" href="#相关api"></a> 相关API</h2>
<p>参看docker官方<a href="https://docker-py.readthedocs.io/en/stable/index.html" target="_blank" rel="noopener">API文档</a>，以下主要对container相关参数加以说明</p>
<ul>
<li>tty (bool) – Allocate a pseudo-TTY.</li>
<li>stdin_open (bool) – Keep STDIN open even if not attached.</li>
</ul>
<h2 id="基本使用"><a class="markdownIt-Anchor" href="#基本使用"></a> 基本使用</h2>
<ul>
<li>连接client</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">root@slt-docker:/home/bqi<span class="comment"># python</span></span><br><span class="line">Python <span class="number">2.7</span><span class="number">.12</span> (default, Dec  <span class="number">4</span> <span class="number">2017</span>, <span class="number">14</span>:<span class="number">50</span>:<span class="number">18</span>)</span><br><span class="line">[GCC <span class="number">5.4</span><span class="number">.0</span> <span class="number">20160609</span>] on linux2</span><br><span class="line">Type <span class="string">"help"</span>, <span class="string">"copyright"</span>, <span class="string">"credits"</span> <span class="keyword">or</span> <span class="string">"license"</span> <span class="keyword">for</span> more information.</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> docker</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">import</span> dockerpty</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>client=docker.from_env()</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>： 支持远程API</p>
<ul>
<li>创建container</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>test1 = client.containers.create(<span class="string">"ubuntu"</span>,<span class="string">"/bin/bash"</span>,tty=<span class="literal">True</span>,stdin_open=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用dockerpty</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>dockerpty.start(client,test1)</span><br><span class="line">root@d6ddcf619602:/<span class="comment"># ls</span></span><br><span class="line">bin  boot  dev  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br><span class="line">root@d6ddcf619602:/<span class="comment"># exit</span></span><br><span class="line">exit</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>dockerpty</tag>
      </tags>
  </entry>
  <entry>
    <title>在Ubuntu 16.04上开启Docker的Remote API</title>
    <url>/2018/03/27/enable-docker-remote-api/</url>
    <content><![CDATA[<p>由于自动化的考虑，需要用docker的remote API，尝试了多种方法，最终才找到了可行的方法</p>
<h3 id="可行的方法"><a class="markdownIt-Anchor" href="#可行的方法"></a> 可行的方法</h3>
<ul>
<li>编辑/lib/systemd/system/docker.service</li>
</ul>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vim /lib/systemd/system/docker.service</span><br></pre></td></tr></table></figure>
<ul>
<li>修改ExecStart的参数</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ExecStart=/usr/bin/dockerd -H fd:// -H tcp://0.0.0.0:2375</span><br></pre></td></tr></table></figure>
<ul>
<li>随后执行<code>service docker restart</code>时会提示<code>Warning: docker.service changed on disk. Run 'systemctl daemon-reload' to reload units.</code>则表示配置成功</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">systemctl daemon-reload</span><br></pre></td></tr></table></figure>
<ul>
<li>重启docker服务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service docker restart</span><br></pre></td></tr></table></figure>
<ul>
<li>测试是否成功</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ curl http://localhost:2375/containers/json</span><br><span class="line">[&#123;<span class="string">"Id"</span>:<span class="string">"30c8e35f1292421d11f6b09385a4fc980d6abaca591d0f52b18dbad8e4f5be04"</span>,<span class="string">"Names"</span>:[<span class="string">"/clever_murdock"</span>],<span class="string">"Image"</span>:<span class="string">"portainer/portainer"</span>,<span class="string">"ImageID"</span>:<span class="string">"sha256:a8f2aeb34cf69178be1d152759fb17ccff7915faf750c82cd7d1851b12ec7b37"</span>,<span class="string">"Command"</span>:<span class="string">"/portainer"</span>,<span class="string">"Created"</span>:1520845664,<span class="string">"Ports"</span>:[&#123;<span class="string">"IP"</span>:<span class="string">"0.0.0.0"</span>,<span class="string">"PrivatePort"</span>:9000,<span class="string">"PublicPort"</span>:9000,<span class="string">"Type"</span>:<span class="string">"tcp"</span>&#125;],<span class="string">"Labels"</span>:&#123;&#125;,<span class="string">"State"</span>:<span class="string">"running"</span>,<span class="string">"Status"</span>:<span class="string">"Up 13 minutes"</span>,<span class="string">"HostConfig"</span>:&#123;<span class="string">"NetworkMode"</span>:<span class="string">"default"</span>&#125;,<span class="string">"NetworkSettings"</span>:&#123;<span class="string">"Networks"</span>:&#123;<span class="string">"bridge"</span>:&#123;<span class="string">"IPAMConfig"</span>:null,<span class="string">"Links"</span>:null,<span class="string">"Aliases"</span>:null,<span class="string">"NetworkID"</span>:<span class="string">"78fa057306e70838bab1e18359c86bd8eff7de2285c351784ad951cd7a73f8d1"</span>,<span class="string">"EndpointID"</span>:<span class="string">"e99ca98169320155c8833a8746be7d0e1c8d98186c75fba9d9bf2486367a4e00"</span>,<span class="string">"Gateway"</span>:<span class="string">"172.17.0.1"</span>,<span class="string">"IPAddress"</span>:<span class="string">"172.17.0.2"</span>,<span class="string">"IPPrefixLen"</span>:16,<span class="string">"IPv6Gateway"</span>:<span class="string">""</span>,<span class="string">"GlobalIPv6Address"</span>:<span class="string">""</span>,<span class="string">"GlobalIPv6PrefixLen"</span>:0,<span class="string">"MacAddress"</span>:<span class="string">"02:42:ac:11:00:02"</span>,<span class="string">"DriverOpts"</span>:null&#125;&#125;&#125;,<span class="string">"Mounts"</span>:[&#123;<span class="string">"Type"</span>:<span class="string">"bind"</span>,<span class="string">"Source"</span>:<span class="string">"/opt/portainer"</span>,<span class="string">"Destination"</span>:<span class="string">"/data"</span>,<span class="string">"Mode"</span>:<span class="string">""</span>,<span class="string">"RW"</span>:<span class="literal">true</span>,<span class="string">"Propagation"</span>:<span class="string">"rprivate"</span>&#125;,&#123;<span class="string">"Type"</span>:<span class="string">"bind"</span>,<span class="string">"Source"</span>:<span class="string">"/var/run/docker.sock"</span>,<span class="string">"Destination"</span>:<span class="string">"/var/run/docker.sock"</span>,<span class="string">"Mode"</span>:<span class="string">""</span>,<span class="string">"RW"</span>:<span class="literal">true</span>,<span class="string">"Propagation"</span>:<span class="string">"rprivate"</span>&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="不可行的方法"><a class="markdownIt-Anchor" href="#不可行的方法"></a> 不可行的方法</h3>
<p>同时列出在Ubuntu上不可行的方法</p>
<ul>
<li>修改<code>/etc/default/docker</code>中的<code>DOCKER_OPTS</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">DOCKER_OPTS=<span class="string">'-H fd:// -H tcp://0.0.0.0:2375'</span></span><br></pre></td></tr></table></figure>
<ul>
<li>修改<code>/etc/init/docker.conf</code>中的<code>DOCKER_OPTS</code></li>
</ul>
<p><em>网上有人说在Ubuntu14.04上可以生效</em></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># modify these in /etc/default/$UPSTART_JOB (/etc/default/docker)</span></span><br><span class="line">        DOCKERD=/usr/bin/dockerd</span><br><span class="line">        DOCKER_OPTS=<span class="string">'-H unix:///var/run/docker.sock -H tcp://0.0.0.0:2375'</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>自动化</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu16.04上安装DPDK</title>
    <url>/2018/11/15/dpdk-setup/</url>
    <content><![CDATA[<h1 id="dpdk安装"><a class="markdownIt-Anchor" href="#dpdk安装"></a> DPDK安装</h1>
<blockquote>
<p>DPDK（Data Plane Development Kit）是一个用来进行包数据处理加速的软件库</p>
</blockquote>
<h2 id="从git获取源码"><a class="markdownIt-Anchor" href="#从git获取源码"></a> 从git获取源码</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> git://dpdk.org/dpdk</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h2 id="创建环境变量"><a class="markdownIt-Anchor" href="#创建环境变量"></a> 创建环境变量</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/dpdk</span><br><span class="line">$ <span class="built_in">export</span> RTE_SDK=`<span class="built_in">pwd</span>`</span><br><span class="line">$ <span class="built_in">export</span> DESTDIR=`<span class="built_in">pwd</span>`</span><br><span class="line">$ <span class="built_in">export</span> RTE_TARGET=x86_64-default-linuxapp-gcc</span><br></pre></td></tr></table></figure>
<p>因为这些环境变量总是会用到，可以将其放入一个文件，如<code>env.source</code>，使用<code>source env.source</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> ~/dpdk</span><br><span class="line">$ more env.source</span><br><span class="line"><span class="built_in">export</span> RTE_SDK=`<span class="built_in">pwd</span>`</span><br><span class="line"><span class="built_in">export</span> DESTDIR=`<span class="built_in">pwd</span>`</span><br><span class="line"><span class="built_in">export</span> RTE_TARGET=x86_64-default-linuxapp-gcc</span><br><span class="line">$ <span class="built_in">source</span> env.source</span><br></pre></td></tr></table></figure>
<h2 id="开始安装"><a class="markdownIt-Anchor" href="#开始安装"></a> 开始安装</h2>
<blockquote>
<p>使用<code>dpdk-setup.sh</code>脚本进行安装</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./usertools/dpdk-setup.sh</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"> RTE_SDK exported as /root/dpdk</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> Step 1: Select the DPDK environment to build</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">[1] arm64-armv8a-linuxapp-clang</span><br><span class="line">[2] arm64-armv8a-linuxapp-gcc</span><br><span class="line">[3] arm64-dpaa2-linuxapp-gcc</span><br><span class="line">[4] arm64-dpaa-linuxapp-gcc</span><br><span class="line">[5] arm64-stingray-linuxapp-gcc</span><br><span class="line">[6] arm64-thunderx-linuxapp-gcc</span><br><span class="line">[7] arm64-xgene1-linuxapp-gcc</span><br><span class="line">[8] arm-armv7a-linuxapp-gcc</span><br><span class="line">[9] i686-native-linuxapp-gcc</span><br><span class="line">[10] i686-native-linuxapp-icc</span><br><span class="line">[11] ppc_64-power8-linuxapp-gcc</span><br><span class="line">[12] x86_64-native-bsdapp-clang</span><br><span class="line">[13] x86_64-native-bsdapp-gcc</span><br><span class="line">[14] x86_64-native-linuxapp-clang</span><br><span class="line">[15] x86_64-native-linuxapp-gcc</span><br><span class="line">[16] x86_64-native-linuxapp-icc</span><br><span class="line">[17] x86_x32-native-linuxapp-gcc</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> Step 2: Setup linuxapp environment</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">[18] Insert IGB UIO module</span><br><span class="line">[19] Insert VFIO module</span><br><span class="line">[20] Insert KNI module</span><br><span class="line">[21] Setup hugepage mappings <span class="keyword">for</span> non-NUMA systems</span><br><span class="line">[22] Setup hugepage mappings <span class="keyword">for</span> NUMA systems</span><br><span class="line">[23] Display current Ethernet/Crypto device settings</span><br><span class="line">[24] Bind Ethernet/Crypto device to IGB UIO module</span><br><span class="line">[25] Bind Ethernet/Crypto device to VFIO module</span><br><span class="line">[26] Setup VFIO permissions</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> Step 3: Run <span class="built_in">test</span> application <span class="keyword">for</span> linuxapp environment</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">[27] Run <span class="built_in">test</span> application (<span class="variable">$RTE_TARGET</span>/app/<span class="built_in">test</span>)</span><br><span class="line">[28] Run testpmd application <span class="keyword">in</span> interactive mode (<span class="variable">$RTE_TARGET</span>/app/testpmd)</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> Step 4: Other tools</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">[29] List hugepage info from /proc/meminfo</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------</span><br><span class="line"> Step 5: Uninstall and system cleanup</span><br><span class="line">----------------------------------------------------------</span><br><span class="line">[30] Unbind devices from IGB UIO or VFIO driver</span><br><span class="line">[31] Remove IGB UIO module</span><br><span class="line">[32] Remove VFIO module</span><br><span class="line">[33] Remove KNI module</span><br><span class="line">[34] Remove hugepage mappings</span><br><span class="line"></span><br><span class="line">[35] Exit Script</span><br><span class="line"></span><br><span class="line">Option:</span><br></pre></td></tr></table></figure>
<ul>
<li>Step1</li>
</ul>
<p>根据自己环境选择相应的build，如我是64位的Intel架构的环境，则选择**[15]**</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line">Installation <span class="keyword">in</span> /root/dpdk/ complete</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"> RTE_TARGET exported as x86_64-native-linuxapp-gcc</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">Press enter to <span class="built_in">continue</span> ...</span><br></pre></td></tr></table></figure>
<ul>
<li>Step2</li>
</ul>
<ol>
<li>选择**[18]**来家在哪里<code>igb_uio</code>模块</li>
<li>选择**[21]**来创建Hugepage，这里我输入了128</li>
<li>选择**[24]**来绑定PCI网卡</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Option: 21</span><br><span class="line"></span><br><span class="line">Removing currently reserved hugepages</span><br><span class="line">Unmounting /mnt/huge and removing directory</span><br><span class="line"></span><br><span class="line">  Input the number of 2048kB hugepages</span><br><span class="line">  Example: to have 128MB of hugepages available <span class="keyword">in</span> a 2MB huge page system,</span><br><span class="line">  enter <span class="string">'64'</span> to reserve 64 * 2MB pages</span><br><span class="line">Number of pages: 128</span><br><span class="line">Reserving hugepages</span><br><span class="line">Creating /mnt/huge and mounting as hugetlbfs</span><br><span class="line"></span><br><span class="line">Press enter to <span class="built_in">continue</span> ...</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Option: 24</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">Other Compress devices</span><br><span class="line">======================</span><br><span class="line">&lt;none&gt;</span><br><span class="line"></span><br><span class="line">Enter PCI address of device to <span class="built_in">bind</span> to IGB UIO driver: 0b:00.0</span><br><span class="line"></span><br><span class="line">Network devices using DPDK-compatible driver</span><br><span class="line">============================================</span><br><span class="line">0000:0b:00.0 <span class="string">'VMXNET3 Ethernet Controller 07b0'</span> drv=igb_uio unused=vmxnet3,uio_pci_generic</span><br><span class="line">0000:13:00.0 <span class="string">'VMXNET3 Ethernet Controller 07b0'</span> drv=igb_uio unused=vmxnet3,uio_pci_generic</span><br></pre></td></tr></table></figure>
<p>确认需要使用的PCI网卡为<strong>drv=igb_uio</strong>则说明绑定成功</p>
<ul>
<li>Step3 - 测试</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Option: 27</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Enter hex bitmask of cores to execute <span class="built_in">test</span> app on</span><br><span class="line">  Example: to execute app on cores 0 to 7, enter 0xff</span><br><span class="line">bitmask: 0x3</span><br><span class="line">Launching app</span><br><span class="line">sudo: x86_64-default-linuxapp-gcc/app/<span class="built_in">test</span>: <span class="built_in">command</span> not found</span><br><span class="line"></span><br><span class="line">Press enter to <span class="built_in">continue</span> ...</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">Option: 28</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  Enter hex bitmask of cores to execute testpmd app on</span><br><span class="line">  Example: to execute app on cores 0 to 7, enter 0xff</span><br><span class="line">bitmask: 0x3</span><br><span class="line">Launching app</span><br><span class="line">sudo: x86_64-default-linuxapp-gcc/app/testpmd: <span class="built_in">command</span> not found</span><br></pre></td></tr></table></figure>
<p>执行27和28都有可能报错，提示<code>command not found</code>，此时，可以先退出安装脚本</p>
<p>进入<code>/dpdk/x86_64-native-linuxapp-gcc/app</code>目录，会看到<code>testpmd</code>存在于目录下，运行测试，正常状况时，会如下显示</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./testpmd</span><br><span class="line">EAL: Detected 8 lcore(s)</span><br><span class="line">EAL: Detected 1 NUMA nodes</span><br><span class="line">EAL: Multi-process socket /var/run/dpdk/rte/mp_socket</span><br><span class="line">EAL: Probing VFIO support...</span><br><span class="line">EAL: PCI device 0000:03:00.0 on NUMA socket -1</span><br><span class="line">EAL:   Invalid NUMA socket, default to 0</span><br><span class="line">EAL:   probe driver: 15ad:7b0 net_vmxnet3</span><br><span class="line">EAL: PCI device 0000:0b:00.0 on NUMA socket -1</span><br><span class="line">EAL:   Invalid NUMA socket, default to 0</span><br><span class="line">EAL:   probe driver: 15ad:7b0 net_vmxnet3</span><br><span class="line">EAL: PCI device 0000:13:00.0 on NUMA socket -1</span><br><span class="line">EAL:   Invalid NUMA socket, default to 0</span><br><span class="line">EAL:   probe driver: 15ad:7b0 net_vmxnet3</span><br><span class="line">testpmd: create a new mbuf pool &lt;mbuf_pool_socket_0&gt;: n=203456, size=2176, socket=0</span><br><span class="line">testpmd: preferred mempool ops selected: ring_mp_mc</span><br><span class="line">Configuring Port 0 (socket 0)</span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">    TX queue: 0</span><br><span class="line">      TX desc=0 - TX free threshold=0</span><br><span class="line">      TX threshold registers: pthresh=0 hthresh=0  wthresh=0</span><br><span class="line">      TX offloads=0x0 - TX RS bit threshold=0</span><br><span class="line">Press enter to <span class="built_in">exit</span></span><br><span class="line"></span><br><span class="line">Telling cores to stop...</span><br><span class="line">Waiting <span class="keyword">for</span> lcores to finish...</span><br><span class="line"></span><br><span class="line">  ---------------------- Forward statistics <span class="keyword">for</span> port 0  ----------------------</span><br><span class="line">  RX-packets: 57             RX-dropped: 0             RX-total: 57</span><br><span class="line">  TX-packets: 57             TX-dropped: 0             TX-total: 57</span><br><span class="line">  ----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">  ---------------------- Forward statistics <span class="keyword">for</span> port 1  ----------------------</span><br><span class="line">  RX-packets: 57             RX-dropped: 0             RX-total: 57</span><br><span class="line">  TX-packets: 57             TX-dropped: 0             TX-total: 57</span><br><span class="line">  ----------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">  +++++++++++++++ Accumulated forward statistics <span class="keyword">for</span> all ports+++++++++++++++</span><br><span class="line">  RX-packets: 114            RX-dropped: 0             RX-total: 114</span><br><span class="line">  TX-packets: 114            TX-dropped: 0             TX-total: 114</span><br><span class="line">  ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">Done.</span><br><span class="line"></span><br><span class="line">Shutting down port 0...</span><br><span class="line">Stopping ports...</span><br><span class="line">Done</span><br><span class="line">Closing ports...</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">Shutting down port 1...</span><br><span class="line">Stopping ports...</span><br><span class="line">Done</span><br><span class="line">Closing ports...</span><br><span class="line">Done</span><br><span class="line"></span><br><span class="line">Bye...</span><br></pre></td></tr></table></figure>
<h2 id="hugepage问题解决"><a class="markdownIt-Anchor" href="#hugepage问题解决"></a> HugePage问题解决</h2>
<ul>
<li>问题</li>
</ul>
<p>当运行测试时或者<code>testpmd</code>，可能会遇到如下问题</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./testpmd</span><br><span class="line">EAL: Detected 8 lcore(s)</span><br><span class="line">EAL: Detected 1 NUMA nodes</span><br><span class="line">EAL: Multi-process socket /var/run/dpdk/rte/mp_socket</span><br><span class="line">EAL: No free hugepages reported <span class="keyword">in</span> hugepages-2048kB</span><br><span class="line">EAL: No free hugepages reported <span class="keyword">in</span> hugepages-2048kB</span><br><span class="line">EAL: FATAL: Cannot get hugepage information.</span><br><span class="line">EAL: Cannot get hugepage information.</span><br><span class="line">PANIC <span class="keyword">in</span> main():</span><br><span class="line">Cannot init EAL</span><br><span class="line">5: [./testpmd(_start+0x29) [0x498829]]</span><br><span class="line">4: [/lib/x86_64-linux-gnu/libc.so.6(__libc_start_main+0xf0) [0x7f8a0fee0830]]</span><br><span class="line">3: [./testpmd(main+0xc48) [0x48f528]]</span><br><span class="line">2: [./testpmd(__rte_panic+0xbb) [0x47eb09]]</span><br><span class="line">1: [./testpmd(rte_dump_stack+0x2b) [0x5c8a1b]]</span><br><span class="line">Aborted (core dumped)</span><br></pre></td></tr></table></figure>
<ul>
<li>问题原因及解决</li>
</ul>
<p>这说明Hugepage不够用，可以先查看系统内存状况</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /proc/meminfo | grep Huge</span><br><span class="line">AnonHugePages:         0 kB</span><br><span class="line">HugePages_Total:     665</span><br><span class="line">HugePages_Free:        0</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:      537</span><br><span class="line">Hugepagesize:       2048 kB</span><br></pre></td></tr></table></figure>
<p>很显然，这里总共有665，太小了，不够用，需要修改系统相关内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 2048 &gt; /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages</span><br><span class="line">$ cat /proc/meminfo | grep Huge</span><br><span class="line">AnonHugePages:         0 kB</span><br><span class="line">HugePages_Total:    2048</span><br><span class="line">HugePages_Free:     1080</span><br><span class="line">HugePages_Rsvd:        0</span><br><span class="line">HugePages_Surp:        0</span><br><span class="line">Hugepagesize:       2048 kB</span><br></pre></td></tr></table></figure>
<p><strong>注</strong> 如果系统重启或者重新编译，则该值会被重新刷新为默认值，需要重新设置</p>
]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>dpdk</tag>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo开启disqus评论系统</title>
    <url>/2018/09/13/hexo-enable-disqus/</url>
    <content><![CDATA[<p>之前一直使用Hexo的Next主题，开启的是Valine评论系统。有<a href="http://www.simble.site/post/a072bce6.html" target="_blank" rel="noopener">博文</a>来说明配置过程。然而，一个主题再好，看的时间久了，还是想要换换。于是使用了现在的<a href="https://github.com/stkevintan/hexo-theme-material-flow" target="_blank" rel="noopener">MaterialFlow</a>，刚好也换换评论系统</p>
<p>相比Valine，disqus开启真的是太简单了</p>
<a id="more"></a>
<h3 id="注册disqus账号"><a class="markdownIt-Anchor" href="#注册disqus账号"></a> 注册disqus账号</h3>
<p>其实我很早之前就注册了账号，直接使用facebook关联过去的.</p>
<h3 id="网站上开启"><a class="markdownIt-Anchor" href="#网站上开启"></a> 网站上开启</h3>
<ol>
<li>登陆disqus后，在首页点击右侧设置-Add Disqus To Site</li>
</ol>
<p><img src="/2018/09/13/hexo-enable-disqus/disqus_1.png" alt="Add Disqus To Site" /></p>
<ol start="2">
<li>在随后弹出的页面点击Start - I want to install Disqus on my site</li>
</ol>
<p><img src="/2018/09/13/hexo-enable-disqus/disqus2.png" alt="Install" /></p>
<p><img src="/2018/09/13/hexo-enable-disqus/disqus-shortname.png" alt="Shortname" /></p>
<h3 id="配置hexo"><a class="markdownIt-Anchor" href="#配置hexo"></a> 配置Hexo</h3>
<p>修改hexo的_config.yml，增加<code>disqus_shortname</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">disqus_shortname:</span> <span class="string">your_shortname</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>大功告成</p>
</blockquote>
<p><strong>欢迎大家留言</strong></p>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>Hello World</title>
    <url>/2018/03/22/hello-world/</url>
    <content><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<a id="more"></a>
<h2 id="quick-start"><a class="markdownIt-Anchor" href="#quick-start"></a> Quick Start</h2>
<h3 id="create-a-new-post"><a class="markdownIt-Anchor" href="#create-a-new-post"></a> Create a new post</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="run-server"><a class="markdownIt-Anchor" href="#run-server"></a> Run server</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="generate-static-files"><a class="markdownIt-Anchor" href="#generate-static-files"></a> Generate static files</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="deploy-to-remote-sites"><a class="markdownIt-Anchor" href="#deploy-to-remote-sites"></a> Deploy to remote sites</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>
]]></content>
  </entry>
  <entry>
    <title>gitbook+gitlab发布私有的图书仓库</title>
    <url>/2018/05/11/gitbook-gitlab/</url>
    <content><![CDATA[<p>近期带着一些同事学习python，开始用markdown的格式写了很多练习题，一直有想法将其发布成一本电子书在公司内部分享。但由于有些内容可能涉及公司相关，无法直接对外发布。而公司内部自建了一个gitlab服务器，一直用于托管一些不是很重要的代码。所以，便有了将markdown托管到gitlab上，然后使用gitbook在内部进行发布。</p>
<p>另一方面，由于最近痴迷于Docker，所以，也同样将gitbook打包成docker image，用于快速发布。这篇文章主要用于记录整个操作过程。</p>
<a id="more"></a>
<h2 id="gitbookdocker"><a class="markdownIt-Anchor" href="#gitbookdocker"></a> gitbook+docker</h2>
<h3 id="本地安装"><a class="markdownIt-Anchor" href="#本地安装"></a> 本地安装</h3>
<p>可参看gitbook的<a href="https://toolchain.gitbook.com/setup.html" target="_blank" rel="noopener">官方文档</a></p>
<ul>
<li>
<p>环境需求</p>
<p>gitbook需要nodejs环境</p>
<ul>
<li>NodeJS (v4.0.0 and above is recommended)</li>
</ul>
</li>
<li>
<p>安装gitbook-cli</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install gitbook-cli -g</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>创建一本书</p>
<p><strong>当使用gitlab时，可跳过此步骤</strong></p>
<ul>
<li>创建存放书籍的目录</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir mybook</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gitbook init</span><br></pre></td></tr></table></figure>
<p>初始化完成后，将生成<code>SUMMARY.md</code>和<code>README.md</code></p>
<ul>
<li>插件安装</li>
</ul>
<p>如果没有生成book.json，可自行创建</p>
  <figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">&quot;root&quot;: &quot;.&#x2F;&quot;,</span><br><span class="line">&quot;title&quot;: &quot;mybook&quot;,</span><br><span class="line">&quot;head_title&quot;: &quot;My first book&quot;,</span><br><span class="line">&quot;description&quot;: &quot;test with gitbook&quot;,</span><br><span class="line">&quot;author&quot;: &quot;myname&quot;,</span><br><span class="line">&quot;output.name&quot;: &quot;practice&quot;,</span><br><span class="line"></span><br><span class="line">&quot;gitbook&quot;: &quot;&gt;&#x3D; 3.0.0&quot;,</span><br><span class="line"></span><br><span class="line">&quot;language&quot;: &quot;zh-hans&quot;,</span><br><span class="line">&quot;plugins&quot;: [</span><br><span class="line">        ]</span><br></pre></td></tr></table></figure>
<p>将插件在<code>plugins</code>字段中进行声明后，执行以下命令进行安装</p>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gitbook install</span><br></pre></td></tr></table></figure>
<ul>
<li>预览和发布自己的书</li>
</ul>
  <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gitbook serve</span><br></pre></td></tr></table></figure>
<p>随后可登陆http://localhost:4000来预览自己的书</p>
</li>
</ul>
<h3 id="docker镜像"><a class="markdownIt-Anchor" href="#docker镜像"></a> docker镜像</h3>
<p>其实在docker hub上搜索便可以得到gitbook的镜像，但本着学习的态度，还是自己动手练习制作自己的docker镜像。</p>
<p>由于nodejs有官方提供的docker镜像，所以，一切变得很简单</p>
<ul>
<li>Dockerfile</li>
</ul>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> node:<span class="number">8</span>-alpine</span><br><span class="line"><span class="keyword">MAINTAINER</span> Bo Qi &lt;simble1986@gmail.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> npm install gitbook-cli -g &amp;&amp; npm install &amp;&amp; gitbook install</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /book</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">4000</span> <span class="number">35729</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> gitbook install &amp;&amp; gitbook serve</span></span><br></pre></td></tr></table></figure>
<ul>
<li>编译docker镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build --tag mygitbook .</span><br></pre></td></tr></table></figure>
<h2 id="书的结构"><a class="markdownIt-Anchor" href="#书的结构"></a> 书的结构</h2>
<p>当使用<code>gitbook init</code>后会在当前目录生成两个文件：<code>README.md</code>和<code>SUMMARY.md</code>.</p>
<p>其中，<code>README.md</code>用来对本书进行一些说明</p>
<p>而<code>SUMMARY.md</code>则用来创建目录结构。</p>
<h3 id="summarymd"><a class="markdownIt-Anchor" href="#summarymd"></a> <a href="http://SUMMARY.md" target="_blank" rel="noopener">SUMMARY.md</a></h3>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line"><span class="section"># Summary</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">* </span>[<span class="string">介绍</span>](<span class="link">README.md</span>)</span><br><span class="line"><span class="bullet">* </span>[<span class="string">Git使用</span>](<span class="link">gitSetup.md</span>)</span><br><span class="line"><span class="bullet">* </span>[<span class="string">Python基础</span>](<span class="link">part1/README.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习1-列表</span>](<span class="link">part1/1.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习2-字典</span>](<span class="link">part1/2.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习3-数据结构嵌套</span>](<span class="link">part1/3.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习4-运算符</span>](<span class="link">part1/4.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习5-逻辑控制</span>](<span class="link">part1/5.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习6-异常处理</span>](<span class="link">part1/6.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习7-函数</span>](<span class="link">part1/7.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习8-文件操作</span>](<span class="link">part1/8.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">轻松一刻-猜数字游戏</span>](<span class="link">part1/happy1.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习9-类.1</span>](<span class="link">part1/9.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习10-类.2</span>](<span class="link">part1/10.md</span>)</span><br><span class="line"><span class="bullet">    * </span>[<span class="string">练习11-类的继承</span>](<span class="link">part1/11.md</span>)</span><br></pre></td></tr></table></figure>
<h3 id="bookjson"><a class="markdownIt-Anchor" href="#bookjson"></a> book.json</h3>
<p>需要自己创建book.json</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"root"</span>: <span class="string">"./"</span>,</span><br><span class="line">    <span class="attr">"title"</span>: <span class="string">"练习python"</span>,</span><br><span class="line">    <span class="attr">"head_title"</span>: <span class="string">"通过练习的方式来学习python"</span>,</span><br><span class="line">    <span class="attr">"description"</span>: <span class="string">"通过小练习一点一点熟悉python"</span>,</span><br><span class="line">    <span class="attr">"author"</span>: <span class="string">"myname(simble1986@gmail.com)"</span>,</span><br><span class="line">    <span class="attr">"output.name"</span>: <span class="string">"通过练习学脚本"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"gitbook"</span>: <span class="string">"3.2.3"</span>,</span><br><span class="line"></span><br><span class="line">    <span class="attr">"language"</span>: <span class="string">"zh-hans"</span>,</span><br><span class="line">    <span class="attr">"links"</span> : &#123;</span><br><span class="line">    <span class="attr">"sidebar"</span> : &#123;</span><br><span class="line">        <span class="attr">"Home"</span> : <span class="string">"http://www.simble.site"</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">"plugins"</span>: [</span><br><span class="line">        <span class="string">"autotheme"</span>,</span><br><span class="line">        <span class="string">"prism"</span>,</span><br><span class="line">        <span class="string">"prism-themes"</span>,</span><br><span class="line">        <span class="string">"-highlight"</span>,</span><br><span class="line">        <span class="string">"-search"</span>,</span><br><span class="line">        <span class="string">"search-pro"</span>,</span><br><span class="line">        <span class="string">"emphasize"</span>,</span><br><span class="line">        <span class="string">"splitter"</span>,</span><br><span class="line">        <span class="string">"tbfed-pagefooter"</span>,</span><br><span class="line">        <span class="string">"toggle-chapters"</span>,</span><br><span class="line">        <span class="string">"codeblock-filename"</span>,</span><br><span class="line">        <span class="string">"ace"</span>,</span><br><span class="line">        <span class="string">"simple-page-toc"</span>,</span><br><span class="line">        <span class="string">"edit-link"</span>,</span><br><span class="line">        <span class="string">"copy-code-button"</span>,</span><br><span class="line">        <span class="string">"alerts"</span>,</span><br><span class="line">        <span class="string">"anchor-navigation-ex"</span>,</span><br><span class="line">        <span class="string">"theme-comscore"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="git-lab归档"><a class="markdownIt-Anchor" href="#git-lab归档"></a> git-lab归档</h3>
<p>在gitlab上创建自己的project并归档</p>
<h2 id="在服务器上用docker启动预览"><a class="markdownIt-Anchor" href="#在服务器上用docker启动预览"></a> 在服务器上用docker启动预览</h2>
<ul>
<li>从gitlab上clone书的结构</li>
<li>启动docker并挂载gitbook的目录到docker中</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -d -p 80:4000 -v /mybook:/book mygitbook</span><br></pre></td></tr></table></figure>
<h2 id="插件及说明"><a class="markdownIt-Anchor" href="#插件及说明"></a> 插件及说明</h2>
<p>非常感谢<a href="http://gitbook.zhangjikai.com/plugins.html" target="_blank" rel="noopener">Zhangjikai的插件说明文档</a>，然后我发现<a href="http://blog.zhangjikai.com/" target="_blank" rel="noopener">Zhangjikai</a>和我一样使用了Hexo搭建了自己的blog，并且同样适用了Next的主题</p>
]]></content>
      <categories>
        <category>docker</category>
      </categories>
  </entry>
  <entry>
    <title>K8s网络相关问题及解决</title>
    <url>/2020/07/20/kubernetes-network-problem-resolve/</url>
    <content><![CDATA[<p>随着学习日渐深入，遇到了不少问题。有问题，度娘+谷哥。学习阶段，我只是各种文章的搬运工。先解决用的问题</p>
<p>本文主要解决以下几个问题：</p>
<ol>
<li>pod无法访问ClusterIP</li>
<li>busybox做dns查询</li>
<li>pod间互访及访问外网</li>
</ol>
<a id="more"></a>
<h2 id="问题1-pod无法访问clusterip"><a class="markdownIt-Anchor" href="#问题1-pod无法访问clusterip"></a> 问题1: pod无法访问ClusterIP</h2>
<blockquote>
<p>这个问题困扰了我好些天，最后，配置了IPVS就OK了</p>
</blockquote>
<h3 id="step0-kube-proxy日志"><a class="markdownIt-Anchor" href="#step0-kube-proxy日志"></a> step0 - kube-proxy日志</h3>
<p>从kube-proxy的日志中看到<code>Unknown proxy mode &quot;&quot;, assuming iptables proxy</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl logs -n kube-system kube-proxy-5n29r | more</span><br><span class="line">W0720 03:22:47.942827       1 server_others.go:559] Unknown proxy mode <span class="string">""</span>, assuming iptables proxy</span><br><span class="line">I0720 03:22:48.245820       1 node.go:136] Successfully retrieved node IP: 10.160.18.183</span><br><span class="line">I0720 03:22:48.245876       1 server_others.go:186] Using iptables Proxier.</span><br><span class="line">I0720 03:22:48.246253       1 server.go:583] Version: v1.18.3</span><br><span class="line">I0720 03:22:48.395170       1 conntrack.go:100] Set sysctl <span class="string">'net/netfilter/nf_conntrack_max'</span> to 131072</span><br><span class="line">I0720 03:22:48.395210       1 conntrack.go:52] Setting nf_conntrack_max to 131072</span><br><span class="line">I0720 03:22:48.395578       1 conntrack.go:83] Setting conntrack hashsize to 32768</span><br><span class="line">I0720 03:22:48.414004       1 conntrack.go:100] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_established'</span> to 86400</span><br><span class="line">I0720 03:22:48.414067       1 conntrack.go:100] Set sysctl <span class="string">'net/netfilter/nf_conntrack_tcp_timeout_close_wait'</span> to 3600</span><br><span class="line">I0720 03:22:48.533638       1 config.go:315] Starting service config controller</span><br><span class="line">I0720 03:22:48.533673       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config</span><br><span class="line">I0720 03:22:48.533997       1 config.go:133] Starting endpoints config controller</span><br><span class="line">I0720 03:22:48.534016       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config</span><br></pre></td></tr></table></figure>
<h3 id="step1-安装相关包"><a class="markdownIt-Anchor" href="#step1-安装相关包"></a> step1 - 安装相关包</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在所有节点上</span></span><br><span class="line">$ apt install ipset ipvsadm</span><br></pre></td></tr></table></figure>
<h3 id="step2-加载module"><a class="markdownIt-Anchor" href="#step2-加载module"></a> step2 - 加载module</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ modprobe -- ip_vs</span><br><span class="line">$ modprobe -- ip_vs_rr</span><br><span class="line">$ modprobe -- ip_vs_wrr</span><br><span class="line">$ modprobe -- ip_vs_sh</span><br><span class="line">$ modprobe -- nf_conntrack</span><br><span class="line"><span class="comment"># 注：很多帖子上都写的是nf_conntrack_ipv4，但在Ubuntu20.04上，这个已经变成了nf_conntrack</span></span><br><span class="line"><span class="comment"># 检查配置</span></span><br><span class="line">$ lsmod | grep -e ipvs -e nf_conntrack</span><br><span class="line">nf_conntrack_netlink    45056  0</span><br><span class="line">nfnetlink              16384  3 nf_conntrack_netlink,ip_set</span><br><span class="line">nf_conntrack          139264  5 xt_conntrack,nf_nat,nf_conntrack_netlink,xt_MASQUERADE,ip_vs</span><br><span class="line">nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span><br><span class="line">nf_defrag_ipv4         16384  1 nf_conntrack</span><br><span class="line">libcrc32c              16384  3 nf_conntrack,nf_nat,ip_vs</span><br><span class="line"><span class="comment"># 再注：Ubuntu 20.04上这些module可能默认已经加载了</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：如果ipvs默认没有加载的话，需要写一个脚本，系统重启时也需要加载</p>
</blockquote>
<h3 id="step3-修改kube-proxy配置文件"><a class="markdownIt-Anchor" href="#step3-修改kube-proxy配置文件"></a> step3 - 修改kube-proxy配置文件</h3>
<p>修改kube-proxy的configmap中的mode字段为<code>ipvs</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl edit configmap kube-proxy -n kube-system</span><br><span class="line">...</span><br><span class="line">     kind: KubeProxyConfiguration</span><br><span class="line">     metricsBindAddress: <span class="string">""</span></span><br><span class="line">     mode: <span class="string">"ipvs"</span></span><br><span class="line">     nodePortAddresses: null</span><br><span class="line">     ...</span><br></pre></td></tr></table></figure>
<h3 id="step4-重启kube-proxy"><a class="markdownIt-Anchor" href="#step4-重启kube-proxy"></a> step4 - 重启kube-proxy</h3>
<p>可以逐个删除kube-proxy的pod，由k8s自动重启，也可以批量删除</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system | grep kube-proxy |awk <span class="string">'&#123;system("kubectl delete pod "$1" -n kube-system")&#125;'</span></span><br></pre></td></tr></table></figure>
<p>查看kube-proxy的日志</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl logs -n kube-system kube-proxy-44zw5</span><br><span class="line">I0720 05:37:30.026304       1 node.go:136] Successfully retrieved node IP: 10.160.18.181</span><br><span class="line">I0720 05:37:30.026349       1 server_others.go:259] Using ipvs Proxier.</span><br><span class="line">W0720 05:37:30.026600       1 proxier.go:429] IPVS scheduler not specified, use rr by default</span><br><span class="line">I0720 05:37:30.026814       1 server.go:583] Version: v1.18.3</span><br><span class="line">I0720 05:37:30.027200       1 conntrack.go:52] Setting nf_conntrack_max to 131072</span><br><span class="line">I0720 05:37:30.027452       1 config.go:133] Starting endpoints config controller</span><br><span class="line">I0720 05:37:30.027474       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> endpoints config</span><br><span class="line">I0720 05:37:30.027507       1 config.go:315] Starting service config controller</span><br><span class="line">I0720 05:37:30.027529       1 shared_informer.go:223] Waiting <span class="keyword">for</span> caches to sync <span class="keyword">for</span> service config</span><br><span class="line">I0720 05:37:30.127736       1 shared_informer.go:230] Caches are synced <span class="keyword">for</span> endpoints config</span><br><span class="line">I0720 05:37:30.127790       1 shared_informer.go:230] Caches are synced <span class="keyword">for</span> service config</span><br></pre></td></tr></table></figure>
<p>可以看到<code>Using ipvs Proxier.</code>，说明IPVS已经启用了</p>
<p><strong>现在，可以启动一个busybox的container来ping一下coredns的clusterIP了</strong></p>
<h2 id="问题2-busybox做dns查询失败"><a class="markdownIt-Anchor" href="#问题2-busybox做dns查询失败"></a> 问题2: busybox做dns查询失败</h2>
<h3 id="step0-问题现象"><a class="markdownIt-Anchor" href="#step0-问题现象"></a> step0 - 问题现象</h3>
<p>在解决了pod无法访问dns clusterIP的问题之后，发现busybox还是无法解析到某个service的IP</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl run -i --tty --image busybox dns-test --restart=Never --rm /bin/sh</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/ # nslookup web-0.nginx</span></span><br><span class="line"><span class="string">;; connection timed out; no servers could be reached</span></span><br></pre></td></tr></table></figure>
<p>上网查完后发现：busybox的版本高于1.28.4都存在这个问题</p>
<h3 id="step1-解决方法"><a class="markdownIt-Anchor" href="#step1-解决方法"></a> step1 - 解决方法</h3>
<p>使用1.28.4的busybox镜像执行dns查询</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty --image busybox:1.28.4 dns-test --restart=Never --rm /bin/sh</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/ # nslookup web-0.nginx</span></span><br><span class="line"><span class="string">Server:    10.96.0.10</span></span><br><span class="line"><span class="string">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Name:      web-0.nginx</span></span><br><span class="line"><span class="string">Address 1: 172.1.2.175 web-0.nginx.default.svc.cluster.local</span></span><br><span class="line"><span class="string">/ # ping web-0.nginx</span></span><br><span class="line"><span class="string">PING web-0.nginx (172.1.2.175): 56 data bytes</span></span><br><span class="line"><span class="string">64 bytes from 172.1.2.175: seq=0 ttl=62 time=1.050 ms</span></span><br><span class="line"><span class="string">64 bytes from 172.1.2.175: seq=1 ttl=62 time=0.432 ms</span></span><br></pre></td></tr></table></figure>
<h2 id="问题3-pod互访及访问外网不通"><a class="markdownIt-Anchor" href="#问题3-pod互访及访问外网不通"></a> 问题3: pod互访及访问外网不通</h2>
<p><strong>问题原因</strong>：iptables</p>
<p><strong>解决方法</strong>：</p>
<p>分别在每个节点上执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iptables -P INPUT ACCEPT</span><br><span class="line">$ iptables -P FORWARD ACCEPT</span><br><span class="line">$ iptables -F</span><br><span class="line">$ iptables -L -n</span><br><span class="line">$ iptables -t nat -I POSTROUTING -s 172.1.2.0/24 -j MASQUERADE</span><br><span class="line"><span class="comment"># 注：172.1.2.0/24是每个节点的pod-network-cidr</span></span><br></pre></td></tr></table></figure>
<p><strong>测试</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl run -i --tty --image busybox:1.28.4 connect-test --restart=Never --rm -- /bin/sh</span><br><span class="line">If you don<span class="string">'t see a command prompt, try pressing enter.</span></span><br><span class="line"><span class="string">/ # ping 10.96.0.10 -c 1</span></span><br><span class="line"><span class="string">PING 10.96.0.10 (10.96.0.10): 56 data bytes</span></span><br><span class="line"><span class="string">64 bytes from 10.96.0.10: seq=0 ttl=64 time=0.082 ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--- 10.96.0.10 ping statistics ---</span></span><br><span class="line"><span class="string">1 packets transmitted, 1 packets received, 0% packet loss</span></span><br><span class="line"><span class="string">round-trip min/avg/max = 0.082/0.082/0.082 ms</span></span><br><span class="line"><span class="string">/ # ping 10.96.0.1 -c 1</span></span><br><span class="line"><span class="string">PING 10.96.0.1 (10.96.0.1): 56 data bytes</span></span><br><span class="line"><span class="string">64 bytes from 10.96.0.1: seq=0 ttl=64 time=0.072 ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--- 10.96.0.1 ping statistics ---</span></span><br><span class="line"><span class="string">1 packets transmitted, 1 packets received, 0% packet loss</span></span><br><span class="line"><span class="string">round-trip min/avg/max = 0.072/0.072/0.072 ms</span></span><br><span class="line"><span class="string">/ # ping 172.1.1.193 -c 1</span></span><br><span class="line"><span class="string">PING 172.1.1.193 (172.1.1.193): 56 data bytes</span></span><br><span class="line"><span class="string">64 bytes from 172.1.1.193: seq=0 ttl=64 time=0.108 ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--- 172.1.1.193 ping statistics ---</span></span><br><span class="line"><span class="string">1 packets transmitted, 1 packets received, 0% packet loss</span></span><br><span class="line"><span class="string">round-trip min/avg/max = 0.108/0.108/0.108 ms</span></span><br><span class="line"><span class="string">/ # ping 223.5.5.5 -c 1</span></span><br><span class="line"><span class="string">PING 223.5.5.5 (223.5.5.5): 56 data bytes</span></span><br><span class="line"><span class="string">64 bytes from 223.5.5.5: seq=0 ttl=114 time=5.659 ms</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--- 223.5.5.5 ping statistics ---</span></span><br><span class="line"><span class="string">1 packets transmitted, 1 packets received, 0% packet loss</span></span><br><span class="line"><span class="string">round-trip min/avg/max = 5.659/5.659/5.659 ms</span></span><br><span class="line"><span class="string">/ #</span></span><br><span class="line"><span class="string"># 注: 10.96.0.1为kube-apiserver的ClusterIP</span></span><br><span class="line"><span class="string">#     10.96.0.10为coredns的ClusterIP</span></span><br><span class="line"><span class="string">#     172.1.1.193为一个pod的IP</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s学习笔记——container之于进程</title>
    <url>/2020/06/17/kubernetesLearning01/</url>
    <content><![CDATA[<blockquote>
<p>学习极客时间上的<a href="https://time.geekbang.org/column/intro/116" target="_blank" rel="noopener">《深入剖析Kubernetes》</a></p>
<p>秉持眼过千遍不如手过一遍的原则.</p>
<p>对应章节：<a href="https://time.geekbang.org/column/article/14642" target="_blank" rel="noopener">05 | 白话容器基础（一）：从进程说开去</a></p>
</blockquote>
<a id="more"></a>
<h2 id="操作"><a class="markdownIt-Anchor" href="#操作"></a> 操作</h2>
<h3 id="start一个container"><a class="markdownIt-Anchor" href="#start一个container"></a> start一个container</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it -d busybox</span><br></pre></td></tr></table></figure>
<h3 id="查看进程"><a class="markdownIt-Anchor" href="#查看进程"></a> 查看进程</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -aux</span><br><span class="line">...</span><br><span class="line">root      2817  0.0  0.2 107700  2296 ?        Sl   05:42   0:00 containerd-shim -namespace moby -workdir /var/lib/containerd/io.containerd.run</span><br><span class="line">root      2851  0.0  0.0   1308     4 pts/0    Ss+  05:42   0:00 sh</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="查看进程树"><a class="markdownIt-Anchor" href="#查看进程树"></a> 查看进程树</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pstree  -g</span><br><span class="line">systemd(1)─┬─VGAuthService(562)</span><br><span class="line">           ├─accounts-daemon(866)─┬─&#123;accounts-daemon&#125;(866)</span><br><span class="line">           │                      └─&#123;accounts-daemon&#125;(866)</span><br><span class="line">           ├─atd(928)</span><br><span class="line">           ├─containerd(1055)─┬─containerd-shim(2817)─┬─sh(2851)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       ├─&#123;containerd-shim&#125;(2817)</span><br><span class="line">           │                  │                       └─&#123;containerd-shim&#125;(2817)</span><br><span class="line"> ....</span><br></pre></td></tr></table></figure>
<h3 id="查看容器内进程"><a class="markdownIt-Anchor" href="#查看容器内进程"></a> 查看容器内进程</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">    6 root      0:00 ps</span><br></pre></td></tr></table></figure>
<h3 id="分别查看两个进程的namespace"><a class="markdownIt-Anchor" href="#分别查看两个进程的namespace"></a> 分别查看两个进程的namespace</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/proc/2817/ns<span class="comment"># ls -l</span></span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 05:43 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 05:43 ipc -&gt; <span class="string">'ipc:[4026531839]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 05:43 mnt -&gt; <span class="string">'mnt:[4026531840]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 05:43 net -&gt; <span class="string">'net:[4026531993]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 05:43 pid -&gt; <span class="string">'pid:[4026531836]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 06:16 pid_for_children -&gt; <span class="string">'pid:[4026531836]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 05:43 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 11 05:43 uts -&gt; <span class="string">'uts:[4026531838]</span></span><br><span class="line"><span class="string">/proc/2851/ns# ls -l</span></span><br><span class="line"><span class="string">total 0</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 05:43 cgroup -&gt; '</span>cgroup:[4026531835]<span class="string">'</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 05:43 ipc -&gt; '</span>ipc:[4026532571]<span class="string">'</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 05:43 mnt -&gt; '</span>mnt:[4026532569]<span class="string">'</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 05:42 net -&gt; '</span>net:[4026532574]<span class="string">'</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 05:43 pid -&gt; '</span>pid:[4026532572]<span class="string">'</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 06:16 pid_for_children -&gt; '</span>pid:[4026532572]<span class="string">'</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 05:43 user -&gt; '</span>user:[4026531837]<span class="string">'</span></span><br><span class="line"><span class="string">lrwxrwxrwx 1 root root 0 Jun 11 05:43 uts -&gt; '</span>uts:[4026532570]<span class="string">'</span></span><br></pre></td></tr></table></figure>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<ol>
<li>启动一个docker容器后，会看到启动了一个2817的进程，这个进程是1055的子进程</li>
<li>而因为busybox容器启动后，启动了<code>sh</code>，其实际上是2817的子进程2851</li>
<li>而在容器中，能看到1号进程是<code>sh</code></li>
<li>通过/proc下可以看到，进程2817和进程2851的ns下，cgroup是都是<code>4026531835</code></li>
<li>而很明显，每个container都会创建<code>ipc</code>, <code>mnt</code>, <code>net</code>, <code>pid</code>, <code>pid_for_children</code>, <code>user</code>, <code>uts</code>这些namespace</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s学习笔记——限制与隔离</title>
    <url>/2020/06/17/kubernetesLearning02/</url>
    <content><![CDATA[<blockquote>
<p>学习极客时间上的<a href="https://time.geekbang.org/column/intro/116" target="_blank" rel="noopener">《深入剖析Kubernetes》</a></p>
<p>秉持眼过千遍不如手过一遍的原则.</p>
<p>对应章节：<a href="https://time.geekbang.org/column/article/14653" target="_blank" rel="noopener">06 | 白话容器基础（二）：隔离与限制</a></p>
</blockquote>
<a id="more"></a>
<h2 id="隔离与限制"><a class="markdownIt-Anchor" href="#隔离与限制"></a> 隔离与限制</h2>
<h2 id="cgroup的mount点"><a class="markdownIt-Anchor" href="#cgroup的mount点"></a> cgroup的mount点</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mount -t cgroup</span><br><span class="line">cgroup on /sys/fs/cgroup/systemd <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,xattr,name=systemd)</span><br><span class="line">cgroup on /sys/fs/cgroup/hugetlb <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,hugetlb)</span><br><span class="line">cgroup on /sys/fs/cgroup/rdma <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,rdma)</span><br><span class="line">cgroup on /sys/fs/cgroup/devices <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,devices)</span><br><span class="line">cgroup on /sys/fs/cgroup/perf_event <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,perf_event)</span><br><span class="line">cgroup on /sys/fs/cgroup/net_cls,net_prio <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,net_cls,net_prio)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpu,cpuacct <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,cpu,cpuacct)</span><br><span class="line">cgroup on /sys/fs/cgroup/blkio <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,blkio)</span><br><span class="line">cgroup on /sys/fs/cgroup/memory <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,memory)</span><br><span class="line">cgroup on /sys/fs/cgroup/pids <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,pids)</span><br><span class="line">cgroup on /sys/fs/cgroup/cpuset <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,cpuset,clone_children)</span><br><span class="line">cgroup on /sys/fs/cgroup/freezer <span class="built_in">type</span> cgroup (rw,nosuid,nodev,noexec,relatime,freezer)</span><br></pre></td></tr></table></figure>
<h2 id="查看cpu相关信息"><a class="markdownIt-Anchor" href="#查看cpu相关信息"></a> 查看CPU相关信息</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> /sys/fs/cgroup</span><br><span class="line">$ ls cpu</span><br><span class="line">cgroup.clone_children  cpuacct.stat       cpuacct.usage_percpu       cpuacct.usage_sys   cpu.cfs_quota_us  docker             system.slice</span><br><span class="line">cgroup.procs           cpuacct.usage      cpuacct.usage_percpu_sys   cpuacct.usage_user  cpu.shares        notify_on_release  tasks</span><br><span class="line">cgroup.sane_behavior   cpuacct.usage_all  cpuacct.usage_percpu_user  cpu.cfs_period_us   cpu.stat          release_agent      user.slice</span><br><span class="line">$ cat cpu/cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line">$ cat cpu/cpu.cfs_quota_us</span><br><span class="line">-1</span><br></pre></td></tr></table></figure>
<h2 id="在cpu目录下创建一个container目录"><a class="markdownIt-Anchor" href="#在cpu目录下创建一个container目录"></a> 在CPU目录下创建一个container目录</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir container</span><br><span class="line">$ ls container/</span><br><span class="line">cgroup.clone_children  cpuacct.usage_all          cpuacct.usage_sys   cpu.shares</span><br><span class="line">cgroup.procs           cpuacct.usage_percpu       cpuacct.usage_user  cpu.stat</span><br><span class="line">cpuacct.stat           cpuacct.usage_percpu_sys   cpu.cfs_period_us   notify_on_release</span><br><span class="line">cpuacct.usage          cpuacct.usage_percpu_user  cpu.cfs_quota_us    tasks</span><br></pre></td></tr></table></figure>
<blockquote>
<p>会看到创建目录后，会自动创建一堆文件</p>
</blockquote>
<h2 id="用一个while循环检测cpu使用状况"><a class="markdownIt-Anchor" href="#用一个while循环检测cpu使用状况"></a> 用一个while循环检测CPU使用状况</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="keyword">while</span> : ; <span class="keyword">do</span> : ; <span class="keyword">done</span> &amp;</span><br><span class="line">[1] 16508</span><br><span class="line">$ top</span><br><span class="line">top - 09:03:06 up  3:32,  4 users,  load average: 0.28, 0.07, 0.02</span><br><span class="line">Tasks: 105 total,   2 running,  61 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s): 99.7 us,  0.3 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :  1009256 total,   208232 free,   220168 used,   580856 buff/cache</span><br><span class="line">KiB Swap:  2018300 total,  2008256 free,    10044 used.   647692 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">16508 root      20   0   21640   3180   1216 R 99.7  0.3   0:17.88 bash</span><br></pre></td></tr></table></figure>
<blockquote>
<p>在有的虚拟机上，你会看到CPU使用率不是99%，可能是50%，25%等，你可以思考一下这是为什么</p>
</blockquote>
<h2 id="使用container的cgroup对while循环进行资源限制"><a class="markdownIt-Anchor" href="#使用container的cgroup对while循环进行资源限制"></a> 使用container的cgroup对while循环进行资源限制</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> 20000 &gt; container/cpu.cfs_quota_us</span><br><span class="line">$ <span class="built_in">echo</span> 16508 &gt; container/tasks</span><br><span class="line">$ top</span><br><span class="line">top - 09:06:24 up  3:35,  4 users,  load average: 0.97, 0.52, 0.21</span><br><span class="line">Tasks: 105 total,   2 running,  61 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s): 20.0 us,  0.0 sy,  0.0 ni, 79.7 id,  0.0 wa,  0.0 hi,  0.3 si,  0.0 st</span><br><span class="line">KiB Mem :  1009256 total,   208636 free,   219736 used,   580884 buff/cache</span><br><span class="line">KiB Swap:  2018300 total,  2008256 free,    10044 used.   648120 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">16508 root      20   0   21640   3180   1216 R 20.6  0.3   3:31.08 bash</span><br></pre></td></tr></table></figure>
<h2 id="起一个容器看看"><a class="markdownIt-Anchor" href="#起一个容器看看"></a> 起一个容器看看</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it --cpu-period=100000 --cpu-quota=20000 ubuntu /bin/bash</span><br><span class="line">root@26cbffdcb5bf:/<span class="comment"># cat /sys/fs/cgroup/cpu/cpu.cfs_period_us</span></span><br><span class="line">100000</span><br><span class="line">root@26cbffdcb5bf:/<span class="comment"># cat /sys/fs/cgroup/cpu/cpu.cfs_quota_us</span></span><br><span class="line">20000</span><br><span class="line"><span class="comment"># 在宿主机上</span></span><br><span class="line">$ cat /sys/fs/cgroup/cpu/docker/26cbffdcb5bf2f9d9ecdc9207f4211c8f5b3cfbc39d83c77ed4666db3ca0bac3/cpu.cfs_period_us</span><br><span class="line">100000</span><br><span class="line">$ cat /sys/fs/cgroup/cpu/docker/26cbffdcb5bf2f9d9ecdc9207f4211c8f5b3cfbc39d83c77ed4666db3ca0bac3/cpu.cfs_quota_us</span><br><span class="line">20000</span><br></pre></td></tr></table></figure>
<h2 id="top对比"><a class="markdownIt-Anchor" href="#top对比"></a> top对比</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 容器中</span></span><br><span class="line">root@26cbffdcb5bf:/<span class="comment"># while : ; do : ; done &amp;</span></span><br><span class="line">[1] 11</span><br><span class="line">root@26cbffdcb5bf:/<span class="comment"># top</span></span><br><span class="line">top - 09:10:34 up  3:39,  0 users,  load average: 0.01, 0.21, 0.15</span><br><span class="line">Tasks:   3 total,   2 running,   1 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s): 20.3 us,  0.0 sy,  0.0 ni, 79.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">MiB Mem :    985.6 total,    163.9 free,    251.5 used,    570.2 buff/cache</span><br><span class="line">MiB Swap:   1971.0 total,   1961.2 free,      9.8 used.    595.9 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S  %CPU  %MEM     TIME+ COMMAND</span><br><span class="line">   11 root      20   0    4224    560      0 R  20.3   0.1   0:01.21 bash</span><br><span class="line">    1 root      20   0    4224   3504   2944 S   0.0   0.3   0:00.19 bash</span><br><span class="line">   12 root      20   0    6080   3244   2740 R   0.0   0.3   0:00.00 top</span><br><span class="line">   </span><br><span class="line"><span class="comment"># 宿主机上</span></span><br><span class="line">$ top</span><br><span class="line">top - 09:11:36 up  3:40,  5 users,  load average: 0.10, 0.20, 0.15</span><br><span class="line">Tasks: 111 total,   2 running,  66 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu(s): 20.0 us,  0.3 sy,  0.0 ni, 79.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">KiB Mem :  1009256 total,   167472 free,   257600 used,   584184 buff/cache</span><br><span class="line">KiB Swap:  2018300 total,  2008256 free,    10044 used.   610176 avail Mem</span><br><span class="line"></span><br><span class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span><br><span class="line">16755 root      20   0    4224    560      0 R 19.9  0.1   0:13.62 bash</span><br><span class="line">$ pstree -g</span><br><span class="line">systemd(1)─┬─VGAuthService(562)</span><br><span class="line">           ├─accounts-daemon(866)─┬─&#123;accounts-daemon&#125;(866)</span><br><span class="line">           │                      └─&#123;accounts-daemon&#125;(866)</span><br><span class="line">           ├─atd(928)</span><br><span class="line">           ├─containerd(1055)─├─containerd-shim(16557)─┬─bash(16585)───bash(16755)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        ├─&#123;containerd-shim&#125;(16557)</span><br><span class="line">           │                  │                        └─&#123;containerd-shim&#125;(16557)</span><br></pre></td></tr></table></figure>
<p>可以看到容器内和容器外部看到的是一样的</p>
<h2 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h2>
<p>主要使用了cgroup对一个进程的CPU使用率进行了限制，通过了解进程的CPU使用率限制机制，了解docker通过cgroup对相关资源使用的限制</p>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo+Next上开启Valine评论系统</title>
    <url>/2018/03/27/hexo-next-valine/</url>
    <content><![CDATA[<p>朋友之前问怎么没有开评论系统，倒不是不想开，而是刚开始建站的时候浏览了好多博文，似乎很多原来的接口都在hexo不太好用了。特别是很多博文都是两年前写的，当然，大多数其他功能都没问题</p>
<a id="more"></a>
<h2 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h2>
<h3 id="valine"><a class="markdownIt-Anchor" href="#valine"></a> Valine</h3>
<p><a href="https://valine.js.org/" target="_blank" rel="noopener">Valine</a>是一款基于<a href="https://leancloud.cn/" target="_blank" rel="noopener">Leancloud</a>的快速、简洁且高效的无后端评论系统。</p>
<h3 id="leancloud"><a class="markdownIt-Anchor" href="#leancloud"></a> Leancloud</h3>
<p>我的理解，<a href="https://leancloud.cn/" target="_blank" rel="noopener">Leancloud</a>相当于是一个数据托管平台，可以帮助应用存储相关数据。Valine主要用到的是其中的数据存储——comments</p>
<h2 id="环境说明"><a class="markdownIt-Anchor" href="#环境说明"></a> 环境说明</h2>
<p>使用了最新版的<a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>以及最新版的<a href="https://github.com/theme-next/hexo-theme-next" target="_blank" rel="noopener">Next主题</a></p>
<h2 id="获取appid"><a class="markdownIt-Anchor" href="#获取appid"></a> 获取AppID</h2>
<h3 id="注册leancloud"><a class="markdownIt-Anchor" href="#注册leancloud"></a> 注册Leancloud</h3>
<p>访问<a href="https://leancloud.cn/" target="_blank" rel="noopener">Leancloud</a>，点击<a href="https://leancloud.cn/dashboard/login.html#/signup" target="_blank" rel="noopener">免费试用</a>就会跳转到注册/登陆页面。当前支持通过Github，Weibo以及QQ进行注册</p>
<img src="/2018/03/27/hexo-next-valine/leancloud_signup.png" class="" title="注册页面">
<p><em>注册完后需要验证邮箱</em></p>
<h3 id="创建应用"><a class="markdownIt-Anchor" href="#创建应用"></a> 创建应用</h3>
<p>访问<a href="https://leancloud.cn/applist.html" target="_blank" rel="noopener">控制台</a>，在控制台中创建新应用</p>
<img src="/2018/03/27/hexo-next-valine/leancloud_new_app.png" class="" title="创建应用">
<h3 id="获取应用key"><a class="markdownIt-Anchor" href="#获取应用key"></a> 获取应用Key</h3>
<p>点击新创建的应用——设置——应用Key，保存页面上的App ID以及App Key以备后续使用</p>
<img src="/2018/03/27/hexo-next-valine/leancloud_appkey.png" class="" title="应用Key">
<h2 id="配置valine"><a class="markdownIt-Anchor" href="#配置valine"></a> 配置Valine</h2>
<p>在最新版的Next主题中，已经合入了Valine的配置代码，使得配置起来非常快捷。访问<a href="https://valine.js.org/#/hexo?id=hexo-theme-next" target="_blank" rel="noopener">Hexo中使用Valine</a>，点击<a href="https://github.com/iissnan/hexo-theme-next/pull/1983" target="_blank" rel="noopener">merged</a>，会跳转到Next主题的merge历史</p>
<h3 id="检查相关文件"><a class="markdownIt-Anchor" href="#检查相关文件"></a> 检查相关文件</h3>
<p>可以再次检查并确认<span id="inline-yellow">主题配置文件</span>_config.xml，<code>layout/_macro/post.swig</code>和<code>layout/_third-party/comments/valine.swig</code>是否都已经合入了相关代码</p>
<h3 id="配置appkey"><a class="markdownIt-Anchor" href="#配置appkey"></a> 配置AppKey</h3>
<p>编辑<span id="inline-yellow">主题配置文件</span>_config.xml中的valine部分内容</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">valine:</span><br><span class="line">  enable: true</span><br><span class="line">  appid: $Your APP ID # your leancloud application appid</span><br><span class="line">  appkey: $Your APP Key # your leancloud application appkey</span><br><span class="line">  notify: false # mail notifier , http<span class="variable">s:</span>//github.<span class="keyword">com</span>/xCss/Valine/wiki</span><br><span class="line">  verify: false # Verification code</span><br><span class="line">  placeholder: 随便说些什么吧 # comment box placeholder</span><br><span class="line">  avatar: mm # gravatar style</span><br><span class="line">  guest_info: nick,mail,link # custom comment header</span><br><span class="line">  pageSize: <span class="number">10</span> # pagination size</span><br></pre></td></tr></table></figure>
<h3 id="重新生成页面"><a class="markdownIt-Anchor" href="#重新生成页面"></a> 重新生成页面</h3>
<p>执行命令，重新生成并部署</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean &amp;&amp; hexo g &amp;&amp; hexo d</span><br></pre></td></tr></table></figure>
<p><strong>到这里，查看页面已经可以看到评论系统</strong></p>
<h2 id="创建留言页面"><a class="markdownIt-Anchor" href="#创建留言页面"></a> 创建留言页面</h2>
<p>可以为站点创建一个单独的留言板页面</p>
<h3 id="创建页面"><a class="markdownIt-Anchor" href="#创建页面"></a> 创建页面</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new page guestbook</span><br></pre></td></tr></table></figure>
<h3 id="配置主题"><a class="markdownIt-Anchor" href="#配置主题"></a> 配置主题</h3>
<ul>
<li>修改主题配置文件</li>
</ul>
<p>在<span id="inline-yellow">主题配置文件</span>_config.xml的menu字段新增guestbook字段</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">menu</span>:</span><br><span class="line">  home: / || home</span><br><span class="line">  <span class="keyword">tag</span><span class="variable">s:</span> /<span class="keyword">tags</span>/ || <span class="keyword">tags</span></span><br><span class="line">  categorie<span class="variable">s:</span> /categories/ || <span class="keyword">th</span></span><br><span class="line">  archive<span class="variable">s:</span> /archives/ || archive</span><br><span class="line">  #schedule: /schedule/ || calendar</span><br><span class="line">  #sitemap: /sitemap.xml || sitemap</span><br><span class="line">  #commonwea<span class="variable">l:</span> /<span class="number">404</span>/ || heartbeat</span><br><span class="line">  abou<span class="variable">t:</span> /about/ || user</span><br><span class="line">  guestbook: /guestbook/ || comments</span><br></pre></td></tr></table></figure>
<p><em>可以访问<a href="https://fontawesome.com/v4.7.0/icons/" target="_blank" rel="noopener">fontawesome</a>选择自己喜欢的图标来作为留言板的图标</em></p>
<ul>
<li>本地化处理</li>
</ul>
<p>编辑对应语言的配置文件<code>themes/next/languages/zh-CN.yml</code>，在menu中增加guestbook的中文</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line"><span class="keyword">menu</span>:</span><br><span class="line">  home: 首页</span><br><span class="line">  archive<span class="variable">s:</span> 归档</span><br><span class="line">  categorie<span class="variable">s:</span> 分类</span><br><span class="line">  <span class="keyword">tag</span><span class="variable">s:</span> 标签</span><br><span class="line">  abou<span class="variable">t:</span> 关于</span><br><span class="line">  <span class="built_in">search</span>: 搜索</span><br><span class="line">  schedule: 日程表</span><br><span class="line">  sitemap: 站点地图</span><br><span class="line">  commonwea<span class="variable">l:</span> 公益 <span class="number">404</span></span><br><span class="line">  guestbook: 留言</span><br></pre></td></tr></table></figure>
<h3 id="编辑页面"><a class="markdownIt-Anchor" href="#编辑页面"></a> 编辑页面</h3>
<p>编辑之前生成的guestbook页面</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: 留言板</span><br><span class="line">date: <span class="number">2018</span>-<span class="number">03</span>-<span class="number">26</span> <span class="number">23</span>:<span class="number">36</span>:<span class="number">19</span></span><br><span class="line">comment<span class="variable">s:</span> true</span><br><span class="line">---</span><br><span class="line"><span class="symbol">&lt;center&gt;</span>既然来了，就是一种缘分，留下点什么吧:<span class="keyword">ca</span><span class="variable">t:</span>&lt;/<span class="keyword">center</span>&gt;</span><br></pre></td></tr></table></figure>
<p>重新部署之后就可以看到留言板了 😃</p>
<h2 id="清除测试留言"><a class="markdownIt-Anchor" href="#清除测试留言"></a> 清除测试留言</h2>
<p>为了确保留言功能已经正常工作，都会测试一下。测试完毕后，可以通过Leancloud的<a href="https://leancloud.cn/dashboard/applist.html#/apps" target="_blank" rel="noopener">控制台</a>清除测试数据</p>
<p>点击<em>myblog</em>——存储——Comments，即可查看当前留言，选中测试时的留言，删除即可</p>
<img src="/2018/03/27/hexo-next-valine/leancloud_cleancomments.png" class="" title="清除测试留言">
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>blog</tag>
        <tag>Next</tag>
        <tag>Valine</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s学习笔记——重新认识Docker容器</title>
    <url>/2020/06/23/kubernetesLearning04/</url>
    <content><![CDATA[<blockquote>
<p>学习极客时间上的<a href="https://time.geekbang.org/column/intro/116" target="_blank" rel="noopener">《深入剖析Kubernetes》</a></p>
<p>秉持眼过千遍不如手过一遍的原则.</p>
<p>对应章节：<a href="https://time.geekbang.org/column/article/18119" target="_blank" rel="noopener">08 | 白话容器基础（四）：重新认识Docker容器</a></p>
</blockquote>
<a id="more"></a>
<h2 id="build一个镜像"><a class="markdownIt-Anchor" href="#build一个镜像"></a> build一个镜像</h2>
<h3 id="创建flask相关文件"><a class="markdownIt-Anchor" href="#创建flask相关文件"></a> 创建Flask相关文件</h3>
<ul>
<li><a href="http://app.py" target="_blank" rel="noopener">app.py</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">app = Flask(__name__)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.route('/')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></span><br><span class="line">    html = <span class="string">"&lt;h3&gt;Hello &#123;name&#125;!&lt;/h3&gt;"</span> \</span><br><span class="line">           <span class="string">"&lt;b&gt;Hostname:&lt;/b&gt; &#123;hostname&#125;&lt;br/&gt;"</span>           </span><br><span class="line">    <span class="keyword">return</span> html.format(name=os.getenv(<span class="string">"NAME"</span>, <span class="string">"world"</span>), hostname=socket.gethostname())</span><br><span class="line">    </span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    app.run(host=<span class="string">'0.0.0.0'</span>, port=<span class="number">80</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>requirements.txt</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">Flask</span><br></pre></td></tr></table></figure>
<h3 id="创建dockerfile"><a class="markdownIt-Anchor" href="#创建dockerfile"></a> 创建Dockerfile</h3>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">2.7</span>-slim</span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># app.py和requirements.txt都放在当前文件夹的app目录下</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> ./app /app</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用pip命令安装这个应用所需要的依赖</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> pip install --trusted-host pypi.python.org -r requirements.txt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许外界访问容器的80端口</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line"><span class="keyword">ENV</span> NAME World</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置容器进程为：python app.py，即：这个Python应用的启动命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"python"</span>, <span class="string">"app.py"</span>]</span></span><br></pre></td></tr></table></figure>
<p>当前目录结构</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tree .</span><br><span class="line">.</span><br><span class="line">├── app</span><br><span class="line">│   ├── app.py</span><br><span class="line">│   └── requirements.txt</span><br><span class="line">└── Dockerfile</span><br><span class="line"></span><br><span class="line">1 directory, 3 files</span><br></pre></td></tr></table></figure>
<h3 id="build-docker镜像"><a class="markdownIt-Anchor" href="#build-docker镜像"></a> build docker镜像</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker build -t flaskapp .</span><br></pre></td></tr></table></figure>
<p>当build镜像时：</p>
<ol>
<li>docker每执行一行，会以上一层为基础拉起一个容器</li>
<li>然后在这个容器里执行对应的命令</li>
<li>完成后，将这一层提交成一个image</li>
</ol>
<h3 id="查看镜像的build-history"><a class="markdownIt-Anchor" href="#查看镜像的build-history"></a> 查看镜像的build history</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">history</span> 06e1a19665ce</span><br><span class="line">IMAGE               CREATED             CREATED BY                                      SIZE                COMMENT</span><br><span class="line">06e1a19665ce        5 weeks ago         /bin/sh -c apk update &amp;&amp; apk add nginx          2.98MB</span><br><span class="line">f70734b6a266        2 months ago        /bin/sh -c <span class="comment">#(nop)  CMD ["/bin/sh"]              0B</span></span><br><span class="line">&lt;missing&gt;           2 months ago        /bin/sh -c <span class="comment">#(nop) ADD file:b91adb67b670d3a6f…   5.61MB</span></span><br></pre></td></tr></table></figure>
<h2 id="docker-exec的本质"><a class="markdownIt-Anchor" href="#docker-exec的本质"></a> docker exec的本质</h2>
<h3 id="进入一个namespace"><a class="markdownIt-Anchor" href="#进入一个namespace"></a> 进入一个namespace</h3>
<ul>
<li><code>set_ns.c</code></li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> errExit(msg) do &#123; perror(msg); exit(EXIT_FAILURE);&#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> fd;</span><br><span class="line">    </span><br><span class="line">    fd = <span class="built_in">open</span>(argv[<span class="number">1</span>], O_RDONLY);</span><br><span class="line">    <span class="keyword">if</span> (setns(fd, <span class="number">0</span>) == <span class="number">-1</span>) &#123;</span><br><span class="line">        errExit(<span class="string">"setns"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    execvp(argv[<span class="number">2</span>], &amp;argv[<span class="number">2</span>]); </span><br><span class="line">    errExit(<span class="string">"execvp"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gcc -o set_ns set_ns.c</span><br></pre></td></tr></table></figure>
<h3 id="启动一个container"><a class="markdownIt-Anchor" href="#启动一个container"></a> 启动一个container</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it -d --rm ubuntu</span><br><span class="line">59ed1b0423ac42b5659e9c3d1759000e934c8383f605875d86db42b6ae7bf098</span><br><span class="line">$ docker inspect 59ed1b0423a | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 14123,</span><br></pre></td></tr></table></figure>
<h3 id="查看进程相关ns"><a class="markdownIt-Anchor" href="#查看进程相关ns"></a> 查看进程相关ns</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /proc/14123/ns/ -l</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:34 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:34 ipc -&gt; <span class="string">'ipc:[4026532571]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:34 mnt -&gt; <span class="string">'mnt:[4026532569]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:32 net -&gt; <span class="string">'net:[4026532574]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:34 pid -&gt; <span class="string">'pid:[4026532572]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:34 pid_for_children -&gt; <span class="string">'pid:[4026532572]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:34 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:34 uts -&gt; <span class="string">'uts:[4026532570]'</span></span><br></pre></td></tr></table></figure>
<h3 id="以net的namespace运行ifconfig"><a class="markdownIt-Anchor" href="#以net的namespace运行ifconfig"></a> 以net的namespace运行ifconfig</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./set_ns /proc/14123/ns/net /bin/bash</span><br><span class="line">$ ifconfig</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.2  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        ether 02:42:ac:11:00:02  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 13  bytes 1046 (1.0 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<h3 id="分别用set_ns和docker-exec查看"><a class="markdownIt-Anchor" href="#分别用set_ns和docker-exec查看"></a> 分别用set_ns和docker exec查看</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -aux | grep /bin/bash</span><br><span class="line">root     14123  0.0  0.3   4112  3288 pts/0    Ss+  07:32   0:00 /bin/bash</span><br><span class="line">root     14682  0.0  5.8 706028 58772 pts/3    Sl+  07:47   0:00 docker <span class="built_in">exec</span> -it 59ed1b0423ac /bin/bash</span><br><span class="line">root     14698  0.0  0.3   4112  3376 pts/1    Ss+  07:47   0:00 /bin/bash</span><br><span class="line">root     14722  0.0  0.3  20416  3792 pts/4    S+   07:52   0:00 /bin/bash</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls -l /proc/14123/ns/net</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:32 /proc/14123/ns/net -&gt; <span class="string">'net:[4026532574]'</span></span><br><span class="line">$ ls -l /proc/14698/ns/net</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:49 /proc/14698/ns/net -&gt; <span class="string">'net:[4026532574]'</span></span><br><span class="line">$ ls -l /proc/14722/ns/net</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 07:52 /proc/14722/ns/net -&gt; <span class="string">'net:[4026532574]'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看出，最终都指向了同一个net namespace</p>
</blockquote>
<blockquote>
<p>Linux的ip命令也支持创建一个network namespace，如：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns add ns_test</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns_test /bin/bash</span><br><span class="line">$ ifconfig</span><br><span class="line"><span class="comment"># 由于并没有为这个namespace设定接口，所以，这里显示为空</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -aux | grep /bin/bash</span><br><span class="line">root     14956  0.0  0.4  20416  4056 pts/0    S+   08:33   0:00 /bin/bash</span><br><span class="line">$ ls -l /proc/14956/ns/net</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 08:33 /proc/14956/ns/net -&gt; <span class="string">'net:[4026532629]'</span></span><br></pre></td></tr></table></figure>
<p>当然，同样可以使用前面的set_ns的工具进行查看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ./set_ns /proc/14956/ns/net /bin/bash</span><br><span class="line">$ ifconfig</span><br><span class="line"><span class="comment"># 这里同样没有内容输出</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -aux | grep /bin/bash</span><br><span class="line">root     14956  0.0  0.4  20416  4056 pts/0    S+   08:33   0:00 /bin/bash</span><br><span class="line">root     14992  0.0  0.4  20416  4084 pts/4    S+   08:42   0:00 /bin/bash</span><br><span class="line">$ ls -l /proc/14992/ns/net</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 16 08:45 /proc/14992/ns/net -&gt; <span class="string">'net:[4026532629]'</span></span><br></pre></td></tr></table></figure>
<p>可以看到，使用ip命令进入namespace和set_ns进入namespace后的的<code>/bin/bash</code>的ns</p>
</blockquote>
<h2 id="volume的本质"><a class="markdownIt-Anchor" href="#volume的本质"></a> Volume的本质</h2>
<h3 id="启动一个挂载volume的容器"><a class="markdownIt-Anchor" href="#启动一个挂载volume的容器"></a> 启动一个挂载volume的容器</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --rm -it -d -v /<span class="built_in">test</span> ubuntu</span><br><span class="line">65f6facb7c3c8e2f239bed07481e70ca7e0d09fc61617d0ef07e00a066ae7f96</span><br><span class="line">$ docker volume ls</span><br><span class="line">DRIVER              VOLUME NAME</span><br><span class="line"><span class="built_in">local</span>               ca1683d1e9cc06657c7857d8b8c7196176a59e409d74fc72ff30f0a76f98d614</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect 65f6fa</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"65f6facb7c3c8e2f239bed07481e70ca7e0d09fc61617d0ef07e00a066ae7f96"</span>,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Mounts"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Type"</span>: <span class="string">"volume"</span>,</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"ca1683d1e9cc06657c7857d8b8c7196176a59e409d74fc72ff30f0a76f98d614"</span>,</span><br><span class="line">                <span class="string">"Source"</span>: <span class="string">"/var/lib/docker/volumes/ca1683d1e9cc06657c7857d8b8c7196176a59e409d74fc72ff30f0a76f98d614/_data"</span>,</span><br><span class="line">                <span class="string">"Destination"</span>: <span class="string">"/test"</span>,</span><br><span class="line">                <span class="string">"Driver"</span>: <span class="string">"local"</span>,</span><br><span class="line">                <span class="string">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"Propagation"</span>: <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>可以看到，在不指定本地目录的时候，docker会自动创建一个volume，且在<code>/var/lib/docker/volumes</code>下创建一个目录</p>
<h3 id="启动一个挂载本地目录的容器"><a class="markdownIt-Anchor" href="#启动一个挂载本地目录的容器"></a> 启动一个挂载本地目录的容器</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run --rm -it -d -v /<span class="built_in">test</span>:/<span class="built_in">test</span> ubuntu</span><br><span class="line">ddbbb888a84a3b700a321db79e0743576d894a2c6c6b9be58f73142d921b60aa</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect ddbbb8</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"ddbbb888a84a3b700a321db79e0743576d894a2c6c6b9be58f73142d921b60aa"</span>,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Mounts"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">                <span class="string">"Source"</span>: <span class="string">"/test"</span>,</span><br><span class="line">                <span class="string">"Destination"</span>: <span class="string">"/test"</span>,</span><br><span class="line">                <span class="string">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="volume挂载的真相"><a class="markdownIt-Anchor" href="#volume挂载的真相"></a> Volume挂载的真相</h3>
<p><strong>这一段话有必要引述</strong></p>
<blockquote>
<p>Docker 又是如何做到把一个宿主机上的目录或者文件，挂载到容器里面去呢？难道又是 Mount Namespace 的黑科技吗？</p>
<p>实际上，并不需要这么麻烦。在《白话容器基础（三）：深入理解容器镜像》的分享中，我已经介绍过，当容器进程被创建之后，尽管开启了 Mount Namespace，但是在它执行 chroot（或者 pivot_root）之前，容器进程一直可以看到宿主机上的整个文件系统。而宿主机上的文件系统，也自然包括了我们要使用的容器镜像。这个镜像的各个层，保存在 /var/lib/docker/aufs/diff 目录下，在容器进程启动后，它们会被联合挂载在 /var/lib/docker/aufs/mnt/ 目录中，这样容器所需的 rootfs 就准备好了。</p>
<p>所以，我们只需要在 rootfs 准备好之后，在执行 chroot 之前，把 Volume 指定的宿主机目录（比如 /home 目录），挂载到指定的容器目录（比如 /test 目录）在宿主机上对应的目录（即 /var/lib/docker/aufs/mnt/[可读写层 ID]/test）上，这个 Volume 的挂载工作就完成了</p>
</blockquote>
<p>由此可见，如果要将一个目录挂载到一个容器里，其操作是：</p>
<ul>
<li>进入mount namespace</li>
<li>将需要挂载的目录挂载到容器的目录上</li>
<li><code>chroot</code>切换到对应的文件系统</li>
</ul>
<h4 id="示例"><a class="markdownIt-Anchor" href="#示例"></a> 示例</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">65f6facb7c3c        ubuntu              <span class="string">"/bin/bash"</span>         14 minutes ago      Up 14 minutes                           recursing_clarke</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect 65f6facb7c3c</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"65f6facb7c3c8e2f239bed07481e70ca7e0d09fc61617d0ef07e00a066ae7f96"</span>,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"GraphDriver"</span>: &#123;</span><br><span class="line">            <span class="string">"Data"</span>: &#123;</span><br><span class="line">                <span class="string">"LowerDir"</span>: <span class="string">"/var/lib/docker/overlay2/9f0bd8e84ddffd8663f01c959a0ced115a4d598b096896be15b3c680039d7754-init/diff:/var/lib/docker/overlay2/17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff:/var/lib/docker/overlay2/823e415d4256d05fb0101af4dcc42a4389d44cf6467972d654e93e0cc575cd9b/diff:/var/lib/docker/overlay2/37d3e588905fae55c8a0481e9cda7be36177af874631abb15724c893887e260b/diff:/var/lib/docker/overlay2/40d198d6f624e455800254766eb6a7190ce02442fc48f02f6f16f72105cefd0d/diff"</span>,</span><br><span class="line">                <span class="string">"MergedDir"</span>: <span class="string">"/var/lib/docker/overlay2/9f0bd8e84ddffd8663f01c959a0ced115a4d598b096896be15b3c680039d7754/merged"</span>,</span><br><span class="line">                <span class="string">"UpperDir"</span>: <span class="string">"/var/lib/docker/overlay2/9f0bd8e84ddffd8663f01c959a0ced115a4d598b096896be15b3c680039d7754/diff"</span>,</span><br><span class="line">                <span class="string">"WorkDir"</span>: <span class="string">"/var/lib/docker/overlay2/9f0bd8e84ddffd8663f01c959a0ced115a4d598b096896be15b3c680039d7754/work"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"Name"</span>: <span class="string">"overlay2"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"Mounts"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Type"</span>: <span class="string">"volume"</span>,</span><br><span class="line">                <span class="string">"Name"</span>: <span class="string">"ca1683d1e9cc06657c7857d8b8c7196176a59e409d74fc72ff30f0a76f98d614"</span>,</span><br><span class="line">                <span class="string">"Source"</span>: <span class="string">"/var/lib/docker/volumes/ca1683d1e9cc06657c7857d8b8c7196176a59e409d74fc72ff30f0a76f98d614/_data"</span>,</span><br><span class="line">                <span class="string">"Destination"</span>: <span class="string">"/test"</span>,</span><br><span class="line">                <span class="string">"Driver"</span>: <span class="string">"local"</span>,</span><br><span class="line">                <span class="string">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"Propagation"</span>: <span class="string">""</span></span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>可以看到<code>Mounts</code>中的<code>/var/lib/docker/volumes/ca1683d1e9cc06657c7857d8b8c7196176a59e409d74fc72ff30f0a76f98d614/_data</code></p>
<p><code>UpperDir</code>中已经可以看到test目录了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/9f0bd8e84ddffd8663f01c959a0ced115a4d598b096896be15b3c680039d7754/diff/</span><br><span class="line"><span class="built_in">test</span></span><br></pre></td></tr></table></figure>
<p>现在，在docker中创建一个文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it 65f6facb7c3c touch /<span class="built_in">test</span>/test.txt</span><br><span class="line">$ ls /var/lib/docker/volumes/ca1683d1e9cc06657c7857d8b8c7196176a59e409d74fc72ff30f0a76f98d614/_data/</span><br><span class="line">test.txt</span><br></pre></td></tr></table></figure>
<h3 id="绑定挂载机制"><a class="markdownIt-Anchor" href="#绑定挂载机制"></a> 绑定挂载机制</h3>
<p>可以将一个目录绑定挂载到另外一个目录</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /<span class="built_in">test</span></span><br><span class="line"><span class="comment"># 没有挂载前，目录为空</span></span><br><span class="line"><span class="comment"># 挂载tmp目录</span></span><br><span class="line">$ mount --<span class="built_in">bind</span> /tmp /<span class="built_in">test</span></span><br><span class="line">$ ls /<span class="built_in">test</span></span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-resolved.service-A5ml7i   vmware-root_550-2991137472</span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-timesyncd.service-qu9LFm</span><br><span class="line"><span class="comment"># /test目录与/tmp目录内容一致</span></span><br><span class="line">$ ls /tmp</span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-resolved.service-A5ml7i   vmware-root_550-2991137472</span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-timesyncd.service-qu9LFm</span><br><span class="line"><span class="comment"># umount</span></span><br><span class="line">$ umount /<span class="built_in">test</span></span><br><span class="line">$ ls /<span class="built_in">test</span></span><br><span class="line"><span class="comment"># 目录为空</span></span><br></pre></td></tr></table></figure>
<p>但是，启动容器前host上的目录没有挂载内容，容器启动后，host上挂载目录，查看容器中的内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /<span class="built_in">test</span></span><br><span class="line"><span class="comment"># 无内容</span></span><br><span class="line">$ docker run -it -d --rm -v /<span class="built_in">test</span>:/<span class="built_in">test</span> ubuntu</span><br><span class="line">5f2aaad59abb7546ecd4b7a47ede09fb6a1541c4bda27b79de893bd27350b93c</span><br><span class="line">$ docker <span class="built_in">exec</span> -it 5f2 ls /<span class="built_in">test</span></span><br><span class="line"><span class="comment"># 无内容</span></span><br><span class="line">$ mount --<span class="built_in">bind</span> /tmp /<span class="built_in">test</span></span><br><span class="line">$ ls /<span class="built_in">test</span></span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-resolved.service-A5ml7i   vmware-root_550-2991137472</span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-timesyncd.service-qu9LFm</span><br><span class="line">$ docker <span class="built_in">exec</span> -it 5f2 ls /<span class="built_in">test</span></span><br><span class="line"><span class="comment"># 依旧没有内容</span></span><br><span class="line">$ docker <span class="built_in">exec</span> -it 5f2 touch /<span class="built_in">test</span>/test.txt</span><br><span class="line">$ ls /<span class="built_in">test</span></span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-resolved.service-A5ml7i   vmware-root_550-2991137472</span><br><span class="line">systemd-private-0ea54a48e403454ba91e8c8d816d2cbd-systemd-timesyncd.service-qu9LFm</span><br><span class="line"><span class="comment"># 咦，test.txt去哪儿了呢</span></span><br><span class="line">$ umount /<span class="built_in">test</span></span><br><span class="line">$ ls /<span class="built_in">test</span></span><br><span class="line">test.txt</span><br><span class="line"><span class="comment"># 这样就有了</span></span><br></pre></td></tr></table></figure>
<p>如果/test目录已经mount了呢？</p>
<h3 id="会不会将本地挂载的目录提交到image里面呢"><a class="markdownIt-Anchor" href="#会不会将本地挂载的目录提交到image里面呢"></a> 会不会将本地挂载的目录提交到image里面呢？</h3>
<blockquote>
<p><strong>不会</strong></p>
<p>容器的镜像操作，比如 docker commit，都是发生在宿主机空间的。而由于 Mount Namespace 的隔离作用，宿主机并不知道这个绑定挂载的存在。所以，在宿主机看来，容器中可读写层的 /test 目录（/var/lib/docker/aufs/mnt/[可读写层 ID]/test），始终是空的。</p>
</blockquote>
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<p>本节主要学习了DockerFile编写、镜像的build方法。以及docker exec和volume的底层实现原理。</p>
<p>通过所有前面几节的实验，不难发现，docker就是通过linux namespace进行隔离，cgroup对资源进行限制，rootfs作为容器的文件系统。无论是docker镜像还是docker容器，以及网络和volume，都是在linux的这些基础功能的基础上实现起来的。</p>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>k8s环境安装之差点儿我就放弃了</title>
    <url>/2019/07/19/k8s-env-prep/</url>
    <content><![CDATA[<p>尝试了好几种方式，想要准备一个k8s的实验集群，都或多或少的遇到了些问题。主要是因为要入门，所以要搭一套环境，但因为还没有入门，搭建过程中遇到问题，就不知如何下手。<br />
在行将放弃之际，<a href="https://github.com/easzlab/kubeasz" target="_blank" rel="noopener">kubeasz</a>挽救了我，本文主要记录如何用kubeasz搭建一个allinone的环境</p>
<a id="more"></a>
<h2 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h2>
<p>其实kubeasz的文档写的非常简单，因为本身搭建过程就是很简单，可参看<a href="https://github.com/easzlab/kubeasz/blob/master/docs/setup/quickStart.md" target="_blank" rel="noopener">官方文档</a></p>
<ol>
<li>一台Linux虚拟机(Ubuntu16.04 server或CentOS 7 Minimal)</li>
<li>内存需要2G</li>
<li>硬盘30G</li>
</ol>
<h2 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h2>
<h3 id="下载文件"><a class="markdownIt-Anchor" href="#下载文件"></a> 下载文件</h3>
<p>github的说明文档提供的下载方式，我其实都疑惑了，因为有一个<code>${release}</code>，并非开箱即食。可以这样做</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/easzlab/kubeasz.git</span><br></pre></td></tr></table></figure>
<p>随后，进入kubeasz目录，使用工具脚本下载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> kubeasz</span><br><span class="line">$ bash tools/easzup -D</span><br></pre></td></tr></table></figure>
<h3 id="安装-2"><a class="markdownIt-Anchor" href="#安装-2"></a> 安装</h3>
<p>下面就是按部就班的运行了，注意，你也不需要提前安装docker，所有的都是自动下载及安装的</p>
<ol>
<li>容器化运行 kubeasz</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ bash tools/easzup -S</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>使用默认配置安装 aio 集群</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it kubeasz easzctl start-aio</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如遇到失败，可再次尝试执行</p>
</blockquote>
<h3 id="验证安装"><a class="markdownIt-Anchor" href="#验证安装"></a> 验证安装</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl version                   <span class="comment"># 验证集群版本     </span></span><br><span class="line">$ kubectl get componentstatus       <span class="comment"># 验证 scheduler/controller-manager/etcd等组件状态</span></span><br><span class="line">$ kubectl get node                  <span class="comment"># 验证节点就绪 (Ready) 状态</span></span><br><span class="line">$ kubectl get pod --all-namespaces  <span class="comment"># 验证集群pod状态，默认已安装网络插件、coredns、metrics-server等</span></span><br><span class="line">$ kubectl get svc --all-namespaces  <span class="comment"># 验证集群服务状态</span></span><br></pre></td></tr></table></figure>
<h3 id="登陆dashboard"><a class="markdownIt-Anchor" href="#登陆dashboard"></a> 登陆dashboard</h3>
<p>安装完成后，dashboard已经准备好了，只需要获取登陆方式即可。</p>
<p>按照官方文档的说法，登陆dashboard有好几种方式，选择一种即可。如token方式</p>
<h4 id="获取port"><a class="markdownIt-Anchor" href="#获取port"></a> 获取port</h4>
<p>按照以上方式安装完成后，默认的port应该是34980，所以，可以访问<code>https://当前IP:34980</code>，即可登陆dashboard</p>
<p>也可以查看dashboard的端口开放状况</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">kubectl get svc --all-namespaces</span><br><span class="line">NAMESPACE     NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                       AGE</span><br><span class="line">default       kubernetes                ClusterIP   10.68.0.1       &lt;none&gt;        443/TCP                       30m</span><br><span class="line">kube-system   heapster                  ClusterIP   10.68.91.148    &lt;none&gt;        80/TCP                        114s</span><br><span class="line">kube-system   kube-dns                  ClusterIP   10.68.0.2       &lt;none&gt;        53/UDP,53/TCP,9153/TCP        2m20s</span><br><span class="line">kube-system   kubernetes-dashboard      NodePort    10.68.23.76     &lt;none&gt;        443:34980/TCP                 118s</span><br><span class="line">kube-system   metrics-server            ClusterIP   10.68.29.183    &lt;none&gt;        443/TCP                       2m13s</span><br><span class="line">kube-system   traefik-ingress-service   NodePort    10.68.226.239   &lt;none&gt;        80:23456/TCP,8080:38858/TCP   105s</span><br></pre></td></tr></table></figure>
<h4 id="获取token"><a class="markdownIt-Anchor" href="#获取token"></a> 获取token</h4>
<ul>
<li>查看如下文件是否存在</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /etc/ansible/manifests/dashboard/admin-user-sa-rbac.yaml</span><br></pre></td></tr></table></figure>
<ul>
<li>获取token</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f /etc/ansible/manifests/dashboard/admin-user-sa-rbac.yaml</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">====</span><br><span class="line">ca.crt:     1350 bytes</span><br><span class="line">namespace:  11 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IiJ9.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWRoNjYyIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJmZDdjZjc4Mi1hOTM0LTExZTktOTA1Zi0wMDBjMjlhMzc1YmYiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.KXFNuuibxRpF7AJHZBRkGgvpiVl4axfGA0A8haLIR3coX0HHPrQph8sO9GKl7C0KP6YXN-43VIxlpDXy-i_UkimxDJRVS08IW4r39Z4HhD-rKFYafQJROMrFG9lcbn1pZWTLBRGsO3lFCI1DyRDC7W_HSb63mgO2IoiQXGhgdhEWc7OnyNfxovkbtQA5xfsVqWqeWE-Dn4Jeo0lFe630I-iREMXPQvF5I7UNJFMJLCgFV0fG8J7__MYBf8xVnYL3ryaMBwKjQxQVsD3IOGS6TAk7RLZzjevySl-pXE1CcE8fosQQwJsOjOoKn5u1LGK3XUkIJR2rOf3jVMoQYYqe1Q</span><br></pre></td></tr></table></figure>
<h2 id="踩过的坑"><a class="markdownIt-Anchor" href="#踩过的坑"></a> 踩过的坑</h2>
<h3 id="node出于notready状态"><a class="markdownIt-Anchor" href="#node出于notready状态"></a> node出于NotReady状态</h3>
<ul>
<li>排查思路</li>
</ul>
<p>查看服务状态及相关错误信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ journalctl -f -u kubelet</span><br></pre></td></tr></table></figure>
<p>最终发现我的内存因为是1G导致运行失败</p>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
        <tag>k8s</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s学习笔记——深入理解容器镜像</title>
    <url>/2020/06/23/kubernetesLearning03/</url>
    <content><![CDATA[<blockquote>
<p>学习极客时间上的<a href="https://time.geekbang.org/column/intro/116" target="_blank" rel="noopener">《深入剖析Kubernetes》</a></p>
<p>秉持眼过千遍不如手过一遍的原则.</p>
<p>对应章节：<a href="https://time.geekbang.org/column/article/17921" target="_blank" rel="noopener">07 | 白话容器基础（三）：深入理解容器镜像</a></p>
</blockquote>
<a id="more"></a>
<h2 id="以系统调用方式创建namespace实验"><a class="markdownIt-Anchor" href="#以系统调用方式创建namespace实验"></a> 以系统调用方式创建namespace实验</h2>
<p><strong>ns.c</strong></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mount.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> STACK_SIZE (1024 * 1024)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> container_stack[STACK_SIZE];</span><br><span class="line"><span class="keyword">char</span>* <span class="keyword">const</span> container_args[] = &#123;</span><br><span class="line">  <span class="string">"/bin/bash"</span>,</span><br><span class="line">  <span class="literal">NULL</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Container - inside the container!\n"</span>);</span><br><span class="line">  execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Something's wrong!\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Parent - start a container!\n"</span>);</span><br><span class="line">  <span class="keyword">int</span> container_pid = clone(container_main, container_stack+STACK_SIZE, CLONE_NEWNS | SIGCHLD , <span class="literal">NULL</span>);</span><br><span class="line">  waitpid(container_pid, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Parent - container stopped!\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="build-ns并进入ns"><a class="markdownIt-Anchor" href="#build-ns并进入ns"></a> build ns并进入ns</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gcc -o ns ns.c</span><br><span class="line">$ ./ns</span><br><span class="line">Parent - start a container!</span><br><span class="line">Container - inside the container!</span><br><span class="line">$ ls /tmp</span><br><span class="line">systemd-private-8bac4934482d484d879054051ff48730-systemd-resolved.service-54yGbQ   vmware-root_563-4281712267</span><br><span class="line">systemd-private-8bac4934482d484d879054051ff48730-systemd-timesyncd.service-ti2Lns</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">Parent - container stopped!</span><br></pre></td></tr></table></figure>
<h3 id="查看进程在另外一个窗口中执行"><a class="markdownIt-Anchor" href="#查看进程在另外一个窗口中执行"></a> 查看进程(在另外一个窗口中执行)</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -aux</span><br><span class="line">...</span><br><span class="line">root     12217  0.0  0.0   5532   720 pts/3    S    06:41   0:00 ./ns</span><br><span class="line">root     12218  0.0  0.3  20312  3980 pts/3    S+   06:41   0:00 /bin/bash</span><br><span class="line">...</span><br><span class="line">$ pstree -g</span><br><span class="line">systemd(1)─┬─VGAuthService(562)</span><br><span class="line">           ├─sshd(1144)─┬─sshd(2307)───bash(2394)</span><br><span class="line">           │            ├─sshd(2448)───bash(2529)</span><br><span class="line">           │            ├─sshd(11698)───bash(11784)───pstree(12265)</span><br><span class="line">           │            └─sshd(11845)───bash(11927)───ns(12217)───bash(12218)</span><br><span class="line">           ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>由上面的操作可见，即使开启了namespace，容器进程看到的文件系统与宿主机一样</p>
</blockquote>
<h2 id="重新挂载目录实验"><a class="markdownIt-Anchor" href="#重新挂载目录实验"></a> 重新挂载目录实验</h2>
<h3 id="修改代码"><a class="markdownIt-Anchor" href="#修改代码"></a> 修改代码</h3>
<ul>
<li>修改<code>ns.c</code>的<code>container_main</code>函数，新创建文件<code>ns_new.c</code></li>
</ul>
<blockquote>
<p>注：因为是在虚拟机上实验，根目录类型默认是shared，所以，需要先重新挂载根目录</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">container_main</span><span class="params">(<span class="keyword">void</span>* arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Container - inside the container!\n"</span>);</span><br><span class="line">  <span class="comment">// 如果你的机器的根目录的挂载类型是shared，那必须先重新挂载根目录</span></span><br><span class="line">  mount(<span class="string">""</span>, <span class="string">"/"</span>, <span class="literal">NULL</span>, MS_PRIVATE, <span class="string">""</span>);</span><br><span class="line">  mount(<span class="string">"none"</span>, <span class="string">"/tmp"</span>, <span class="string">"tmpfs"</span>, <span class="number">0</span>, <span class="string">""</span>);</span><br><span class="line">  execv(container_args[<span class="number">0</span>], container_args);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Something's wrong!\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="编译及测试效果"><a class="markdownIt-Anchor" href="#编译及测试效果"></a> 编译及测试效果</h3>
<ul>
<li>在容器内</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ gcc -o ns_new ns_new.c</span><br><span class="line">$ ./ns_new</span><br><span class="line">Parent - start a container!</span><br><span class="line">Container - inside the container!</span><br><span class="line">$ ls /tmp</span><br><span class="line">$ mount -l | grep tmpfs</span><br><span class="line">udev on /dev <span class="built_in">type</span> devtmpfs (rw,nosuid,relatime,size=473204k,nr_inodes=118301,mode=755)</span><br><span class="line">tmpfs on /run <span class="built_in">type</span> tmpfs (rw,nosuid,noexec,relatime,size=100928k,mode=755)</span><br><span class="line">tmpfs on /dev/shm <span class="built_in">type</span> tmpfs (rw,nosuid,nodev)</span><br><span class="line">tmpfs on /run/lock <span class="built_in">type</span> tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)</span><br><span class="line">tmpfs on /sys/fs/cgroup <span class="built_in">type</span> tmpfs (ro,nosuid,nodev,noexec,mode=755)</span><br><span class="line">tmpfs on /run/user/0 <span class="built_in">type</span> tmpfs (rw,nosuid,nodev,relatime,size=100924k,mode=700)</span><br><span class="line">none on /tmp <span class="built_in">type</span> tmpfs (rw,relatime)</span><br><span class="line">$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line">Parent - container stopped!</span><br></pre></td></tr></table></figure>
<ul>
<li>在宿主机上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mount -l | grep tmpfs</span><br><span class="line">udev on /dev <span class="built_in">type</span> devtmpfs (rw,nosuid,relatime,size=473204k,nr_inodes=118301,mode=755)</span><br><span class="line">tmpfs on /run <span class="built_in">type</span> tmpfs (rw,nosuid,noexec,relatime,size=100928k,mode=755)</span><br><span class="line">tmpfs on /dev/shm <span class="built_in">type</span> tmpfs (rw,nosuid,nodev)</span><br><span class="line">tmpfs on /run/lock <span class="built_in">type</span> tmpfs (rw,nosuid,nodev,noexec,relatime,size=5120k)</span><br><span class="line">tmpfs on /sys/fs/cgroup <span class="built_in">type</span> tmpfs (ro,nosuid,nodev,noexec,mode=755)</span><br><span class="line">tmpfs on /run/user/0 <span class="built_in">type</span> tmpfs (rw,nosuid,nodev,relatime,size=100924k,mode=700)</span><br></pre></td></tr></table></figure>
<h2 id="chroot实验"><a class="markdownIt-Anchor" href="#chroot实验"></a> chroot实验</h2>
<h3 id="准备"><a class="markdownIt-Anchor" href="#准备"></a> 准备</h3>
<ul>
<li>创建一个test目录并准备未见</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir <span class="built_in">test</span></span><br><span class="line">$ mkdir -p <span class="built_in">test</span>/&#123;bin,lib64,lib&#125;</span><br><span class="line"><span class="comment"># 拷贝bash和ls命令</span></span><br><span class="line">$ cp -v /bin/&#123;bash,ls&#125; <span class="built_in">test</span>/bin/</span><br><span class="line"><span class="string">'/bin/bash'</span> -&gt; <span class="string">'test/bin/bash'</span></span><br><span class="line"><span class="string">'/bin/ls'</span> -&gt; <span class="string">'test/bin/ls'</span></span><br><span class="line"><span class="comment"># 拷贝lib</span></span><br><span class="line">$ list=<span class="string">"<span class="variable">$(ldd /bin/ls | egrep -o '/lib.*\.[0-9]')</span>"</span></span><br><span class="line">$ mkdir <span class="built_in">test</span>/lib/x86_64-linux-gnu</span><br><span class="line">$ <span class="keyword">for</span> i <span class="keyword">in</span> <span class="variable">$list</span>; <span class="keyword">do</span> cp -v <span class="string">"<span class="variable">$i</span>"</span> <span class="string">"test<span class="variable">$&#123;i&#125;</span>"</span>; <span class="keyword">done</span></span><br><span class="line"><span class="string">'/lib/x86_64-linux-gnu/libselinux.so.1'</span> -&gt; <span class="string">'test/lib/x86_64-linux-gnu/libselinux.so.1'</span></span><br><span class="line"><span class="string">'/lib/x86_64-linux-gnu/libc.so.6'</span> -&gt; <span class="string">'test/lib/x86_64-linux-gnu/libc.so.6'</span></span><br><span class="line"><span class="string">'/lib/x86_64-linux-gnu/libpcre.so.3'</span> -&gt; <span class="string">'test/lib/x86_64-linux-gnu/libpcre.so.3'</span></span><br><span class="line"><span class="string">'/lib/x86_64-linux-gnu/libdl.so.2'</span> -&gt; <span class="string">'test/lib/x86_64-linux-gnu/libdl.so.2'</span></span><br><span class="line"><span class="string">'/lib64/ld-linux-x86-64.so.2'</span> -&gt; <span class="string">'test/lib64/ld-linux-x86-64.so.2'</span></span><br><span class="line"><span class="string">'/lib/x86_64-linux-gnu/libpthread.so.0'</span> -&gt; <span class="string">'test/lib/x86_64-linux-gnu/libpthread.so.0'</span></span><br><span class="line">$ cp /lib/x86_64-linux-gnu/libtinfo.so.5 <span class="built_in">test</span>/lib/x86_64-linux-gnu/</span><br></pre></td></tr></table></figure>
<h3 id="chroot"><a class="markdownIt-Anchor" href="#chroot"></a> chroot</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chroot <span class="built_in">test</span> /bin/bash</span><br><span class="line">bash-4.4<span class="comment"># ls</span></span><br><span class="line">bin  lib  lib64</span><br></pre></td></tr></table></figure>
<ul>
<li>以busybox的镜像为例，同样可以chroot</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ chroot busybox /bin/sh</span><br><span class="line">/ <span class="comment"># ls</span></span><br><span class="line">bin   dev   etc   home  root  tmp   usr   var</span><br></pre></td></tr></table></figure>
<h2 id="unionfs实验"><a class="markdownIt-Anchor" href="#unionfs实验"></a> UnionFS实验</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir A</span><br><span class="line">$ mkdir B</span><br><span class="line">$ mkdi^C</span><br><span class="line">$ touch A/t1.txt</span><br><span class="line">$ touch A/t2.txt</span><br><span class="line">$ touch B/t2.txt</span><br><span class="line">$ touch B/t3.txt</span><br><span class="line">$ mkdir C</span><br><span class="line">$ mount -t aufs -o <span class="built_in">dirs</span>=./A:./B none ./C</span><br><span class="line">$ ls C</span><br><span class="line">t1.txt  t2.txt  t3.txt</span><br><span class="line">$ mount -l | grep aufs</span><br><span class="line">none on /root/bqi/C <span class="built_in">type</span> aufs (rw,relatime,si=f9e234d74656f278)</span><br></pre></td></tr></table></figure>
<p>此时，可以尝试修改<code>A/t1.txt</code>, <code>A/t2.txt</code>, <code>B/t2.txt</code>, <code>B/t3.txt</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> <span class="string">'This is a test'</span> &gt; A/t1.txt</span><br><span class="line">$ cat C/t1.txt</span><br><span class="line">This is a <span class="built_in">test</span></span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'This is a test2'</span> &gt; A/t2.txt</span><br><span class="line">$ cat C/t2.txt</span><br><span class="line">This is a test2</span><br><span class="line">$ cat B/t2.txt</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">'This is test2 for B'</span> &gt; B/t2.txt</span><br><span class="line">$ cat C/t2.txt</span><br><span class="line">This is a test2</span><br></pre></td></tr></table></figure>
<h2 id="docker-image解析"><a class="markdownIt-Anchor" href="#docker-image解析"></a> docker image解析</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect ubuntu</span><br><span class="line">...</span><br><span class="line">        <span class="string">"GraphDriver"</span>: &#123;</span><br><span class="line">            <span class="string">"Data"</span>: &#123;</span><br><span class="line">                <span class="string">"LowerDir"</span>: <span class="string">"/var/lib/docker/overlay2/823e415d4256d05fb0101af4dcc42a4389d44cf6467972d654e93e0cc575cd9b/diff:/var/lib/docker/overlay2/37d3e588905fae55c8a0481e9cda7be36177af874631abb15724c893887e260b/diff:/var/lib/docker/overlay2/40d198d6f624e455800254766eb6a7190ce02442fc48f02f6f16f72105cefd0d/diff"</span>,</span><br><span class="line">                <span class="string">"MergedDir"</span>: <span class="string">"/var/lib/docker/overlay2/17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/merged"</span>,</span><br><span class="line">                <span class="string">"UpperDir"</span>: <span class="string">"/var/lib/docker/overlay2/17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff"</span>,</span><br><span class="line">                <span class="string">"WorkDir"</span>: <span class="string">"/var/lib/docker/overlay2/17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/work"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"Name"</span>: <span class="string">"overlay2"</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"RootFS"</span>: &#123;</span><br><span class="line">            <span class="string">"Type"</span>: <span class="string">"layers"</span>,</span><br><span class="line">            <span class="string">"Layers"</span>: [</span><br><span class="line">                <span class="string">"sha256:7789f1a3d4e9258fbe5469a8d657deb6aba168d86967063e9b80ac3e1154333f"</span>,</span><br><span class="line">                <span class="string">"sha256:9e53fd4895597d04f8871a68caea4c686011e1fbd0be32e57e89ada2ea5c24c4"</span>,</span><br><span class="line">                <span class="string">"sha256:2a19bd70fcd4ce7fd73b37b1b2c710f8065817a9db821ff839fe0b4b4560e643"</span>,</span><br><span class="line">                <span class="string">"sha256:8891751e0a1733c5c214d17ad2b0040deccbdea0acebb963679735964d516ac2"</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>你会看到，Ubuntu镜像，在我的环境里面是4层</p>
<h3 id="overlay挂载方式"><a class="markdownIt-Anchor" href="#overlay挂载方式"></a> overlay挂载方式</h3>
<h4 id="先启动一个container"><a class="markdownIt-Anchor" href="#先启动一个container"></a> 先启动一个container</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it -d ubuntu</span><br><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</span><br><span class="line">a274e38c218a        ubuntu              <span class="string">"/bin/bash"</span>         17 minutes ago      Up 17 minutes                           musing_knuth</span><br><span class="line">$ docker inspect a274e38c218a</span><br><span class="line">...</span><br><span class="line">        <span class="string">"GraphDriver"</span>: &#123;</span><br><span class="line">            <span class="string">"Data"</span>: &#123;</span><br><span class="line">                <span class="string">"LowerDir"</span>: <span class="string">"/var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2-init/diff:/var/lib/docker/overlay2/17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff:/var/lib/docker/overlay2/823e415d4256d05fb0101af4dcc42a4389d44cf6467972d654e93e0cc575cd9b/diff:/var/lib/docker/overlay2/37d3e588905fae55c8a0481e9cda7be36177af874631abb15724c893887e260b/diff:/var/lib/docker/overlay2/40d198d6f624e455800254766eb6a7190ce02442fc48f02f6f16f72105cefd0d/diff"</span>,</span><br><span class="line">                <span class="string">"MergedDir"</span>: <span class="string">"/var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2/merged"</span>,</span><br><span class="line">                <span class="string">"UpperDir"</span>: <span class="string">"/var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2/diff"</span>,</span><br><span class="line">                <span class="string">"WorkDir"</span>: <span class="string">"/var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2/work"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="string">"Name"</span>: <span class="string">"overlay2"</span></span><br><span class="line">        &#125;,</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h4 id="查看系统挂载表"><a class="markdownIt-Anchor" href="#查看系统挂载表"></a> 查看系统挂载表</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /proc/mounts | grep overlay</span><br><span class="line">overlay /var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2/merged overlay rw,relatime,lowerdir=/var/lib/docker/overlay2/l/7ZDIR6KYXXF6RMDW3JCBEQUGMH:/var/lib/docker/overlay2/l/TH3OYMS4POUF3S22QNB7UJPORG:/var/lib/docker/overlay2/l/BJILDL5W6H6U7LGVSUUS2QUTGO:/var/lib/docker/overlay2/l/6F6BVIETKMGL5QLJIOCP6CONB3:/var/lib/docker/overlay2/l/P5BANYVEKZJYYPT4M6IFNLAR7Z,upperdir=/var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2/diff,workdir=/var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2/work 0 0</span><br></pre></td></tr></table></figure>
<p>可以看到，lowerdir由5个目录共同挂载而成，分别是</p>
<ol>
<li><code>7ZDIR6KYXXF6RMDW3JCBEQUGMH</code></li>
<li><code>TH3OYMS4POUF3S22QNB7UJPORG</code></li>
<li><code>BJILDL5W6H6U7LGVSUUS2QUTGO</code></li>
<li><code>6F6BVIETKMGL5QLJIOCP6CONB3</code></li>
<li><code>P5BANYVEKZJYYPT4M6IFNLAR7Z</code></li>
</ol>
<h4 id="查看overlay2目录下的文件"><a class="markdownIt-Anchor" href="#查看overlay2目录下的文件"></a> 查看overlay2目录下的文件</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/l/ -l</span><br><span class="line">total 56</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 14 07:09 2L7W765NSNAZAJUW324PTRY6AF -&gt; ../6bd794b03d6772755f61a55ff28f0f20caf1541192c57030b1c0d92e4d3134fa/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 13 07:09 2VHUX6G37XVXLON33KHDZBOVBH -&gt; ../2787c91d4cd57511162a5b17a1ad9cca5204e57b541127223dd11b8c084710bb/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jun 11 05:51 6F6BVIETKMGL5QLJIOCP6CONB3 -&gt; ../37d3e588905fae55c8a0481e9cda7be36177af874631abb15724c893887e260b/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 13 07:24 6P3MYX3ANRVWUUGIBBTJYPGRLP -&gt; ../6d18d5f8aed3820e7500e1f70b3c5d896b90c109977a1097e957667a6b0f48f3/diff</span><br><span class="line">lrwxrwxrwx 1 root root 77 Jun 11 07:53 7ZDIR6KYXXF6RMDW3JCBEQUGMH -&gt; ../0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2-init/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jun 11 05:51 BJILDL5W6H6U7LGVSUUS2QUTGO -&gt; ../823e415d4256d05fb0101af4dcc42a4389d44cf6467972d654e93e0cc575cd9b/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 13 07:24 D26SOVMOFLZLRVVBCVXJVRYAE2 -&gt; ../a74c293f4eb20bef383865bbba97f84a51fd0d894ced280dc1cfe6021be3ae77/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jun 11 07:53 EY46SF3NEYTFL4QOXUZT5YHMA3 -&gt; ../0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 13 07:30 IXP5XYXVUASXI2FOX5UKMYW2JN -&gt; ../c58e315ff14dda2b6ec7f75a3a0a8099dfe269604a0acecf6ecf026c6b56de63/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 14 07:18 N7NRQKX4E62F2JKRQ5JCI3BSSH -&gt; ../d6fed7e45abcf9e0055b9de876a81a5347cdcf364736b0f50053630f8f189e30/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 13 06:16 NJCD6YK72MQFTUSJUMGOEJL4WM -&gt; ../bf1fb537d794b4460c81ae39fc45c3230c22b47e4509a35c282ca15727fe81ac/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jun 11 05:51 P5BANYVEKZJYYPT4M6IFNLAR7Z -&gt; ../40d198d6f624e455800254766eb6a7190ce02442fc48f02f6f16f72105cefd0d/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Jun 11 05:51 TH3OYMS4POUF3S22QNB7UJPORG -&gt; ../17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 May 13 07:24 YQB24YJNNQSDHU2IDBA2L4LCX4 -&gt; ../c3bee923bb1d5cd56503c976bc8353a6a579698186536f6023524b84373a6834/diff</span><br></pre></td></tr></table></figure>
<h4 id="做个对比"><a class="markdownIt-Anchor" href="#做个对比"></a> 做个对比</h4>
<ol>
<li>
<p>容器ID为a274e38，对应的DIR的ID是0c3ff90</p>
</li>
<li>
<p><code>lowerdir=/var/lib/docker/overlay2/l/7ZDIR6KYXXF6RMDW3JCBEQUGMH</code>， 实际上指向了<code>0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2-init/diff</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/0c3ff90aba26b4197b2293789f75d4e3db7a9213601b8d222b1f0c413c7115b2-init/diff/</span><br><span class="line">dev  etc</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>/var/lib/docker/overlay2/l/TH3OYMS4POUF3S22QNB7UJPORG</code> 实际上指向了<code>17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff/</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>而<code>17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff</code>实际上是ubuntu镜像的<code>UpperDir</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/17bd5da0cda20e8ecd1d4955d25f49609ff0d7aa72fe45a0388a357fcc5b625f/diff/</span><br><span class="line">run</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>/var/lib/docker/overlay2/l/BJILDL5W6H6U7LGVSUUS2QUTGO</code>实际上是<code>823e415d4256d05fb0101af4dcc42a4389d44cf6467972d654e93e0cc575cd9b/diff</code></p>
</li>
<li>
<p>而<code>823e415d4256d05fb0101af4dcc42a4389d44cf6467972d654e93e0cc575cd9b/diff</code>实际上是ubuntu镜像的<code>LowerDir</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/823e415d4256d05fb0101af4dcc42a4389d44cf6467972d654e93e0cc575cd9b/diff/</span><br><span class="line">etc  usr  var</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>/var/lib/docker/overlay2/l/6F6BVIETKMGL5QLJIOCP6CONB3</code>实际上是<code>37d3e588905fae55c8a0481e9cda7be36177af874631abb15724c893887e260b/diff</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/37d3e588905fae55c8a0481e9cda7be36177af874631abb15724c893887e260b/diff/</span><br><span class="line">var</span><br></pre></td></tr></table></figure>
</li>
<li>
<p><code>/var/lib/docker/overlay2/l/P5BANYVEKZJYYPT4M6IFNLAR7Z</code>实际上是<code>40d198d6f624e455800254766eb6a7190ce02442fc48f02f6f16f72105cefd0d/diff</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/docker/overlay2/40d198d6f624e455800254766eb6a7190ce02442fc48f02f6f16f72105cefd0d/diff/</span><br><span class="line">bin  boot  dev  etc  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<ol>
<li>容器的镜像即rootfs是按照一层一层的组合起来的。</li>
<li>启动容器进程时，将多个增量的rootfs联合挂载成一个完整的rootfs</li>
<li>启动容器时，会只读模式挂载一个init层，以及一个可写的层</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s学习笔记——为什么需要Pod</title>
    <url>/2020/07/06/kubernetesLearning05/</url>
    <content><![CDATA[<blockquote>
<p>学习极客时间上的<a href="https://time.geekbang.org/column/intro/116" target="_blank" rel="noopener">《深入剖析Kubernetes》</a></p>
<p>秉持眼过千遍不如手过一遍的原则.</p>
<p>对应章节：<a href="https://time.geekbang.org/column/article/40092" target="_blank" rel="noopener">13 | 为什么我们需要Pod？</a></p>
</blockquote>
<a id="more"></a>
<h2 id="共享net的container"><a class="markdownIt-Anchor" href="#共享net的container"></a> 共享net的container</h2>
<h3 id="先来起两个共享net和volume的容器"><a class="markdownIt-Anchor" href="#先来起两个共享net和volume的容器"></a> 先来起两个共享net和volume的容器</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it -d --name test1 busybox</span><br><span class="line">15dafb04a3fae857c0db7ce09c02d6ebc565de71a49df2511eded48457e0945e</span><br><span class="line">$ docker run -it -d --network container:test1 --volumes-from test1 --name test2 busybox</span><br><span class="line">6e15995e63a4f2cc0b293be848a448c2e34a1502477645c434e529245ffaa1f3</span><br></pre></td></tr></table></figure>
<h3 id="查看两个container的信息"><a class="markdownIt-Anchor" href="#查看两个container的信息"></a> 查看两个container的信息</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect test1</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"15dafb04a3fae857c0db7ce09c02d6ebc565de71a49df2511eded48457e0945e"</span>,</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">"Pid"</span>: 2282,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">            <span class="string">"Networks"</span>: &#123;</span><br><span class="line">                <span class="string">"bridge"</span>: &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="string">"NetworkID"</span>: <span class="string">"5bdb44786ae497e27f9626360b59ff35eead5c02f6f6da4392306132e8910ad0"</span>,</span><br><span class="line">                    <span class="string">"EndpointID"</span>: <span class="string">"8a9d1594a9949509e42eee8af6145d30e1162cc4c8384c0f7d7e8d7bece5cfdd"</span>,</span><br><span class="line">                    <span class="string">"Gateway"</span>: <span class="string">"172.17.0.1"</span>,</span><br><span class="line">                    <span class="string">"IPAddress"</span>: <span class="string">"172.17.0.2"</span>,</span><br><span class="line">                &#125;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">$ docker inspect test2</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"6e15995e63a4f2cc0b293be848a448c2e34a1502477645c434e529245ffaa1f3"</span>,</span><br><span class="line">        ...</span><br><span class="line">            <span class="string">"Pid"</span>: 3555,</span><br><span class="line">        ...</span><br><span class="line">            <span class="string">"NetworkMode"</span>: <span class="string">"container:15dafb04a3fae857c0db7ce09c02d6ebc565de71a49df2511eded48457e0945e"</span>,</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<h3 id="查看进程"><a class="markdownIt-Anchor" href="#查看进程"></a> 查看进程</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls -l /proc/2282/ns/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:45 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:31 ipc -&gt; <span class="string">'ipc:[4026532571]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:31 mnt -&gt; <span class="string">'mnt:[4026532569]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:16 net -&gt; <span class="string">'net:[4026532574]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:31 pid -&gt; <span class="string">'pid:[4026532572]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:45 pid_for_children -&gt; <span class="string">'pid:[4026532572]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:45 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:31 uts -&gt; <span class="string">'uts:[4026532570]'</span></span><br><span class="line">$ ls -l /proc/3555/ns/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:45 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:42 ipc -&gt; <span class="string">'ipc:[4026532630]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:42 mnt -&gt; <span class="string">'mnt:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:42 net -&gt; <span class="string">'net:[4026532574]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:42 pid -&gt; <span class="string">'pid:[4026532631]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:45 pid_for_children -&gt; <span class="string">'pid:[4026532631]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:45 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 12 06:42 uts -&gt; <span class="string">'uts:[4026532629]'</span></span><br></pre></td></tr></table></figure>
<p>可以看到，cgroup、net和user是相同的</p>
<blockquote>
<p>实际上，在不指定共享net的container的时候，cgroup和user也都是相同的</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker run -it -d ubuntu</span><br><span class="line">25b637a2facf0ba713403c14f300644ee21cd107b45fb57d47f7cb4be0fcc3ad</span><br><span class="line">$ docker inspect 25b637a2f | grep Pid</span><br><span class="line">      <span class="string">"Pid"</span>: 10895,</span><br><span class="line">      <span class="string">"PidMode"</span>: <span class="string">""</span>,</span><br><span class="line">         <span class="string">"PidsLimit"</span>: null,</span><br><span class="line">$ ls /proc/10895/ns/ -l</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 ipc -&gt; <span class="string">'ipc:[4026532706]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 mnt -&gt; <span class="string">'mnt:[4026532704]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 net -&gt; <span class="string">'net:[4026532709]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 pid -&gt; <span class="string">'pid:[4026532707]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 pid_for_children -&gt; <span class="string">'pid:[4026532707]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 03:10 uts -&gt; <span class="string">'uts:[4026532705]'</span></span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="查看网络"><a class="markdownIt-Anchor" href="#查看网络"></a> 查看网络</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it test1 ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02</span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:19 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:1522 (1.4 KiB)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">$ docker <span class="built_in">exec</span> -it test2 ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:42:AC:11:00:02</span><br><span class="line">          inet addr:172.17.0.2  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:19 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:1522 (1.4 KiB)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p>两个container的eth0的IP，MAC等都相同</p>
<h2 id="pod"><a class="markdownIt-Anchor" href="#pod"></a> Pod</h2>
<h3 id="先起一个pod看看"><a class="markdownIt-Anchor" href="#先起一个pod看看"></a> 先起一个pod看看</h3>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">two-containers</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-test-container1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-test-container2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：因为已经pull了image，所以这里设置了<code>imagePullPolicy: Never</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME             READY   STATUS    RESTARTS   AGE</span><br><span class="line">two-containers   2/2     Running   0          3s</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                               COMMAND                  CREATED              STATUS              PORTS               NAMES</span><br><span class="line">14aea3a7ec58        1c35c4412082                                        <span class="string">"sh"</span>                     About a minute ago   Up About a minute                       k8s_my-test-container2_two-containers_default_dd628b40-a070-4d9d-9837-7d3031092e86_0</span><br><span class="line">fb9a5a4e5ee2        1c35c4412082                                        <span class="string">"sh"</span>                     About a minute ago   Up About a minute                       k8s_my-test-container1_two-containers_default_dd628b40-a070-4d9d-9837-7d3031092e86_0</span><br><span class="line">bac4514284b2        registry.aliyuncs.com/google_containers/pause:3.2   <span class="string">"/pause"</span>                 About a minute ago   Up About a minute                       k8s_POD_two-containers_default_dd628b40-a070-4d9d-9837-7d3031092e86_0</span><br></pre></td></tr></table></figure>
<p>可以看到，分别起了3个container：</p>
<ul>
<li>k8s_my-test-container1_two-containers_default</li>
<li>k8s_my-test-container2_two-containers_default</li>
<li>k8s_POD_two-containers_default</li>
</ul>
<p>其中，<code>k8s_POD_two-containers_default</code>的image是<code>pause</code></p>
<h3 id="先看看namespace"><a class="markdownIt-Anchor" href="#先看看namespace"></a> 先看看namespace</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect 14aea3a7ec58 | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 359647,</span><br><span class="line">$ docker inspect fb9a5a4e5ee2 | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 359614,</span><br><span class="line">$ docker inspect bac4514284b2 | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 359530,</span><br><span class="line">$ ls -l /proc/359647/ns</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 ipc -&gt; <span class="string">'ipc:[4026532625]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 mnt -&gt; <span class="string">'mnt:[4026532715]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 net -&gt; <span class="string">'net:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 pid -&gt; <span class="string">'pid:[4026532717]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 pid_for_children -&gt; <span class="string">'pid:[4026532717]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 uts -&gt; <span class="string">'uts:[4026532716]'</span></span><br><span class="line">$ ls -l /proc/359614/ns</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 ipc -&gt; <span class="string">'ipc:[4026532625]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 mnt -&gt; <span class="string">'mnt:[4026532710]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 net -&gt; <span class="string">'net:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 pid -&gt; <span class="string">'pid:[4026532714]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 pid_for_children -&gt; <span class="string">'pid:[4026532714]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 uts -&gt; <span class="string">'uts:[4026532713]'</span></span><br><span class="line">$ ls -l /proc/359530/ns</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:38 ipc -&gt; <span class="string">'ipc:[4026532625]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 mnt -&gt; <span class="string">'mnt:[4026532623]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:38 net -&gt; <span class="string">'net:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 pid -&gt; <span class="string">'pid:[4026532626]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 pid_for_children -&gt; <span class="string">'pid:[4026532626]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 15 14:41 uts -&gt; <span class="string">'uts:[4026532624]'</span></span><br></pre></td></tr></table></figure>
<h3 id="看看ip"><a class="markdownIt-Anchor" href="#看看ip"></a> 看看IP</h3>
<ul>
<li>Pod层面</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod two-containers</span><br><span class="line">Name:         two-containers</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         node2/10.160.18.181</span><br><span class="line">Start Time:   Mon, 15 Jun 2020 14:38:10 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  Status:  Running</span><br><span class="line">IP:           172.172.1.35</span><br><span class="line">IPs:</span><br><span class="line">  IP:  172.172.1.35</span><br><span class="line">Containers:</span><br><span class="line">  my-test-container1:</span><br><span class="line">    Container ID:   docker://fb9a5a4e5ee2eef15dddc159bdb507b435ebbbc189d3ceefbaca7d7d4dac994d</span><br><span class="line">    Image:          busybox</span><br><span class="line">    ...</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nlz8h (ro)</span><br><span class="line">  my-test-container2:</span><br><span class="line">    Container ID:   docker://14aea3a7ec58e4f4220d6eea1266799a55fbdd945956d4845d4e062fce6542d7</span><br><span class="line">    Image:          busybox</span><br><span class="line">    ...</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nlz8h (ro)</span><br><span class="line">...</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nlz8h:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nlz8h</span><br><span class="line">    Optional:    <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Container层面</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it 14aea3a7ec58 ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 26:64:FF:FA:7D:BE</span><br><span class="line">          inet addr:172.172.1.35  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1450  Metric:1</span><br><span class="line">          RX packets:15 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:1198 (1.1 KiB)  TX bytes:42 (42.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">$ docker <span class="built_in">exec</span> -it fb9a5a4e5ee2 ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 26:64:FF:FA:7D:BE</span><br><span class="line">          inet addr:172.172.1.35  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1450  Metric:1</span><br><span class="line">          RX packets:15 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:1198 (1.1 KiB)  TX bytes:42 (42.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<h2 id="pod共享volume"><a class="markdownIt-Anchor" href="#pod共享volume"></a> Pod共享volume</h2>
<h3 id="pod配置"><a class="markdownIt-Anchor" href="#pod配置"></a> Pod配置</h3>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">two-containers-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">c2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shared-data</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br></pre></td></tr></table></figure>
<h3 id="查看pod信息"><a class="markdownIt-Anchor" href="#查看pod信息"></a> 查看pod信息</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pods</span><br><span class="line">NAME                    READY   STATUS    RESTARTS   AGE</span><br><span class="line">two-containers-volume   2/2     Running   0          5s</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod two-containers-volume</span><br><span class="line">Name:         two-containers-volume</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         node2/10.160.18.181</span><br><span class="line">Start Time:   Mon, 15 Jun 2020 14:53:43 +0800</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  Status:  Running</span><br><span class="line">IP:           172.172.1.36</span><br><span class="line">IPs:</span><br><span class="line">  IP:  172.172.1.36</span><br><span class="line">Containers:</span><br><span class="line">  c1:</span><br><span class="line">    Container ID:   docker://b5b285305aae0d9155fca8415a1002697b0a446d222ce8f8bb27456c51680bc0</span><br><span class="line">    Image:          busybox</span><br><span class="line">    ...</span><br><span class="line">    Mounts:</span><br><span class="line">      /data from shared-data (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nlz8h (ro)</span><br><span class="line">  c2:</span><br><span class="line">    Container ID:   docker://52767f5bfa9e246e79547b11bfca0eb5948f3458850beaf173fbd921e43aa949</span><br><span class="line">    Image:          busybox</span><br><span class="line">    ...</span><br><span class="line">    Mounts:</span><br><span class="line">      /data from shared-data (rw)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nlz8h (ro)</span><br><span class="line">...</span><br><span class="line">Volumes:</span><br><span class="line">  shared-data:</span><br><span class="line">    Type:          HostPath (bare host directory volume)</span><br><span class="line">    Path:          /data</span><br><span class="line">    HostPathType:</span><br><span class="line">  default-token-nlz8h:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nlz8h</span><br><span class="line">    Optional:    <span class="literal">false</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>对比之前的，可以看到，volumes中增加了一个<code>shared-data</code>的volume，每个container的<code>Mounts</code>中多了一个<code>/data from shared-data (rw)</code></p>
</blockquote>
<h3 id="查看container层面的信息"><a class="markdownIt-Anchor" href="#查看container层面的信息"></a> 查看container层面的信息</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">52767f5bfa9e        1c35c4412082                                        <span class="string">"sh"</span>                     6 minutes ago       Up 6 minutes                            k8s_c2_two-containers-volume_default_a66c7066-35c2-4be6-b58a-0df6ede9d95d_0</span><br><span class="line">b5b285305aae        1c35c4412082                                        <span class="string">"sh"</span>                     6 minutes ago       Up 6 minutes                            k8s_c1_two-containers-volume_default_a66c7066-35c2-4be6-b58a-0df6ede9d95d_0</span><br><span class="line">09b081c04b1b        registry.aliyuncs.com/google_containers/pause:3.2   <span class="string">"/pause"</span>                 6 minutes ago       Up 6 minutes                            k8s_POD_two-containers-volume_default_a66c7066-35c2-4be6-b58a-0df6ede9d95d_0</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect 52767f5bfa9e</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"/k8s_c2_two-containers-volume_default_a66c7066-35c2-4be6-b58a-0df6ede9d95d_0"</span>,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"HostConfig"</span>: &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">"NetworkMode"</span>: <span class="string">"container:09b081c04b1ba2b973d7fb31aadd7d796d8f6aef03113764f4a868022b6332ee"</span>,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Mounts"</span>: [</span><br><span class="line">            ...</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">                <span class="string">"Source"</span>: <span class="string">"/data"</span>,</span><br><span class="line">                <span class="string">"Destination"</span>: <span class="string">"/data"</span>,</span><br><span class="line">                <span class="string">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            ...</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">$ docker inspect b5b285305aae</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"/k8s_c1_two-containers-volume_default_a66c7066-35c2-4be6-b58a-0df6ede9d95d_0"</span>,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"HostConfig"</span>: &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">"NetworkMode"</span>: <span class="string">"container:09b081c04b1ba2b973d7fb31aadd7d796d8f6aef03113764f4a868022b6332ee"</span>,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Mounts"</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">"Type"</span>: <span class="string">"bind"</span>,</span><br><span class="line">                <span class="string">"Source"</span>: <span class="string">"/data"</span>,</span><br><span class="line">                <span class="string">"Destination"</span>: <span class="string">"/data"</span>,</span><br><span class="line">                <span class="string">"Mode"</span>: <span class="string">""</span>,</span><br><span class="line">                <span class="string">"RW"</span>: <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"Propagation"</span>: <span class="string">"rprivate"</span></span><br><span class="line">            &#125;,</span><br><span class="line">            ...</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br><span class="line">$ docker inspect 09b081c04b1b</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Name"</span>: <span class="string">"/k8s_POD_two-containers-volume_default_a66c7066-35c2-4be6-b58a-0df6ede9d95d_0"</span>,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"HostConfig"</span>: &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">"NetworkMode"</span>: <span class="string">"none"</span>,</span><br><span class="line">            ...</span><br><span class="line">        &#125;,</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"Mounts"</span>: [],</span><br><span class="line">        ...</span><br><span class="line">        <span class="string">"NetworkSettings"</span>: &#123;</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">"SandboxKey"</span>: <span class="string">"/var/run/docker/netns/cb1ed85e8f94"</span>,</span><br><span class="line">            ...</span><br><span class="line">            <span class="string">"Networks"</span>: &#123;</span><br><span class="line">                <span class="string">"none"</span>: &#123;</span><br><span class="line">                    ...</span><br><span class="line">                    <span class="string">"NetworkID"</span>: <span class="string">"d5b75ce86af4c81134a382c1b77ed2de74e8ec9d484a68a5002f52ed3905b239"</span>,</span><br><span class="line">                    <span class="string">"EndpointID"</span>: <span class="string">"f6ea091a8d1445dae3a4b961c6cfbfa05c671f604dab8c9284eca959d02e7867"</span>,</span><br><span class="line">                    ...</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<blockquote>
<p>说明：</p>
<ul>
<li><code>k8s_POD_two-containers-volume_default</code>这个container的<code>NetworkSettings</code>字段声明有网络相关内容，但Mounts为空</li>
<li><code>k8s_c1</code>和<code>k8s_c2</code>的container的<code>NetworkSettings</code>为空，但Mounts中则挂载了<code>/data</code>目录</li>
</ul>
</blockquote>
<h2 id="init-container"><a class="markdownIt-Anchor" href="#init-container"></a> Init container</h2>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">init-container-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-volume</span></span><br><span class="line">    <span class="attr">emptyDir:</span> <span class="string">&#123;&#125;</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">data-container</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">["touch",</span> <span class="string">"/data/test.txt"</span><span class="string">]</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/data"</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">app-volume</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">app-container</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">"/data"</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">app-volume</span></span><br></pre></td></tr></table></figure>
<h3 id="查看pod状况"><a class="markdownIt-Anchor" href="#查看pod状况"></a> 查看pod状况</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME                  READY   STATUS    RESTARTS   AGE</span><br><span class="line">init-container-test   1/1     Running   0          5s</span><br></pre></td></tr></table></figure>
<h3 id="查看container"><a class="markdownIt-Anchor" href="#查看container"></a> 查看container</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">ce67fd98bc68        1c35c4412082                                        <span class="string">"sh"</span>                     30 seconds ago      Up 29 seconds                           k8s_app-container_init-container-test_default_5960cae6-00b3-48ae-9991-741d73077dc4_0</span><br><span class="line">e75657cb2079        registry.aliyuncs.com/google_containers/pause:3.2   <span class="string">"/pause"</span>                 31 seconds ago      Up 30 seconds                           k8s_POD_init-container-test_default_5960cae6-00b3-48ae-9991-741d73077dc4_0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>会发现这里只有一个<code>k8s_app-container</code>和<code>k8s_POD</code>，而没有<code>init-container</code></p>
<p>是因为</p>
<blockquote>
<p>在 Pod 中，所有 Init Container 定义的容器，都会比 spec.containers 定义的用户容器先启动。并且，Init Container 容器会按顺序逐一启动，而直到它们都启动并且退出了，用户容器才会启动。</p>
</blockquote>
<p>但k8s并没有在这个container结束运行后重启它</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps -a</span><br><span class="line">CONTAINER ID        IMAGE                                                COMMAND                  CREATED             STATUS                      PORTS               NAMES</span><br><span class="line">ce67fd98bc68        1c35c4412082                                         <span class="string">"sh"</span>                     36 seconds ago      Up 36 seconds                                   k8s_app-container_init-container-test_default_5960cae6-00b3-48ae-9991-741d73077dc4_0</span><br><span class="line">bbc45d10357c        1c35c4412082                                         <span class="string">"touch /data/test.txt"</span>   37 seconds ago      Exited (0) 37 seconds ago                       k8s_data-container_init-container-test_default_5960cae6-00b3-48ae-9991-741d73077dc4_0</span><br><span class="line">e75657cb2079        registry.aliyuncs.com/google_containers/pause:3.2    <span class="string">"/pause"</span>                 37 seconds ago      Up 37 seconds                                   k8s_POD_init-container-test_default_5960cae6-00b3-48ae-9991-741d73077dc4_0</span><br></pre></td></tr></table></figure>
<blockquote>
<p>从这里可以看到， <code>data-container</code>已经<code>Exited (0) 37 seconds ago</code></p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> init-container-test -- ls /data</span><br><span class="line">test.txt</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过容器可以看到test.txt已经存在在<code>init-container-test</code>的<code>/data</code>目录下了</p>
</blockquote>
<h2 id="总结引用"><a class="markdownIt-Anchor" href="#总结引用"></a> 总结引用</h2>
<ul>
<li>一个运行在虚拟机里的应用，哪怕再简单，也是被管理在 systemd 或者 supervisord 之下的一组进程，而不是一个进程。</li>
<li>对于容器来说，一个容器永远只能管理一个进程</li>
<li>Pod，实际上是在扮演传统基础设施里“虚拟机”的角色；而容器，则是这个虚拟机里运行的用户程序。</li>
</ul>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s学习笔记——Pod的基本概念</title>
    <url>/2020/07/08/kubernetesLearning14/</url>
    <content><![CDATA[<blockquote>
<p>学习极客时间上的<a href="https://time.geekbang.org/column/intro/116" target="_blank" rel="noopener">《深入剖析Kubernetes》</a></p>
<p>秉持眼过千遍不如手过一遍的原则。动手实践并记录结果</p>
<p>对应章节：<a href="https://time.geekbang.org/column/article/40366" target="_blank" rel="noopener">14 | 深入解析Pod对象（一）：基本概念</a></p>
</blockquote>
<a id="more"></a>
<h2 id="hostaliases测试"><a class="markdownIt-Anchor" href="#hostaliases测试"></a> <code>hostAliases</code>测试</h2>
<ul>
<li>Pod配置</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-first-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostAliases:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">ip:</span> <span class="number">10.9</span><span class="number">.8</span><span class="number">.7</span></span><br><span class="line">    <span class="attr">hostnames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"host.test.site"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">"host.aliases.test.site"</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-test-container1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">my-test-container2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<ul>
<li>查看容器内的hosts信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> my-first-test -c my-test-container1 -- cat /etc/hosts</span><br><span class="line"><span class="comment"># Kubernetes-managed hosts file.</span></span><br><span class="line">127.0.0.1   localhost</span><br><span class="line">::1 localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">fe00::0 ip6-mcastprefix</span><br><span class="line">fe00::1 ip6-allnodes</span><br><span class="line">fe00::2 ip6-allrouters</span><br><span class="line">172.172.1.41    my-first-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># Entries added by HostAliases.</span></span><br><span class="line">10.9.8.7    host.test.site  host.aliases.test.site</span><br><span class="line">$ kubectl <span class="built_in">exec</span> my-first-test -c my-test-container2 -- cat /etc/hosts</span><br><span class="line"><span class="comment"># Kubernetes-managed hosts file.</span></span><br><span class="line">127.0.0.1   localhost</span><br><span class="line">::1 localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">fe00::0 ip6-mcastprefix</span><br><span class="line">fe00::1 ip6-allnodes</span><br><span class="line">fe00::2 ip6-allrouters</span><br><span class="line">172.172.1.41    my-first-test</span><br><span class="line"></span><br><span class="line"><span class="comment"># Entries added by HostAliases.</span></span><br><span class="line">10.9.8.7    host.test.site  host.aliases.test.site</span><br></pre></td></tr></table></figure>
<h2 id="shareprocessnamespace"><a class="markdownIt-Anchor" href="#shareprocessnamespace"></a> <code>shareProcessNamespace</code></h2>
<h3 id="不配置shareprocessnamespace"><a class="markdownIt-Anchor" href="#不配置shareprocessnamespace"></a> 不配置<code>shareProcessNamespace</code></h3>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="literal">no</span><span class="string">-share-process-ns-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过shell的container查看进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> no-share-process-ns-test -c shell -- ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 sh</span><br><span class="line">    6 root      0:00 ps</span><br><span class="line"><span class="comment"># shell的容器仅能看到自己容器内的进程</span></span><br></pre></td></tr></table></figure>
<ul>
<li>container层面信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                               COMMAND                  CREATED              STATUS              PORTS               NAMES</span><br><span class="line">117497ca101c        2622e6cca7eb                                        <span class="string">"/docker-entrypoint.…"</span>   About a minute ago   Up About a minute                       k8s_web_no-share-process-ns-test_default_94884606-ea15-4038-9fa0-0e3b11ca4f31_0</span><br><span class="line">ca8b6e6a1796        1c35c4412082                                        <span class="string">"sh"</span>                     About a minute ago   Up About a minute                       k8s_shell_no-share-process-ns-test_default_94884606-ea15-4038-9fa0-0e3b11ca4f31_0</span><br><span class="line">eb0fd0f91677        registry.aliyuncs.com/google_containers/pause:3.2   <span class="string">"/pause"</span>                 About a minute ago   Up About a minute                       k8s_POD_no-share-process-ns-test_default_94884606-ea15-4038-9fa0-0e3b11ca4f31_0</span><br><span class="line">$ docker inspect ca8b6e6a1796 | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 1561218,</span><br><span class="line">$ docker inspect 117497ca101c | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 1561252,</span><br><span class="line">$ ls -l /proc/1561218/ns/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:41 ipc -&gt; <span class="string">'ipc:[4026532625]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:41 mnt -&gt; <span class="string">'mnt:[4026532718]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:41 net -&gt; <span class="string">'net:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:41 pid -&gt; <span class="string">'pid:[4026532723]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 pid_for_children -&gt; <span class="string">'pid:[4026532723]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:41 uts -&gt; <span class="string">'uts:[4026532721]'</span></span><br><span class="line">$ ls -l /proc/1561252/ns/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 ipc -&gt; <span class="string">'ipc:[4026532625]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 mnt -&gt; <span class="string">'mnt:[4026532724]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 net -&gt; <span class="string">'net:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 pid -&gt; <span class="string">'pid:[4026532726]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 pid_for_children -&gt; <span class="string">'pid:[4026532726]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:43 uts -&gt; <span class="string">'uts:[4026532725]'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>两个container的<code>pid</code>和<code>pid_for_children</code>不同</p>
</blockquote>
<h3 id="开启shareprocessnamespace"><a class="markdownIt-Anchor" href="#开启shareprocessnamespace"></a> 开启shareProcessNamespace</h3>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">share-process-ns-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">shareProcessNamespace:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>
<ul>
<li>通过shell的container查看进程</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> share-process-ns-test -c shell -- ps</span><br><span class="line">PID   USER     TIME  COMMAND</span><br><span class="line">    1 root      0:00 /pause</span><br><span class="line">    6 root      0:00 sh</span><br><span class="line">   12 root      0:00 nginx: master process nginx -g daemon off;</span><br><span class="line">   39 101       0:00 nginx: worker process</span><br><span class="line">   40 root      0:00 ps</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到，名为shell的container中也能看到nginx的进程</p>
</blockquote>
<ul>
<li>container层面</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker ps</span><br><span class="line">CONTAINER ID        IMAGE                                               COMMAND                  CREATED             STATUS              PORTS               NAMES</span><br><span class="line">955d3e3b9cba        2622e6cca7eb                                        <span class="string">"/docker-entrypoint.…"</span>   2 minutes ago       Up 2 minutes                            k8s_web_share-process-ns-test_default_d1b8348e-5399-4d30-9d53-de91ffdb9746_0</span><br><span class="line">d065b6907db0        1c35c4412082                                        <span class="string">"sh"</span>                     2 minutes ago       Up 2 minutes                            k8s_shell_share-process-ns-test_default_d1b8348e-5399-4d30-9d53-de91ffdb9746_0</span><br><span class="line">79a59e6e245c        registry.aliyuncs.com/google_containers/pause:3.2   <span class="string">"/pause"</span>                 2 minutes ago       Up 2 minutes                            k8s_POD_share-process-ns-test_default_d1b8348e-5399-4d30-9d53-de91ffdb9746_0</span><br><span class="line">$ docker inspect 955d3e3b9cba | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 1564637,</span><br><span class="line">$ docker inspect d065b6907db0 | grep \"Pid\"</span><br><span class="line">            <span class="string">"Pid"</span>: 1564603,</span><br><span class="line">$ ls -l /proc/1564637/ns/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 ipc -&gt; <span class="string">'ipc:[4026532625]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 mnt -&gt; <span class="string">'mnt:[4026532724]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 net -&gt; <span class="string">'net:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 pid -&gt; <span class="string">'pid:[4026532626]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 pid_for_children -&gt; <span class="string">'pid:[4026532626]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 uts -&gt; <span class="string">'uts:[4026532725]'</span></span><br><span class="line">$ ls -l /proc/1564603/ns/</span><br><span class="line">total 0</span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 cgroup -&gt; <span class="string">'cgroup:[4026531835]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:48 ipc -&gt; <span class="string">'ipc:[4026532625]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:48 mnt -&gt; <span class="string">'mnt:[4026532721]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:48 net -&gt; <span class="string">'net:[4026532628]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:48 pid -&gt; <span class="string">'pid:[4026532626]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 pid_for_children -&gt; <span class="string">'pid:[4026532626]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:51 user -&gt; <span class="string">'user:[4026531837]'</span></span><br><span class="line">lrwxrwxrwx 1 root root 0 Jun 17 14:48 uts -&gt; <span class="string">'uts:[4026532723]'</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>shell的container和web的container的<code>pid</code>和<code>pid_for_children</code>都是<code>pid:[4026532626]</code>的namespace</p>
</blockquote>
<h2 id="hostnetwork练习"><a class="markdownIt-Anchor" href="#hostnetwork练习"></a> <code>hostNetwork</code>练习</h2>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">host-net-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">shell</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:latest</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> host-net-test -c shell -- ifconfig</span><br><span class="line">cni0      Link encap:Ethernet  HWaddr 16:80:F0:F9:A0:B4</span><br><span class="line">          inet addr:172.172.1.1  Bcast:0.0.0.0  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::1480:f0ff:fef9:a0b4/64 Scope:Link</span><br><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:31 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:600 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:868 (868.0 B)  TX bytes:43824 (42.7 KiB)</span><br><span class="line"></span><br><span class="line">docker0   Link encap:Ethernet  HWaddr 02:42:BB:9B:62:76</span><br><span class="line">          inet addr:172.17.0.1  Bcast:172.17.255.255  Mask:255.255.0.0</span><br><span class="line">          inet6 addr: fe80::42:bbff:fe9b:6276/64 Scope:Link</span><br><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:19 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:1666 (1.6 KiB)</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>container中看到的网卡信息与host相同</p>
</blockquote>
<h2 id="lifecycle练习"><a class="markdownIt-Anchor" href="#lifecycle练习"></a> <code>lifecycle</code>练习</h2>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">lifecycle-demo</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">lifecycle-demo-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">lifecycle:</span></span><br><span class="line">      <span class="attr">postStart:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">["/bin/sh",</span> <span class="string">"-c"</span><span class="string">,</span> <span class="string">"echo Hello from the postStart handler &gt; /usr/share/message"</span><span class="string">]</span></span><br><span class="line">      <span class="attr">preStop:</span></span><br><span class="line">        <span class="attr">exec:</span></span><br><span class="line">          <span class="attr">command:</span> <span class="string">["/usr/sbin/nginx","-s","quit"]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> lifecycle-demo -- cat /usr/share/message</span><br><span class="line">Hello from the postStart handler</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到container启动后就打印了</p>
</blockquote>
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<p>这章节主要是理解哪些操作是属于pod层面，而哪些操作是属于容器层面。比如hostAliases和shareProcessNamespace，都是属于整个pod层面，而imagePullPolicy和lifecycle则属于container层面。</p>
<p>再次引用原文中的总结：</p>
<blockquote>
<p>**凡是 Pod 中的容器要共享宿主机的 Namespace，也一定是 Pod 级别的定义</p>
</blockquote>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>K8s学习笔记——Pod使用进阶</title>
    <url>/2020/07/09/kubernetesLearning15/</url>
    <content><![CDATA[<blockquote>
<p>学习极客时间上的<a href="https://time.geekbang.org/column/intro/116" target="_blank" rel="noopener">《深入剖析Kubernetes》</a></p>
<p>秉持眼过千遍不如手过一遍的原则。动手实践并记录结果</p>
<p>对应章节：<a href="https://time.geekbang.org/column/article/40466" target="_blank" rel="noopener">15 | 深入解析Pod对象（二）：使用进阶</a></p>
</blockquote>
<a id="more"></a>
<h2 id="project-volume"><a class="markdownIt-Anchor" href="#project-volume"></a> Project Volume</h2>
<p>Project Volume（投射数据卷）是为Pod提供事先定义好的一些数据，包括4种：</p>
<ol>
<li>Secret</li>
<li>ConfigMap</li>
<li>Downward API</li>
<li>ServiceAccountToken</li>
</ol>
<h3 id="secret"><a class="markdownIt-Anchor" href="#secret"></a> Secret</h3>
<ol>
<li>以文件形式创建secret</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 先创建两个文件，username.txt和password.txt</span></span><br><span class="line">$ cat username.txt</span><br><span class="line">secuser</span><br><span class="line">$ cat password.txt</span><br><span class="line">secPassword</span><br><span class="line">$ kubectl create secret generic user --from-file=./username.txt</span><br><span class="line">secret/user created</span><br><span class="line">$ kubectl create secret generic pass --from-file=./password.txt</span><br><span class="line">secret/pass created</span><br><span class="line">$ kubectl get secret</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-nlz8h   kubernetes.io/service-account-token   3      36d</span><br><span class="line">pass                  Opaque                                1      6s</span><br><span class="line">user                  Opaque                                1      38s</span><br><span class="line"><span class="comment"># 可以看到default-token-nlz8h，实际上是k8s的默认token</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pv-secret</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-secret</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sec-test</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">"/pv"</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sec-test</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">user</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">pass</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod <span class="built_in">test</span>-pv-secret</span><br><span class="line">Name:         <span class="built_in">test</span>-pv-secret</span><br><span class="line">...</span><br><span class="line">Volumes:</span><br><span class="line">  sec-test:</span><br><span class="line">    Type:                Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    SecretName:          user</span><br><span class="line">    SecretOptionalName:  &lt;nil&gt;</span><br><span class="line">    SecretName:          pass</span><br><span class="line">    SecretOptionalName:  &lt;nil&gt;</span><br><span class="line">  default-token-nlz8h:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nlz8h</span><br><span class="line">    Optional:    <span class="literal">false</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可以看到，pod的Volumes中有两个：</p>
<ul>
<li>sec-test，即为yaml文件中的volume</li>
<li>default-token-nlz8h，k8s默认的token</li>
</ul>
<ol start="3">
<li>容器层面</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker inspect a77ad18a7a2a</span><br><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"Id"</span>: <span class="string">"a77ad18a7a2aad64fba15bf1dcef8b3f2fa803aa3da3cab5def23b40a0aa5b21"</span>,</span><br><span class="line">        ...</span><br><span class="line">        HostConfig<span class="string">": &#123;</span></span><br><span class="line"><span class="string">            "</span>Binds<span class="string">": [</span></span><br><span class="line"><span class="string">                "</span>/var/lib/kubelet/pods/cba17e39-f12d-416b-a9d1-6390b590d754/volumes/kubernetes.io~projected/sec-test:/pv:ro<span class="string">",</span></span><br><span class="line"><span class="string">                "</span>/var/lib/kubelet/pods/cba17e39-f12d-416b-a9d1-6390b590d754/volumes/kubernetes.io~secret/default-token-nlz8h:/var/run/secrets/kubernetes.io/serviceaccount:ro<span class="string">",</span></span><br><span class="line"><span class="string">                ...</span></span><br><span class="line"><span class="string">        "</span>Mounts<span class="string">": [</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">                "</span>Type<span class="string">": "</span><span class="built_in">bind</span><span class="string">",</span></span><br><span class="line"><span class="string">                "</span>Source<span class="string">": "</span>/var/lib/kubelet/pods/cba17e39-f12d-416b-a9d1-6390b590d754/volumes/kubernetes.io~projected/sec-test<span class="string">",</span></span><br><span class="line"><span class="string">                "</span>Destination<span class="string">": "</span>/pv<span class="string">",</span></span><br><span class="line"><span class="string">                "</span>Mode<span class="string">": "</span>ro<span class="string">",</span></span><br><span class="line"><span class="string">                "</span>RW<span class="string">": false,</span></span><br><span class="line"><span class="string">                "</span>Propagation<span class="string">": "</span>rprivate<span class="string">"</span></span><br><span class="line"><span class="string">            &#125;,</span></span><br><span class="line"><span class="string">            ...</span></span><br></pre></td></tr></table></figure>
<p>从上面的信息可以看出，<code>/var/lib/kubelet/pods/cba17e39-f12d-416b-a9d1-6390b590d754/volumes/kubernetes.io~projected/sec-test</code>目录以只读方式挂载到了容器上</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls /var/lib/kubelet/pods/cba17e39-f12d-416b-a9d1-6390b590d754/volumes/kubernetes.io~projected/sec-test/</span><br><span class="line">password.txt  username.txt</span><br><span class="line">$ cat /var/lib/kubelet/pods/cba17e39-f12d-416b-a9d1-6390b590d754/volumes/kubernetes.io~projected/sec-test/username.txt</span><br><span class="line">secuser</span><br><span class="line">$ cat /var/lib/kubelet/pods/cba17e39-f12d-416b-a9d1-6390b590d754/volumes/kubernetes.io~projected/sec-test/password.txt</span><br><span class="line">secPassword</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>查看结果</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> <span class="built_in">test</span>-pv-secret -- ls /pv</span><br><span class="line">password.txt</span><br><span class="line">username.txt</span><br><span class="line">$ kubectl <span class="built_in">exec</span> <span class="built_in">test</span>-pv-secret -- cat /pv/username.txt</span><br><span class="line">secuser</span><br><span class="line">$ kubectl <span class="built_in">exec</span> <span class="built_in">test</span>-pv-secret -- cat /pv/password.txt</span><br><span class="line">secPassword</span><br></pre></td></tr></table></figure>
<h3 id="secret对象"><a class="markdownIt-Anchor" href="#secret对象"></a> secret对象</h3>
<ol>
<li>创建secret对象</li>
</ol>
<blockquote>
<p>Secret 对象要求这些数据必须是经过 Base64 转码的，以免出现明文密码的安全隐患</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">echo</span> -n <span class="string">'secuser'</span> | base64</span><br><span class="line">c2VjdXNlcg==</span><br><span class="line">$ <span class="built_in">echo</span> -n <span class="string">'secPassword'</span> | base64</span><br><span class="line">c2VjUGFzc3dvcmQ=</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sec-obj-test</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">c2VjdXNlcg==</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">c2VjUGFzc3dvcmQ=</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f secret-obj.yaml</span><br><span class="line">secret/sec-obj-test created</span><br><span class="line">$ kubectl get secret</span><br><span class="line">NAME                  TYPE                                  DATA   AGE</span><br><span class="line">default-token-nlz8h   kubernetes.io/service-account-token   3      36d</span><br><span class="line">sec-obj-test          Opaque                                2      45s</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>创建pod</li>
</ol>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">sec-obj-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-secobj</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">secobj-test</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">"/pv"</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sec-test</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">secret:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">sec-obj-test</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod sec-obj-test</span><br><span class="line">Name:         sec-obj-test</span><br><span class="line">...</span><br><span class="line">    Mounts:</span><br><span class="line">      /pv from secobj-test (ro)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nlz8h (ro)</span><br><span class="line">...</span><br><span class="line">Volumes:</span><br><span class="line">  secobj-test:</span><br><span class="line">    Type:                Projected (a volume that contains injected data from multiple sources)</span><br><span class="line">    SecretName:          sec-obj-test</span><br><span class="line">    SecretOptionalName:  &lt;nil&gt;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>检查容器上的内容</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> sec-obj-test -- ls /pv</span><br><span class="line">password</span><br><span class="line">username</span><br><span class="line">$ kubectl <span class="built_in">exec</span> sec-obj-test -- cat /pv/username</span><br><span class="line">secuser</span><br><span class="line"><span class="comment"># 注：这里没有换行</span></span><br><span class="line">$ kubectl <span class="built_in">exec</span> sec-obj-test -- cat /pv/password</span><br><span class="line">secPassword</span><br><span class="line"><span class="comment"># 注：这里没有换行</span></span><br></pre></td></tr></table></figure>
<h3 id="configmap"><a class="markdownIt-Anchor" href="#configmap"></a> ConfigMap</h3>
<h4 id="创建configmap"><a class="markdownIt-Anchor" href="#创建configmap"></a> 创建configMap</h4>
<p>以如下配置文件为例</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">APP_NAME = <span class="string">"demo"</span></span><br><span class="line">APP_PORT = <span class="number">80</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl create configmap flask-config --from-file=config.py</span><br><span class="line">$ kubectl describe configmaps</span><br><span class="line">Name:         flask-config</span><br><span class="line">Namespace:    default</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  &lt;none&gt;</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">config.py:</span><br><span class="line">----</span><br><span class="line">APP_NAME = <span class="string">"demo"</span></span><br><span class="line">APP_PORT = 80</span><br><span class="line"></span><br><span class="line">Events:  &lt;none&gt;</span><br></pre></td></tr></table></figure>
<h4 id="创建pod"><a class="markdownIt-Anchor" href="#创建pod"></a> 创建pod</h4>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">configmap-test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">configmap-test-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flask-config</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">"/flask_config"</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">flask-config</span></span><br><span class="line">    <span class="attr">projected:</span></span><br><span class="line">      <span class="attr">sources:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMap:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">flask-config</span></span><br></pre></td></tr></table></figure>
<h4 id="查看容器内的结果"><a class="markdownIt-Anchor" href="#查看容器内的结果"></a> 查看容器内的结果</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> configmap-test -- ls /flask_config</span><br><span class="line">config.py</span><br><span class="line">$ kubectl <span class="built_in">exec</span> configmap-test -- cat /flask_config/config.py</span><br><span class="line">APP_NAME = <span class="string">"demo"</span></span><br><span class="line">APP_PORT = 80</span><br></pre></td></tr></table></figure>
<h3 id="downwardapi"><a class="markdownIt-Anchor" href="#downwardapi"></a> DownwardAPI</h3>
<h4 id="创建pod-2"><a class="markdownIt-Anchor" href="#创建pod-2"></a> 创建pod</h4>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">downward-api-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">arch:</span> <span class="string">amd64</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">downward-api-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">stdin:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">tty:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-label</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/pod_label</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">pod-label</span></span><br><span class="line">    <span class="attr">downwardAPI:</span></span><br><span class="line">      <span class="attr">items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">"labels"</span></span><br><span class="line">          <span class="attr">fieldRef:</span></span><br><span class="line">            <span class="attr">fieldPath:</span> <span class="string">metadata.labels</span></span><br></pre></td></tr></table></figure>
<p>说明：在volumes中声明了downwardAPI，将metadata.labels挂载到容器中的<code>/pod_label</code>里</p>
<blockquote>
<p>注：我当前的k8s环境中，downwardAPI可以不用定义在projected之下，当然也可以定义在之下</p>
</blockquote>
<h4 id="查看结果"><a class="markdownIt-Anchor" href="#查看结果"></a> 查看结果</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> downward-api-test -- ls /pod_label</span><br><span class="line">labels</span><br><span class="line">$ kubectl <span class="built_in">exec</span> downward-api-test -- cat /pod_label/labels</span><br><span class="line">arch=<span class="string">"amd64"</span></span><br></pre></td></tr></table></figure>
<h4 id="尝试一个其他filed"><a class="markdownIt-Anchor" href="#尝试一个其他filed"></a> 尝试一个其他filed</h4>
<p>如将<code>metadata.labels</code>换成<code>metadata.namespace</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> downward-api-test -- cat /pod_label/labels</span><br><span class="line">default</span><br></pre></td></tr></table></figure>
<h3 id="serviceaccounttoken"><a class="markdownIt-Anchor" href="#serviceaccounttoken"></a> ServiceAccountToken</h3>
<p>其实之前查看pod信息的时候已经看到了相关内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod xxxxxx</span><br><span class="line">...</span><br><span class="line">    Mounts:</span><br><span class="line">      /pod_label from pod-label (ro)</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from default-token-nlz8h (ro)</span><br><span class="line">...</span><br><span class="line">Volumes:</span><br><span class="line">  default-token-nlz8h:</span><br><span class="line">    Type:        Secret (a volume populated by a Secret)</span><br><span class="line">    SecretName:  default-token-nlz8h</span><br><span class="line">    Optional:    <span class="literal">false</span></span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl <span class="built_in">exec</span> downward-api-test -- ls /var/run/secrets/kubernetes.io/serviceaccount</span><br><span class="line">ca.crt</span><br><span class="line">namespace</span><br><span class="line">token</span><br><span class="line">$ kubectl <span class="built_in">exec</span> downward-api-test -- cat /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6IlhTSnlXMUhXTlNnUmd4MlVMTzdtbm14YVdiSzNUdjk4UnVoZ3RRbUFXZGsifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJkZWZhdWx0Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZWNyZXQubmFtZSI6ImRlZmF1bHQtdG9rZW4tbmx6OGgiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC5uYW1lIjoiZGVmYXVsdCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VydmljZS1hY2NvdW50LnVpZCI6IjU1MDAxNDE1LWU5N2MtNDVmNS04ZTNlLThkMzZhNGE5ZmYxMSIsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDpkZWZhdWx0OmRlZmF1bHQifQ.wPr9cO6ySUGV65jjA4WxheIk5mpDkim9jYNSN9hmDOOitOkKrC1qj5fg5eF_GnETUZbS7xaf7sitJgIWmNZfA9YJDMn_nY7a6TLGMMRlhRx3ZXhYg6XFheFCQkCwHLJt2FGNlBtf6WpRGBFVZK_bNbjrcxkBAE-tzz7wYFuA4L1zK3UQfZoie11F8NeEWVOliuMXlVT31GZeMG5MCsuSYk_c-S2c2eTT4ru1k74uH7W1nUi9P5O2CzQPjKHTIRcP3HSBuA1CQYxuBk8Av0eE6vQB41tYMIlpIavzljpd-_jWngPkZAUnQbislaXWZhzzKkGkGqsxsFGb0P57sX4Dyg</span><br></pre></td></tr></table></figure>
<h3 id="查看帮助"><a class="markdownIt-Anchor" href="#查看帮助"></a> 查看帮助</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl explain pod.spec.volumes.projected.sources</span><br><span class="line">KIND:     Pod</span><br><span class="line">VERSION:  v1</span><br><span class="line"></span><br><span class="line">RESOURCE: sources &lt;[]Object&gt;</span><br><span class="line"></span><br><span class="line">DESCRIPTION:</span><br><span class="line">     list of volume projections</span><br><span class="line"></span><br><span class="line">     Projection that may be projected along with other supported volume types</span><br><span class="line"></span><br><span class="line">FIELDS:</span><br><span class="line">   configMap    &lt;Object&gt;</span><br><span class="line">     information about the configMap data to project</span><br><span class="line"></span><br><span class="line">   downwardAPI  &lt;Object&gt;</span><br><span class="line">     information about the downwardAPI data to project</span><br><span class="line"></span><br><span class="line">   secret   &lt;Object&gt;</span><br><span class="line">     information about the secret data to project</span><br><span class="line"></span><br><span class="line">   serviceAccountToken  &lt;Object&gt;</span><br><span class="line">     information about the serviceAccountToken data to project</span><br></pre></td></tr></table></figure>
<h2 id="容器健康检查及恢复"><a class="markdownIt-Anchor" href="#容器健康检查及恢复"></a> 容器健康检查及恢复</h2>
<h3 id="创建pod-3"><a class="markdownIt-Anchor" href="#创建pod-3"></a> 创建pod</h3>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">liveness-test</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">liveness</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">liveness</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/bin/sh</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">-c</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">touch</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">30</span><span class="string">;</span> <span class="string">rm</span> <span class="string">/tmp/healthy;</span> <span class="string">sleep</span> <span class="number">600</span></span><br><span class="line">    <span class="attr">livenessProbe:</span></span><br><span class="line">      <span class="attr">exec:</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/tmp/healthy</span></span><br><span class="line">      <span class="attr">initialDelaySeconds:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-test   1/1     Running   0          21s</span><br></pre></td></tr></table></figure>
<p>可以看到，在21s的时候，pod的运行状态正常，RESTARTS字段为0</p>
<blockquote>
<p>给他一会儿时间</p>
</blockquote>
<h3 id="查看pod详情"><a class="markdownIt-Anchor" href="#查看pod详情"></a> 查看pod详情</h3>
 <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ubectl describe pod liveness-test</span><br><span class="line">Name:         liveness-test</span><br><span class="line">Namespace:    default</span><br><span class="line">Priority:     0</span><br><span class="line">Node:         node2/10.160.18.181</span><br><span class="line">...</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason     Age                From               Message</span><br><span class="line">  ----     ------     ----               ----               -------</span><br><span class="line">  Normal   Scheduled  75s                default-scheduler  Successfully assigned default/liveness-test to node2</span><br><span class="line">  Normal   Pulled     74s                kubelet, node2     Container image <span class="string">"busybox"</span> already present on machine</span><br><span class="line">  Normal   Created    74s                kubelet, node2     Created container liveness</span><br><span class="line">  Normal   Started    74s                kubelet, node2     Started container liveness</span><br><span class="line">  Warning  Unhealthy  32s (x3 over 42s)  kubelet, node2     Liveness probe failed: cat: can<span class="string">'t open '</span>/tmp/healthy<span class="string">': No such file or directory</span></span><br><span class="line"><span class="string">  Normal   Killing    32s                kubelet, node2     Container liveness failed liveness probe, will be restarted</span></span><br><span class="line"><span class="string">  Warning  Unhealthy  30s (x3 over 40s)  kubelet, node2     Liveness probe failed: cat: can'</span>t open <span class="string">'/tmp/healthy'</span>: No such file or directory</span><br><span class="line">  Normal   Killing    30s                kubelet, node2     Container liveness failed liveness probe, will be restarted</span><br><span class="line">  Normal   Started    2s (x2 over 74s)   kubelet, node2     Started container liveness</span><br><span class="line">  Normal   Pulled     2s (x2 over 74s)   kubelet, node2     Container image <span class="string">"busybox"</span> already present on machine</span><br><span class="line">  Normal   Created    2s (x2 over 74s)   kubelet, node2     Created container liveness</span><br></pre></td></tr></table></figure>
<p>当pod运行了一会儿后，<code>/tmp/healthy</code>被删除，随后，<code>Container liveness failed liveness probe, will be restarted</code></p>
<h3 id="查看pod重启状况"><a class="markdownIt-Anchor" href="#查看pod重启状况"></a> 查看pod重启状况</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod</span><br><span class="line">NAME            READY   STATUS    RESTARTS   AGE</span><br><span class="line">liveness-test   1/1     Running   5          6m19s</span><br></pre></td></tr></table></figure>
<blockquote>
<p>podPresets是一个需要开启的选项，在我当前环境中没有开启，暂不学习</p>
</blockquote>
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<p>Pod使用进阶主要涉及了：</p>
<ol>
<li>Project Volume的4种类型</li>
<li>健康状况检查和恢复</li>
</ol>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux虚拟网络学习笔记</title>
    <url>/2019/08/07/linux-virtual-network-basic/</url>
    <content><![CDATA[<p>Linux虚拟网络是近几年虚拟化及容器等技术的基础，掌握了这些基础，可以更深入的理解openstack、docker的网络功能，以及测试过程中的问题定位。</p>
<p>本文通过实验的方式学习这些虚拟网络功能，包括tap设备，veth pair， bridge及router</p>
<a id="more"></a>
<h2 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h2>
<blockquote>
<p>注：本实验基于Ubuntu16.04</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt install uml-utilities</span><br><span class="line">$ apt install bridge-utils</span><br></pre></td></tr></table></figure>
<h2 id="tap设备"><a class="markdownIt-Anchor" href="#tap设备"></a> tap设备</h2>
<blockquote>
<p>Linux的tun/tap驱动实现了虚拟网卡的功能，tun表示虚拟的是点对点设备，tap表示虚拟的是以太网设备</p>
<p>tap位于网络OSI模型的二层（数据链路层），tun位于网络的三层。</p>
</blockquote>
<p><strong>1. 创建tap</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tunctl -t tap_test</span><br><span class="line">$ ifconfig tap_test 192.168.100.1/24</span><br></pre></td></tr></table></figure>
<p><strong>2. 创建namespace</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns add ns_test</span><br></pre></td></tr></table></figure>
<p><strong>3. 迁移网口到namespace</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link <span class="built_in">set</span> tap_test netns ns_test</span><br></pre></td></tr></table></figure>
<blockquote>
<p>迁移后，对应的ip会没有</p>
</blockquote>
<p><strong>4. 进入namespace并查看接口信息</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns_test /bin/bash</span><br><span class="line">$ ifconfig tap_test 192.168.50.1/24</span><br><span class="line">$ ifconfig</span><br><span class="line">tap_test  Link encap:Ethernet  HWaddr 76:71:70:f2:ac:f6</span><br><span class="line">          inet addr:192.168.50.1  Bcast:192.168.50.255  Mask:255.255.255.0</span><br><span class="line">          UP BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<h2 id="veth-pair"><a class="markdownIt-Anchor" href="#veth-pair"></a> veth pair</h2>
<blockquote>
<p>Veth pair是一对虚拟网卡，从一个veth网卡发出的数据包可以直接到达它的peer veth。相当于两个接口之间接着一根网线</p>
</blockquote>
<p><strong>1. 创建两个ns</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns add ns1</span><br><span class="line">$ ip netns add ns2</span><br></pre></td></tr></table></figure>
<p><strong>2. 创建veth pair</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link add tap1 <span class="built_in">type</span> veth peer name tap2</span><br></pre></td></tr></table></figure>
<p><strong>3. 迁移网口到namespace</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link <span class="built_in">set</span> tap1 netns ns1</span><br><span class="line">$ ip link <span class="built_in">set</span> tap2 netns ns2</span><br></pre></td></tr></table></figure>
<p><strong>4. 分别绑定IP地址</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ifconfig tap1 192.168.40.1/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ifconfig tap2 192.168.40.2/24</span><br></pre></td></tr></table></figure>
<p><strong>5. 测试连通性</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ping 192.168.40.2</span><br><span class="line">PING 192.168.40.2 (192.168.40.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.40.2: icmp_seq=1 ttl=64 time=0.096 ms</span><br><span class="line">64 bytes from 192.168.40.2: icmp_seq=2 ttl=64 time=0.049 ms</span><br></pre></td></tr></table></figure>
<h2 id="bridge"><a class="markdownIt-Anchor" href="#bridge"></a> bridge</h2>
<blockquote>
<p>两个namespace中的网络可以通过veth pair访问，但3个之间甚至多个互通，veth pair就无法胜任，此时需要用到bridge/switch</p>
</blockquote>
<p>下面的实验模拟4个namespace中的接口通过bridge互通</p>
<img src="/2019/08/07/linux-virtual-network-basic/bridge.jpg" class="" title="Rule List">
<p><strong>1. 创建veth pair</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link add tap1 <span class="built_in">type</span> veth peer name tap1_peer</span><br><span class="line">$ ip link add tap2 <span class="built_in">type</span> veth peer name tap2_peer</span><br><span class="line">$ ip link add tap3 <span class="built_in">type</span> veth peer name tap3_peer</span><br><span class="line">$ ip link add tap4 <span class="built_in">type</span> veth peer name tap4_peer</span><br></pre></td></tr></table></figure>
<p><strong>2. 创建namespace并迁移tap接口</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns add ns1</span><br><span class="line">$ ip netns add ns2</span><br><span class="line">$ ip netns add ns3</span><br><span class="line">$ ip netns add ns4</span><br><span class="line"><span class="comment"># 迁移tap接口</span></span><br><span class="line">$ ip link <span class="built_in">set</span> tap1 netns ns1</span><br><span class="line">$ ip link <span class="built_in">set</span> tap2 netns ns2</span><br><span class="line">$ ip link <span class="built_in">set</span> tap3 netns ns3</span><br><span class="line">$ ip link <span class="built_in">set</span> tap4 netns ns4</span><br></pre></td></tr></table></figure>
<p><strong>3. 创建bridge</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brctl addbr br1</span><br></pre></td></tr></table></figure>
<p><strong>4. 将对应的tap添加到bridge中</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brctl addif br1 tap1_peer</span><br><span class="line">$ brctl addif br1 tap2_peer</span><br><span class="line">$ brctl addif br1 tap3_peer</span><br><span class="line">$ brctl addif br1 tap4_peer</span><br></pre></td></tr></table></figure>
<p><strong>5. 配置IP地址</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ifconfig tap1 192.168.50.1/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ifconfig tap2 192.168.50.2/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns3 ifconfig tap3 192.168.50.3/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns4 ifconfig tap4 192.168.50.4/24</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注： 此时是无法相互访问</p>
</blockquote>
<p><strong>6. 设置网桥及对应接口状态为up</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig br1 up</span><br><span class="line">$ ifconfig tap1_peer up</span><br><span class="line">$ ifconfig tap2_peer up</span><br><span class="line">$ ifconfig tap3_peer up</span><br><span class="line">$ ifconfig tap4_peer up</span><br></pre></td></tr></table></figure>
<p><strong>7. 测试连通性</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns4 ping 192.168.50.1 -c 1</span><br><span class="line">PING 192.168.50.1 (192.168.50.1) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.50.1: icmp_seq=1 ttl=64 time=0.095 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.50.1 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.095/0.095/0.095/0.000 ms</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns4 ping 192.168.50.2 -c 1</span><br><span class="line">PING 192.168.50.2 (192.168.50.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.50.2: icmp_seq=1 ttl=64 time=0.106 ms</span><br><span class="line"></span><br><span class="line">--- 192.168.50.2 ping statistics ---</span><br><span class="line">1 packets transmitted, 1 received, 0% packet loss, time 0ms</span><br><span class="line">rtt min/avg/max/mdev = 0.106/0.106/0.106/0.000 ms</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h2 id="router"><a class="markdownIt-Anchor" href="#router"></a> router</h2>
<blockquote>
<p>注：Linux默认不开启转发功能，实验前需要先打开</p>
<p>修改<code>/etc/sysctl.conf</code>文件，设置<code>net.ipv4.ip_forward=1</code>，重启生效</p>
<p>临时修改： <code>echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</code></p>
</blockquote>
<img src="/2019/08/07/linux-virtual-network-basic/router.jpg" class="" title="Rule List">
<p><strong>1. 创建veth pair</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link add tap5 <span class="built_in">type</span> veth peer name tap5_peer</span><br><span class="line">$ ip link add tap6 <span class="built_in">type</span> veth peer name tap6_peer</span><br></pre></td></tr></table></figure>
<p><strong>2. 创建namespace并迁移tap接口</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns add ns5</span><br><span class="line">$ ip netns add ns6</span><br><span class="line">$ ip link <span class="built_in">set</span> tap5 netns ns5</span><br><span class="line">$ ip link <span class="built_in">set</span> tap6 netns ns6</span><br></pre></td></tr></table></figure>
<p><strong>3. 配置IP地址</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig tap5_peer 192.168.100.1/24</span><br><span class="line">$ ifconfig tap6_peer 192.168.200.1/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns5 ifconfig tap5 192.168.100.2/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns6 ifconfig tap6 192.168.200.2/24</span><br></pre></td></tr></table></figure>
<p><strong>4. 为namespace配置路由</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns5 route add -net 192.168.200.0/24 gw 192.168.100.1</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns6 route add -net 192.168.100.0/24 gw 192.168.200.1</span><br></pre></td></tr></table></figure>
<p><strong>5. 测试</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns5 ping 192.168.200.2</span><br><span class="line">PING 192.168.200.2 (192.168.200.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.200.2: icmp_seq=1 ttl=63 time=0.077 ms</span><br><span class="line">64 bytes from 192.168.200.2: icmp_seq=2 ttl=63 time=0.087 ms</span><br></pre></td></tr></table></figure>
<h2 id="tun"><a class="markdownIt-Anchor" href="#tun"></a> tun</h2>
<blockquote>
<p>tun应该是tunnel的缩写，启用了IP层隧道功能</p>
<p>Linux原生支持5种隧道<code>{ ipip | gre | sit | isatap | vti }</code></p>
</blockquote>
<img src="/2019/08/07/linux-virtual-network-basic/tunnel.jpg" class="" title="Rule List">
<p>忽略上图中的tun1和tun2后，整个topo与router中的一样。那么先按照<a href="#router">router</a>章节创建两个ns及配置</p>
<p><strong>1. 创建veth pair并分别迁移到对应的namespace</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link add tap1 <span class="built_in">type</span> veth peer name tap1_peer</span><br><span class="line">$ ip link add tap2 <span class="built_in">type</span> veth peer name tap2_peer</span><br><span class="line">$ ip netns add ns1</span><br><span class="line">$ ip netns add ns2</span><br><span class="line">$ ip link <span class="built_in">set</span> tap1 netns ns1</span><br><span class="line">$ ip link <span class="built_in">set</span> tap2 netns ns2</span><br></pre></td></tr></table></figure>
<p><strong>2. 配置IP和路由</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ifconfig tap1_peer 192.168.100.1/24</span><br><span class="line">$ ifconfig tap2_peer 192.168.200.1/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ifconfig tap1 192.168.100.2/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ifconfig tap2 192.168.200.2/24</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 route add -net 192.168.200.0/24 gw 192.168.100.1</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 route add -net 192.168.100.0/24 gw 192.168.200.1</span><br></pre></td></tr></table></figure>
<p><strong>3. 在ns1中创建tun1</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ip tunnel add tun1 mode ipip remote 192.168.200.2 <span class="built_in">local</span> 192.168.100.2 ttl 255</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ip addr add 192.168.50.10 peer 192.168.60.10 dev tun1</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ifconfig tun1 up</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ifconfig</span><br><span class="line">tap1      Link encap:Ethernet  HWaddr 46:a0:97:02:8c:07</span><br><span class="line">          inet addr:192.168.100.2  Bcast:192.168.100.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::44a0:97ff:fe02:8c07/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:12 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:928 (928.0 B)  TX bytes:928 (928.0 B)</span><br><span class="line"></span><br><span class="line">tun1      Link encap:IPIP Tunnel  HWaddr</span><br><span class="line">          inet addr:192.168.50.10  P-t-P:192.168.60.10  Mask:255.255.255.255</span><br><span class="line">          UP POINTOPOINT RUNNING NOARP  MTU:1480  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p><strong>4. 在ns2中创建tun2</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ip tunnel add tun2 mode ipip remote 192.168.100.2 <span class="built_in">local</span> 192.168.200.2 ttl 255</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ip addr add 192.168.60.10 peer 192.168.50.10 dev tun2</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ifconfig tun2 up</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 ifconfig</span><br><span class="line">tap2      Link encap:Ethernet  HWaddr aa:2e:e9:18:94:95</span><br><span class="line">          inet addr:192.168.200.2  Bcast:192.168.200.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::a82e:e9ff:fe18:9495/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:12 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:12 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:928 (928.0 B)  TX bytes:928 (928.0 B)</span><br><span class="line"></span><br><span class="line">tun2      Link encap:IPIP Tunnel  HWaddr</span><br><span class="line">          inet addr:192.168.60.10  P-t-P:192.168.50.10  Mask:255.255.255.255</span><br><span class="line">          UP POINTOPOINT RUNNING NOARP  MTU:1480  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br></pre></td></tr></table></figure>
<p><strong>5. 测试tun的连通性</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns1 ping 192.168.60.10</span><br><span class="line">PING 192.168.60.10 (192.168.60.10) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.60.10: icmp_seq=1 ttl=64 time=0.333 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>6. 抓包看看</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns2 tcpdump -i tap2</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on tap2, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">09:55:19.399964 IP 192.168.100.2 &gt; 192.168.200.2: IP 192.168.50.10 &gt; 192.168.60.10: ICMP <span class="built_in">echo</span> request, id 17197, seq 1, length 64 (ipip-proto-4)</span><br><span class="line">09:55:19.400004 IP 192.168.200.2 &gt; 192.168.100.2: IP 192.168.60.10 &gt; 192.168.50.10: ICMP <span class="built_in">echo</span> reply, id 17197, seq 1, length 64 (ipip-proto-4)</span><br><span class="line">...</span><br><span class="line">$ ip netns <span class="built_in">exec</span> ns2 tcpdump -i tun2</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on tun2, link-type RAW (Raw IP), capture size 262144 bytes</span><br><span class="line">09:55:57.735663 IP 192.168.50.10 &gt; 192.168.60.10: ICMP <span class="built_in">echo</span> request, id 17199, seq 1, length 64</span><br><span class="line">09:55:57.735685 IP 192.168.60.10 &gt; 192.168.50.10: ICMP <span class="built_in">echo</span> reply, id 17199, seq 1, length 64</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>注：namespace中抓包可能不会立即打印在屏幕上</p>
</blockquote>
<p><strong>7. 查看路由表项</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> ns1 route -n</span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">192.168.60.10   0.0.0.0         255.255.255.255 UH    0      0        0 tun1</span><br><span class="line">192.168.100.0   0.0.0.0         255.255.255.0   U     0      0        0 tap1</span><br><span class="line">192.168.200.0   192.168.100.1   255.255.255.0   UG    0      0        0 tap1</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到，ns1中自动创建了一条指向192.168.60.10的路由，下一跳是tun1</p>
</blockquote>
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<p>Openstack的neutron组件正是基于这些Linux虚拟网络功能实现了虚拟机之间的网络通道。</p>
<p>其中，tap、tun、veth pair被用于bridge之间的连接、bridge与vm的连接、bridge与router之间的连接。</p>
<p>而bridge提供二层转发功能，router提供三层转发功能。</p>
]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>使用markdown写PPT</title>
    <url>/2018/06/21/marp/</url>
    <content><![CDATA[<p><img src="https://raw.githubusercontent.com/yhat/2018/06/21/marp/master/images/marp.png" alt="" /></p>
<p>自打接触Markdown以来，深深的爱上了这种格式的书写，先是弄网站，然后又弄电子书。最近要给新员工培训，要准备4个PPT，于是就想有没有直接用md来写PPT的呢？上网一搜，还真有。</p>
<a id="more"></a>
<p>有Reveal.js, LandSlide, GitPitch等，但也许是我研究的不深吧，gitpitch是在线的，LandSlide要用pip来安装。Reveal.js倒是之前见team里的大神有写过，但现在好像变成了slides了，也是在线的。最终，主角出场，我选择了<a href="https://yhatt.github.i/2018/06/21/marp/" target="_blank" rel="noopener">Marp</a>。</p>
<h3 id="优点"><a class="markdownIt-Anchor" href="#优点"></a> 优点</h3>
<ul>
<li>书写简单</li>
<li>提供两套模版</li>
<li>可实时预览</li>
<li>只需要一个md文件即可，不需要其他诸如yaml之类的东西</li>
<li>支持Mac，Win和Linux</li>
</ul>
<h3 id="缺点"><a class="markdownIt-Anchor" href="#缺点"></a> 缺点</h3>
<ul>
<li>没有动画</li>
<li>只能导出为pdf格式，不能生成PPT格式</li>
<li>仅支持基础的markdown语法</li>
</ul>
<p><strong>虽然有着上面的缺点，然而，对于写技术类PPT，我觉得够用了</strong></p>
<h3 id="用法"><a class="markdownIt-Anchor" href="#用法"></a> 用法</h3>
<p>Marp提供两套主题，都说专治选择障碍。特别是默认主题，简直是选择障碍患者的福音。</p>
<p>下载完安装后，两个例子中已经有比较基本的说明了。但有一些东西还是很容易被忽略。</p>
<h4 id="设置页码"><a class="markdownIt-Anchor" href="#设置页码"></a> 设置页码</h4>
<p>页码是可以随时开启，随时关闭的。</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&lt;!-- page_number: true --&gt;</span><br></pre></td></tr></table></figure>
<p>在任意页输入以上代码就可以开启，但如果你要在哪页关闭显示页码，可以用false</p>
<h4 id="背景设置"><a class="markdownIt-Anchor" href="#背景设置"></a> 背景设置</h4>
<p>因为只有两套模版，所以，想要好看点，还是需要一些背景图片的。刚开始我只知道用<code>![bg](aaa.png)</code>的方式引入背景，但后来发现背景图片其实是和背景主题叠加了的。</p>
<p>后来细细看了文档才发现，原来可以用开关开启，还可以设置背景的大小</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![bg original 70%](aaa.png)</span><br></pre></td></tr></table></figure>
<p>使用了<code>original</code>之后，背景就变成了纯图片，而70%则可以指定图片大小。</p>
<p>当然，更有趣的是，可以用多个背景并排的方式来完成部分植入。</p>
<p>比如：</p>
<img src="/2018/06/21/marp/ppt1.png" class="" title="效果">
<p>则是用如下代码完成</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">![bg 450% original](robot2.png)</span><br><span class="line">![bg]()</span><br><span class="line">![bg]()</span><br><span class="line">![bg]()</span><br><span class="line">![bg]()</span><br><span class="line">![bg 450% original](robot2.png)</span><br></pre></td></tr></table></figure>
<p>还有一个有意思的是，如果不设置图片的比例，那么会按照扩充满整个屏幕来设置，但如果设置比例，如上面的代码，则100%是整个页面宽度/6之后的图片大小。</p>
<p>当然，灵活运用这一个特性，也能带来很多意想不到的效果。</p>
<h4 id="emoji"><a class="markdownIt-Anchor" href="#emoji"></a> emoji</h4>
<p>值得一提的是Marp的emoji表情选择的很是我喜欢的那种，而且可以按照段落来调整大小</p>
<p>比如：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># :cat:</span><br><span class="line">## :fish:</span><br><span class="line">### :tiger:</span><br><span class="line">#### :bird:</span><br></pre></td></tr></table></figure>
<p>表情的大小会随着段落比较而变化。还是很不错的。</p>
<p><strong>另外，似乎软件的作者正在开发新的软件，很是期待</strong></p>
<p>🐱</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux虚拟网络之虚拟机</title>
    <url>/2019/08/16/linux-virtual-vm/</url>
    <content><![CDATA[<p>本文将通过实验来理解Linux上的虚拟机如何通过tap、bridge、router以及iptables实现相关的网络访问功能。</p>
<h2 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h2>
<blockquote>
<p>系统： Ubuntu 16.04.6 LTS</p>
</blockquote>
<a id="more"></a>
<h3 id="实验topo"><a class="markdownIt-Anchor" href="#实验topo"></a> 实验topo</h3>
<img src="/2019/08/16/linux-virtual-vm/qemu_topo.png" class="" title="TOPO">
<h3 id="软件包"><a class="markdownIt-Anchor" href="#软件包"></a> 软件包</h3>
<p><strong>1. qemu</strong></p>
<p>由于整套实验环境都是在虚拟机上完成，在没有开启诸如Intel-VTx技术的情况下，使用<code>qemu</code>作为虚拟机模拟器</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt install qemu</span><br><span class="line">$ apt install uml-utilities</span><br><span class="line">$ apt install bridge-utils</span><br></pre></td></tr></table></figure>
<p><strong>2. 虚拟机镜像</strong></p>
<p>本文使用<strong>cirros</strong>(当前版本：0.4.0)作为虚拟机镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget http://download.cirros-cloud.net/0.4.0/cirros-0.4.0-x86_64-disk.img</span><br><span class="line">$ cp cirros-0.4.0-x86_64-disk.img cirros.img</span><br></pre></td></tr></table></figure>
<p><strong>3. vncserver</strong></p>
<p>使用qemu启动cirros需要用到图形界面，在纯命令行模式启动，需要使用vncserver</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt install tightvncserver</span><br></pre></td></tr></table></figure>
<p><strong>4. 环境检查</strong></p>
<p>先拉起个虚机试试</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ qemu-system-x86_64 -vnc 10.180.13.232:99 cirros-0.4.0-x86_64-disk.img</span><br></pre></td></tr></table></figure>
<p><strong>5. 测试</strong></p>
<p>用vnc viewer连接当前虚拟机</p>
<img src="/2019/08/16/linux-virtual-vm/qemu_vnc_example.png" class="" title="vnc viewer">
<h2 id="tap接口使用"><a class="markdownIt-Anchor" href="#tap接口使用"></a> tap接口使用</h2>
<p><strong>1. 创建虚拟机</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ qemu-system-x86_64 -vnc 10.180.13.232:99 cirros-0.4.0-x86_64-disk.img -netdev tap,id=mynet0,ifname=tap1,script=no,downscript=no -device e1000,netdev=mynet0</span><br></pre></td></tr></table></figure>
<p>创建成功后，可以看到，自动创建了一个<code>tap1</code>的接口，但没有up</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ ifconfig -a</span><br><span class="line">...</span><br><span class="line">tap1      Link encap:Ethernet  HWaddr 7a:d1:ba:68:06:b2</span><br><span class="line">          BROADCAST MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>2. 测试连通性</strong></p>
<ul>
<li>配置host的tap1接口IP</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ ifconfig tap1 192.168.1.1/24 up</span><br></pre></td></tr></table></figure>
<ul>
<li>配置虚拟机的IP</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(vm)$ sudo ifconfig eth0 192.168.1.2</span><br></pre></td></tr></table></figure>
<ul>
<li>ping</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(vm)$ ping 192.168.1.2</span><br><span class="line">PING 192.168.1.2 (192.168.1.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 192.168.1.2: icmp_seq=1 ttl=64 time=16.6 ms</span><br><span class="line">64 bytes from 192.168.1.2: icmp_seq=2 ttl=64 time=1.51 ms</span><br></pre></td></tr></table></figure>
<p><strong>3. 小结</strong></p>
<p>使用tap类型的netdev创建qemu虚拟机时，会自动创建一个tap接口，而这个tap接口与VM的接口相连。</p>
<p>连接图如下：</p>
<img src="/2019/08/16/linux-virtual-vm/qemu_tap.png" class="" title="tap">
<h2 id="虚拟机通信"><a class="markdownIt-Anchor" href="#虚拟机通信"></a> 虚拟机通信</h2>
<p>理解了虚拟机使用tap接口之后，就可以考虑使用网桥方式进行2个甚至多个虚拟机之间通信了。</p>
<p><strong>1. 创建虚拟机</strong></p>
<p>先拉起4个VM，分别指定网络</p>
<blockquote>
<p>注意，必须为每个虚机指定MAC地址，否则，拉起的虚机将使用同样的MAC地址</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ qemu-system-x86_64 -vnc 10.180.13.232:10 cirros.img -netdev tap,id=mynet0,ifname=tap0,script=no,downscript=no -device e1000,netdev=mynet0,mac=52:54:98:76:54:30 &amp;</span><br><span class="line">(host)$ qemu-system-x86_64 -vnc 10.180.13.232:11 cirros.img -netdev tap,id=mynet1,ifname=tap1,script=no,downscript=no -device e1000,netdev=mynet1,mac=52:54:98:76:54:31 &amp;</span><br></pre></td></tr></table></figure>
<p><strong>查看Host网卡</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ ip link show</span><br><span class="line">...</span><br><span class="line">46: tap0: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 42:47:1b:de:8e:07 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">47: tap1: &lt;BROADCAST,MULTICAST&gt; mtu 1500 qdisc noop state DOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether f2:23:b1:c5:55:d3 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>
<p>可以看到随虚拟机启动，创建了4个tap接口</p>
<p><strong>2. 配置IP</strong></p>
<p><strong>VM1</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(vm1)$ sudo ifconfig eth0 192.168.1.10</span><br></pre></td></tr></table></figure>
<p><strong>VM2</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(vm2)$ sudo ifconfig eth0 192.168.1.11</span><br></pre></td></tr></table></figure>
<p><strong>3. 创建网桥</strong></p>
<p><strong>Host</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ brctl addbr br0</span><br><span class="line">(host)$ brctl addif br0 tap0</span><br><span class="line">(host)$ brctl addif br0 tap1</span><br><span class="line">(host)$ bridge name bridge id               STP enabled interfaces</span><br><span class="line">  br0         8000.42471bde8e07       no          tap0</span><br><span class="line">                                                  tap1</span><br></pre></td></tr></table></figure>
<p>尝试ping一下，发现还是ping不通。因为对应的tap接口及br0没有up</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ ifconfig br0 up</span><br><span class="line">(host)$ ifconfig tap0 up</span><br><span class="line">(host)$ ifconfig tap1 up</span><br></pre></td></tr></table></figure>
<p>现在，可以两个VM相互ping一下了</p>
<p><strong>4. 访问外部PC</strong></p>
<p>虚拟机需要访问外部网络，则需要添加物理接口，如下图</p>
<img src="/2019/08/16/linux-virtual-vm/qemu_bridge.png" class="" title="bridge">
<p><strong>Host</strong></p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">(host)$ ifconfig ens192 up</span><br><span class="line">(host)$ brctl addif br0 ens192</span><br></pre></td></tr></table></figure>
<p><strong>VM1</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(vm1)$ ping 192.168.1.3</span><br><span class="line">PING 192.168.1.3 (192.168.1.3): 56 data bytes</span><br><span class="line">64 bytes from 192.168.1.3: seq=0 ttl=64 time=29.700 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>抓个包看看 - ens192</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ tcpdump -i ens192</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens192, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">11:15:02.317164 IP 192.168.1.11 &gt; 192.168.1.3: ICMP <span class="built_in">echo</span> request, id 47873, seq 0, length 64</span><br><span class="line">11:15:02.317527 IP 192.168.1.3 &gt; 192.168.1.11: ICMP <span class="built_in">echo</span> reply, id 47873, seq 0, length 64</span><br></pre></td></tr></table></figure>
<p><strong>5. 小结</strong></p>
<p>本节主要实验了虚拟机通过网桥进行相互通信及访问外网。对应了qemu网络的<strong>基于网桥的虚拟网卡</strong></p>
<h2 id="nat模式"><a class="markdownIt-Anchor" href="#nat模式"></a> NAT模式</h2>
<blockquote>
<p>Host需要开启转发功能</p>
<p>临时修改：<code>echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</code></p>
</blockquote>
<p>NAT模式主要通过iptables来实现。通过将虚拟机发出的报文的源地址转换为物理接口的IP，实现与外网的通信</p>
<p>拓扑图如下：</p>
<img src="/2019/08/16/linux-virtual-vm/qemu_nat.png" class="" title="nat">
<p><strong>1. 为网桥配置IP地址</strong></p>
<p>用网桥的br0接口作为192.168.1.0/24网段的网关</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ ifconfig br0 192.168.1.1/24</span><br></pre></td></tr></table></figure>
<p>测试host与外部网络连通性</p>
<blockquote>
<p>需要确保host有通往外部网络的路由</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ ping 223.5.5.5</span><br><span class="line">PING 223.5.5.5 (223.5.5.5) 56(84) bytes of data.</span><br><span class="line">64 bytes from 223.5.5.5: icmp_seq=1 ttl=115 time=11.7 ms</span><br></pre></td></tr></table></figure>
<p><strong>2. 配置iptables</strong></p>
<p>将192.168.1.0/24网段转换为发送出去的接口IP</p>
<blockquote>
<p>MASQUERADE: 用发送数据的网卡上的IP来替换源IP</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ iptables -t nat -A POSTROUTING -s 192.168.1.0/24 ! -d 192.168.1.0/24  -j MASQUERADE</span><br></pre></td></tr></table></figure>
<p><strong>3. 虚拟机配置默认路由</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(vm1)$ route add -net 0.0.0.0/0 gw 192.168.1.1</span><br></pre></td></tr></table></figure>
<p><strong>4. 测试连通性</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(vm1)$ ping 223.5.5.5</span><br><span class="line">PING 223.5.5.5 (223.5.5.5): 56 data bytes</span><br><span class="line">64 bytes from 223.5.5.5: seq=0 ttl=114 time=14.161 ms</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><strong>5. 抓包看看</strong></p>
<p><strong>tap1</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(host)$ tcpdump -i tap0 -n</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on tap0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">14:33:41.158181 IP 192.168.1.10 &gt; 223.5.5.5: ICMP <span class="built_in">echo</span> request, id 53761, seq 0, length 64</span><br><span class="line">14:33:41.332908 IP 223.5.5.5 &gt; 192.168.1.10: ICMP <span class="built_in">echo</span> reply, id 53761, seq 0, length 64</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>tap1</code>接口上体现了虚拟机的请求： 192.168.1.10 - 223.5.5.5</p>
<p><strong>br0</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tcpdump -i br0 -n</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">14:35:05.964841 IP 192.168.1.10 &gt; 223.5.5.5: ICMP <span class="built_in">echo</span> request, id 54017, seq 0, length 64</span><br><span class="line">14:35:06.028936 IP 223.5.5.5 &gt; 192.168.1.10: ICMP <span class="built_in">echo</span> reply, id 54017, seq 0, length 64</span><br></pre></td></tr></table></figure>
<p>网桥接口<code>br0</code>上的报文于<code>tap0</code>相同，既当前并没有修改报文</p>
<p><strong>ens160</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tcpdump -i ens160 -n host 223.5.5.5</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ens160, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">14:36:22.762002 IP 10.180.13.232 &gt; 223.5.5.5: ICMP <span class="built_in">echo</span> request, id 54273, seq 0, length 64</span><br><span class="line">14:36:22.775182 IP 223.5.5.5 &gt; 10.180.13.232: ICMP <span class="built_in">echo</span> reply, id 54273, seq 0, length 64</span><br></pre></td></tr></table></figure>
<p>可以看到在<code>ens160</code>接口上，IP则变成了10.180.13.232 - 223.5.5.5之间的通信</p>
<p><strong>6. 小结</strong></p>
<p>在本节中，当虚拟机访问外部网络时，从虚拟机内部发出的报文，在主机上通过查路由的方式转发到外部网络中。而在转发出去之前，将源IP地址修改为当前主机的接口IP</p>
]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Mininet基础使用</title>
    <url>/2018/11/07/mininet-base/</url>
    <content><![CDATA[<h2 id="mininet是什么"><a class="markdownIt-Anchor" href="#mininet是什么"></a> Mininet是什么</h2>
<p>Mininet是一个网络模拟器，可以创建虚拟主机，交换机，控制器和链接的网络。</p>
<p>Mininet的交换机支持OpenFlow，可实现高度灵活的自定义路由和SDN，为开发和测试SDN提供实验环境</p>
<a id="more"></a>
<h2 id="mininet用途"><a class="markdownIt-Anchor" href="#mininet用途"></a> Mininet用途</h2>
<ul>
<li>为开发OpenFlow应用程序提供简单而廉价的<strong>网络测试平台</strong></li>
<li>允许<strong>多个并发开发人员</strong>在同一拓扑上独立工作</li>
<li>支持<strong>系统级回归测试</strong>，这些<strong>测试</strong>可重复且易于打包</li>
<li>支持<strong>复杂的拓扑测试</strong>，无需连接物理网络</li>
<li>包括具有拓扑感知和OpenFlow感知的<strong>CLI</strong>，用于调试或运行网络范围的测试</li>
<li>支持<strong>任意自定义拓扑</strong>，并包括一组基本的<strong>参数化拓扑</strong></li>
<li><strong>可以在</strong>没有编程<strong>的情况下开箱</strong>即<strong>用</strong></li>
<li>提供了一个简单易用的**Python API，**用于网络创建和实验</li>
</ul>
<h2 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h2>
<h3 id="ubuntu1604"><a class="markdownIt-Anchor" href="#ubuntu1604"></a> Ubuntu16.04</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt install mininet</span><br></pre></td></tr></table></figure>
<h3 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo mn --<span class="built_in">test</span> pingall</span><br></pre></td></tr></table></figure>
<h2 id="使用"><a class="markdownIt-Anchor" href="#使用"></a> 使用</h2>
<h3 id="常用命令"><a class="markdownIt-Anchor" href="#常用命令"></a> 常用命令</h3>
<ul>
<li>进入mininet命令行模式</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mininet:~<span class="comment"># mn</span></span><br><span class="line">*** No default OpenFlow controller found <span class="keyword">for</span> default switch!</span><br><span class="line">*** Falling back to OVS Bridge</span><br><span class="line">*** Creating network</span><br><span class="line">*** Adding controller</span><br><span class="line">*** Adding hosts:</span><br><span class="line">h1 h2</span><br><span class="line">*** Adding switches:</span><br><span class="line">s1</span><br><span class="line">*** Adding links:</span><br><span class="line">(h1, s1) (h2, s1)</span><br><span class="line">*** Configuring hosts</span><br><span class="line">h1 h2</span><br><span class="line">*** Starting controller</span><br><span class="line"></span><br><span class="line">*** Starting 1 switches</span><br><span class="line">s1 ...</span><br><span class="line">*** Starting CLI:</span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>查看节点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mininet&gt; nodes</span><br><span class="line">available nodes are:</span><br><span class="line">h1 h2 s1</span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>可以看到当前包含3个节点，包括两个host，一个switch</p>
</blockquote>
<ul>
<li>查看连接状况</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mininet&gt; net</span><br><span class="line">h1 h1-eth0:s1-eth1</span><br><span class="line">h2 h2-eth0:s1-eth2</span><br><span class="line">s1 lo:  s1-eth1:h1-eth0 s1-eth2:h2-eth0</span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>h1的eth0与s1的eth1相连<br />
h2的eth0与s1的eth2相连</p>
</blockquote>
<ul>
<li>查看详细信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mininet&gt; dump</span><br><span class="line">&lt;Host h1: h1-eth0:10.0.0.1 pid=6896&gt;</span><br><span class="line">&lt;Host h2: h2-eth0:10.0.0.2 pid=6899&gt;</span><br><span class="line">&lt;OVSBridge s1: lo:127.0.0.1,s1-eth1:None,s1-eth2:None pid=6905&gt;</span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>环境清理</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># mn -c</span></span><br><span class="line">*** Removing excess controllers/ofprotocols/ofdatapaths/pings/noxes</span><br><span class="line">killall controller ofprotocol ofdatapath ping nox_core lt-nox_core ovs-openflowd ovs-controller udpbwtest mnexec ivs 2&gt; /dev/null</span><br><span class="line">killall -9 controller ofprotocol ofdatapath ping nox_core lt-nox_core ovs-openflowd ovs-controller udpbwtest mnexec ivs 2&gt; /dev/null</span><br><span class="line">pkill -9 -f <span class="string">"sudo mnexec"</span></span><br><span class="line">*** Removing junk from /tmp</span><br><span class="line">rm -f /tmp/vconn* /tmp/vlogs* /tmp/*.out /tmp/*.<span class="built_in">log</span></span><br><span class="line">*** Removing old X11 tunnels</span><br><span class="line">*** Removing excess kernel datapaths</span><br><span class="line">ps ax | egrep -o <span class="string">'dp[0-9]+'</span> | sed <span class="string">'s/dp/nl:/'</span></span><br><span class="line">***  Removing OVS datapaths</span><br><span class="line">ovs-vsctl --timeout=1 list-br</span><br><span class="line">ovs-vsctl --timeout=1 list-br</span><br><span class="line">*** Removing all links of the pattern foo-ethX</span><br><span class="line">ip link show | egrep -o <span class="string">'([-_.[:alnum:]]+-eth[[:digit:]]+)'</span></span><br><span class="line">ip link show</span><br><span class="line">*** Killing stale mininet node processes</span><br><span class="line">pkill -9 -f mininet:</span><br><span class="line">*** Shutting down stale tunnels</span><br><span class="line">pkill -9 -f Tunnel=Ethernet</span><br><span class="line">pkill -9 -f .ssh/mn</span><br><span class="line">rm -f ~/.ssh/mn/*</span><br><span class="line">*** Cleanup complete.</span><br><span class="line">root@mininet:~<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<ul>
<li>节点命令</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mininet&gt; h1 ifconfig</span><br><span class="line">h1-eth0   Link encap:Ethernet  HWaddr a2:5f:da:ed:6a:74</span><br><span class="line">          inet addr:10.0.0.1  Bcast:10.255.255.255  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: fe80::a05f:daff:feed:6a74/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:15 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:1206 (1.2 KB)  TX bytes:648 (648.0 B)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback</span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:0 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1</span><br><span class="line">          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)</span><br><span class="line"></span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>Run http server</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mininet&gt; h1 python -m SimpleHTTPServer 80 &amp;</span><br></pre></td></tr></table></figure>
<ul>
<li>Http client</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mininet&gt; h2 wget h1</span><br><span class="line">--2018-11-07 10:52:29--  http://10.0.0.1/</span><br><span class="line">Connecting to 10.0.0.1:80... connected.</span><br><span class="line">HTTP request sent, awaiting response... 200 OK</span><br><span class="line">Length: 370 [text/html]</span><br><span class="line">Saving to: <span class="string">'index.html'</span></span><br><span class="line"></span><br><span class="line">index.html          100%[===================&gt;]     370  --.-KB/s    <span class="keyword">in</span> 0s</span><br><span class="line"></span><br><span class="line">2018-11-07 10:52:29 (62.3 MB/s) - <span class="string">'index.html'</span> saved [370/370]</span><br><span class="line"></span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>sdn</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>sdn</tag>
      </tags>
  </entry>
  <entry>
    <title>Mininet自定义topo</title>
    <url>/2018/11/08/mininet-user-define-topo/</url>
    <content><![CDATA[<h2 id="mininet自带topo"><a class="markdownIt-Anchor" href="#mininet自带topo"></a> mininet自带topo</h2>
<p>通过<code>mn -h</code>可以看到Mininet自带的几种topo类型，分别有Linear, minimal, reversed, single, torus和tree类型，但有时候这些类型无法满足需求，需要自定义topo</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mn --<span class="built_in">help</span></span><br><span class="line">Usage: mn [options]</span><br><span class="line">(<span class="built_in">type</span> mn -h <span class="keyword">for</span> details)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  --topo=TOPO           linear|minimal|reversed|single|torus|tree[,param=value</span><br><span class="line">                        ...] linear=LinearTopo torus=TorusTopo tree=TreeTopo</span><br><span class="line">                        single=SingleSwitchTopo</span><br><span class="line">                        reversed=SingleSwitchReversedTopo minimal=MinimalTopo</span><br></pre></td></tr></table></figure>
<h2 id="获取示例"><a class="markdownIt-Anchor" href="#获取示例"></a> 获取示例</h2>
<p>Mininet提供了topo-2sw-2host的示例，可以通过<a href="https://github.com/mininet/mininet" target="_blank" rel="noopener">Mininet github</a>的custom目录下获取</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">"""Custom topology example</span></span><br><span class="line"><span class="string">Two directly connected switches plus a host for each switch:</span></span><br><span class="line"><span class="string">   host --- switch --- switch --- host</span></span><br><span class="line"><span class="string">Adding the 'topos' dict with a key/value pair to generate our newly defined</span></span><br><span class="line"><span class="string">topology enables one to pass in '--topo=mytopo' from the command line.</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> mininet.topo <span class="keyword">import</span> Topo</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTopo</span><span class="params">( Topo )</span>:</span></span><br><span class="line">    <span class="string">"Simple topology example."</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">( self )</span>:</span></span><br><span class="line">        <span class="string">"Create custom topo."</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Initialize topology</span></span><br><span class="line">        Topo.__init__( self )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add hosts and switches</span></span><br><span class="line">        leftHost = self.addHost( <span class="string">'h1'</span> )</span><br><span class="line">        rightHost = self.addHost( <span class="string">'h2'</span> )</span><br><span class="line">        leftSwitch = self.addSwitch( <span class="string">'s3'</span> )</span><br><span class="line">        rightSwitch = self.addSwitch( <span class="string">'s4'</span> )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add links</span></span><br><span class="line">        self.addLink( leftHost, leftSwitch )</span><br><span class="line">        self.addLink( leftSwitch, rightSwitch )</span><br><span class="line">        self.addLink( rightSwitch, rightHost )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">topos = &#123; <span class="string">'mytopo'</span>: ( <span class="keyword">lambda</span>: MyTopo() ) &#125;</span><br></pre></td></tr></table></figure>
<h2 id="自定义topo"><a class="markdownIt-Anchor" href="#自定义topo"></a> 自定义topo</h2>
<p>如要创建如下topo</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">                         +------------+</span><br><span class="line">              +----------+     s3     +---------+</span><br><span class="line">              |          +------------+         |</span><br><span class="line">              |                                 |</span><br><span class="line">         +----+----+                       +----+----+</span><br><span class="line">   +-----+    s1   +-----+           +-----+   s2    +-----+</span><br><span class="line">   |     +---------+     |           |     +---------+     |</span><br><span class="line">   |                     |           |                     |</span><br><span class="line">+--+--+               +--+--+     +--+--+               +--+--+</span><br><span class="line">| h1  |               | h2  |     | h3  |               | h4  |</span><br><span class="line">+-----+               +-----+     +-----+               +-----+</span><br></pre></td></tr></table></figure>
<p>代码</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> mininet.topo <span class="keyword">import</span> Topo</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyTopo</span><span class="params">( Topo )</span>:</span></span><br><span class="line">    <span class="string">"Simple topology example."</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">( self )</span>:</span></span><br><span class="line">        <span class="string">"Create custom topo."</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Initialize topology</span></span><br><span class="line">        Topo.__init__( self )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add hosts and switches</span></span><br><span class="line">        h1 = self.addHost( <span class="string">'h1'</span> )</span><br><span class="line">        h2 = self.addHost( <span class="string">'h2'</span> )</span><br><span class="line">        h3 = self.addHost( <span class="string">'h3'</span> )</span><br><span class="line">        h4 = self.addHost( <span class="string">'h4'</span> )</span><br><span class="line">        s1 = self.addSwitch( <span class="string">'s1'</span> )</span><br><span class="line">        s2 = self.addSwitch( <span class="string">'s2'</span> )</span><br><span class="line">        s3 = self.addSwitch( <span class="string">'s3'</span> )</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Add links</span></span><br><span class="line">        self.addLink( h1, s1 )</span><br><span class="line">        self.addLink( s1, h2 )</span><br><span class="line">        self.addLink( s1, s3 )</span><br><span class="line">        self.addLink( s3, s2 )</span><br><span class="line">        self.addLink( h3, s2 )</span><br><span class="line">        self.addLink( s2, h4 )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">topos = &#123; <span class="string">'mytopo'</span>: ( <span class="keyword">lambda</span>: MyTopo() ) &#125;</span><br></pre></td></tr></table></figure>
<h2 id="使用自定义topo"><a class="markdownIt-Anchor" href="#使用自定义topo"></a> 使用自定义topo</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@mininet:~<span class="comment"># mn --custom ./testtopo.py --topo mytopo --controller=remote,ip=127.0.0.1,port=6633</span></span><br><span class="line">*** Creating network</span><br><span class="line">*** Adding controller</span><br><span class="line">*** Adding hosts:</span><br><span class="line">h1 h2 h3 h4</span><br><span class="line">*** Adding switches:</span><br><span class="line">s1 s2 s3</span><br><span class="line">*** Adding links:</span><br><span class="line">(h1, s1) (h3, s2) (s1, h2) (s1, s3) (s2, h4) (s3, s2)</span><br><span class="line">*** Configuring hosts</span><br><span class="line">h1 h2 h3 h4</span><br><span class="line">*** Starting controller</span><br><span class="line">c0</span><br><span class="line">*** Starting 3 switches</span><br><span class="line">s1 s2 s3 ...</span><br><span class="line">*** Starting CLI:</span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
<p>查看连接状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mininet&gt; links</span><br><span class="line">h1-eth0&lt;-&gt;s1-eth1 (OK OK)</span><br><span class="line">h3-eth0&lt;-&gt;s2-eth2 (OK OK)</span><br><span class="line">s1-eth2&lt;-&gt;h2-eth0 (OK OK)</span><br><span class="line">s1-eth3&lt;-&gt;s3-eth1 (OK OK)</span><br><span class="line">s2-eth3&lt;-&gt;h4-eth0 (OK OK)</span><br><span class="line">s3-eth2&lt;-&gt;s2-eth1 (OK OK)</span><br><span class="line">mininet&gt; pingall</span><br><span class="line">*** Ping: testing ping reachability</span><br><span class="line">h1 -&gt; h2 h3 h4</span><br><span class="line">h2 -&gt; h1 h3 h4</span><br><span class="line">h3 -&gt; h1 h2 h4</span><br><span class="line">h4 -&gt; h1 h2 h3</span><br><span class="line">*** Results: 0% dropped (12/12 received)</span><br><span class="line">mininet&gt;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>sdn</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>sdn</tag>
      </tags>
  </entry>
  <entry>
    <title>在树莓派上部署nodejs</title>
    <url>/2018/03/23/nodejs-setup-pi/</url>
    <content><![CDATA[<p>终于有时间在树莓派上部署一个自己的小博客了，平时用惯了ubuntu，到了树莓派上，发现并没有那么简单。首先就是apt install nodejs，安装完没有npm。不过，经过一番折腾，便有了现在的小站点</p>
<a id="more"></a>
<h2 id="安装nodejs"><a class="markdownIt-Anchor" href="#安装nodejs"></a> 安装nodejs</h2>
<p><a href="https://nodejs.org" target="_blank" rel="noopener">nodejs</a>可以使用源码编译和二进制包来安装。考虑到树莓派的处理能力，要编译一个nodejs，太过耗时。直接选用官网提供的二进制包完成安装</p>
<h3 id="安装包获取"><a class="markdownIt-Anchor" href="#安装包获取"></a> 安装包获取</h3>
<p>官网上ARM的bin包有3个，分别是v6，v7和v8。而树莓派的版本是v7</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ uname -a</span><br><span class="line">Linux raspberrypi 4.9.80-v7+ <span class="comment">#1098 SMP Fri Mar 9 19:11:42 GMT 2018 armv7l GNU/Linux</span></span><br></pre></td></tr></table></figure>
<p>获取<a href="https://nodejs.org/dist/v8.10.0/node-v8.10.0-linux-armv7l.tar.xz" target="_blank" rel="noopener">安装包</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ wget https://nodejs.org/dist/v8.10.0/node-v8.10.0-linux-armv7l.tar.xz</span><br></pre></td></tr></table></figure>
<h3 id="安装nodejs-2"><a class="markdownIt-Anchor" href="#安装nodejs-2"></a> 安装nodejs</h3>
<p>解压缩</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tar -Jxv -f node-v8.10.0-linux-armv7l.tar.xz</span><br><span class="line">node-v8.10.0-linux-armv7l/</span><br><span class="line">node-v8.10.0-linux-armv7l/README.md</span><br><span class="line">node-v8.10.0-linux-armv7l/bin/</span><br><span class="line">node-v8.10.0-linux-armv7l/bin/node</span><br><span class="line">node-v8.10.0-linux-armv7l/bin/npm</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>可根据个人喜好重命名文件夹，此处重命名为node，分别验证版本信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pi@raspberrypi:~/node $ ./bin/node -v</span><br><span class="line">v8.10.0</span><br><span class="line">pi@raspberrypi:~/node $ ./bin/npm -v</span><br><span class="line">5.6.0</span><br></pre></td></tr></table></figure>
<p>配置node和npm为全局命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pi@raspberrypi:~/node $ sudo ln /home/pi/node/bin/node /usr/<span class="built_in">local</span>/bin/node</span><br><span class="line">pi@raspberrypi:~/node $ sudo ln -s /home/pi/node/lib/node_modules/npm/bin/npm /usr/<span class="built_in">local</span>/bin/npm</span><br></pre></td></tr></table></figure>
<p>此时执行npm会报错</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pi@raspberrypi:~/node $ npm -v</span><br><span class="line">module.js:471</span><br><span class="line">    throw err;</span><br><span class="line">    ^</span><br><span class="line"></span><br><span class="line">Error: Cannot find module <span class="string">'/usr/local/bin/node_modules/npm/bin/npm-cli.js'</span></span><br></pre></td></tr></table></figure>
<p>需要修改/usr/local/bin/目录下的npm文件，将$basedir替换为绝对路径，此处为/home/pi/node/</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">#!/bin/<span class="keyword">sh</span></span><br><span class="line">(set -o igncr) 2&gt;/dev/null &amp;&amp; set -o igncr; # cygwin encoding fix</span><br><span class="line"></span><br><span class="line">basedir=`dirname <span class="string">"$0"</span>`</span><br><span class="line"></span><br><span class="line">case `uname` in</span><br><span class="line">    *CYGWIN*) basedir=`cygpath -w "$basedir"`;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line">NODE_EXE=<span class="string">"/home/pi/node/bin/node.exe"</span></span><br><span class="line">if ! [ -x "$NODE_EXE" ]; then</span><br><span class="line">  NODE_EXE=node</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">NPM_CLI_JS=<span class="string">"/home/pi/node/lib/node_modules/npm/bin/npm-cli.js"</span></span><br><span class="line"></span><br><span class="line">case `uname` in</span><br><span class="line">  *MINGW*)</span><br><span class="line">    NPM_PREFIX=`<span class="string">"$NODE_EXE"</span> <span class="string">"$NPM_CLI_JS"</span> prefix -g`</span><br><span class="line">    NPM_PREFIX_NPM_CLI_JS=<span class="string">"$NPM_PREFIX/node_modules/npm/bin/npm-cli.js"</span></span><br><span class="line">    if [ -f "$NPM_PREFIX_NPM_CLI_JS" ]; then</span><br><span class="line">      NPM_CLI_JS=<span class="string">"$NPM_PREFIX_NPM_CLI_JS"</span></span><br><span class="line">    fi</span><br><span class="line">    ;;</span><br><span class="line">  *CYGWIN*)</span><br><span class="line">    NPM_PREFIX=`<span class="string">"$NODE_EXE"</span> <span class="string">"$NPM_CLI_JS"</span> prefix -g`</span><br><span class="line">    NPM_PREFIX_NPM_CLI_JS=<span class="string">"$NPM_PREFIX/node_modules/npm/bin/npm-cli.js"</span></span><br><span class="line">    if [ -f "$NPM_PREFIX_NPM_CLI_JS" ]; then</span><br><span class="line">      NPM_CLI_JS=<span class="string">"$NPM_PREFIX_NPM_CLI_JS"</span></span><br><span class="line">    fi</span><br><span class="line">    ;;</span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"><span class="string">"$NODE_EXE"</span> <span class="string">"$NPM_CLI_JS"</span> <span class="string">"$@"</span></span><br></pre></td></tr></table></figure>
<p>再次验证，npm已经可以正常工作</p>
]]></content>
      <categories>
        <category>树莓派</category>
      </categories>
      <tags>
        <tag>树莓派</tag>
        <tag>nodejs</tag>
        <tag>pi</tag>
      </tags>
  </entry>
  <entry>
    <title>Opendaylight Oxygen环境准备</title>
    <url>/2018/11/07/odl-setup/</url>
    <content><![CDATA[<h2 id="安装opendaylight"><a class="markdownIt-Anchor" href="#安装opendaylight"></a> 安装Opendaylight</h2>
<h3 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h3>
<ol>
<li>
<p>基础包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get install unzip lrzsz</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>安装jdk</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get install openjdk-8-jdk</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>设置<code>JAVA_HOME</code></p>
<p>在<code>/etc/environment</code>的末尾添加<code>JAVA_HOME=&quot;/usr/lib/jvm/java-8-openjdk-amd64&quot;</code>，需要退出当前终端重新登陆</p>
</li>
</ol>
<a id="more"></a>
<h3 id="获取安装包"><a class="markdownIt-Anchor" href="#获取安装包"></a> 获取安装包</h3>
<blockquote>
<p><a href="https://docs.opendaylight.org/en/latest/downloads.html" target="_blank" rel="noopener">https://docs.opendaylight.org/en/latest/downloads.html</a></p>
</blockquote>
<ul>
<li>运行karaf</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ unzip karaf-0.8.3.zip</span><br><span class="line">   ...</span><br><span class="line">$ <span class="built_in">cd</span> karaf-0.8.3/</span><br><span class="line">$ ./bin/karaf</span><br><span class="line">Apache Karaf starting up. Press Enter to open the shell now...</span><br><span class="line">100% [========================================================================]</span><br><span class="line">Karaf started <span class="keyword">in</span> 1s. Bundle stats: 54 active, 55 total</span><br><span class="line"></span><br><span class="line">    ________                       ________                .__  .__       .__     __</span><br><span class="line">    \_____  \ ______   ____   ____ \______ \ _____  ___.__.|  | |__| ____ |  |___/  |_</span><br><span class="line">     /   |   \\____ \_/ __ \ /    \ |    |  \\__  \&lt;   |  ||  | |  |/ ___\|  |  \   __\</span><br><span class="line">    /    |    \  |_&gt; &gt;  ___/|   |  \|    `   \/ __ \\___  ||  |_|  / /_/  &gt;   Y  \  |</span><br><span class="line">    \_______  /   __/ \___  &gt;___|  /_______  (____  / ____||____/__\___  /|___|  /__|</span><br><span class="line">            \/|__|        \/     \/        \/     \/\/            /_____/      \/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hit <span class="string">'&lt;tab&gt;'</span> <span class="keyword">for</span> a list of available commands</span><br><span class="line">and <span class="string">'[cmd] --help'</span> <span class="keyword">for</span> <span class="built_in">help</span> on a specific <span class="built_in">command</span>.</span><br><span class="line">Hit <span class="string">'&lt;ctrl-d&gt;'</span> or <span class="built_in">type</span> <span class="string">'system:shutdown'</span> or <span class="string">'logout'</span> to shutdown OpenDaylight.</span><br><span class="line"></span><br><span class="line">opendaylight-user@root&gt;</span><br></pre></td></tr></table></figure>
<h3 id="安装feature"><a class="markdownIt-Anchor" href="#安装feature"></a> 安装feature</h3>
<blockquote>
<p>说起来，这真的是一件让人崩溃的事情，不同的版本，安装feature不同，在什么都还不懂的情况下安装feature，遇到了无数的问题，终于当我将要换到更老的版本之前（0.7.3），让我找到了**Oxygen（0.8.3）**的feature</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">opendaylight-user@root&gt;feature:install odl-restconf odl-l2switch-switch odl-dlux-core odl-dluxapps-nodes odl-dluxapps-topology odl-dluxapps-yangui odl-dluxapps-yangvisualizer odl-dluxapps-yangman</span><br></pre></td></tr></table></figure>
<p>我有必要把这些feature再次列出来</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">feature:install odl-restconf</span><br><span class="line">feature:install odl-l2switch-switch </span><br><span class="line">feature:install odl-dlux-core </span><br><span class="line">feature:install odl-dluxapps-nodes </span><br><span class="line">feature:install odl-dluxapps-topology </span><br><span class="line">feature:install odl-dluxapps-yangui </span><br><span class="line">feature:install odl-dluxapps-yangvisualizer </span><br><span class="line">feature:install odl-dluxapps-yangman</span><br></pre></td></tr></table></figure>
<p><strong>务必按照顺序安装，如果出现错误，删了目录重新来过吧</strong></p>
<h3 id="登陆web"><a class="markdownIt-Anchor" href="#登陆web"></a> 登陆Web</h3>
<p>使用<code>admin:admin</code>登陆即可</p>
<img src="/2018/11/07/odl-setup/opendaylight_login.png" class="" title="ODL WebUI">
]]></content>
      <categories>
        <category>sdn</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>sdn</tag>
        <tag>opendaylight</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack学习 —— 创建网络及子网</title>
    <url>/2019/11/21/openstack-create-network/</url>
    <content><![CDATA[<p>搭建完测试环境后，拉起来个虚拟机看看，操作步骤</p>
<p><strong>创建网络</strong> - 创建虚拟机实例 - 创建路由器</p>
<p>本篇主要关注创建网络时主机上的行为</p>
<a id="more"></a>
<blockquote>
<p>注：openstack CLI以及ovs命令行输出信息较多，仅提取关键信息</p>
</blockquote>
<h3 id="创建网络及子网"><a class="markdownIt-Anchor" href="#创建网络及子网"></a> 创建网络及子网</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack network create net1</span><br><span class="line">+---------------------------+-------------------------------------</span><br><span class="line">| Field                     | Value           </span><br><span class="line">+---------------------------+-------------------------------------</span><br><span class="line">| id                        | 2caecd1e-bda7-4a4e-baec-3d192f52aa3b</span><br><span class="line">| provider:network_type     | vxlan                               </span><br><span class="line">| provider:segmentation_id  | 15                                  </span><br><span class="line">+---------------------------+-------------------------------------</span><br><span class="line">$ openstack subnet create --network net1 --subnet-range 200.0.0.0/24 sub1</span><br><span class="line">+-------------------+-------------------------------------</span><br><span class="line">| Field             | Value                               </span><br><span class="line">+-------------------+-------------------------------------</span><br><span class="line">| allocation_pools  | 200.0.0.2-200.0.0.254               </span><br><span class="line">| cidr              | 200.0.0.0/24                        </span><br><span class="line">| gateway_ip        | 200.0.0.1                           </span><br><span class="line">| id                | 5875f007-7b0f-45af-b78f-82527e5d9a90</span><br><span class="line">| network_id        | 2caecd1e-bda7-4a4e-baec-3d192f52aa3b</span><br><span class="line">+-------------------+-------------------------------------</span><br></pre></td></tr></table></figure>
<h3 id="发生了什么"><a class="markdownIt-Anchor" href="#发生了什么"></a> 发生了什么？</h3>
<p><strong>1. openstack</strong></p>
<p><code>net1</code>的id为<code>2caecd1e-bda7-4a4e-baec-3d192f52aa3b</code></p>
<p><code>sub1</code>的id为<code>5875f007-7b0f-45af-b78f-82527e5d9a90</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack port list</span><br><span class="line">+--------------------------------------+------+-------------------+--------------------------------------------------------------------------+--------+</span><br><span class="line">| ID                                   | Name | MAC Address       | Fixed IP Addresses                                                       | Status |</span><br><span class="line">+--------------------------------------+------+-------------------+--------------------------------------------------------------------------+--------+</span><br><span class="line">| 17a89323-fd0a-44cc-a525-fcf8d2efb836 |      | fa:16:3e:f6:db:c9 | ip_address=<span class="string">'200.0.0.2'</span>, subnet_id=<span class="string">'5875f007-7b0f-45af-b78f-82527e5d9a90'</span> | ACTIVE |</span><br><span class="line">+--------------------------------------+------+-------------------+--------------------------------------------------------------------------+--------+</span><br></pre></td></tr></table></figure>
<p>在<code>sub1</code>下创建了一个port</p>
<ul>
<li>ID：<code>17a89323-fd0a-44cc-a525-fcf8d2efb836</code></li>
<li>IP：<code>200.0.0.2</code></li>
</ul>
<p><strong>2. ovs</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl show</span><br><span class="line">...</span><br><span class="line">    Bridge br-int</span><br><span class="line">        ...</span><br><span class="line">        Port <span class="string">"tap17a89323-fd"</span></span><br><span class="line">            tag: 1</span><br><span class="line">            Interface <span class="string">"tap17a89323-fd"</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>ovs在br-int下创建了一个port <code>tap17a89323-fd</code>, tag为 <code>1</code></p>
<p><strong>3. Linux namespace</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns</span><br><span class="line">qdhcp-2caecd1e-bda7-4a4e-baec-3d192f52aa3b (id: 0)</span><br><span class="line">$ ip netns <span class="built_in">exec</span> qdhcp-2caecd1e-bda7-4a4e-baec-3d192f52aa3b ifconfig</span><br><span class="line">...</span><br><span class="line">tap17a89323-fd: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 169.254.169.254  netmask 255.255.0.0  broadcast 169.254.255.255</span><br><span class="line">        inet6 fe80::f816:3eff:fef6:dbc9  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether fa:16:3e:f6:db:c9  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 5  bytes 446 (446.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<p>创建了一个<code>qdhcp-2caecd1e-bda7-4a4e-baec-3d192f52aa3b</code>的namespace</p>
<p>ovs的br-int上的 <code>tap17a89323-fd</code>的port被放在了这个namespace中。</p>
<blockquote>
<p>留意一下接口的IP地址及MAC地址</p>
</blockquote>
<h3 id="综上"><a class="markdownIt-Anchor" href="#综上"></a> 综上</h3>
<p>openstack上创建network并创建一个子网之后，体现为：</p>
<ol>
<li>创建了一个dhcp的namespace</li>
<li>ovs在br-int上创建了dhcp的port，并将其置于dhcp的namespace中</li>
</ol>
<p><img src="/2019/11/21/openstack-create-network/create_network.png" alt="Create Network" /></p>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack学习 —— 跨主机虚拟机访问1</title>
    <url>/2019/11/22/openstack-cross-host-vm-1/</url>
    <content><![CDATA[<p>前面已经有一篇博文讲解了<a href="/2019/09/02/openstack-vm-traffic1/">同主机内的虚拟机通信</a>，本篇则主要关注与跨主机虚拟机访问的详细解析。</p>
<p>创建网络 - <strong>创建虚拟机实例</strong> - 创建路由器</p>
<p>在上一篇文章中已经详细介绍了创建网络后主机上发生的事情。接下来，我们就<strong>创建两个虚拟机</strong>（nova自动调度到了两个节点上），然后来看看网络部分又发生了哪些事情。</p>
<a id="more"></a>
<blockquote>
<p>注：openstack及ovs等CLI输出内容较多，文章中仅列出关注的部分内容</p>
</blockquote>
<h3 id="创建虚拟机"><a class="markdownIt-Anchor" href="#创建虚拟机"></a> 创建虚拟机</h3>
<blockquote>
<p>在创建虚拟机之前，需要创建规格（flavor）和上传镜像（image）</p>
<p>本文使用cirros作为测试镜像</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack server create --flavor small --image cirros --network net1 --min 2 --max 2 vm</span><br><span class="line">$ openstack server list</span><br><span class="line">+--------------------------------------+------+--------+------------------+--------+--------+</span><br><span class="line">| ID                                   | Name | Status | Networks         | Image  | Flavor |</span><br><span class="line">+--------------------------------------+------+--------+------------------+--------+--------+</span><br><span class="line">| ebb1b8fa-6457-4e80-8a49-14093622ce5d | vm-2 | ACTIVE | net1=200.0.0.219 | cirros | small  |</span><br><span class="line">| fb619b6c-9954-4dbd-8b1e-461c1c3c4c7d | vm-1 | ACTIVE | net1=200.0.0.238 | cirros | small  |</span><br><span class="line">+--------------------------------------+------+--------+------------------+--------+--------+</span><br></pre></td></tr></table></figure>
<h2 id="发生了什么"><a class="markdownIt-Anchor" href="#发生了什么"></a> 发生了什么？</h2>
<h3 id="compute"><a class="markdownIt-Anchor" href="#compute"></a> Compute</h3>
<p>还是有必要简单介绍一下nova相关的操作</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack server show vm-1</span><br><span class="line">+-------------------------------------+--------------------------------------+</span><br><span class="line">| Field                               | Value                                |</span><br><span class="line">+-------------------------------------+--------------------------------------+</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | node1                                |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name       | instance-00000039                    |</span><br><span class="line">| addresses                           | net1=200.0.0.238                     |</span><br><span class="line">| id                                  | fb619b6c-9954-4dbd-8b1e-461c1c3c4c7d |</span><br><span class="line">| name                                | vm-1                                 |</span><br><span class="line">+-------------------------------------+--------------------------------------+</span><br><span class="line">$ openstack server show vm-2</span><br><span class="line">+-------------------------------------+--------------------------------------+</span><br><span class="line">| Field                               | Value                                |</span><br><span class="line">+-------------------------------------+--------------------------------------+</span><br><span class="line">| OS-EXT-SRV-ATTR:hypervisor_hostname | node0                                |</span><br><span class="line">| OS-EXT-SRV-ATTR:instance_name       | instance-0000003a                    |</span><br><span class="line">| addresses                           | net1=200.0.0.219                     |</span><br><span class="line">| id                                  | ebb1b8fa-6457-4e80-8a49-14093622ce5d |</span><br><span class="line">| name                                | vm-2                                 |</span><br><span class="line">+-------------------------------------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<p>从实例的信息中看到，分别在node1上创建了vm-1：<code>instance-00000039</code>，在node0上创建了vm-2：<code>instance-0000003a</code>。不妨分别在两个node上使用<code>virsh list</code>看看：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(node0)$ virsh list</span><br><span class="line"> Id   Name                State</span><br><span class="line">-----------------------------------</span><br><span class="line"> 21   instance-0000003a   running</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(node1)$ virsh list</span><br><span class="line"> Id   Name                State</span><br><span class="line">-----------------------------------</span><br><span class="line"> 11   instance-00000039   running</span><br></pre></td></tr></table></figure>
<h3 id="network"><a class="markdownIt-Anchor" href="#network"></a> Network</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack port list</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------------------------------------------+--------+</span><br><span class="line">| ID                                   | Name | MAC Address       | Fixed IP Addresses                                                         | Status |</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------------------------------------------+--------+</span><br><span class="line">| 02407769-97c6-45ae-8fba-ea464020951c |      | fa:16:3e:ad:66:9e | ip_address=<span class="string">'200.0.0.219'</span>, subnet_id=<span class="string">'5875f007-7b0f-45af-b78f-82527e5d9a90'</span> | ACTIVE |</span><br><span class="line">| 17a89323-fd0a-44cc-a525-fcf8d2efb836 |      | fa:16:3e:f6:db:c9 | ip_address=<span class="string">'200.0.0.2'</span>, subnet_id=<span class="string">'5875f007-7b0f-45af-b78f-82527e5d9a90'</span>   | ACTIVE |</span><br><span class="line">| f4c391da-2295-479a-95c5-c7759132f2ea |      | fa:16:3e:f5:ca:f5 | ip_address=<span class="string">'200.0.0.238'</span>, subnet_id=<span class="string">'5875f007-7b0f-45af-b78f-82527e5d9a90'</span> | ACTIVE |</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------------------------------------------+--------+</span><br></pre></td></tr></table></figure>
<p>先记住两个port对应的ID：</p>
<table>
<thead>
<tr>
<th>ID</th>
<th>IP</th>
<th>Instance</th>
<th>Node</th>
</tr>
</thead>
<tbody>
<tr>
<td>02407769-97c6-45ae-8fba-ea464020951c</td>
<td>200.0.0.219</td>
<td>vm-1</td>
<td>node0</td>
</tr>
<tr>
<td>f4c391da-2295-479a-95c5-c7759132f2ea</td>
<td>200.0.0.238</td>
<td>vm-2</td>
<td>node1</td>
</tr>
</tbody>
</table>
<h4 id="node0"><a class="markdownIt-Anchor" href="#node0"></a> node0</h4>
<ul>
<li><strong>Linux bridge</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line">bridge name       bridge id           STP enabled   interfaces</span><br><span class="line">qbr02407769-97      8000.02989dedfae5   no            qvb02407769-97</span><br><span class="line">                                                              tap02407769-97</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ovs</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl show</span><br><span class="line">...</span><br><span class="line">    Bridge br-int</span><br><span class="line">    ...</span><br><span class="line">        Port <span class="string">"qvo02407769-97"</span></span><br><span class="line">            tag: 1</span><br><span class="line">            Interface <span class="string">"qvo02407769-97"</span></span><br><span class="line">            ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>别忘了留意<code>tag: 1</code>，后面分析时才会用到</p>
</blockquote>
<ul>
<li><strong>MAC地址</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link show</span><br><span class="line">161: qbr02407769-97: ...</span><br><span class="line">    link/ether 02:98:9d:ed:fa:e5 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">162: qvo02407769-97@qvb02407769-97: ...</span><br><span class="line">    link/ether 2a:16:2b:d1:8d:a3 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">163: qvb02407769-97@qvo02407769-97: ...</span><br><span class="line">    link/ether 02:98:9d:ed:fa:e5 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">164: tap02407769-97: ...</span><br><span class="line">    link/ether fe:16:3e:ad:66:9e brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>
<ul>
<li>vm-1</li>
</ul>
<blockquote>
<p>可以使用<code>virsh console xxx</code>连入虚拟机的console进行操作</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ virsh console instance-0000003a</span><br><span class="line">Connected to domain instance-0000003a</span><br><span class="line">Escape character is ^]</span><br><span class="line"></span><br><span class="line">login as <span class="string">'cirros'</span> user. default password: <span class="string">'gocubsgo'</span>. use <span class="string">'sudo'</span> <span class="keyword">for</span> root.</span><br><span class="line">vm-2 login: cirros</span><br><span class="line">Password:</span><br><span class="line">$ ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr FA:16:3E:AD:66:9E</span><br><span class="line">          inet addr:200.0.0.219  Bcast:200.0.0.255  Mask:255.255.255.0</span><br><span class="line">          inet6 addr: fe80::f816:3eff:fead:669e/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1450  Metric:1</span><br><span class="line">          RX packets:94 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:122 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000</span><br><span class="line">          RX bytes:9192 (8.9 KiB)  TX bytes:10571 (10.3 KiB)       </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>从上面我们可以看到，分别创建了：</p>
<ol>
<li>一个linux网桥<code>qbr02407769-97</code></li>
<li>一组接口对： <code>qvb02407769-97@qvo02407769-97</code></li>
<li>一个tap接口：<code>tap02407769-97</code></li>
</ol>
<p><strong>你或许已经发现了<code>tap02407769-97</code>接口与instance-0000003a的<code>eth0</code>的关系</strong>，是的，他们MAC地址相同，也即表示他们实际上就是同一个网络接口。</p>
<ul>
<li><strong>连接关系整理</strong></li>
</ul>
<p><img src="/2019/11/22/openstack-cross-host-vm-1/create_vm_ports.png" alt="create_vm_ports" /></p>
<p>将上一篇文章中的dhcp的namespace也合入整个连接关系后：</p>
<p><img src="/2019/11/22/openstack-cross-host-vm-1/create_vm_portswithdhcp.png" alt="create_vm_portswithdhcp" /></p>
<h4 id="node1"><a class="markdownIt-Anchor" href="#node1"></a> node1</h4>
<p>同样收集node1上的各种信息</p>
<ul>
<li><strong>linux bridge</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line">bridge name       bridge id           STP enabled   interfaces</span><br><span class="line">qbrf4c391da-22      8000.aa5d4b2ddf79   no            qvbf4c391da-22</span><br><span class="line">                                                              tapf4c391da-22</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>ovs</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl show</span><br><span class="line">...</span><br><span class="line">    Bridge br-int</span><br><span class="line">        ...</span><br><span class="line">        Port <span class="string">"qvof4c391da-22"</span></span><br><span class="line">            tag: 6</span><br><span class="line">            Interface <span class="string">"qvof4c391da-22"</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<blockquote>
<p>别忘了留意<code>tag: 6</code>，你也可以思考一下，为什么同一个subnet，node0上是1，node1上是6？</p>
</blockquote>
<ul>
<li><strong>连接关系</strong></li>
</ul>
<p>到现在，分布在两个node上的VM与br-int之间的通路已经清晰起来</p>
<p><img src="/2019/11/22/openstack-cross-host-vm-1/create_vm_portswithnode1.png" alt="create_vm_portswithnode1" /></p>
<h3 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h3>
<p>至此，两台虚拟机已经创建完毕。再加上<a href="/2019/11/21/openstack-env/">实验环境介绍</a>中的连接图：</p>
<p><img src="/2019/11/22/openstack-cross-host-vm-1/create_vm_with_2node.png" alt="create_vm_with_2node" /></p>
<p>不妨先从vm-1访问一下vm-2，先思考一下两个虚拟机是如何访问的。下一篇文章再继续探讨流量是如何从一个节点的虚拟机经历千山万水到达另外一个节点虚拟机上的。</p>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack学习 —— 跨主机虚拟机访问2</title>
    <url>/2019/11/27/openstack-cross-host-vm-2/</url>
    <content><![CDATA[<p>上篇文章梳理了分别在两个node上创建了VM后，底层的Linux系统上的namespace、linux bridge以及ovs中发生的事情。</p>
<p>本文将来着重关注两个node上的VM相互访问的流量通路。特别是令人头疼的ovs流表以及两个node是如何通过VXLAN网络将两台虚拟机连在了一起的。</p>
<a id="more"></a>
<p><img src="/2019/11/27/openstack-cross-host-vm-2/create_vm_with_2node.png" alt="create_vm_with_2node" /></p>
<h3 id="br-tun"><a class="markdownIt-Anchor" href="#br-tun"></a> br-tun</h3>
<p><strong>在前面收集信息时，你或许已经关注到了linux bridge和ovs中还有其他变化，那么，来看看 <code>br-tun</code></strong></p>
<ul>
<li>ovs</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(node0)$ ovs-vsctl show</span><br><span class="line">...</span><br><span class="line">    Bridge br-tun</span><br><span class="line">        ...</span><br><span class="line">        Port <span class="string">"vxlan-ac0a000b"</span></span><br><span class="line">            Interface <span class="string">"vxlan-ac0a000b"</span></span><br><span class="line">                <span class="built_in">type</span>: vxlan</span><br><span class="line">                options: &#123;df_default=<span class="string">"true"</span>, in_key=flow, local_ip=<span class="string">"172.10.0.10"</span>, out_key=flow, remote_ip=<span class="string">"172.10.0.11"</span>&#125;</span><br><span class="line">        ...</span><br><span class="line">        </span><br><span class="line">(node1)$ ovs-vsctl show</span><br><span class="line">...</span><br><span class="line">    Bridge br-tun</span><br><span class="line">        ...</span><br><span class="line">        Port <span class="string">"vxlan-ac0a000a"</span></span><br><span class="line">            Interface <span class="string">"vxlan-ac0a000a"</span></span><br><span class="line">                <span class="built_in">type</span>: vxlan</span><br><span class="line">                options: &#123;df_default=<span class="string">"true"</span>, in_key=flow, local_ip=<span class="string">"172.10.0.11"</span>, out_key=flow, remote_ip=<span class="string">"172.10.0.10"</span>&#125;</span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>当环境搭建完毕后，并不会立即创建这个接口，而是当创建了虚拟机后，会创建VXLAN的VTEP接口。</p>
<p><img src="/2019/11/27/openstack-cross-host-vm-2/create_vm_with_2node_vxlan.png" alt="create_vm_with_2node_vxlan" /></p>
<h3 id="流表"><a class="markdownIt-Anchor" href="#流表"></a> 流表</h3>
<h4 id="node0"><a class="markdownIt-Anchor" href="#node0"></a> node0</h4>
<ul>
<li><strong>br-int</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows br-int</span><br><span class="line"> table=0, ..., priority=65535,vlan_tci=0x0fff/0x1fff actions=drop</span><br><span class="line"> table=0, ..., priority=10,icmp6,in_port=<span class="string">"qvo02407769-97"</span>,icmp_type=136 actions=resubmit(,24)</span><br><span class="line"> table=0, ..., priority=10,arp,in_port=<span class="string">"qvo02407769-97"</span> actions=resubmit(,24)</span><br><span class="line"> table=0, ..., priority=2,in_port=<span class="string">"int-br-provider"</span> actions=drop</span><br><span class="line"> table=0, ..., priority=2,in_port=<span class="string">"int-br-ext"</span> actions=drop</span><br><span class="line"> table=0, ..., priority=9,in_port=<span class="string">"qvo02407769-97"</span> actions=resubmit(,25)</span><br><span class="line"> table=0, ..., priority=0 actions=resubmit(,60)</span><br><span class="line"> table=23, ..., priority=0 actions=drop</span><br><span class="line"> table=24, ..., priority=2,icmp6,in_port=<span class="string">"qvo02407769-97"</span>,icmp_type=136,nd_target=fe80::f816:3eff:fead:669e actions=resubmit(,60)</span><br><span class="line"> table=24, ..., priority=2,arp,in_port=<span class="string">"qvo02407769-97"</span>,arp_spa=200.0.0.219 actions=resubmit(,25)</span><br><span class="line"> table=24, ..., priority=0 actions=drop</span><br><span class="line"> table=25, ..., priority=2,in_port=<span class="string">"qvo02407769-97"</span>,dl_src=fa:16:3e:ad:66:9e actions=resubmit(,60)</span><br><span class="line"> table=60, ..., priority=3 actions=NORMAL</span><br></pre></td></tr></table></figure>
<p><strong>table 0</strong></p>
<ol>
<li>从<code>qvo02407769-97</code>送入的icmp，arp报文，送往table 24</li>
<li>从<code>qvo02407769-97</code>送入其他报文送往table 25</li>
<li>其他报文送table 60</li>
</ol>
<p><strong>table 24</strong></p>
<ol>
<li>从<code>qvo02407769-97</code>送入的报文，送往table 60。<code>fe80::f816:3eff:fead:669e</code>是vm-1的IPv6地址</li>
<li>从<code>qvo02407769-97</code>送入的arp报文，arp源地址为<code>200.0.0.219</code>即vm-1来的报文，送往table 25</li>
</ol>
<p><strong>table 25</strong></p>
<p>从<code>qvo02407769-97</code>送入的报文，源mac为<code>fa:16:3e:ad:66:9e</code>即vm-1来的报文，送往table 60</p>
<p><strong>table 60</strong></p>
<p>正常转发</p>
<blockquote>
<p>综上，从vm-1来的报文以及其他报文，都将正常在<code>br-int</code>上转发</p>
</blockquote>
<ul>
<li><strong>br-tun</strong></li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows br-tun</span><br><span class="line"> table=0, ..., priority=1,in_port=<span class="string">"patch-int"</span> actions=resubmit(,2)</span><br><span class="line"> table=0, ..., priority=1,in_port=<span class="string">"vxlan-ac0a000b"</span> actions=resubmit(,4)</span><br><span class="line"> table=0, ..., priority=0 actions=drop</span><br><span class="line"> table=2, ..., priority=0,dl_dst=00:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,20)</span><br><span class="line"> table=2, ..., priority=0,dl_dst=01:00:00:00:00:00/01:00:00:00:00:00 actions=resubmit(,22)</span><br><span class="line"> table=3, ..., priority=0 actions=drop</span><br><span class="line"> table=4, ..., priority=1,tun_id=0xf actions=mod_vlan_vid:1,resubmit(,10)</span><br><span class="line"> table=4, ..., priority=0 actions=drop</span><br><span class="line"> table=6, ..., priority=0 actions=drop</span><br><span class="line"> table=10, ..., priority=1 actions=learn(table=20,hard_timeout=300,priority=1,cookie=0x9c915752f14d2544,NXM_OF_VLAN_TCI[0..11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:0-&gt;NXM_OF_VLAN_TCI[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:OXM_OF_IN_PORT[]),output:<span class="string">"patch-int"</span></span><br><span class="line"> table=20, ..., priority=2,dl_vlan=1,dl_dst=fa:16:3e:f5:ca:f5 actions=strip_vlan,load:0xf-&gt;NXM_NX_TUN_ID[],output:<span class="string">"vxlan-ac0a000b"</span></span><br><span class="line"> table=20, ..., hard_timeout=300, priority=1,vlan_tci=0x0001/0x0fff,dl_dst=fa:16:3e:f5:ca:f5 actions=load:0-&gt;NXM_OF_VLAN_TCI[],load:0xf-&gt;NXM_NX_TUN_ID[],output:<span class="string">"vxlan-ac0a000b"</span></span><br><span class="line"> table=20, ..., priority=0 actions=resubmit(,22)</span><br><span class="line"> table=22, ..., priority=1,dl_vlan=1 actions=strip_vlan,load:0xf-&gt;NXM_NX_TUN_ID[],output:<span class="string">"vxlan-ac0a000b"</span></span><br><span class="line"> table=22, ..., priority=0 actions=drop</span><br></pre></td></tr></table></figure>
<p><strong>table 0</strong></p>
<ol>
<li>从<code>br-int</code>来的报文（即需要从本节点送出的报文），送到table 2</li>
<li>从<code>vxlan-ac0a000b</code>送来的报文（即从其他节点送到node 0的），送到table 4</li>
</ol>
<p><strong>table 2</strong>： 将要送出本节点的报文</p>
<ol>
<li>送往table 20</li>
<li>送往table 22</li>
</ol>
<p><strong>table 4</strong>： 从其他节点送到本节点的报文</p>
<p>tun_id为15（0xf）的报文，打上vlan标签1，送往table 10</p>
<blockquote>
<p>即从vxlan的tunnel出来的报文，如果tunnel id是15，则报文设置vlan为1</p>
<p>而<code>qvo02407769-97</code>（与vm-1相连）和<code>tap17a89323-fd</code>（DHCP的tap接口）的vlan tag正是<code>1</code></p>
</blockquote>
<p><strong>table 10</strong></p>
<blockquote>
<p>learn(table=20,hard_timeout=300,priority=1,cookie=0x9c915752f14d2544,NXM_OF_VLAN_TCI[0…11],NXM_OF_ETH_DST[]=NXM_OF_ETH_SRC[],load:0-&gt;NXM_OF_VLAN_TCI[],load:NXM_NX_TUN_ID[]-&gt;NXM_NX_TUN_ID[],output:OXM_OF_IN_PORT[]),output:“patch-int”</p>
</blockquote>
<p>这个action是如此的复杂，但不看<code>learn()</code>中的内容，报文最终被送往了<code>br-int</code></p>
<blockquote>
<p>learn则是在table20中增加对于回程报文的转发规则</p>
</blockquote>
<p><strong>table 20</strong></p>
<p>送往table 22</p>
<p><strong>table 22</strong></p>
<p>VLAN tag为1的报文，去掉VLAN，设置tun_id为15（0xf）后，送往<code>vxlan-ac0a000b</code></p>
<blockquote>
<p>综上：</p>
<ol>
<li>从vm-1送来的报文，携带VLAN tag为1，去掉VLAN tag，设置tun_id为15，从vxlan接口送出</li>
<li>从其他节点送来的报文，如果tun_id为15，设置VLAN tag为1，送往br-int</li>
</ol>
</blockquote>
<h3 id="总结"><a class="markdownIt-Anchor" href="#总结"></a> 总结</h3>
<p>完整的分析了node0上的流表，node1上的流表内容基本相似，就不再展开。</p>
<p>至此，跨节点的虚拟机相互访问的实验及分析正式完结。你会发现</p>
<ol>
<li>每一个port在连接到虚拟机的时候，都创建了一个网桥</li>
<li>每个虚拟机连在br-int上的接口，都按照subnet分配了一个VLAN tag，且每个节点的并不相同</li>
<li>当虚拟机的报文要送出/进入当前节点时，会有VLAN tag和VXLAN的tun_id相互转换</li>
</ol>
<p>现在，思考一下：</p>
<ol>
<li>node1上的vm-1是如何通过DHCP获取IP地址的？</li>
<li>为什么虚拟机不直接连在br-int上，而是要通过一个linux bridge连接到br-int上呢？</li>
</ol>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack学习 —— 实验环境介绍</title>
    <url>/2019/11/21/openstack-env/</url>
    <content><![CDATA[<p>本文作为个人学习笔记整理归档。如果你在学习openstack的过程中看到了本文，希望也能为你带来更加深入的理解。</p>
<p>CloudMan的每天5分钟系列作为入门书，确实让我了解了不少东西。一边看书，一边实验并且加以理解，才是更好的理解其中实现的原理。但老话说的，自己理解了和能给别人讲清楚，还是有很大差异。本着试着把里面的内容讲清楚的目的，进行一系列实验来验证，从而提升自己对相关内容的理解。</p>
<a id="more"></a>
<h3 id="环境概览"><a class="markdownIt-Anchor" href="#环境概览"></a> 环境概览</h3>
<p>Openstack的环境搭建有很多方法，这里仅对我当前环境组网加以说明。</p>
<p><img src="/2019/11/21/openstack-env/test_env_brief.png" alt="test_env_brief" /></p>
<h3 id="版本说明"><a class="markdownIt-Anchor" href="#版本说明"></a> 版本说明</h3>
<ul>
<li>
<p>Openstack： stein（1 controller node + 1 compute node）</p>
</li>
<li>
<p>Host： Ubuntu 18.04</p>
</li>
<li>
<p>Network driver： openvswitch</p>
</li>
</ul>
<h3 id="节点说明"><a class="markdownIt-Anchor" href="#节点说明"></a> 节点说明</h3>
<ol>
<li>node0既做为控制节点，也同时为网络节点、存储节点</li>
<li>node1为计算节点</li>
</ol>
<h3 id="网桥说明"><a class="markdownIt-Anchor" href="#网桥说明"></a> 网桥说明</h3>
<ol>
<li><strong>br-tun</strong>和<strong>br-int</strong>以及其连接关系皆由openstack的neutron-openvswitch-agent自动创建</li>
<li>分别在两个node上手工创建了<strong>br-provider</strong>并将物理接口绑定其中</li>
<li>在node0上创建<strong>br-ext</strong>作为外部网络网桥并绑定物理接口</li>
</ol>
<blockquote>
<p>在<code>/etc/neutron/plugins/ml2/openvswitch_agent.ini</code>中配置了<code>bridge_mappings = provider:br-provider,external:br-ext</code>后，重启neutron-openvswitch-agent后，系统会自动创建br-int与相关网桥的连接</p>
</blockquote>
<h3 id="tunnel相关配置"><a class="markdownIt-Anchor" href="#tunnel相关配置"></a> tunnel相关配置</h3>
<ol>
<li><code>tunnel_type</code>当前设置为<code>vxlan</code></li>
<li><code>local_ip</code>配置于<code>br-provider</code>上</li>
</ol>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu在Openstack中启动密码注入不生效问题定位1</title>
    <url>/2018/09/11/openstack-metadata/</url>
    <content><![CDATA[<h2 id="问题说明"><a class="markdownIt-Anchor" href="#问题说明"></a> 问题说明</h2>
<p>使用Ubuntu的cloud镜像创建实例，在创建时使用脚本修改密码</p>
<a id="more"></a>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">passwd ubuntu&lt;&lt;EOF</span><br><span class="line">ubuntu</span><br><span class="line">ubuntu</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>系统启动后，发现密码修改未成功</p>
<h2 id="定位思路"><a class="markdownIt-Anchor" href="#定位思路"></a> 定位思路</h2>
<p>查看实例启动日志 ➡️ 查看openstack的neutron agent状态 ➡️ 查看meta-data服务日志</p>
<h2 id="step-by-step"><a class="markdownIt-Anchor" href="#step-by-step"></a> step by step</h2>
<ul>
<li>查看实例启动日志</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[  731.435163] cloud-init[845]: 2018-09-11 01:42:24,574 - url_helper.py[WARNING]: Calling <span class="string">'http://169.254.169.254/2009-04-04/meta-data/instance-id'</span> failed [119/120s]: request error [HTTPConnectionPool(host=<span class="string">'169.254.169.254'</span>, port=80): Max retries exceeded with url: /2009-04-04/meta-data/instance-id (Caused by NewConnectionError(<span class="string">'&lt;requests.packages.urllib3.connection.HTTPConnection object at 0x7fa26f1eb6d8&gt;: Failed to establish a new connection: [Errno 101] Network is unreachable'</span>,))]</span><br><span class="line">[  738.460169] cloud-init[845]: 2018-09-11 01:42:31,597 - DataSourceEc2.py[CRITICAL]: Giving up on md from [<span class="string">'http://169.254.169.254/2009-04-04/meta-data/instance-id'</span>] after 126 seconds</span><br><span class="line">[  738.470572] cloud-init[845]: 2018-09-11 01:42:31,608 - util.py[WARNING]: Getting data from &lt;class <span class="string">'cloudinit.sources.DataSourceCloudStack.DataSourceCloudStack'</span>&gt; failed</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上日志说明cloud-init在向meta-data server获取meta-data时失败</p>
</blockquote>
<ul>
<li>查看neutron agent状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@pxea4badb217413:~<span class="comment"># neutron agent-list</span></span><br><span class="line">+--------------------------------------+--------------------+-----------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| id                                   | agent_type         | host            | availability_zone | alive | admin_state_up | binary                    |</span><br><span class="line">+--------------------------------------+--------------------+-----------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">| 459740a7-b60c-4db7-9ee0-3b45d6c3b2de | Linux bridge agent | pxe1418773526e5 |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| 4ec74c6a-c392-4216-bddd-789ec5aa3d86 | DHCP agent         | pxea4badb217413 | nova              | :-)   | True           | neutron-dhcp-agent        |</span><br><span class="line">| 6d992669-fbe6-412c-a717-5c2b61a2b901 | Metadata agent     | pxea4badb217413 |                   | :-)   | True           | neutron-metadata-agent    |</span><br><span class="line">| 77dc04a5-0e43-4907-be3a-6f165e77807c | Linux bridge agent | pxe74867aee16bc |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| c54c7593-5973-41ed-86c8-7e22ac1e95ec | Linux bridge agent | pxea4badb217413 |                   | :-)   | True           | neutron-linuxbridge-agent |</span><br><span class="line">| e882e27d-45de-4cb3-9284-7e9101e2b39b | L3 agent           | pxea4badb217413 | nova              | :-)   | True           | neutron-l3-agent          |</span><br><span class="line">+--------------------------------------+--------------------+-----------------+-------------------+-------+----------------+---------------------------+</span><br><span class="line">root@pxea4badb217413:~<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<ul>
<li>检查neutron-metadata日志</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent [-] Failed reporting state!</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent Traceback (most recent call last):</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/agent/metadata/agent.py"</span>, line <span class="number">266</span>, <span class="keyword">in</span> _report_state</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     use_call=self.agent_state.get(<span class="string">'start_flag'</span>))</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/agent/rpc.py"</span>, line <span class="number">87</span>, <span class="keyword">in</span> report_state</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     <span class="keyword">return</span> method(context, <span class="string">'report_state'</span>, **kwargs)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/oslo_messaging/rpc/client.py"</span>, line <span class="number">158</span>, <span class="keyword">in</span> call</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     retry=self.retry)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/oslo_messaging/transport.py"</span>, line <span class="number">90</span>, <span class="keyword">in</span> _send</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     timeout=timeout, retry=retry)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py"</span>, line <span class="number">470</span>, <span class="keyword">in</span> send</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     retry=retry)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py"</span>, line <span class="number">459</span>, <span class="keyword">in</span> _send</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     result = self._waiter.wait(msg_id, timeout)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py"</span>, line <span class="number">342</span>, <span class="keyword">in</span> wait</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     message = self.waiters.get(msg_id, timeout=timeout)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent   File <span class="string">"/usr/lib/python2.7/dist-packages/oslo_messaging/_drivers/amqpdriver.py"</span>, line <span class="number">244</span>, <span class="keyword">in</span> get</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent     <span class="string">'to message ID %s'</span> % msg_id)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent MessagingTimeout: Timed out waiting <span class="keyword">for</span> a reply to message ID <span class="number">5</span>b145001c0a34d37a68337821e64908f</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.404</span> <span class="number">10617</span> ERROR neutron.agent.metadata.agent</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-05</span> <span class="number">19</span>:<span class="number">07</span>:<span class="number">06.405</span> <span class="number">10617</span> WARNING oslo.service.loopingcall [-] Function <span class="string">'neutron.agent.metadata.agent.UnixDomainMetadataProxy._report_state'</span> run outlasted interval by <span class="number">30.00</span> s</span><br><span class="line">ec</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">2018-09-06 16:23:48.658 1238 ERROR oslo.messaging._drivers.impl_rabbit [-] AMQP server on controller:5672 is unreachable: [Errno 111] ECONNREFUSED. Trying again <span class="keyword">in</span> 1 seconds.</span><br><span class="line">2018-09-06 16:23:49.752 1238 ERROR oslo.messaging._drivers.impl_rabbit [-] AMQP server on controller:5672 is unreachable: [Errno 111] ECONNREFUSED. Trying again <span class="keyword">in</span> 2 seconds.</span><br><span class="line">2018-09-06 16:23:51.766 1238 ERROR oslo.messaging._drivers.impl_rabbit [-] AMQP server on controller:5672 is unreachable: [Errno 111] ECONNREFUSED. Trying again <span class="keyword">in</span> 4 seconds.</span><br><span class="line">2018-09-06 16:23:55.779 1238 ERROR oslo.messaging._drivers.impl_rabbit [-] AMQP server on controller:5672 is unreachable: [Errno 111] ECONNREFUSED. Trying again <span class="keyword">in</span> 6 seconds.</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上显示为AMQP server连接不到</p>
</blockquote>
<ul>
<li>检查meta-data的配置</li>
</ul>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line"> /etc/neutron/metadata_agent.ini</span><br><span class="line"> </span><br><span class="line"># IP address used by Nova metadata server. (string value)</span><br><span class="line">#nova_metadata_ip = 127.0.0.1</span><br><span class="line">nova_metadata_ip = controller</span><br><span class="line"># TCP Port used by Nova metadata server. (port value)</span><br><span class="line"># Minimum value: 0</span><br><span class="line"># Maximum value: 65535</span><br><span class="line">#nova_metadata_port = 8775</span><br></pre></td></tr></table></figure>
<ul>
<li>查看controller上端口监听状况</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@pxea4badb217413:~<span class="comment"># netstat -lnp</span></span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name</span><br><span class="line">tcp        0      0 0.0.0.0:22              0.0.0.0:*               LISTEN      1149/sshd</span><br><span class="line">tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN      2316/exim4</span><br><span class="line">tcp        0      0 127.0.0.1:6010          0.0.0.0:*               LISTEN      18284/12</span><br><span class="line">tcp        0      0 127.0.0.1:6011          0.0.0.0:*               LISTEN      18861/20</span><br><span class="line">tcp        0      0 0.0.0.0:9696            0.0.0.0:*               LISTEN      1243/python</span><br><span class="line">tcp        0      0 0.0.0.0:6080            0.0.0.0:*               LISTEN      1247/python</span><br><span class="line">tcp        0      0 0.0.0.0:8774            0.0.0.0:*               LISTEN      1237/python</span><br><span class="line">tcp        0      0 0.0.0.0:8775            0.0.0.0:*               LISTEN      1237/python</span><br><span class="line">tcp        0      0 0.0.0.0:9191            0.0.0.0:*               LISTEN      1242/python</span><br><span class="line">tcp        0      0 0.0.0.0:25672           0.0.0.0:*               LISTEN      2922/beam.smp</span><br><span class="line">tcp        0      0 0.0.0.0:8776            0.0.0.0:*               LISTEN      1235/python</span><br><span class="line">tcp        0      0 10.160.17.196:3306      0.0.0.0:*               LISTEN      1769/mysqld</span><br><span class="line">tcp        0      0 10.160.17.196:11211     0.0.0.0:*               LISTEN      2443/memcached</span><br><span class="line">tcp        0      0 0.0.0.0:9292            0.0.0.0:*               LISTEN      1246/python</span><br><span class="line">tcp6       0      0 :::21                   :::*                    LISTEN      833/vsftpd</span><br><span class="line">tcp6       0      0 :::22                   :::*                    LISTEN      1149/sshd</span><br><span class="line">tcp6       0      0 ::1:25                  :::*                    LISTEN      2316/exim4</span><br><span class="line">tcp6       0      0 ::1:6010                :::*                    LISTEN      18284/12</span><br><span class="line">tcp6       0      0 ::1:6011                :::*                    LISTEN      18861/20</span><br><span class="line">tcp6       0      0 :::35357                :::*                    LISTEN      3904/apache2</span><br><span class="line">tcp6       0      0 :::5000                 :::*                    LISTEN      3904/apache2</span><br><span class="line">tcp6       0      0 :::80                   :::*                    LISTEN      3904/apache2</span><br><span class="line">tcp6       0      0 :::8081                 :::*                    LISTEN      4749/cma</span><br><span class="line">tcp6       0      0 :::4369                 :::*                    LISTEN      2586/epmd</span><br><span class="line">udp        0      0 0.0.0.0:123             0.0.0.0:*                           3218/chronyd</span><br><span class="line">udp        0      0 0.0.0.0:161             0.0.0.0:*                           3189/snmpd</span><br><span class="line">udp        0      0 0.0.0.0:323             0.0.0.0:*                           3218/chronyd</span><br><span class="line">udp6       0      0 :::123                  :::*                                3218/chronyd</span><br><span class="line">udp6       0      0 :::323                  :::*                                3218/chronyd</span><br></pre></td></tr></table></figure>
<blockquote>
<p>以上，发现5762端口未监听</p>
</blockquote>
<ul>
<li>尝试启动rabbitmq-server</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">service rabbitmq-server start</span><br><span class="line"> * Starting RabbitMQ Messaging Server rabbitmq-server                                                                                                                              * RabbitMQ Messaging Server already running</span><br><span class="line">                                                                                                                                                                           [ OK ]</span><br></pre></td></tr></table></figure>
<ul>
<li>再次查看端口监听状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">tcp6       0      0 :::5672                 :::*                    LISTEN      2922/beam.smp</span><br></pre></td></tr></table></figure>
<ul>
<li>重启meta-data的service，发现日志已经不再报错了</li>
</ul>
<blockquote>
<p>然而，这竟然不是最终原因，最终的问题发现是<strong>网络问题</strong></p>
</blockquote>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>openstack接口状态异常</title>
    <url>/2018/09/11/openstack-neutron-problem1/</url>
    <content><![CDATA[<h2 id="错误信息"><a class="markdownIt-Anchor" href="#错误信息"></a> 错误信息</h2>
<p>neutron错误日志<code>Exit code: 2; Stdin: ; Stdout: ; Stderr: sudo: unable to resolve host pxea4badb2</code></p>
<h2 id="问题现象"><a class="markdownIt-Anchor" href="#问题现象"></a> 问题现象</h2>
<blockquote>
<p>openstack的router中创建了一个联通两个vlan的路由器，发现两个接口轮流处于<code>build</code>状态</p>
</blockquote>
<a id="more"></a>
<h2 id="查看日志"><a class="markdownIt-Anchor" href="#查看日志"></a> 查看日志</h2>
<ul>
<li>/var/log/neutron/neutron-linuxbridge-agent.log</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">115265 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/oslo_utils/excutils.py"</span>, line 196, <span class="keyword">in</span> force_reraise</span><br><span class="line">115266 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     six.reraise(self.type_, self.value, self.tb)</span><br><span class="line">115267 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/plugins/ml2/drivers/linuxbridge/agent/linuxbridge_neut       ron_agent.py"</span>, line 419, <span class="keyword">in</span> add_tap_interface</span><br><span class="line">115268 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     tap_device_name, device_owner)</span><br><span class="line">115269 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/plugins/ml2/drivers/linuxbridge/agent/linuxbridge_neut       ron_agent.py"</span>, line 451, <span class="keyword">in</span> _add_tap_interface</span><br><span class="line">115270 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     segmentation_id)</span><br><span class="line">115271 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/plugins/ml2/drivers/linuxbridge/agent/linuxbridge_neut       ron_agent.py"</span>, line 403, <span class="keyword">in</span> ensure_physical_in_bridge</span><br><span class="line">115272 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     physical_interface)</span><br><span class="line">115273 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/plugins/ml2/drivers/linuxbridge/agent/linuxbridge_neut       ron_agent.py"</span>, line 221, <span class="keyword">in</span> ensure_flat_bridge</span><br><span class="line">115274 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     gateway):</span><br><span class="line">115275 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/plugins/ml2/drivers/linuxbridge/agent/linuxbridge_neut       ron_agent.py"</span>, line 362, <span class="keyword">in</span> ensure_bridge</span><br><span class="line">115276 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     self.update_interface_ip_details(bridge_name, interface, ips, gateway)</span><br><span class="line">115277 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/plugins/ml2/drivers/linuxbridge/agent/linuxbridge_neut       ron_agent.py"</span>, line 301, <span class="keyword">in</span> update_interface_ip_details</span><br><span class="line">115278 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     dst_device.addr.add(cidr=ip[<span class="string">'cidr'</span>])</span><br><span class="line">115279 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/agent/linux/ip_lib.py"</span>, line 597, <span class="keyword">in</span> add</span><br><span class="line">115280 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     self._as_root([net.version], tuple(args))</span><br><span class="line">115281 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/agent/linux/ip_lib.py"</span>, line 384, <span class="keyword">in</span> _as_root</span><br><span class="line">115282 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     use_root_namespace=use_root_namespace)</span><br><span class="line">115283 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/agent/linux/ip_lib.py"</span>, line 96, <span class="keyword">in</span> _as_root</span><br><span class="line">115284 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     log_fail_as_error=self.log_fail_as_error)</span><br><span class="line">115285 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/agent/linux/ip_lib.py"</span>, line 105, <span class="keyword">in</span> _execute</span><br><span class="line">115286 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     log_fail_as_error=log_fail_as_error)</span><br><span class="line">115287 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent   File <span class="string">"/usr/lib/python2.7/dist-packages/neutron/agent/linux/utils.py"</span>, line 146, <span class="keyword">in</span> execute</span><br><span class="line">115288 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent     raise ProcessExecutionError(msg, returncode=returncode)</span><br><span class="line">115289 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent ProcessExecutionError: Exit code: 2; Stdin: ; Stdout: ; Stderr: sudo: unable to resolve host pxea4badb2       17413</span><br><span class="line">115290 2018-09-11 16:59:59.274 1553 ERROR neutron.plugins.ml2.drivers.agent._common_agent RTNETLINK answers: File exists</span><br></pre></td></tr></table></figure>
<h2 id="问题原因"><a class="markdownIt-Anchor" href="#问题原因"></a> 问题原因</h2>
<ul>
<li><code>sudo: unable to resolve host pxea4badb2</code></li>
</ul>
<blockquote>
<p>无法解析主机名</p>
</blockquote>
<p>查看<code>/etc/hosts</code>中缺少了本地hostname的IP地址映射</p>
<ul>
<li><code>Exit code: 2; Stdin: ; Stdout: ; Stderr:</code></li>
</ul>
<blockquote>
<p>问题比较不直观，google之后，有人说是因为bridge上配置了IP，导致冲突了</p>
</blockquote>
<p>经查看controller上，发现一个bridge和一个无力网卡配置了同样的IP，可能是因为之前使用flat网络后切换为vlan网络，没有清理openstack中创建的配置导致。</p>
<p>将bridge上的IP地址删除后，恢复正常</p>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack学习笔记1</title>
    <url>/2018/06/28/openstack-study1/</url>
    <content><![CDATA[<p>该系列用来记录本人使用Openstack的一些笔记和心得</p>
<a id="more"></a>
<h2 id="openstack一些理解"><a class="markdownIt-Anchor" href="#openstack一些理解"></a> Openstack一些理解</h2>
<h3 id="服务说明"><a class="markdownIt-Anchor" href="#服务说明"></a> 服务说明</h3>
<ul>
<li>keystone - 必选</li>
</ul>
<p>认证服务，是其他所有服务的基础</p>
<ul>
<li>glance - 必选</li>
</ul>
<p>镜像服务，用来存储镜像文件，如iso, vmdk, qcow2等</p>
<ul>
<li>nova - 必选</li>
</ul>
<p>计算服务，包括计算，调度，管理，api等，是openstack的核心服务</p>
<ul>
<li>neutron - 必选</li>
</ul>
<p>网络服务</p>
<ul>
<li>horizon - 可选（推荐选择）</li>
</ul>
<p>管理界面，图形化管理界面，方便使用</p>
<ul>
<li>cinder - 可选</li>
</ul>
<p>块存储服务，用来创建虚拟机的磁盘</p>
<h3 id="一些理解"><a class="markdownIt-Anchor" href="#一些理解"></a> 一些理解</h3>
<p>openstack可以理解为插件型的，灵活就体现于此。</p>
<ul>
<li>计算服务，控制节点可以只做计算的调度，管理，也可以在控制节点上启动计算服务</li>
<li>同样，可以在任意一个节点上起块存储服务</li>
</ul>
<h3 id="关于网络"><a class="markdownIt-Anchor" href="#关于网络"></a> 关于网络</h3>
<p>刚开始的时候很疑惑，为什么每个计算节点上都要配置一个额外的网卡，并将其连在一起</p>
<p>需要说明的是：</p>
<ul>
<li>虚拟机的第一个网口是openstack的各个节点用来通信的网卡</li>
<li>第二个网口是用来实现在openstack上启动的实例彼此通信的（即东西向流量）</li>
<li>也可以不用第二个网口，这时，两个实例可以通过基于第一个网口之间建立的隧道进行通信</li>
<li>如果要让实例可以访问外网，则需要为其分配专门的访问外网的网口</li>
<li>openstack并不直接管理网口或网桥，要么通过linux bridge，或者是openvSwitch</li>
<li>在openstack的UI上看到的网口，都是代号</li>
</ul>
<h2 id="测试环境准备"><a class="markdownIt-Anchor" href="#测试环境准备"></a> 测试环境准备</h2>
<h3 id="两台虚拟机当然也可以all-in-one"><a class="markdownIt-Anchor" href="#两台虚拟机当然也可以all-in-one"></a> 两台虚拟机（当然也可以all in one）</h3>
<h4 id="硬件准备"><a class="markdownIt-Anchor" href="#硬件准备"></a> 硬件准备</h4>
<p>每台虚拟机应包含</p>
<ol>
<li>虚机可上网</li>
<li>另外包含一张额外的网卡</li>
<li>内存尽量多（8G）</li>
<li>CPU尽量多（8 cpus）</li>
<li>controller硬盘稍微大一些</li>
</ol>
<h4 id="基本准备"><a class="markdownIt-Anchor" href="#基本准备"></a> 基本准备</h4>
<blockquote>
<p>Ubuntu16.04 + Q版本（Queens）</p>
</blockquote>
<h5 id="配置ntp"><a class="markdownIt-Anchor" href="#配置ntp"></a> 配置NTP</h5>
<h5 id="安装openstack基础包"><a class="markdownIt-Anchor" href="#安装openstack基础包"></a> 安装Openstack基础包</h5>
<ul>
<li>准备仓库</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># apt install software-properties-common</span></span><br><span class="line"><span class="comment"># add-apt-repository cloud-archive:queens</span></span><br></pre></td></tr></table></figure>
<ul>
<li>安装openstack包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt update</span><br><span class="line">$ apt upgrade <span class="comment">#经实际测试，如果用apt dist-upgrade可能会出现问题，安装的不是最新的包</span></span><br><span class="line">$ apt install python-openstackclient</span><br></pre></td></tr></table></figure>
<h4 id="controller"><a class="markdownIt-Anchor" href="#controller"></a> controller</h4>
<p>controller上需要安装的东西最多</p>
<h5 id="依赖"><a class="markdownIt-Anchor" href="#依赖"></a> 依赖</h5>
<ul>
<li>数据库: MariaDB</li>
<li>消息队列: RabbitMQ</li>
<li>服务及身份认证: Memcached</li>
<li>etcd</li>
</ul>
<h5 id="openstack服务"><a class="markdownIt-Anchor" href="#openstack服务"></a> openstack服务</h5>
<ul>
<li>认证服务: keystone</li>
<li>镜像服务: glance</li>
<li>计算服务（指计算的调度，管理，api等服务）: nova</li>
<li>网络服务（网络管理，调度等服务）: neutron</li>
<li>管理界面: horizon</li>
<li>块存储服务（可选）: cinder</li>
</ul>
<h4 id="compute"><a class="markdownIt-Anchor" href="#compute"></a> compute</h4>
<p>计算节点相对来说简单了很多</p>
<h5 id="openstack服务-2"><a class="markdownIt-Anchor" href="#openstack服务-2"></a> openstack服务</h5>
<ul>
<li>计算服务（专指计算服务）: nova-compute</li>
<li>网络服务: neutron</li>
</ul>
<p><strong>可在controller上同样起计算服务</strong></p>
<p>详细安装过程可参看<a href="https://docs.openstack.org/install-guide/openstack-services.html" target="_blank" rel="noopener">官方文档</a></p>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack安全组基于ovs的学习笔记</title>
    <url>/2019/08/08/openstack-security-group-ovs-1/</url>
    <content><![CDATA[<p>本文主要介绍Openstack的安全组在规则及其在ovs的流表中的体现。</p>
<p>实验基于openstack的stein版本，devstack安装，采用了ovs作为虚拟交换机。描述Openflow在Openstack安全组中的应用分析。实验环境以Ubuntu 18.04.3 LTS搭建</p>
<a id="more"></a>
<h2 id="openstack安全组"><a class="markdownIt-Anchor" href="#openstack安全组"></a> Openstack安全组</h2>
<p><strong>1. 安全组</strong></p>
<p>在Openstack中，安全组是做哦那个在neutron port上的一组策略，这些策略可以理解为一些防火墙的规则集合。</p>
<p><strong>2. 安全组的实现</strong></p>
<p>Openstack中的安全组的实现有以下集中：</p>
<ul>
<li>ovs + iptables + connection track</li>
<li>ovs + openflow + connection track</li>
<li>linuxbridge + iptables + connection track</li>
</ul>
<p>由于本文实验环境基于devstack（stein），因此，仅基于第二种情况进行说明</p>
<h2 id="实验准备"><a class="markdownIt-Anchor" href="#实验准备"></a> 实验准备</h2>
<p><strong>1. 创建项目及用户（非必须）</strong></p>
<p>创建一个test的project和user</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack project create --domain default --description <span class="string">"Security Group Test Project"</span> <span class="built_in">test</span></span><br><span class="line">$ openstack user create --domain default --password-prompt <span class="built_in">test</span></span><br><span class="line">$ openstack role add --project <span class="built_in">test</span> --user <span class="built_in">test</span> admin</span><br></pre></td></tr></table></figure>
<p><strong>2. 查看test租户的默认安全组下的规则</strong></p>
<p>以test用户登陆openstack的dashboard，在<strong>网络</strong> &gt; <strong>安全组</strong> 下找到default安全组，查看对应的规则</p>
<img src="/2019/08/08/openstack-security-group-ovs-1/rule_list.png" class="" title="Rule List">
<h2 id="安全组实验"><a class="markdownIt-Anchor" href="#安全组实验"></a> 安全组实验</h2>
<blockquote>
<p>需要事先创建一个虚拟机示例，默认关联default的安全组</p>
</blockquote>
<p><strong>0. 获取一些信息</strong></p>
<ul>
<li>端口ID</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack port list</span><br><span class="line">+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------------------------+--------+</span><br><span class="line">| ID                                   | Name | MAC Address       | Fixed IP Addresses                                                                                  | Status |</span><br><span class="line">+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------------------------+--------+</span><br><span class="line">| 41ca5359-2edc-4d74-8321-5883ecb618c5 |      | fa:16:3e:fa:fd:13 | ip_address=<span class="string">'192.168.233.49'</span>, subnet_id=<span class="string">'ef4d1362-24b5-4d01-8748-ffe9cc2ca2e5'</span>                       | ACTIVE |</span><br><span class="line">+--------------------------------------+------+-------------------+-----------------------------------------------------------------------------------------------------+--------+</span><br></pre></td></tr></table></figure>
<p>创建了一个ID为<code>41ca5359-2edc-4d74-8321-5883ecb618c5</code>的port，分配IP地址为<code>192.168.233.49</code></p>
<ul>
<li>接口名称</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl show</span><br><span class="line">...</span><br><span class="line">    Bridge br-int</span><br><span class="line">        Controller <span class="string">"tcp:127.0.0.1:6633"</span></span><br><span class="line">            is_connected: <span class="literal">true</span></span><br><span class="line">            ...</span><br><span class="line">            </span><br><span class="line">        Port <span class="string">"tap41ca5359-2e"</span></span><br><span class="line">            tag: 3</span><br><span class="line">            Interface <span class="string">"tap41ca5359-2e"</span></span><br><span class="line">            </span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<p>对应的创建了一个<code>tap41ca5359-2e</code>的接口</p>
<p><strong>1. 创建一条ingress的规则</strong></p>
<p>通过Dashboard在default的安全组下创建一条ingress的规则，remote-ip为199.0.0.0/24，协议为tcp，目的端口为80</p>
<ul>
<li>查看br-int流表</li>
</ul>
<blockquote>
<p>br-int下的流表非常的多，可以使用过滤规则进行匹配</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows br-int | grep 199.0.0.0</span><br><span class="line"> cookie=0xd9177c011dbdf439, duration=98.493s, table=82, n_packets=0, n_bytes=0, idle_age=98, priority=77,ct_state=+est-rel-rpl,tcp,reg5=0xe,nw_src=199.0.0.0/24,tp_dst=80 actions=output:14</span><br><span class="line"> cookie=0xd9177c011dbdf439, duration=98.493s, table=82, n_packets=0, n_bytes=0, idle_age=98, priority=77,ct_state=+new-est,tcp,reg5=0xe,nw_src=199.0.0.0/24,tp_dst=80 actions=ct(commit,zone=NXM_NX_REG6[0..15]),output:14,resubmit(,92)</span><br></pre></td></tr></table></figure>
<p>可以看到，共新增了两条流表</p>
<p><strong>3. 创建一条egress的规则</strong></p>
<blockquote>
<p>同样以remote-ip为199.0.0.0/24，协议为tcp，目的端口为80的参数创建egress规则</p>
</blockquote>
<p>查看流表看到新增了如下两条：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cookie=0xd9177c011dbdf439, duration=19.261s, table=72, n_packets=0, n_bytes=0, idle_age=19, priority=77,ct_state=+est-rel-rpl,tcp,reg5=0xe,nw_dst=199.0.0.0/24,tp_dst=80 actions=resubmit(,73)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=19.261s, table=72, n_packets=0, n_bytes=0, idle_age=19, priority=77,ct_state=+new-est,tcp,reg5=0xe,nw_dst=199.0.0.0/24,tp_dst=80 actions=resubmit(,73)</span><br></pre></td></tr></table></figure>
<p><strong>4. 流表解读</strong></p>
<p><strong>4.1 ingress</strong></p>
<ul>
<li>stpe2中的流表，分别指定了<code>tcp</code>协议，<code>nw_src</code>为<code>199.0.0.0/24</code>，<code>tp_dst</code>为<code>80</code></li>
<li>step2的action，第一条为直接从14的接口送出，第二条为重定向到了92</li>
</ul>
<p>先来看看ID为14的接口是哪个？不出所料，自然是<code>tap41ca5359-2e</code>的接口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl show br-int</span><br><span class="line">...</span><br><span class="line"> 14(tap41ca5359-2e): addr:fe:16:3e:fa:fd:13</span><br><span class="line">     config:     0</span><br><span class="line">     state:      0</span><br><span class="line">     current:    10MB-FD COPPER</span><br><span class="line">     speed: 10 Mbps now, 0 Mbps max</span><br><span class="line">     </span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<ul>
<li>table 92</li>
</ul>
<blockquote>
<p>丢弃</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cookie=0xd9177c011dbdf439, duration=3197934.551s, table=92, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br></pre></td></tr></table></figure>
<p><strong>以上可看到，源地址为<code>199.0.0.0/24</code>，目的端口为<code>80</code>的<code>TCP</code>报文大多数情况将送往<code>tap41ca5359-2e</code>的接口</strong></p>
<p><strong>4.2 egress</strong></p>
<ul>
<li>step3中的流表，则分别指定了<code>tcp</code>协议，<code>nw_dst</code>为<code>199.0.0.0/24</code>，<code>tp_dst</code>为<code>80</code></li>
<li>step3的action则送往了73的table，而73则非常复杂，又涉及到了81，91，94的table</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=73, n_packets=10, n_bytes=1345, priority=100,reg6=0x3,dl_dst=fa:16:3e:fa:fd:13 actions=load:0xe-&gt;NXM_NX_REG5[],resubmit(,81)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=73, n_packets=5, n_bytes=438, priority=90,ct_state=+new-est,ip,reg5=0xe actions=ct(commit,zone=NXM_NX_REG6[0..15]),resubmit(,91)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=73, n_packets=0, n_bytes=0, priority=90,ct_state=+new-est,ipv6,reg5=0xe actions=ct(commit,zone=NXM_NX_REG6[0..15]),resubmit(,91)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197929.613s, table=73, n_packets=0, n_bytes=0, priority=80,reg5=0x6 actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197929.613s, table=73, n_packets=0, n_bytes=0, priority=80,reg5=0x3 actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197929.613s, table=73, n_packets=0, n_bytes=0, priority=80,reg5=0x4 actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197929.613s, table=73, n_packets=0, n_bytes=0, priority=80,reg5=0x7 actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197929.613s, table=73, n_packets=0, n_bytes=0, priority=80,reg5=0x5 actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197849.617s, table=73, n_packets=5, n_bytes=446, priority=80,reg5=0x9 actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197849.617s, table=73, n_packets=2, n_bytes=180, priority=80,reg5=0x8 actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197817.084s, table=73, n_packets=11, n_bytes=778, priority=80,reg5=0xa actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197815.612s, table=73, n_packets=49080, n_bytes=5791412, priority=80,reg5=0xb actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197815.612s, table=73, n_packets=8, n_bytes=648, priority=80,reg5=0xc actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=73, n_packets=6, n_bytes=1078, priority=80,reg5=0xe actions=resubmit(,94)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197934.616s, table=73, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br></pre></td></tr></table></figure>
<ul>
<li>table 91</li>
</ul>
<blockquote>
<p>重定向到了94</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cookie=0xd9177c011dbdf439, duration=3197934.561s, table=91, n_packets=10, n_bytes=876, priority=1 actions=resubmit(,94)</span><br></pre></td></tr></table></figure>
<ul>
<li>table 94</li>
</ul>
<blockquote>
<p>正常转发</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cookie=0xd9177c011dbdf439, duration=3197934.572s, table=94, n_packets=49280, n_bytes=5803120, priority=1 actions=NORMAL</span><br></pre></td></tr></table></figure>
<ul>
<li>table 81</li>
</ul>
<blockquote>
<p>送往<code>tap41ca5359-2e</code>的接口</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=3, n_bytes=126, priority=100,arp,reg5=0xe actions=output:<span class="string">"tap41ca5359-2e"</span></span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=0, n_bytes=0, priority=100,icmp6,reg5=0xe,icmp_type=130 actions=output:<span class="string">"tap41ca5359-2e"</span></span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=0, n_bytes=0, priority=100,icmp6,reg5=0xe,icmp_type=135 actions=output:<span class="string">"tap41ca5359-2e"</span></span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=0, n_bytes=0, priority=100,icmp6,reg5=0xe,icmp_type=136 actions=output:<span class="string">"tap41ca5359-2e"</span></span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=2, n_bytes=729, priority=95,udp,reg5=0xe,tp_src=67,tp_dst=68 actions=output:<span class="string">"tap41ca5359-2e"</span></span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=0, n_bytes=0, priority=95,udp6,reg5=0xe,tp_src=547,tp_dst=546 actions=output:<span class="string">"tap41ca5359-2e"</span></span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=5, n_bytes=490, priority=90,ct_state=-trk,ip,reg5=0xe actions=ct(table=82,zone=NXM_NX_REG6[0..15])</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=0, n_bytes=0, priority=90,ct_state=-trk,ipv6,reg5=0xe actions=ct(table=82,zone=NXM_NX_REG6[0..15])</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=1305.051s, table=81, n_packets=0, n_bytes=0, priority=80,ct_state=+trk,reg5=0xe actions=resubmit(,82)</span><br><span class="line">cookie=0xd9177c011dbdf439, duration=3197934.606s, table=81, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br></pre></td></tr></table></figure>
<p><strong>由上可看到，送往<code>199.0.0.0/24</code>，目的端口为<code>80</code>的<code>TCP</code>报文大多数情况将正常转发出去</strong></p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>ovs</tag>
        <tag>openstack</tag>
      </tags>
  </entry>
  <entry>
    <title>Openstack网络——虚拟机通信实验1</title>
    <url>/2019/09/02/openstack-vm-traffic1/</url>
    <content><![CDATA[<p>Openstack中的虚拟机流量通常被分为东西向和南北向。而测试环境中可能会遇到各种流量问题，搞清楚每种流量的通路有助于出现问题后的快速定位。</p>
<p>计划将分多篇博文，掰开来详细分析openstack中的各种流量路径。</p>
<p>本文以最简单的单节点为例，介绍在同子网下，虚拟机之间相互访问的流量路径</p>
<a id="more"></a>
<h2 id="环境说明"><a class="markdownIt-Anchor" href="#环境说明"></a> 环境说明</h2>
<ul>
<li>Openstack： stein（all in one）</li>
<li>Host： Ubuntu 18.04</li>
<li>Network driver： openvswitch</li>
</ul>
<h2 id="必要准备"><a class="markdownIt-Anchor" href="#必要准备"></a> 必要准备</h2>
<ol>
<li>外部网络：MyEx</li>
<li>镜像：cirros</li>
<li>flavor： small</li>
</ol>
<h2 id="实验"><a class="markdownIt-Anchor" href="#实验"></a> 实验</h2>
<h3 id="同子网虚拟机"><a class="markdownIt-Anchor" href="#同子网虚拟机"></a> 同子网虚拟机</h3>
<h4 id="创建网络"><a class="markdownIt-Anchor" href="#创建网络"></a> 创建网络</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack network create net1</span><br><span class="line">$ openstack subnet create --network net1 --subnet-range 200.0.0.0/24 sub1</span><br></pre></td></tr></table></figure>
<h4 id="创建虚拟机"><a class="markdownIt-Anchor" href="#创建虚拟机"></a> 创建虚拟机</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack server create --flavor small --image cirros --network net1 --min 2 --max 2 vm</span><br><span class="line">$ openstack server list</span><br><span class="line">+--------------------------------------+------+--------+------------------+--------+--------+</span><br><span class="line">| ID                                   | Name | Status | Networks         | Image  | Flavor |</span><br><span class="line">+--------------------------------------+------+--------+------------------+--------+--------+</span><br><span class="line">| ba3d4162-6a4d-45dc-9b41-0aa2e2ae0c88 | vm-1 | ACTIVE | net1=200.0.0.16  | cirros | small  |</span><br><span class="line">| d349a3a1-fdae-473c-83be-ac02ab5997f3 | vm-2 | ACTIVE | net1=200.0.0.224 | cirros | small  |</span><br><span class="line">+--------------------------------------+------+--------+------------------+--------+--------+</span><br></pre></td></tr></table></figure>
<p>分别创建了：</p>
<p>vm-1: 200.0.0.16</p>
<p>vm-2: 200.0.0.224</p>
<blockquote>
<p>先确认两个虚机的连通性</p>
</blockquote>
<h2 id="发生了什么"><a class="markdownIt-Anchor" href="#发生了什么"></a> 发生了什么?</h2>
<h3 id="linux-bridge"><a class="markdownIt-Anchor" href="#linux-bridge"></a> linux bridge</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ brctl show</span><br><span class="line">bridge name          bridge id              STP enabled    interfaces</span><br><span class="line">brq459c374c-d3        8000.da9618bd3c8d    no              vxlan-6</span><br><span class="line">qbra95f52ba-a2        8000.c26ea2427d47    no              qvba95f52ba-a2</span><br><span class="line">                                                              tapa95f52ba-a2</span><br><span class="line">qbrebeae637-5c        8000.e2ef56b21ffb    no              qvbebeae637-5c</span><br><span class="line">                                                              tapebeae637-5c</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先不关注<code>brq459c374c-d3</code>的网桥</p>
</blockquote>
<h3 id="openstack"><a class="markdownIt-Anchor" href="#openstack"></a> Openstack</h3>
<p>先来记录一下openstack上的port信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack port list</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------------------------------------------+--------+</span><br><span class="line">| ID                                   | Name | MAC Address       | Fixed IP Addresses                                                         | Status |</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------------------------------------------+--------+</span><br><span class="line">| a333499b-e5ea-4658-9ec4-cc9b1942d660 |      | fa:16:3e:c7:8c:10 | ip_address=<span class="string">'192.168.0.2'</span>, subnet_id=<span class="string">'a5b25645-c5df-486b-9a49-9412eebc2e59'</span> | ACTIVE |</span><br><span class="line">| a95f52ba-a255-46a7-b3ca-2c870de30e2d |      | fa:16:3e:53:d5:50 | ip_address=<span class="string">'200.0.0.224'</span>, subnet_id=<span class="string">'690d8c09-5f55-4b0c-b673-aff967fb0765'</span> | ACTIVE |</span><br><span class="line">| e013286e-b707-4992-b9e2-4c1f77d465b1 |      | fa:16:3e:45:00:dc | ip_address=<span class="string">'200.0.0.2'</span>, subnet_id=<span class="string">'690d8c09-5f55-4b0c-b673-aff967fb0765'</span>   | ACTIVE |</span><br><span class="line">| ebeae637-5c92-4a5d-943c-27a7c3abfe1f |      | fa:16:3e:17:60:c2 | ip_address=<span class="string">'200.0.0.16'</span>, subnet_id=<span class="string">'690d8c09-5f55-4b0c-b673-aff967fb0765'</span>  | ACTIVE |</span><br><span class="line">+--------------------------------------+------+-------------------+----------------------------------------------------------------------------+--------+</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>id</th>
<th>用途</th>
<th>ip</th>
</tr>
</thead>
<tbody>
<tr>
<td>a333499b-e5</td>
<td>外部网络MyEx的DHCP port</td>
<td>192.168.0.2</td>
</tr>
<tr>
<td>a95f52ba-a2</td>
<td>vm-2</td>
<td>200.0.0.224</td>
</tr>
<tr>
<td>e013286e-b7</td>
<td>租户网络net1的DHCP port</td>
<td>200.0.0.2</td>
</tr>
<tr>
<td>ebeae637-5c</td>
<td>vm-1</td>
<td>200.0.0.16</td>
</tr>
</tbody>
</table>
<h3 id="网络接口"><a class="markdownIt-Anchor" href="#网络接口"></a> 网络接口</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip link show</span><br><span class="line">...</span><br><span class="line">45: qbra95f52ba-a2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether c2:6e:a2:42:7d:47 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># qbra95f52ba-a2: linux bridge，vm-2相关</span></span><br><span class="line">46: qvoa95f52ba-a2@qvba95f52ba-a2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master ovs-system state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 72:63:10:8c:b6:b4 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">47: qvba95f52ba-a2@qvoa95f52ba-a2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master qbra95f52ba-a2 state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether c2:6e:a2:42:7d:47 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># qvoa95f52ba-a2和qvba95f52ba-a2：veth pair</span></span><br><span class="line">48: qbrebeae637-5c: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether e2:ef:56:b2:1f:fb brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># qbrebeae637-5c： linux bridge，vm-1相关</span></span><br><span class="line">49: qvoebeae637-5c@qvbebeae637-5c: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master ovs-system state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether 92:19:d7:5f:b7:0c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">50: qvbebeae637-5c@qvoebeae637-5c: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master qbrebeae637-5c state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether e2:ef:56:b2:1f:fb brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># qvoebeae637-5c和qvbebeae637-5c：veth pair</span></span><br><span class="line">51: tapa95f52ba-a2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc fq_codel master qbra95f52ba-a2 state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether fe:16:3e:53:d5:50 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># tapa95f52ba-a2：tap接口，通过vnet方式与虚拟机vm-2相连</span></span><br><span class="line">52: tapebeae637-5c: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc fq_codel master qbrebeae637-5c state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether fe:16:3e:17:60:c2 brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># tapebeae637-5c：tap接口，通过vnet方式与虚拟机vm-1相连</span></span><br><span class="line">53: vxlan-6: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue master brq459c374c-d3 state UNKNOWN mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether da:96:18:bd:3c:8d brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># overlay接口</span></span><br><span class="line">54: brq459c374c-d3: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1450 qdisc noqueue state UP mode DEFAULT group default qlen 1000</span><br><span class="line">    link/ether da:96:18:bd:3c:8d brd ff:ff:ff:ff:ff:ff</span><br><span class="line"><span class="comment"># overlay网桥</span></span><br></pre></td></tr></table></figure>
<p>上面出现了两个<code>id</code>：<code>a95f52ba-a2</code>和<code>ebeae637-5c</code>，分别对应了openstack的两个port的<code>id</code></p>
<p>而对于同一个<code>id</code>，有4个前缀：<code>qbr</code>,<code>qvb</code>,<code>qvo</code>,<code>tap</code>:</p>
<table>
<thead>
<tr>
<th>前缀</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>qbr</td>
<td>Linux网桥</td>
</tr>
<tr>
<td>qvb</td>
<td>与qvo互为veth pair，qvb置于qbr网桥中</td>
</tr>
<tr>
<td>qvo</td>
<td>与qvo互为veth pair，qvo置于br-int的ovs网桥中</td>
</tr>
<tr>
<td>tap</td>
<td>tap接口，与虚拟机中的网卡组成veth pair</td>
</tr>
</tbody>
</table>
<h3 id="namespace"><a class="markdownIt-Anchor" href="#namespace"></a> namespace</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns list</span><br><span class="line">qdhcp-459c374c-d347-4c3d-8dca-7dbb6b403f4f (id: 0)</span><br><span class="line">qdhcp-04d375a6-7600-4a62-87ff-9d66a41d15b1 (id: 1)</span><br></pre></td></tr></table></figure>
<p>2个namespace的<code>id</code>分别对应了openstack上的两个network的<code>id</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ openstack network list</span><br><span class="line">+--------------------------------------+------+--------------------------------------+</span><br><span class="line">| ID                                   | Name | Subnets                              |</span><br><span class="line">+--------------------------------------+------+--------------------------------------+</span><br><span class="line">| 04d375a6-7600-4a62-87ff-9d66a41d15b1 | MyEx | a5b25645-c5df-486b-9a49-9412eebc2e59 |</span><br><span class="line">| 459c374c-d347-4c3d-8dca-7dbb6b403f4f | net1 | 690d8c09-5f55-4b0c-b673-aff967fb0765 |</span><br><span class="line">+--------------------------------------+------+--------------------------------------+</span><br></pre></td></tr></table></figure>
<p>namespace中：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> qdhcp-459c374c-d347-4c3d-8dca-7dbb6b403f4f ifconfig</span><br><span class="line">...</span><br><span class="line">tape013286e-b7: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 169.254.169.254  netmask 255.255.0.0  broadcast 169.254.255.255</span><br><span class="line">        inet6 fe80::f816:3eff:fe45:dc  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether fa:16:3e:45:00:dc  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 254  bytes 18301 (18.3 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 161  bytes 17139 (17.1 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line">$ ip netns <span class="built_in">exec</span> qdhcp-04d375a6-7600-4a62-87ff-9d66a41d15b1 ifconfig</span><br><span class="line">...</span><br><span class="line">tapa333499b-e5: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 169.254.169.254  netmask 255.255.0.0  broadcast 169.254.255.255</span><br><span class="line">        inet6 fe80::f816:3eff:fec7:8c10  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether fa:16:3e:c7:8c:10  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 153628  bytes 12984859 (12.9 MB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 151174  bytes 14352784 (14.3 MB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>每个namespace各有一个接口：<code>tape013286e-b7</code>和<code>tapa333499b-e5</code></p>
</li>
<li>
<p>这两个接口因为在namespace中，在<code>ip link show</code>的时候看不到。</p>
</li>
<li>
<p>其<code>id</code>也分别对应了openstack中的port的<code>id</code>，后面会看到这两个接口出现在ovs的<code>br-int</code>中</p>
</li>
</ul>
<h3 id="openvswitch"><a class="markdownIt-Anchor" href="#openvswitch"></a> openvswitch</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl show</span><br><span class="line">479f3788-7afb-48a4-accd-eb173f318715</span><br><span class="line">    ...</span><br><span class="line">    Bridge br-int</span><br><span class="line">        Controller <span class="string">"tcp:127.0.0.1:6633"</span></span><br><span class="line">            is_connected: <span class="literal">true</span></span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port int-br-ext</span><br><span class="line">            Interface int-br-ext</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=phy-br-ext&#125;</span><br><span class="line">        Port <span class="string">"tapa333499b-e5"</span></span><br><span class="line">            tag: 2</span><br><span class="line">            Interface <span class="string">"tapa333499b-e5"</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">"tape013286e-b7"</span></span><br><span class="line">            tag: 3</span><br><span class="line">            Interface <span class="string">"tape013286e-b7"</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">        Port <span class="string">"qvoebeae637-5c"</span></span><br><span class="line">            tag: 3</span><br><span class="line">            Interface <span class="string">"qvoebeae637-5c"</span></span><br><span class="line">        Port <span class="string">"qvoa95f52ba-a2"</span></span><br><span class="line">            tag: 3</span><br><span class="line">            Interface <span class="string">"qvoa95f52ba-a2"</span></span><br><span class="line">        Port patch-tun</span><br><span class="line">            Interface patch-tun</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=patch-int&#125;</span><br><span class="line">        Port int-br-provider</span><br><span class="line">            Interface int-br-provider</span><br><span class="line">                <span class="built_in">type</span>: patch</span><br><span class="line">                options: &#123;peer=phy-br-provider&#125;</span><br><span class="line">        Port br-int</span><br><span class="line">            Interface br-int</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">"2.11.0"</span></span><br></pre></td></tr></table></figure>
<p><code>br-int</code>下有4个port：<code>tapa333499b-e5</code>,<code>tape013286e-b7</code>,<code>qvoebeae637-5c</code>,<code>qvoa95f52ba-a2</code>，这4个接口在前面都有提及</p>
<table>
<thead>
<tr>
<th>port</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tapa333499b-e5</td>
<td>MyEx的dhcp相关，位于<code>qdhcp-04d375a6-76...</code>的namespace中</td>
</tr>
<tr>
<td>tape013286e-b7</td>
<td>net1的dhcp相关，位于<code>qdhcp-459c374c-d3...</code>的namespace中</td>
</tr>
<tr>
<td>qvoebeae637-5c</td>
<td>通过veth peer接口<code>qvbebeae637-5c</code>与vm-1连接</td>
</tr>
<tr>
<td>qvoa95f52ba-a2</td>
<td>通过veth peer接口<code>qvoa95f52ba-a2</code>与vm-2连接</td>
</tr>
</tbody>
</table>
<h3 id="ovs流表"><a class="markdownIt-Anchor" href="#ovs流表"></a> ovs流表</h3>
<blockquote>
<p>为了方便观察，手动删除了<code>cookie</code>和<code>duration</code>字段</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows br-int</span><br><span class="line">table=0, n_packets=0, n_bytes=0, priority=65535,vlan_tci=0x0fff/0x1fff actions=drop</span><br><span class="line">table=0, n_packets=0, n_bytes=0, priority=10,icmp6,in_port=<span class="string">"qvoebeae637-5c"</span>,icmp_type=136 actions=resubmit(,24)</span><br><span class="line">table=0, n_packets=0, n_bytes=0, priority=10,icmp6,in_port=<span class="string">"qvoa95f52ba-a2"</span>,icmp_type=136 actions=resubmit(,24)</span><br><span class="line">table=0, n_packets=1073, n_bytes=45066, priority=10,arp,in_port=<span class="string">"qvoebeae637-5c"</span> actions=resubmit(,24)</span><br><span class="line">table=0, n_packets=1072, n_bytes=45024, priority=10,arp,in_port=<span class="string">"qvoa95f52ba-a2"</span> actions=resubmit(,24)</span><br><span class="line">table=0, n_packets=3103, n_bytes=926990, priority=2,in_port=<span class="string">"int-br-provider"</span> actions=drop</span><br><span class="line">table=0, n_packets=21, n_bytes=5096, priority=2,in_port=<span class="string">"int-br-ext"</span> actions=drop</span><br><span class="line">table=0, n_packets=18494, n_bytes=1811307, priority=9,in_port=<span class="string">"qvoebeae637-5c"</span> actions=resubmit(,25)</span><br><span class="line">table=0, n_packets=18499, n_bytes=1811728, priority=9,in_port=<span class="string">"qvoa95f52ba-a2"</span> actions=resubmit(,25)</span><br><span class="line">table=0, n_packets=2654, n_bytes=849079, priority=3,in_port=<span class="string">"int-br-ext"</span>,vlan_tci=0x0000/0x1fff actions=mod_vlan_vid:2,resubmit(,60)</span><br><span class="line">table=0, n_packets=763992, n_bytes=72539656, priority=0 actions=resubmit(,60)</span><br><span class="line">table=23, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line">table=24, n_packets=0, n_bytes=0, priority=2,icmp6,in_port=<span class="string">"qvoebeae637-5c"</span>,icmp_type=136,nd_target=fe80::f816:3eff:fe17:60c2 actions=resubmit(,60)</span><br><span class="line">table=24, n_packets=0, n_bytes=0, priority=2,icmp6,in_port=<span class="string">"qvoa95f52ba-a2"</span>,icmp_type=136,nd_target=fe80::f816:3eff:fe53:d550 actions=resubmit(,60)</span><br><span class="line">table=24, n_packets=1073, n_bytes=45066, priority=2,arp,in_port=<span class="string">"qvoebeae637-5c"</span>,arp_spa=200.0.0.16 actions=resubmit(,25)</span><br><span class="line">table=24, n_packets=1072, n_bytes=45024, priority=2,arp,in_port=<span class="string">"qvoa95f52ba-a2"</span>,arp_spa=200.0.0.224 actions=resubmit(,25)</span><br><span class="line">table=24, n_packets=0, n_bytes=0, priority=0 actions=drop</span><br><span class="line">table=25, n_packets=19555, n_bytes=1855533, priority=2,in_port=<span class="string">"qvoebeae637-5c"</span>,dl_src=fa:16:3e:17:60:c2 actions=resubmit(,60)</span><br><span class="line">table=25, n_packets=19560, n_bytes=1855982, priority=2,in_port=<span class="string">"qvoa95f52ba-a2"</span>,dl_src=fa:16:3e:53:d5:50 actions=resubmit(,60)</span><br><span class="line">table=60, n_packets=963419, n_bytes=92070282, priority=3 actions=NORMAL</span><br></pre></td></tr></table></figure>
<blockquote>
<p>先忽略icmp6的流表</p>
</blockquote>
<p><strong>table=0</strong></p>
<ul>
<li>in_port为<code>qvoebeae637-5c</code>和<code>qvoa95f52ba-a2</code>的arp报文送往table=24</li>
<li>in_port为<code>qvoebeae637-5c</code>和<code>qvoa95f52ba-a2</code>的其他报文送往table=25</li>
<li>其他报文送往table=60</li>
</ul>
<p><strong>table=24</strong></p>
<ul>
<li>in_port为<code>qvoebeae637-5c</code>和<code>qvoa95f52ba-a2</code>的arp报文，arp_spa分别是<code>200.0.0.224</code>和<code>200.0.0.16</code>的报文，送往table=25</li>
</ul>
<p><strong>table=25</strong></p>
<ul>
<li>in_port为<code>qvoebeae637-5c</code>和<code>qvoa95f52ba-a2</code>的报文，目的mac分别为<code>fa:16:3e:17:60:c2</code>和<code>fa:16:3e:53:d5:50</code>的报文，送往table=60</li>
</ul>
<p><strong>table=60</strong></p>
<ul>
<li>正常转发</li>
</ul>
<blockquote>
<p>通过上面一系列的流表，in_port为<code>qvoebeae637-5c</code>和<code>qvoa95f52ba-a2</code>的报文基本上都会在<code>br-int</code>上正常转发</p>
</blockquote>
<h3 id="梳理一下"><a class="markdownIt-Anchor" href="#梳理一下"></a> 梳理一下</h3>
<img src="/2019/09/02/openstack-vm-traffic1/same_subnet.png" class="" title="same_subnet">
<ol>
<li>vm通过vnet与一个tap接口相连</li>
<li>tap接口与qvbxxx接口置于一个linux网桥中</li>
<li>qvbxxx的veth peer置于br-int的ovs网桥中</li>
<li>dhcp服务位于linux namespace中，使用了一个tap接口，而此tap接口同时位于br-int的ovs网桥中</li>
</ol>
<h2 id="报文跟踪"><a class="markdownIt-Anchor" href="#报文跟踪"></a> 报文跟踪</h2>
<h3 id="vm之间互通"><a class="markdownIt-Anchor" href="#vm之间互通"></a> vm之间互通</h3>
<h4 id="分析"><a class="markdownIt-Anchor" href="#分析"></a> 分析</h4>
<p>根据上面的图我们可以看到，vm-1访问vm-2的流量路径为：</p>
<ol>
<li>tapebeae637-5c</li>
<li>qbrebeae637-5c</li>
<li>qvbebeae637-5c</li>
<li>qvoebeae637-5c</li>
<li>br-int</li>
<li>qvoa95f52ba-a2</li>
<li>qvba95f52ba-a2</li>
<li>qbra95f52ba-a2</li>
<li>tapa95f52ba-a2</li>
</ol>
<h4 id="抓包"><a class="markdownIt-Anchor" href="#抓包"></a> 抓包</h4>
<p>实际上这个抓包很无聊，因为每个上面看到的报文都是一样的，这里只列举其中一个的结果</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tcpdump -i qvoebeae637-5c</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on qvoebeae637-5c, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">15:42:19.320342 IP 200.0.0.224 &gt; 200.0.0.16: ICMP <span class="built_in">echo</span> request, id 48897, seq 20449, length 64</span><br><span class="line">15:42:19.321219 IP 200.0.0.16 &gt; 200.0.0.224: ICMP <span class="built_in">echo</span> reply, id 48897, seq 20449, length 64</span><br><span class="line">15:42:20.321525 IP 200.0.0.224 &gt; 200.0.0.16: ICMP <span class="built_in">echo</span> request, id 48897, seq 20450, length 64</span><br><span class="line">15:42:20.322566 IP 200.0.0.16 &gt; 200.0.0.224: ICMP <span class="built_in">echo</span> reply, id 48897, seq 20450, length 64</span><br></pre></td></tr></table></figure>
<h3 id="vm-1访问dhcp的port"><a class="markdownIt-Anchor" href="#vm-1访问dhcp的port"></a> vm-1访问dhcp的port</h3>
<h4 id="分析-2"><a class="markdownIt-Anchor" href="#分析-2"></a> 分析</h4>
<p>而访问dhcp的通路，前面到达br-int的报文都一样，到了br-int后，会到达对应的namespace中</p>
<p><strong>1. 在vm-1上ping 200.0.0.2</strong></p>
<p><strong>2. 在ovs中抓包</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-tcpdump -i tape013286e-b7</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on ovsmi644603, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:00:35.469101 IP6 :: &gt; ff02::16: HBH ICMP6, multicast listener report v2, 1 group record(s), length 28</span><br><span class="line">16:00:35.552469 IP 200.0.0.16 &gt; 200.0.0.2: ICMP <span class="built_in">echo</span> request, id 48129, seq 480, length 64</span><br><span class="line">16:00:35.552507 IP 200.0.0.2 &gt; 200.0.0.16: ICMP <span class="built_in">echo</span> reply, id 48129, seq 480, length 64</span><br></pre></td></tr></table></figure>
<p><strong>3. 在namespace中抓包</strong></p>
<blockquote>
<p>注意，在namespace中抓包，报文信息可能不会及时打印在屏幕上</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> qdhcp-459c374c-d347-4c3d-8dca-7dbb6b403f4f tcpdump -i tape013286e-b7</span><br><span class="line">tcpdump: verbose output suppressed, use -v or -vv <span class="keyword">for</span> full protocol decode</span><br><span class="line">listening on tape013286e-b7, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class="line">16:02:00.643387 IP 200.0.0.16 &gt; 200.0.0.2: ICMP <span class="built_in">echo</span> request, id 48129, seq 565, length 64</span><br><span class="line">16:02:00.643461 IP 200.0.0.2 &gt; 200.0.0.16: ICMP <span class="built_in">echo</span> reply, id 48129, seq 565, length 64</span><br></pre></td></tr></table></figure>
<h2 id="more"><a class="markdownIt-Anchor" href="#more"></a> More</h2>
<p>你或许已经发现了，在namespace中的接口的IP为<code>169.254.169.254</code>，这个地址是干嘛的？那么<code>200.0.0.2</code>到底在哪儿呢？</p>
<h3 id="169254169254"><a class="markdownIt-Anchor" href="#169254169254"></a> 169.254.169.254</h3>
<p>在openstack中，你会经常看到这个IP地址，它是metadata service的IP</p>
<p>大多数cloud os实例启动时，都会向这个IP地址发起请求，获取一些信息，如以下实例启动日志中，获取<code>public-keys</code>和<code>user-data</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Starting network...</span><br><span class="line">udhcpc (v1.23.2) started</span><br><span class="line">Sending discover...</span><br><span class="line">Sending select <span class="keyword">for</span> 200.0.0.224...</span><br><span class="line">Lease of 200.0.0.224 obtained, lease time 86400</span><br><span class="line">route: SIOCADDRT: File exists</span><br><span class="line">WARN: failed: route add -net <span class="string">"0.0.0.0/0"</span> gw <span class="string">"200.0.0.1"</span></span><br><span class="line">checking http://169.254.169.254/2009-04-04/instance-id</span><br><span class="line">failed 1/20: up 24.66. request failed</span><br><span class="line">successful after 2/20 tries: up 37.29. iid=i-00000021</span><br><span class="line">failed to get http://169.254.169.254/2009-04-04/meta-data/public-keys</span><br><span class="line">warning: no ec2 metadata <span class="keyword">for</span> public-keys</span><br><span class="line">failed to get http://169.254.169.254/2009-04-04/user-data</span><br><span class="line">warning: no ec2 metadata <span class="keyword">for</span> user-data</span><br></pre></td></tr></table></figure>
<h3 id="200002在哪儿"><a class="markdownIt-Anchor" href="#200002在哪儿"></a> 200.0.0.2在哪儿？</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ps -aux | grep dnsmasq</span><br><span class="line">...</span><br><span class="line">nobody    3449  0.0  0.0  53332  2588 ?        S    09:49   0:00 dnsmasq --no-hosts --no-resolv --pid-file=/var/lib/neutron/dhcp/459c374c-d347-4c3d-8dca-7dbb6b403f4f/pid --dhcp-hostsfile=/var/lib/neutron/dhcp/459c374c-d347-4c3d-8dca-7dbb6b403f4f/host --addn-hosts=/var/lib/neutron/dhcp/459c374c-d347-4c3d-8dca-7dbb6b403f4f/addn_hosts --dhcp-optsfile=/var/lib/neutron/dhcp/459c374c-d347-4c3d-8dca-7dbb6b403f4f/opts --dhcp-leasefile=/var/lib/neutron/dhcp/459c374c-d347-4c3d-8dca-7dbb6b403f4f/leases --dhcp-match=<span class="built_in">set</span>:ipxe,175 --dhcp-userclass=<span class="built_in">set</span>:ipxe6,iPXE --<span class="built_in">local</span>-service --<span class="built_in">bind</span>-interfaces --dhcp-range=<span class="built_in">set</span>:tag0,200.0.0.0,static,255.255.255.0,86400s --dhcp-option-force=option:mtu,1450 --dhcp-lease-max=256 --conf-file= --domain=openstacklocal</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>--dhcp-leasefile</code>指向了<code>/var/lib/neutron/dhcp/459c374c-d347-4c3d-8dca-7dbb6b403f4f/leases</code>，这个文件记录了dhcp分配的IP地址：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ cat /var/lib/neutron/dhcp/459c374c-d347-4c3d-8dca-7dbb6b403f4f/leases</span><br><span class="line">1567498384 fa:16:3e:17:60:c2 200.0.0.16 host-200-0-0-16 01:fa:16:3e:17:60:c2</span><br><span class="line">1567475691 fa:16:3e:53:d5:50 200.0.0.224 host-200-0-0-224 01:fa:16:3e:53:d5:50</span><br><span class="line">1567475394 fa:16:3e:45:00:dc 200.0.0.2 host-200-0-0-2 *</span><br></pre></td></tr></table></figure>
<p><code>200.0.0.2</code>的mac地址是<code>fa:16:3e:45:00:dc</code>，而这个mac正是<code>tape013286e-b7</code>的物理地址</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ip netns <span class="built_in">exec</span> qdhcp-459c374c-d347-4c3d-8dca-7dbb6b403f4f ifconfig</span><br><span class="line">...</span><br><span class="line">tape013286e-b7: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1450</span><br><span class="line">        inet 169.254.169.254  netmask 255.255.0.0  broadcast 169.254.255.255</span><br><span class="line">        inet6 fe80::f816:3eff:fe45:dc  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">        ether fa:16:3e:45:00:dc  txqueuelen 1000  (Ethernet)</span><br><span class="line">        RX packets 1639  bytes 130817 (130.8 KB)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 1546  bytes 149118 (149.1 KB)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br></pre></td></tr></table></figure>
<h2 id="小结"><a class="markdownIt-Anchor" href="#小结"></a> 小结</h2>
<p>在单节点状况下，同子网下的虚拟机相互访问，是一个非常简单的路径。</p>
<p>通过tap接口、veth pair、linux网桥、ovs网桥以及ovs流表来实现了流量通路。</p>
]]></content>
      <categories>
        <category>openstack</category>
      </categories>
      <tags>
        <tag>linux</tag>
        <tag>openstack</tag>
        <tag>neutron</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu16.04安装Open vSwitch</title>
    <url>/2018/05/30/ovs-install/</url>
    <content><![CDATA[<h3 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h3>
<ul>
<li>获取安装包</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">git clone https:&#x2F;&#x2F;github.com&#x2F;openvswitch&#x2F;ovs.git</span><br></pre></td></tr></table></figure>
<ul>
<li>安装必要的依赖</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">apt install autoconf libtool make libssl-dev libcap-ng-dev</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h3 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h3>
<ul>
<li>当使用源代码时，需要自己创建<code>configure</code>脚本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;boot.sh</span><br></pre></td></tr></table></figure>
<ul>
<li>配置并开启内核模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ .&#x2F;configure --prefix&#x3D;&#x2F;usr --localstatedir&#x3D;&#x2F;var --sysconfdir&#x3D;&#x2F;etc --with-linux&#x3D;&#x2F;lib&#x2F;modules&#x2F;$(uname -r)&#x2F;build</span><br></pre></td></tr></table></figure>
<ul>
<li>安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ make</span><br><span class="line">$ make install</span><br></pre></td></tr></table></figure>
<ul>
<li>安装内核模块</li>
</ul>
<p>该步骤可能会报错，请参看后文</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ make modules_install</span><br></pre></td></tr></table></figure>
<p>官方安装文档中提到，你有可能之前已经安装了ovs的模块，为了确保使用的是你刚才编译的，则需要在<code>/etc/depmod.d/</code>中添加如下内容</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ config_file&#x3D;&quot;&#x2F;etc&#x2F;depmod.d&#x2F;openvswitch.conf&quot;</span><br><span class="line">$ for module in datapath&#x2F;linux&#x2F;*.ko; do</span><br><span class="line">   modname&#x3D;&quot;$(basename $&#123;module&#125;)&quot;</span><br><span class="line">   echo &quot;override $&#123;modname%.ko&#125; * extra&quot; &gt;&gt; &quot;$config_file&quot;</span><br><span class="line">   echo &quot;override $&#123;modname%.ko&#125; * weak-updates&quot; &gt;&gt; &quot;$config_file&quot;</span><br><span class="line">   done</span><br><span class="line">$ depmod -a</span><br></pre></td></tr></table></figure>
<ul>
<li>加载内核模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ &#x2F;sbin&#x2F;modprobe openvswitch</span><br></pre></td></tr></table></figure>
<ul>
<li>验证</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ &#x2F;sbin&#x2F;lsmod | grep openvswitch</span><br><span class="line">openvswitch           303104  0</span><br><span class="line">tunnel6                16384  1 openvswitch</span><br><span class="line">nf_nat_ipv6            16384  1 openvswitch</span><br><span class="line">nf_defrag_ipv6         36864  2 openvswitch,nf_conntrack_ipv6</span><br><span class="line">nf_nat_ipv4            16384  2 openvswitch,iptable_nat</span><br><span class="line">nf_nat                 28672  6 nf_nat_redirect,openvswitch,nf_nat_ipv4,nf_nat_ipv6,xt_nat,nf_nat_masquerade_ipv4</span><br><span class="line">nf_conntrack          106496  11 xt_CT,openvswitch,nf_nat,nf_nat_ipv4,nf_nat_ipv6,xt_conntrack,nf_nat_masquerade_ipv4,nf_conntrack_netlink,xt_connmark,nf_conntrack_ipv4,nf_conntrack_ipv6</span><br><span class="line">libcrc32c              16384  2 raid456,openvswitch</span><br></pre></td></tr></table></figure>
<h3 id="启动服务"><a class="markdownIt-Anchor" href="#启动服务"></a> 启动服务</h3>
<p>官方说明中提到有一个<code>ovs-ctl</code>的命令，然而，我安装完之后并没有这个命令。可能官方文档比较老了吧。</p>
<h4 id="创建必要的目录"><a class="markdownIt-Anchor" href="#创建必要的目录"></a> 创建必要的目录</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ mkdir -p &#x2F;etc&#x2F;openvswitch</span><br><span class="line">$ mkdir -p &#x2F;var&#x2F;log&#x2F;openvswitch</span><br><span class="line">$ mkdir -p &#x2F;var&#x2F;run&#x2F;openvswitch</span><br></pre></td></tr></table></figure>
<h4 id="配置ovsdb-server"><a class="markdownIt-Anchor" href="#配置ovsdb-server"></a> 配置ovsdb-server</h4>
<ul>
<li>从源文件目录创建<code>conf.db</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ovs$ ovsdb-tool create &#x2F;etc&#x2F;openvswitch&#x2F;conf.db \</span><br><span class="line">    vswitchd&#x2F;vswitch.ovsschema</span><br></pre></td></tr></table></figure>
<ul>
<li>配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ovsdb-server --remote&#x3D;punix:&#x2F;var&#x2F;run&#x2F;openvswitch&#x2F;db.sock \</span><br><span class="line">    --remote&#x3D;db:Open_vSwitch,Open_vSwitch,manager_options \</span><br><span class="line">    --private-key&#x3D;db:Open_vSwitch,SSL,private_key \</span><br><span class="line">    --certificate&#x3D;db:Open_vSwitch,SSL,certificate \</span><br><span class="line">    --bootstrap-ca-cert&#x3D;db:Open_vSwitch,SSL,ca_cert \</span><br><span class="line">    --pidfile --detach --log-file</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化数据库</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ovs-vsctl --no-wait init</span><br></pre></td></tr></table></figure>
<h4 id="启动ovs进程"><a class="markdownIt-Anchor" href="#启动ovs进程"></a> 启动ovs进程</h4>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">ovs-vswitchd --pidfile --detach --log-file</span><br></pre></td></tr></table></figure>
<h3 id="验证"><a class="markdownIt-Anchor" href="#验证"></a> 验证</h3>
<ul>
<li>创建bridge</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl add-br br0</span><br></pre></td></tr></table></figure>
<ul>
<li>为br0添加接口</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl add-port br0 eth1</span><br></pre></td></tr></table></figure>
<ul>
<li>查看配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl show</span><br></pre></td></tr></table></figure>
<h3 id="问题及解决"><a class="markdownIt-Anchor" href="#问题及解决"></a> 问题及解决</h3>
<p>安装内核模块时出现如下错误，<strong>忽略即可</strong>（我还以为很严重，搜了一阵，发现不用管）</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ make modules_install</span><br><span class="line">cd datapath&#x2F;linux &amp;&amp; make modules_install</span><br><span class="line">make[1]: Entering directory &#39;&#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#39;</span><br><span class="line">make -C &#x2F;lib&#x2F;modules&#x2F;4.4.0-127-generic&#x2F;build M&#x3D;&#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux modules_install</span><br><span class="line">make[2]: Entering directory &#39;&#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-127-generic&#39;</span><br><span class="line">  INSTALL &#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#x2F;openvswitch.ko</span><br><span class="line">At main.c:222:</span><br><span class="line">- SSL error:02001002:system library:fopen:No such file or directory: bss_file.c:175</span><br><span class="line">- SSL error:2006D080:BIO routines:BIO_new_file:no such file: bss_file.c:178</span><br><span class="line">sign-file: certs&#x2F;signing_key.pem: No such file or directory</span><br><span class="line">  INSTALL &#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#x2F;vport-geneve.ko</span><br><span class="line">At main.c:222:</span><br><span class="line">- SSL error:02001002:system library:fopen:No such file or directory: bss_file.c:175</span><br><span class="line">- SSL error:2006D080:BIO routines:BIO_new_file:no such file: bss_file.c:178</span><br><span class="line">sign-file: certs&#x2F;signing_key.pem: No such file or directory</span><br><span class="line">  INSTALL &#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#x2F;vport-gre.ko</span><br><span class="line">At main.c:222:</span><br><span class="line">- SSL error:02001002:system library:fopen:No such file or directory: bss_file.c:175</span><br><span class="line">- SSL error:2006D080:BIO routines:BIO_new_file:no such file: bss_file.c:178</span><br><span class="line">sign-file: certs&#x2F;signing_key.pem: No such file or directory</span><br><span class="line">  INSTALL &#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#x2F;vport-lisp.ko</span><br><span class="line">At main.c:222:</span><br><span class="line">- SSL error:02001002:system library:fopen:No such file or directory: bss_file.c:175</span><br><span class="line">- SSL error:2006D080:BIO routines:BIO_new_file:no such file: bss_file.c:178</span><br><span class="line">sign-file: certs&#x2F;signing_key.pem: No such file or directory</span><br><span class="line">  INSTALL &#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#x2F;vport-stt.ko</span><br><span class="line">At main.c:222:</span><br><span class="line">- SSL error:02001002:system library:fopen:No such file or directory: bss_file.c:175</span><br><span class="line">- SSL error:2006D080:BIO routines:BIO_new_file:no such file: bss_file.c:178</span><br><span class="line">sign-file: certs&#x2F;signing_key.pem: No such file or directory</span><br><span class="line">  INSTALL &#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#x2F;vport-vxlan.ko</span><br><span class="line">At main.c:222:</span><br><span class="line">- SSL error:02001002:system library:fopen:No such file or directory: bss_file.c:175</span><br><span class="line">- SSL error:2006D080:BIO routines:BIO_new_file:no such file: bss_file.c:178</span><br><span class="line">sign-file: certs&#x2F;signing_key.pem: No such file or directory</span><br><span class="line">  DEPMOD  4.4.0-127-generic</span><br><span class="line">make[2]: Leaving directory &#39;&#x2F;usr&#x2F;src&#x2F;linux-headers-4.4.0-127-generic&#39;</span><br><span class="line">depmod &#96;sed -n &#39;s&#x2F;#define UTS_RELEASE &quot;\([^&quot;]*\)&quot;&#x2F;\1&#x2F;p&#39; &#x2F;lib&#x2F;modules&#x2F;4.4.0-127-generic&#x2F;build&#x2F;include&#x2F;generated&#x2F;utsrelease.h&#96;</span><br><span class="line">make[1]: Leaving directory &#39;&#x2F;root&#x2F;ovs&#x2F;datapath&#x2F;linux&#39;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>ovs</tag>
      </tags>
  </entry>
  <entry>
    <title>OpenvSwitch学习笔记1</title>
    <url>/2018/09/21/ovs-study-overview/</url>
    <content><![CDATA[<h2 id="功能支持"><a class="markdownIt-Anchor" href="#功能支持"></a> 功能支持</h2>
<ol>
<li>VLAN with trunk and access ports</li>
<li>绑定NIC(with/without LAC)</li>
<li>可见性：NetFlow, sFlow®, and mirroring</li>
<li>QoS</li>
<li>Geneve, GRE, VXLAN, STT, and LISP 隧道</li>
<li>连接故障管理</li>
<li>openflow 1.0及其扩展</li>
<li>使用Linux内核进行高性能转发</li>
</ol>
<a id="more"></a>
<h2 id="主要组成部分"><a class="markdownIt-Anchor" href="#主要组成部分"></a> 主要组成部分</h2>
<ul>
<li>
<p>ovs-vswitchd: 实现交换功能的守护进程，与Linux内核模块实现flow-based switching</p>
</li>
<li>
<p>ovsdb-server: 用以保存ovs配置信息的轻量级的数据库</p>
</li>
<li>
<p>ovs-dpctl: 用以配置交换机内核模块的工具</p>
</li>
<li>
<p>ovs-vsctl: 查看和更新ovs配置信息的工具</p>
</li>
<li>
<p>ovs-ofctl: 配置和查看OpenFlow的控制和交换。主要用来操作OpenFlow流表</p>
</li>
</ul>
<h2 id="场景"><a class="markdownIt-Anchor" href="#场景"></a> 场景</h2>
<p>多服务器虚拟化部署场景</p>
<ul>
<li>高动态的end-points</li>
<li>维护的是逻辑抽象</li>
<li>状态迁移</li>
<li>响应网络动态修改</li>
<li>维护逻辑标签</li>
</ul>
<h3 id="包处理流程"><a class="markdownIt-Anchor" href="#包处理流程"></a> 包处理流程</h3>
<img src="/2018/09/21/ovs-study-overview/ovs-arch.png" class="" title="arch">
<p>如上图</p>
<ol>
<li>当包被从物理网卡上收到之后，如果是第一次收到包，ovs的kernel datapath不知道该如何处理，于是，将其送往ovs-vswitchd。</li>
<li>ovs-vswitchd决定这个包该如何处理之后，回送到kernel datapath</li>
<li>kernel datapath根据ovs-vswitchd执行相应的动作，并缓存这个动作</li>
<li>当再次收到相关包之后，kernel datapath已经存在之前缓存好的动作，则直接执行该动作</li>
</ol>
<h3 id="包处理流程-2"><a class="markdownIt-Anchor" href="#包处理流程-2"></a> 包处理流程</h3>
<img src="/2018/09/21/ovs-study-overview/ovs-module.png" class="" title="module">
<ol>
<li>因为Flow table在内核中有一份，当从物理网卡收到包后，通过key查找内核中的flow table，即可以得到action，然后执行action</li>
<li>如果没有查找到，则通过upcall调用，将数据包以netlink协议上传到vswitchd</li>
<li>vswitchd将数据包在ovsdb中进行查表匹配，若能匹配，则转到第五步</li>
<li>若不能匹配，则通过 OpenFlow协议与控制器通信，控制器下发流表项，Vswitchd解析流表项得到相应的动作，同时将流表存入ovsdb。</li>
<li>将匹配的流表项通过netlink下发到内核的Flow-table中</li>
<li>通过reinject，使用netlink将包重新送回内核</li>
<li>匹配流表项并根据相应的动作执行</li>
</ol>
]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>ovs</tag>
        <tag>network</tag>
        <tag>openvswitch</tag>
      </tags>
  </entry>
  <entry>
    <title>pyenv使用笔记</title>
    <url>/2019/02/05/pyenv-notebook/</url>
    <content><![CDATA[<p>OSX上的python版本纷繁复杂。</p>
<ul>
<li>有系统自带的: /System/Library/Frameworks/Python.framework/Versions/</li>
<li>有后来安装的: /Library/Frameworks/Python.framework/Versions/</li>
</ul>
<a id="more"></a>
<p>经常搞不清楚用的是哪里的python。遇到要升级python版本，又提心吊胆的怕把系统的那个给搞挂了。于是，便试着用pyenv来管理版本</p>
<h2 id="关于pyenv"><a class="markdownIt-Anchor" href="#关于pyenv"></a> 关于Pyenv</h2>
<blockquote>
<p>pyenv是Python版本管理工具，能够使你轻松的在多个python版本之间进行切换</p>
</blockquote>
<ul>
<li>
<p>pyenv当前在<a href="https://github.com/pyenv/pyenv" target="_blank" rel="noopener">github</a>上有14k的关注量</p>
</li>
<li>
<p>安装说明参看github上的<a href="https://github.com/pyenv/pyenv#installation" target="_blank" rel="noopener">安装文档</a></p>
</li>
</ul>
<h2 id="常用命令"><a class="markdownIt-Anchor" href="#常用命令"></a> 常用命令</h2>
<p>使用<code>pyenv commands</code>可以查看所有命令或者通过<code>pyenv -h</code>来查看常用命令</p>
<h3 id="版本管理"><a class="markdownIt-Anchor" href="#版本管理"></a> 版本管理</h3>
<h4 id="查看已安装的python版本"><a class="markdownIt-Anchor" href="#查看已安装的python版本"></a> 查看已安装的python版本</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv versions</span><br><span class="line">* system (<span class="built_in">set</span> by /Users/xxx/.pyenv/version)</span><br><span class="line">  3.7.0</span><br></pre></td></tr></table></figure>
<h4 id="查看可以安装的版本"><a class="markdownIt-Anchor" href="#查看可以安装的版本"></a> 查看可以安装的版本</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv install -l</span><br><span class="line">Available versions:</span><br><span class="line">  2.1.3</span><br><span class="line">  2.2.3</span><br><span class="line">  ...</span><br><span class="line">  stackless-3.5.4</span><br></pre></td></tr></table></figure>
<p>可以看到，可安装的版本有python2, python3, activepython, anaconda, ironpython, jython, pypy, stackless, etc.</p>
<h4 id="安装指定版本"><a class="markdownIt-Anchor" href="#安装指定版本"></a> 安装指定版本</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv install 2.7.15</span><br><span class="line">python-build: use openssl from homebrew</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">Installing Python-2.7.15...</span><br><span class="line">python-build: use readline from homebrew</span><br><span class="line">Installed Python-2.7.15 to /Users/xxx/.pyenv/versions/2.7.15</span><br></pre></td></tr></table></figure>
<p><strong>注</strong>：Mac上安装可能会遇到<code>The Python zlib extension was not compiled. Missing the zlib?</code>的错误，可以尝试<code>CFLAGS=&quot;-I$(xcrun --show-sdk-path)/usr/include&quot; pyenv install 2.7.15</code></p>
<p><em>更多错误，可查看项目的wiki中的<a href="https://github.com/pyenv/pyenv/wiki/Common-build-problems" target="_blank" rel="noopener">常见问题</a></em></p>
<blockquote>
<p>安装完毕一个python版本后，需要执行<code>pyenv rehash</code>来更新后，才能看到已安装的版本</p>
</blockquote>
<h3 id="优先级"><a class="markdownIt-Anchor" href="#优先级"></a> 优先级</h3>
<p>可以为当前目录、当前shell以及全局进行不同的python版本定义</p>
<p>遵循<strong>shell&gt;local&gt;global</strong>的优先级顺序</p>
<h4 id="设置版本"><a class="markdownIt-Anchor" href="#设置版本"></a> 设置版本</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv global 2.7.15 <span class="comment">#设置全局版本，版本信息记录在~/.pyenv/version</span></span><br><span class="line">$ pyenv <span class="built_in">local</span> 3.7.0 <span class="comment">#设置当前目录的python版本，将在当前目录生成.python-version文件</span></span><br></pre></td></tr></table></figure>
<ul>
<li>当需要为一个目录设置特定的python版本时，可以先进入该目录下执行<code>pyenv local xxx</code></li>
<li>当需要为该目录下的一个子目录设置特定的python版本，可进入该子目录设置local</li>
<li>设置完毕后，会在响应的目录下生成<code>.python-version</code>的文件</li>
<li>使用时，将从当前目录开始查找，如果不存在<code>.python-version</code>文件，则向上一级查找，直到根目录为止</li>
<li>如果到跟目录任然没有查找到，则使用global的设置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv shell 3.6.0 <span class="comment">#为当前shell设置python版本，将通过环境变量的方式设置</span></span><br><span class="line">$ env | grep PYENV_VERSION</span><br><span class="line">PYENV_VERSION=2.7.15</span><br><span class="line">$ pyenv shell --<span class="built_in">unset</span> <span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="virtualenv"><a class="markdownIt-Anchor" href="#virtualenv"></a> virtualenv</h3>
<p>默认情况下，安装pyenv后会安装<strong>pyenv-virtualenv</strong>的插件，可以通过<code>pyenv virtualenv</code>创建虚拟环境</p>
<h4 id="查看已有的virtualenv"><a class="markdownIt-Anchor" href="#查看已有的virtualenv"></a> 查看已有的virtualenv</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv virtualenvs</span><br><span class="line">  3.7.0/envs/common3 (created from /Users/abc/.pyenv/versions/3.7.0)</span><br><span class="line">  common3 (created from /Users/abc/.pyenv/versions/3.7.0)</span><br></pre></td></tr></table></figure>
<h4 id="创建virtualenv"><a class="markdownIt-Anchor" href="#创建virtualenv"></a> 创建virtualenv</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv virtualenv 2.7.15 my2.7.15</span><br><span class="line">Collecting virtualenv</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/8f/f1/c0b069ca6cb44f9681715232e6d3d65c75866dd231c5e4a88e80a46634bb/virtualenv-16.3.0-py2.py3-none-any.whl (2.0MB)</span><br><span class="line">    100% |████████████████████████████████| 2.0MB 117kB/s</span><br><span class="line">Requirement already satisfied: setuptools&gt;=18.0.0 <span class="keyword">in</span> ./.pyenv/versions/2.7.15/lib/python2.7/site-packages (from virtualenv) (39.0.1)</span><br><span class="line">Installing collected packages: virtualenv</span><br><span class="line">Successfully installed virtualenv-16.3.0</span><br><span class="line">New python executable <span class="keyword">in</span> /Users/abc/.pyenv/versions/2.7.15/envs/my2.7.15/bin/python2.7</span><br><span class="line">Also creating executable <span class="keyword">in</span> /Users/abc/.pyenv/versions/2.7.15/envs/my2.7.15/bin/python</span><br><span class="line">Installing setuptools, pip, wheel...</span><br><span class="line"><span class="keyword">done</span>.</span><br><span class="line">Requirement already satisfied: setuptools <span class="keyword">in</span> /Users/abc/.pyenv/versions/2.7.15/envs/my2.7.15/lib/python2.7/site-packages</span><br><span class="line">Requirement already satisfied: pip <span class="keyword">in</span> /Users/abc/.pyenv/versions/2.7.15/envs/my2.7.15/lib/python2.7/site-packages</span><br><span class="line"></span><br><span class="line">$ pyenv virtualenvs</span><br><span class="line">  2.7.15/envs/my2.7.15 (created from /Users/abc/.pyenv/versions/2.7.15)</span><br><span class="line">  3.7.0/envs/common3 (created from /Users/abc/.pyenv/versions/3.7.0)</span><br><span class="line">  common3 (created from /Users/abc/.pyenv/versions/3.7.0)</span><br><span class="line">  my2.7.15 (created from /Users/abc/.pyenv/versions/2.7.15)</span><br></pre></td></tr></table></figure>
<h4 id="active-deactive"><a class="markdownIt-Anchor" href="#active-deactive"></a> active &amp; deactive</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv activate my2.7.15</span><br><span class="line">(my2.7.15) $</span><br><span class="line">(my2.7.15) $ pyenv deactivate</span><br></pre></td></tr></table></figure>
<h4 id="删除virtualenv"><a class="markdownIt-Anchor" href="#删除virtualenv"></a> 删除virtualenv</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ pyenv uninstall my2.7.15</span><br><span class="line">pyenv-virtualenv: remove /Users/abc/.pyenv/versions/2.7.15/envs/my2.7.15? Y</span><br></pre></td></tr></table></figure>
<p><strong>Have Fun</strong> 😄</p>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>python virtenv环境搭建</title>
    <url>/2018/05/07/python-virtenv/</url>
    <content><![CDATA[<p>近期由于组内测试框架更新频繁，且由于框架采用了插件形式，安装包很多。当使用同一台服务器来安装时，可能会导致生产环境破坏。为此，必须采用virtenv方式。</p>
<p>virtualenv的环境建立并不复杂，但每次都需要去查一番。特此记录</p>
<a id="more"></a>
<h4 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h4>
<p>安装virtualenv</p>
<ul>
<li>python2.7</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip install virtualenv</span><br></pre></td></tr></table></figure>
<ul>
<li>python3</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">pip3 install virtualenv</span><br></pre></td></tr></table></figure>
<h4 id="使用"><a class="markdownIt-Anchor" href="#使用"></a> 使用</h4>
<ul>
<li>创建工作目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@vm1:/home/<span class="built_in">test</span><span class="comment"># mkdir myproject</span></span><br><span class="line">root@vm1:/home/<span class="built_in">test</span><span class="comment"># cd myproject</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建独立的python运行环境</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@vm1:/home/<span class="built_in">test</span><span class="comment"># virtualenv venv</span></span><br><span class="line">New python executable <span class="keyword">in</span> /home/<span class="built_in">test</span>/myproject/venv/bin/python</span><br><span class="line">Installing setuptools, pip, wheel...done.</span><br><span class="line">root@vm1:/home/<span class="built_in">test</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<ul>
<li>引用新的环境变量</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">root@vm1:/home/<span class="built_in">test</span><span class="comment"># source venv/bin/activate</span></span><br><span class="line">(venv)root@vm1:/home/<span class="built_in">test</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<ul>
<li>开始使用</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv)root@vm1:/home/<span class="built_in">test</span><span class="comment"># pip install docker</span></span><br></pre></td></tr></table></figure>
<ul>
<li>退出当前venv环境</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(venv)root@vm1:/home/<span class="built_in">test</span><span class="comment"># deactivate</span></span><br><span class="line">root@vm1:/home/<span class="built_in">test</span><span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="一个小问题"><a class="markdownIt-Anchor" href="#一个小问题"></a> 一个小问题</h3>
<p>git clone时遇到<code>server certificate verification failed. CAfile: /etc/ssl/certs/ca-certificates.crt CRLfile: none</code>的解决方法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> GIT_SSL_NO_VERIFY=1</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
      </tags>
  </entry>
  <entry>
    <title>使用hexo搭建自己的博客——创建站点</title>
    <url>/2018/03/25/setup-hexo-create-site/</url>
    <content><![CDATA[<h2 id="安装及配置"><a class="markdownIt-Anchor" href="#安装及配置"></a> 安装及配置</h2>
<h3 id="简介"><a class="markdownIt-Anchor" href="#简介"></a> 简介</h3>
<p><a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a>是一个快速、简介且高效的博客框架，可以使用<a href="https://daringfireball.net/projects/markdown/" target="_blank" rel="noopener">Markdown</a>解析文章并生成网站</p>
<a id="more"></a>
<h3 id="说明"><a class="markdownIt-Anchor" href="#说明"></a> 说明</h3>
<p><span id="inline-blue">站点配置文件</span> <code>$site_dir/_config.xml</code></p>
<p><span id="inline-yellow">主题配置文件</span><code>$site_dir/theme/$theme_dir/_config</code></p>
<h3 id="安装hexo"><a class="markdownIt-Anchor" href="#安装hexo"></a> 安装hexo</h3>
<p>当环境准备好git以及nodejs后便可以安装hexo</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install hexo-cli -g</span><br></pre></td></tr></table></figure>
<h3 id="建站"><a class="markdownIt-Anchor" href="#建站"></a> 建站</h3>
<p>安装Hexo后，创建站点文件存放的文件夹，如<em>blog</em>，然后执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo init blog</span><br><span class="line">$ <span class="built_in">cd</span> blog</span><br><span class="line">$ npm install</span><br></pre></td></tr></table></figure>
<p>完成后，blog目录结构</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">├── _config.yml</span><br><span class="line">├── package.json</span><br><span class="line">├── scaffolds</span><br><span class="line">├── <span class="built_in">source</span></span><br><span class="line">|   ├── _drafts</span><br><span class="line">|   └── _posts</span><br><span class="line">└── themes</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3>
<p>修改_config.yml</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">title:</span> <span class="string">your</span> <span class="string">site</span> <span class="string">tile</span></span><br><span class="line"><span class="attr">subtitle:</span> </span><br><span class="line"><span class="attr">description:</span> <span class="string">description</span></span><br><span class="line"><span class="attr">author:</span> <span class="string">your</span> <span class="string">name</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-Hans</span></span><br><span class="line"><span class="attr">timezone:</span> <span class="string">Asia/Shanghai</span></span><br></pre></td></tr></table></figure>
<h3 id="常用命令"><a class="markdownIt-Anchor" href="#常用命令"></a> 常用命令</h3>
<ul>
<li>清除缓存文件及已生成的静态文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo clean</span><br></pre></td></tr></table></figure>
<ul>
<li>启动服务器</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p><em>默认状况下，服务器将使用4000端口。可以通过<code>hexo server -p 80</code>来将server绑定至80端口</em></p>
<ul>
<li>部署网站<br />
可将网站按照_config.yml中的配置直接部署于github等（后续看心情写步骤）</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<h3 id="主题修改"><a class="markdownIt-Anchor" href="#主题修改"></a> 主题修改</h3>
<p>可访问hexo官方<a href="https://hexo.io/themes/" target="_blank" rel="noopener">主题库</a>选择自己喜欢的主题，并下载至theme目录下</p>
<p>修改_config.xml中的theme字段</p>
<figure class="highlight"><table><tr><td class="code"><pre><span class="line">theme: landscape</span><br></pre></td></tr></table></figure>
<h2 id="写作"><a class="markdownIt-Anchor" href="#写作"></a> 写作</h2>
<p>有两种方法创建文章</p>
<h3 id="创建文章"><a class="markdownIt-Anchor" href="#创建文章"></a> 创建文章</h3>
<ul>
<li>hexo命令行方式</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new &lt;layout&gt; title</span><br></pre></td></tr></table></figure>
<p><em>layout为模版</em></p>
<p>命令执行后，默认文章将位于source/_post/目录下，文件内容为：</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: test</span><br><span class="line">date: 2018-03-25 23:10:04</span><br><span class="line">tags:</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<ul>
<li>直接创建文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> <span class="built_in">source</span>/_post/</span><br><span class="line">$ touch myfirstblog.md</span><br></pre></td></tr></table></figure>
<p>此时文件内容为空，需要自己添加相关内容</p>
<h3 id="创建标签页"><a class="markdownIt-Anchor" href="#创建标签页"></a> 创建标签页</h3>
<ul>
<li>配置确认</li>
</ul>
<p>确认<span id="inline-blue">站点配置文件</span>中有以下内容</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">tag_dir:</span> <span class="string">tags</span></span><br></pre></td></tr></table></figure>
<p>确认<span id="inline-yellow">主题配置文件</span>中tags打开</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">menu:</span></span><br><span class="line">  <span class="string">主页:</span> <span class="string">/</span> <span class="string">||</span> <span class="string">home</span></span><br><span class="line">  <span class="string">标签:</span> <span class="string">/tags/</span> <span class="string">||</span> <span class="string">tags</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建标签页</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new page tags</span><br></pre></td></tr></table></figure>
<p>修改tags/index.md中的type为&quot;tags&quot;</p>
<figure class="highlight markdown"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">title: Tagcloud</span><br><span class="line">date: 2018-03-23 01:18:00</span><br><span class="line">type: "tags"</span><br><span class="line">---</span><br></pre></td></tr></table></figure>
<h3 id="创建分类页面"><a class="markdownIt-Anchor" href="#创建分类页面"></a> 创建分类页面</h3>
<p>与创建标签页相似</p>
<ul>
<li>确认配置</li>
</ul>
<p><span id="inline-blue">站点配置文件</span>中有<code>category_dir: categories</code></p>
<p><span id="inline-yellow">主题配置文件</span>中的<code>分类: /categories/ || th</code>开启</p>
<ul>
<li>创建分类也</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ hexo new page categories</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>hexo</category>
      </categories>
      <tags>
        <tag>hexo</tag>
        <tag>blog</tag>
        <tag>markdown</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu安装IPSAN</title>
    <url>/2020/04/17/setup-ipsan-ubuntu/</url>
    <content><![CDATA[<p><a href="https://www.howtoforge.com/how-to-setup-iscsi-storage-server-on-ubuntu-1804/" target="_blank" rel="noopener">参考文章</a></p>
<p>IPSAN的定义就不讲了，主要讲一下搭建环境。IPSAN主要包括两种node：</p>
<ul>
<li>initiator：可以理解为客户端</li>
<li>target：可以理解为服务器端</li>
</ul>
<p>实际上也不存在客户端服务器端的理解。target端主要是把磁盘share出来给其他设备用的。initiator相当于用来映射target端的磁盘到本地的。</p>
<a id="more"></a>
<h2 id="安装及配置target端"><a class="markdownIt-Anchor" href="#安装及配置target端"></a> 安装及配置target端</h2>
<h3 id="服务器准备ip-1921680100"><a class="markdownIt-Anchor" href="#服务器准备ip-1921680100"></a> 服务器准备(ip: 192.168.0.100)</h3>
<p>服务器需要有两块磁盘，如果使用虚拟机环境，则特别简单</p>
<ul>
<li>第一块硬盘用来安装系统，大小40G就够了</li>
<li>第二块硬盘用来通过IPSAN来share，按需来创建，最小2G</li>
</ul>
<h3 id="安装软件包"><a class="markdownIt-Anchor" href="#安装软件包"></a> 安装软件包</h3>
<p>在Ubuntu上安装target端很简单，主要是安装tgt软件包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 升级软件包</span></span><br><span class="line">$ apt update -y</span><br><span class="line">$ apt upgrade -y</span><br><span class="line"><span class="comment"># 安装tgt</span></span><br><span class="line">$ apt install tgt -y</span><br></pre></td></tr></table></figure>
<p>默认状况下，安装完毕后，tgt服务就应该已经正常运行了。当然，可以确认是否已经运行正常</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl status tgt</span><br></pre></td></tr></table></figure>
<h3 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h3>
<p>安装完成后，一般情况是没有这个文件的，需要自己创建一个。创建配置文件<code>/etc/tgt/conf.d/iscsi.conf</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">target</span> <span class="attr">abc.id123.testsite.xyz:lun1</span>&gt;</span></span><br><span class="line">     backing-store /dev/sdb</span><br><span class="line">     initiator-address 192.168.0.0/16</span><br><span class="line">     incominguser test password</span><br><span class="line">     outgoinguser test password</span><br><span class="line"><span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="配置说明"><a class="markdownIt-Anchor" href="#配置说明"></a> 配置说明</h4>
<ol>
<li>target后面为节点名称，随便写</li>
<li>backing-store，即将要share出去的磁盘</li>
<li>initiator-address，即可以允许连接的IP地址或地址范围</li>
<li>incominguser，入的用户名密码（我的理解是写权限）</li>
<li>outgoinguser，出的用户名密码（我的理解是读权限）</li>
</ol>
<h4 id="检查配置"><a class="markdownIt-Anchor" href="#检查配置"></a> 检查配置</h4>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl restart tgt</span><br></pre></td></tr></table></figure>
<ul>
<li>查看状态</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ tgtadm --mode target --op show</span><br><span class="line">Target abc.id123.testsite.xyz:lun1</span><br><span class="line">    System information:</span><br><span class="line">        Driver: iscsi</span><br><span class="line">        State: ready</span><br><span class="line">    I_T nexus information:</span><br><span class="line">    LUN information:</span><br><span class="line">        LUN: 0</span><br><span class="line">            Type: controller</span><br><span class="line">            SCSI ID: IET     00010000</span><br><span class="line">            SCSI SN: beaf10</span><br><span class="line">            Size: 0 MB, Block size: 1</span><br><span class="line">            Online: Yes</span><br><span class="line">            Removable media: No</span><br><span class="line">            Prevent removal: No</span><br><span class="line">            Readonly: No</span><br><span class="line">            SWP: No</span><br><span class="line">            Thin-provisioning: No</span><br><span class="line">            Backing store <span class="built_in">type</span>: null</span><br><span class="line">            Backing store path: None</span><br><span class="line">            Backing store flags: </span><br><span class="line">        LUN: 1</span><br><span class="line">            Type: disk</span><br><span class="line">            SCSI ID: IET     00010001</span><br><span class="line">            SCSI SN: beaf11</span><br><span class="line">            Size: 2146 MB, Block size: 512</span><br><span class="line">            Online: Yes</span><br><span class="line">            Removable media: No</span><br><span class="line">            Prevent removal: No</span><br><span class="line">            Readonly: No</span><br><span class="line">            SWP: No</span><br><span class="line">            Thin-provisioning: No</span><br><span class="line">            Backing store <span class="built_in">type</span>: rdwr</span><br><span class="line">            Backing store path: /dev/sdb</span><br><span class="line">            Backing store flags: </span><br><span class="line">    Account information:</span><br><span class="line">        <span class="built_in">test</span></span><br><span class="line">        <span class="built_in">test</span> (outgoing)</span><br><span class="line">    ACL information:</span><br><span class="line">        192.168.0.0/16</span><br></pre></td></tr></table></figure>
<h2 id="安装及配置initiator"><a class="markdownIt-Anchor" href="#安装及配置initiator"></a> 安装及配置initiator</h2>
<p>如果你只是想创建一个IPSAN共享存储出去，那么不需要安装initiator。本例则同样通过另外一台Ubuntu服务器来连接target端</p>
<h3 id="安装及配置initiator1921680200"><a class="markdownIt-Anchor" href="#安装及配置initiator1921680200"></a> 安装及配置initiator(192.168.0.200)</h3>
<ul>
<li>安装open-iscsi软件包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get install open-iscsi -y</span><br></pre></td></tr></table></figure>
<ul>
<li>探测target端</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ iscsiadm -m discovery -t st -p 192.168.0.100</span><br><span class="line">192.168.0.100:3260,1 abc.id123.testsite.xyz:lun1</span><br></pre></td></tr></table></figure>
<ul>
<li>修改配置文件</li>
</ul>
<p>探测完成后，将会在<code>/etc/iscsi/nodes/</code>目录和<code>/etc/iscsi/send_targets/</code>目录下看到对应的target</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ls -l /etc/iscsi/nodes/abc.id123.testsite.xyz\:lun1/192.168.0.100\,3260\,1/ </span><br><span class="line">total 4</span><br><span class="line">-rw------- 1 root root 1840 Nov  8 13:17 default</span><br><span class="line"></span><br><span class="line">$ ls -l /etc/iscsi/send_targets/192.168.0.100,3260/</span><br><span class="line">total 8</span><br><span class="line">lrwxrwxrwx 1 root root  66 Nov  8 13:17 abc.id123.testsite.xyz:lun1,192.168.0.100,3260,1,default -&gt; /etc/iscsi/nodes/abc.id123.testsite.xyz:lun1/192.168.0.100,3260,1</span><br><span class="line">-rw------- 1 root root 547 Nov  8 13:17 st_config</span><br></pre></td></tr></table></figure>
<p>修改default文件，增加CHAP的配置（认证相关）</p>
<p><code>vim /etc/iscsi/nodes/abc.id123.testsite.xyz\:lun1/192.168.0.100\,3260\,1/default</code>，新增如下内容</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">node.session.auth.authmethod = CHAP</span><br><span class="line">node.session.auth.username = <span class="built_in">test</span></span><br><span class="line">node.session.auth.password = password</span><br><span class="line">node.session.auth.username_in = <span class="built_in">test</span></span><br><span class="line">node.session.auth.password_in = password</span><br><span class="line">node.startup = automatic</span><br></pre></td></tr></table></figure>
<h3 id="验证"><a class="markdownIt-Anchor" href="#验证"></a> 验证</h3>
<ul>
<li>重启服务</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl restart open-iscsi</span><br></pre></td></tr></table></figure>
<ul>
<li>检查是否映射完成</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ lsblk</span><br><span class="line">NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">sda      8:0    0   40G  0 disk</span><br><span class="line">├─sda1   8:1    0  512M  0 part /boot/efi</span><br><span class="line">└─sda2   8:2    0 39.5G  0 part /</span><br><span class="line">sdb      8:16   0  120G  0 disk</span><br><span class="line">└─sdb1   8:17   0  120G  0 part</span><br><span class="line">sr0     11:0    1 1024M  0 rom</span><br></pre></td></tr></table></figure>
<p>其中的sdb即为通过IPSAN连接的磁盘。可以以本地磁盘的方式进行访问</p>
<h2 id="更多内容"><a class="markdownIt-Anchor" href="#更多内容"></a> 更多内容</h2>
<p>可以参看<a href="https://www.cnblogs.com/kevingrace/p/8467141.html" target="_blank" rel="noopener">这篇文章</a>来创建多台target，创建LVM并share出去一组成IPSAN存储设备组</p>
]]></content>
      <categories>
        <category>cloud</category>
      </categories>
      <tags>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>OVS学习笔记——常用命令练习</title>
    <url>/2018/11/13/ovs-study2/</url>
    <content><![CDATA[<h1 id="控制管理"><a class="markdownIt-Anchor" href="#控制管理"></a> 控制管理</h1>
<ul>
<li>创建网桥</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl add-br testbr</span><br></pre></td></tr></table></figure>
<ul>
<li>查看网桥和端口</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl show</span><br><span class="line">b66c0897-27c9-441a-9486-42cfb65a4649</span><br><span class="line">    Bridge testbr</span><br><span class="line">        Port testbr</span><br><span class="line">            Interface testbr</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">"2.5.5"</span></span><br></pre></td></tr></table></figure>
<a id="more"></a>
<ul>
<li>网桥端口操作</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl add-port br0 eth1</span><br><span class="line">$ ovs-vsctl del-port br0 eth1</span><br></pre></td></tr></table></figure>
<ul>
<li>查看流表</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows testbr</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=364.789s, table=0, n_packets=0, n_bytes=0, idle_age=364, priority=0 actions=NORMAL</span><br></pre></td></tr></table></figure>
<ul>
<li>控制器设置</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置控制器</span></span><br><span class="line">$ ovs-vsctl <span class="built_in">set</span>-controller testbr tcp:10.180.9.62:6633</span><br><span class="line">$ ovs-vsctl show</span><br><span class="line">b66c0897-27c9-441a-9486-42cfb65a4649</span><br><span class="line">    Bridge testbr</span><br><span class="line">        Controller <span class="string">"tcp:10.180.9.62:6633"</span></span><br><span class="line">        Port testbr</span><br><span class="line">            Interface testbr</span><br><span class="line">                <span class="built_in">type</span>: internal</span><br><span class="line">    ovs_version: <span class="string">"2.5.5"</span></span><br><span class="line"><span class="comment"># 查看控制器列表</span></span><br><span class="line">$ ovs-vsctl list controller</span><br><span class="line">_uuid               : 2fe35662-3f4f-446b-9296-6f1eae38ba5e</span><br><span class="line">connection_mode     : []</span><br><span class="line">controller_burst_limit: []</span><br><span class="line">controller_rate_limit: []</span><br><span class="line">enable_async_messages: []</span><br><span class="line">external_ids        : &#123;&#125;</span><br><span class="line">inactivity_probe    : []</span><br><span class="line">is_connected        : <span class="literal">true</span></span><br><span class="line">local_gateway       : []</span><br><span class="line">local_ip            : []</span><br><span class="line">local_netmask       : []</span><br><span class="line">max_backoff         : []</span><br><span class="line">other_config        : &#123;&#125;</span><br><span class="line">role                : other</span><br><span class="line">status              : &#123;sec_since_connect=<span class="string">"4"</span>, state=ACTIVE&#125;</span><br><span class="line">target              : <span class="string">"tcp:10.180.9.62:6633"</span></span><br><span class="line"><span class="comment"># 删除控制器</span></span><br><span class="line">$ ovs-vsctl del-controller testbr</span><br></pre></td></tr></table></figure>
<ul>
<li>接口相关</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-ports s1</span><br><span class="line">OFPST_PORT reply (xid=0x2): 3 ports</span><br><span class="line">  port LOCAL: rx pkts=0, bytes=0, drop=94, errs=0, frame=0, over=0, crc=0</span><br><span class="line">           tx pkts=0, bytes=0, drop=0, errs=0, coll=0</span><br><span class="line">  port  1: rx pkts=124, bytes=8418, drop=0, errs=0, frame=0, over=0, crc=0</span><br><span class="line">           tx pkts=130, bytes=8898, drop=0, errs=0, coll=0</span><br><span class="line">  port  2: rx pkts=123, bytes=8340, drop=0, errs=0, frame=0, over=0, crc=0</span><br><span class="line">           tx pkts=130, bytes=8886, drop=0, errs=0, coll=0</span><br><span class="line">$ ovs-appctl dpif/show</span><br><span class="line">system@ovs-system: hit:318465 missed:735</span><br><span class="line">    s1:</span><br><span class="line">        s1 65534/3: (internal)</span><br><span class="line">        s1-eth1 1/2: (system)</span><br><span class="line">        s1-eth2 2/1: (system)</span><br></pre></td></tr></table></figure>
<h1 id="流表类"><a class="markdownIt-Anchor" href="#流表类"></a> 流表类</h1>
<h2 id="流表操作"><a class="markdownIt-Anchor" href="#流表操作"></a> 流表操作</h2>
<h3 id="查看流表"><a class="markdownIt-Anchor" href="#查看流表"></a> 查看流表</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows s1</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=356.689s, table=0, n_packets=708, n_bytes=42480, idle_age=0, priority=65535,dl_dst=01:80:c2:00:00:0e,dl_type=0x88cc actions=CONTROLLER:65535</span><br><span class="line"> cookie=0x0, duration=356.699s, table=0, n_packets=94, n_bytes=7488, idle_age=346, priority=0 actions=CONTROLLER:65535</span><br></pre></td></tr></table></figure>
<h3 id="添加普通流表"><a class="markdownIt-Anchor" href="#添加普通流表"></a> 添加普通流表</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s1 in_port=1,actions=drop</span><br><span class="line">$ ovs-ofctl dump-flows s1</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=441.879s, table=0, n_packets=878, n_bytes=52680, idle_age=0, priority=65535,dl_dst=01:80:c2:00:00:0e,dl_type=0x88cc actions=CONTROLLER:65535</span><br><span class="line"> cookie=0x0, duration=2.861s, table=0, n_packets=0, n_bytes=0, idle_age=2, in_port=1 actions=drop</span><br><span class="line"> cookie=0x0, duration=441.889s, table=0, n_packets=94, n_bytes=7488, idle_age=432, priority=0 actions=CONTROLLER:65535</span><br></pre></td></tr></table></figure>
<h3 id="按照匹配删除流表"><a class="markdownIt-Anchor" href="#按照匹配删除流表"></a> 按照匹配删除流表</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl del-flows s1 <span class="string">"in_port=1"</span></span><br><span class="line">mininet&gt; sh ovs-ofctl dump-flows s1</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=521.249s, table=0, n_packets=1036, n_bytes=62160, idle_age=0, priority=65535,dl_dst=01:80:c2:00:00:0e,dl_type=0x88cc actions=CONTROLLER:65535</span><br><span class="line"> cookie=0x0, duration=521.259s, table=0, n_packets=94, n_bytes=7488, idle_age=511, priority=0 actions=CONTROLLER:65535</span><br></pre></td></tr></table></figure>
<h2 id="常用匹配项"><a class="markdownIt-Anchor" href="#常用匹配项"></a> 常用匹配项</h2>
<h3 id="vlan-tag"><a class="markdownIt-Anchor" href="#vlan-tag"></a> VLAN Tag</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ vs-ofctl add-flow s1 priority=401,in_port=1,dl_vlan=777,actions=output:2</span><br><span class="line">$ ovs-ofctl dump-flows s1</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=663.043s, table=0, n_packets=1318, n_bytes=79080, idle_age=0, priority=65535,dl_dst=01:80:c2:00:00:0e,dl_type=0x88cc actions=CONTROLLER:65535</span><br><span class="line"> cookie=0x0, duration=3.022s, table=0, n_packets=0, n_bytes=0, idle_age=3, priority=401,in_port=1,dl_vlan=777 actions=output:2</span><br><span class="line"> cookie=0x0, duration=663.053s, table=0, n_packets=94, n_bytes=7488, idle_age=653, priority=0 actions=CONTROLLER:65535</span><br></pre></td></tr></table></figure>
<h3 id="mac"><a class="markdownIt-Anchor" href="#mac"></a> MAC</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s3 in_port=1,dl_src=0a:f6:95:7e:c6:4a/0a:f6:95:7e:c6:4a,action=output:3</span><br><span class="line">$ ovs-ofctl add-flow s3 in_port=1,dl_dst=be:7c:6a:e9:e6:b1/be:7c:6a:e9:e6:b1,action=output:2</span><br><span class="line">$ sh ovs-ofctl dump-flows s3</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=69.067s, table=0, n_packets=0, n_bytes=0, idle_age=69, in_port=1,dl_src=0a:f6:95:7e:c6:4a/0a:f6:95:7e:c6:4a actions=output:3</span><br><span class="line"> cookie=0x0, duration=14.496s, table=0, n_packets=0, n_bytes=0, idle_age=14, in_port=1,dl_dst=be:7c:6a:e9:e6:b1/be:7c:6a:e9:e6:b1 actions=output:2</span><br></pre></td></tr></table></figure>
<h3 id="ip"><a class="markdownIt-Anchor" href="#ip"></a> IP</h3>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s3 ip,in_port=1,nw_src=192.168.0.0/16,action=drop</span><br><span class="line">$ ovs-ofctl add-flow s3 ip,in_port=1,nw_dst=192.168.0.0/16,action=drop</span><br><span class="line">$ ovs-ofctl dump-flows s3</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=119.033s, table=0, n_packets=119, n_bytes=7140, idle_age=0, priority=65535,dl_dst=01:80:c2:00:00:0e,dl_type=0x88cc actions=CONTROLLER:65535</span><br><span class="line"> cookie=0x0, duration=28.864s, table=0, n_packets=0, n_bytes=0, idle_age=28, ip,in_port=1,nw_src=192.168.0.0/16 actions=drop</span><br><span class="line"> cookie=0x0, duration=10.036s, table=0, n_packets=0, n_bytes=0, idle_age=10, ip,in_port=1,nw_dst=192.168.0.0/16 actions=drop</span><br><span class="line"> cookie=0x0, duration=119.057s, table=0, n_packets=90, n_bytes=7164, idle_age=109, priority=0 actions=CONTROLLER:65535</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a class="markdownIt-Anchor" href="#其他"></a> 其他</h3>
<table>
<thead>
<tr>
<th>匹配项</th>
<th>关键字</th>
<th>条件</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>以太网类型</td>
<td>dl_type</td>
<td></td>
<td><code>in_port=1,dl_type=0x0806,actions=output:2</code></td>
</tr>
<tr>
<td>协议号</td>
<td>nw_proto</td>
<td>指定dl_type=0x0800或者ip</td>
<td><code>ip,in_port=1,nw_proto=1,actions=output:2</code></td>
</tr>
<tr>
<td>TCP flags</td>
<td>tcp_flags</td>
<td>指定TCP</td>
<td><code>tcp,tcp_flags=ack,actions=output:2</code></td>
</tr>
</tbody>
</table>
<h3 id="一些速记符"><a class="markdownIt-Anchor" href="#一些速记符"></a> 一些速记符</h3>
<table>
<thead>
<tr>
<th>速记符</th>
<th>匹配项</th>
</tr>
</thead>
<tbody>
<tr>
<td>ip</td>
<td>dl_type=0x800</td>
</tr>
<tr>
<td>ipv6</td>
<td>dl_type=0x86dd</td>
</tr>
<tr>
<td>icmp</td>
<td>dl_type=0x0800,nw_proto=1</td>
</tr>
<tr>
<td>icmp6</td>
<td>dl_type=0x86dd,nw_proto=58</td>
</tr>
<tr>
<td>tcp</td>
<td>dl_type=0x0800,nw_proto=6</td>
</tr>
<tr>
<td>tcp6</td>
<td>dl_type=0x86dd,nw_proto=6</td>
</tr>
<tr>
<td>udp</td>
<td>dl_type=0x0800,nw_proto=17</td>
</tr>
<tr>
<td>udp6</td>
<td>dl_type=0x86dd,nw_proto=17</td>
</tr>
<tr>
<td>arp</td>
<td>dl_type=0x0806</td>
</tr>
</tbody>
</table>
<h2 id="指令动作actions"><a class="markdownIt-Anchor" href="#指令动作actions"></a> 指令动作（actions）</h2>
<h3 id="基础动作"><a class="markdownIt-Anchor" href="#基础动作"></a> 基础动作</h3>
<table>
<thead>
<tr>
<th>动作</th>
<th>说明</th>
<th>举例</th>
</tr>
</thead>
<tbody>
<tr>
<td>normal</td>
<td>L2/L3处理</td>
<td><code>actions=normal</code></td>
</tr>
<tr>
<td>output</td>
<td>出接口</td>
<td><code>actions=output:2</code></td>
</tr>
<tr>
<td>group</td>
<td>指定的group</td>
<td><code>actions=group:1</code></td>
</tr>
<tr>
<td>flood</td>
<td>从所有物理接口转发出去，除了入接口和已关闭flooding的接口</td>
<td><code>actions=flood</code></td>
</tr>
<tr>
<td>all</td>
<td>从所有物理接口转发出去，除了入接口</td>
<td><code>actions=all</code></td>
</tr>
<tr>
<td>local</td>
<td>转发给本地网桥</td>
<td><code>actions=local</code></td>
</tr>
<tr>
<td>in_port</td>
<td>从入接口转发出去</td>
<td><code>actions=in_port</code></td>
</tr>
<tr>
<td>controller</td>
<td>以packet-in消息上送给控制器</td>
<td><code>actions=controller</code></td>
</tr>
<tr>
<td>drop</td>
<td>丢弃数据包</td>
<td><code>actions=drop</code></td>
</tr>
</tbody>
</table>
<h3 id="修改vlan-id"><a class="markdownIt-Anchor" href="#修改vlan-id"></a> 修改VLAN ID</h3>
<ul>
<li>
<p>关键字： <code>mod_vlan_vid</code></p>
</li>
<li>
<p>举例</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s1 in_port&#x3D;1,actions&#x3D;mod_vlan_vid:1034,output:2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="剥除vlan"><a class="markdownIt-Anchor" href="#剥除vlan"></a> 剥除VLAN</h3>
<ul>
<li>
<p>关键字： <code>strip_vlan</code></p>
</li>
<li>
<p>举例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s1 in_port=1,actions=strip_vlan,output:2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="弹出最外层vlan"><a class="markdownIt-Anchor" href="#弹出最外层vlan"></a> 弹出最外层VLAN</h3>
<ul>
<li>
<p>关键字： <code>pop_vlan</code></p>
</li>
<li>
<p>举例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow br0 in_port=1,dl_type=0x8100,dl_vlan=777,actions=pop_vlan,output:2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="修改源目的mac"><a class="markdownIt-Anchor" href="#修改源目的mac"></a> 修改源/目的MAC</h3>
<ul>
<li>
<p>关键字：<code>mod_dl_src</code> / <code>mod_dl_dst</code></p>
</li>
<li>
<p>举例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s1 in_port=1,actions=mod_dl_src:01:80:c2:00:00:0e,output:2</span><br><span class="line">$ ovs-ofctl add-flow s1 in_port=1,actions=mod_dl_dst:01:80:c2:00:00:0e,output:2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="修改源目的ip"><a class="markdownIt-Anchor" href="#修改源目的ip"></a> 修改源/目的IP</h3>
<ul>
<li>
<p>关键字： <code>mod_nw_src</code>/<code>mod_nw_dst</code></p>
</li>
<li>
<p>举例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s1 in_port=1,actions=mod_nw_src:192.168.0.10,output:2</span><br><span class="line">$ ovs-ofctl add-flow s1 in_port=1,actions=mod_nw_dst:192.168.0.10,output:2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="修改tcpudp端口"><a class="markdownIt-Anchor" href="#修改tcpudp端口"></a> 修改TCP/UDP端口</h3>
<ul>
<li>
<p>关键字：<code>mod_tp_src</code>/<code>mod_tp_dst</code></p>
</li>
<li>
<p>举例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s1 tcp,in_port=1,actions=mod_tp_src:1039,output:2</span><br><span class="line">$ ovs-ofctl add-flow s1 tcp,in_port=1,actions=mod_tp_dst:21,output:2</span><br><span class="line">$ ovs-ofctl add-flow s1 udp,in_port=1,actions=mod_tp_src:1039,output:2</span><br><span class="line">$ ovs-ofctl add-flow s1 udp,in_port=1,actions=mod_tp_dst:53,output:2</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="vxlan"><a class="markdownIt-Anchor" href="#vxlan"></a> VxLan</h3>
<ul>
<li>
<p>创建VxLAN接口</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-vsctl add-port s3 vxlan1 -- <span class="built_in">set</span> Interface vxlan1 <span class="built_in">type</span>=vxlan options:remote_ip=1.1.1.1 ofport_request=2000</span><br><span class="line">$ ovs-vsctl show</span><br><span class="line">    Bridge <span class="string">"s3"</span></span><br><span class="line">        Controller <span class="string">"tcp:10.180.9.62:6633"</span></span><br><span class="line">        Controller <span class="string">"ptcp:6636"</span></span><br><span class="line">        fail_mode: secure</span><br><span class="line">        Port <span class="string">"s3-eth2"</span></span><br><span class="line">            Interface <span class="string">"s3-eth2"</span></span><br><span class="line">        Port <span class="string">"vxlan1"</span></span><br><span class="line">            Interface <span class="string">"vxlan1"</span></span><br><span class="line">                <span class="built_in">type</span>: vxlan</span><br><span class="line">                options: &#123;remote_ip=<span class="string">"1.1.1.1"</span>&#125;</span><br><span class="line">        Port <span class="string">"s3-eth3"</span></span><br><span class="line">            Interface <span class="string">"s3-eth3"</span></span><br><span class="line">        Port <span class="string">"s3-eth1"</span></span><br><span class="line">            Interface <span class="string">"s3-eth1"</span></span><br><span class="line">        Port <span class="string">"s3"</span></span><br><span class="line">            Interface <span class="string">"s3"</span></span><br><span class="line">                <span class="built_in">type</span>: internal</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>VxLAN流表</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl add-flow s3 ip,in_port=1,nw_dst=192.168.0.0/16,actions=output:2000</span><br><span class="line">$ ovs-ofctl add-flow s3 in_port=2000,actions=output:1</span><br><span class="line">$ ovs-ofctl dump-flows s3</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=35.227s, table=0, n_packets=0, n_bytes=0, idle_age=35, ip,in_port=1,nw_dst=192.168.0.0/16 actions=output:2000</span><br><span class="line"> cookie=0x0, duration=2.469s, table=0, n_packets=0, n_bytes=0, idle_age=2, in_port=2000 actions=output:1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h1 id="实验"><a class="markdownIt-Anchor" href="#实验"></a> 实验</h1>
<h2 id="拓扑"><a class="markdownIt-Anchor" href="#拓扑"></a> 拓扑</h2>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line">                <span class="string">+------------+</span></span><br><span class="line">                <span class="string">|</span>     <span class="string">s2</span>     <span class="string">|</span></span><br><span class="line">                <span class="string">+---+----+---+</span></span><br><span class="line">                    <span class="string">|</span>    <span class="string">|</span></span><br><span class="line">         <span class="string">+----------+</span>    <span class="string">+----------+</span></span><br><span class="line">         <span class="string">|</span>                          <span class="string">|</span></span><br><span class="line"><span class="string">+--------+--------+</span>        <span class="string">+--------+--------+</span></span><br><span class="line"><span class="string">|</span>       <span class="string">s3</span>        <span class="string">|</span>        <span class="string">|</span>        <span class="string">s4</span>       <span class="string">|</span></span><br><span class="line"><span class="string">+---+---------+---+</span>        <span class="string">+---+---------+---+</span></span><br><span class="line">    <span class="string">|</span>         <span class="string">|</span>                <span class="string">|</span>         <span class="string">|</span></span><br><span class="line"><span class="string">+---+--+</span>   <span class="string">+--+---+</span>        <span class="string">+---+--+</span>   <span class="string">+--+---+</span></span><br><span class="line"><span class="string">|</span>  <span class="string">h1</span>  <span class="string">|</span>   <span class="string">|</span>  <span class="string">h2</span>  <span class="string">|</span>        <span class="string">|</span>  <span class="string">h3</span>  <span class="string">|</span>   <span class="string">|</span>  <span class="string">h4</span>  <span class="string">|</span></span><br><span class="line"><span class="string">+------+</span>   <span class="string">+------+</span>        <span class="string">+------+</span>   <span class="string">+------+</span></span><br></pre></td></tr></table></figure>
<h2 id="实验要求"><a class="markdownIt-Anchor" href="#实验要求"></a> 实验要求</h2>
<ol>
<li>h1可以与h3通信，但不可以与h2和h4通信</li>
<li>h2可以与h4通信，但不可以与h1和h3通信</li>
</ol>
<h2 id="具体操作"><a class="markdownIt-Anchor" href="#具体操作"></a> 具体操作</h2>
<ol>
<li>由h1送出的报文，在s3上打上vlan tag 1000</li>
<li>随后s3将报文送往s2</li>
<li>s2收到s3的vlan1000的报文，直接转送s4</li>
<li>s4收到vlan1000的报文后，剥离vlan，送到h3</li>
<li>h3收到请求报文后，返回响应报文，送往s4</li>
<li>s4收到h3的报文后，打上vlan tag 1000</li>
<li>随后s4将报文送往s2</li>
<li>s2收到s4的vlan1000的报文，直接送往s3</li>
<li>s3收到s2的vlan1000报文后，剥离vlan，送往h1</li>
</ol>
<h2 id="h1-h3流表"><a class="markdownIt-Anchor" href="#h1-h3流表"></a> h1-h3流表</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows s2</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=1664.027s, table=0, n_packets=79, n_bytes=4026, idle_age=803, in_port=1,dl_vlan=1000 actions=output:2</span><br><span class="line"> cookie=0x0, duration=1642.112s, table=0, n_packets=10, n_bytes=852, idle_age=803, in_port=2,dl_vlan=1000 actions=output:1</span><br><span class="line"></span><br><span class="line">$ ovs-ofctl dump-flows s3</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=2826.459s, table=0, n_packets=330, n_bytes=14700, idle_age=807, in_port=1 actions=mod_vlan_vid:1000,output:3</span><br><span class="line"> cookie=0x0, duration=1895.062s, table=0, n_packets=10, n_bytes=852, idle_age=807, in_port=3,dl_vlan=1000 actions=strip_vlan,output:1</span><br><span class="line"></span><br><span class="line">$ ovs-ofctl dump-flows s4</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=2776.175s, table=0, n_packets=229, n_bytes=10010, idle_age=810, in_port=1 actions=mod_vlan_vid:1000,output:3</span><br><span class="line"> cookie=0x0, duration=1507.500s, table=0, n_packets=10, n_bytes=852, idle_age=810, in_port=3,dl_vlan=1000 actions=strip_vlan,output:1</span><br></pre></td></tr></table></figure>
<h2 id="h2-h4流表"><a class="markdownIt-Anchor" href="#h2-h4流表"></a> h2-h4流表</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ ovs-ofctl dump-flows s2</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=827.167s, table=0, n_packets=60, n_bytes=2816, idle_age=698, in_port=2,dl_vlan=2000 actions=output:1</span><br><span class="line"> cookie=0x0, duration=812.342s, table=0, n_packets=60, n_bytes=2816, idle_age=698, in_port=1,dl_vlan=2000 actions=output:2</span><br><span class="line"> </span><br><span class="line">$ ovs-ofctl dump-flows s3</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=1347.703s, table=0, n_packets=60, n_bytes=2576, idle_age=702, in_port=2 actions=mod_vlan_vid:2000,output:3</span><br><span class="line"> cookie=0x0, duration=710.639s, table=0, n_packets=3, n_bytes=194, idle_age=702, in_port=3,dl_vlan=2000 actions=strip_vlan,output:2</span><br><span class="line"> </span><br><span class="line">$ ovs-ofctl dump-flows s4</span><br><span class="line">NXST_FLOW reply (xid=0x4):</span><br><span class="line"> cookie=0x0, duration=1133.570s, table=0, n_packets=60, n_bytes=2576, idle_age=705, in_port=2 actions=mod_vlan_vid:2000,output:3</span><br><span class="line"> cookie=0x0, duration=1088.590s, table=0, n_packets=60, n_bytes=2816, idle_age=705, in_port=3,dl_vlan=2000 actions=strip_vlan,output:2</span><br></pre></td></tr></table></figure>
<h2 id="命令列表"><a class="markdownIt-Anchor" href="#命令列表"></a> 命令列表</h2>
<ul>
<li>h1-h3</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ovs-ofctl add-flow s2 in_port=1,dl_vlan=1000,actions=output:2</span><br><span class="line">ovs-ofctl add-flow s2 in_port=2,dl_vlan=1000,actions=output:1</span><br><span class="line">ovs-ofctl add-flow s3 in_port=1,actions=mod_vlan_vid:1000,output:3</span><br><span class="line">ovs-ofctl add-flow s3 in_port=3,dl_vlan=1000,actions=strip_vlan,output:1</span><br><span class="line">ovs-ofctl add-flow s4 in_port=1,actions=mod_vlan_vid:1000,output:3</span><br><span class="line">ovs-ofctl add-flow s4 in_port=3,dl_vlan=1000,actions=strip_vlan,output:1</span><br></pre></td></tr></table></figure>
<ul>
<li>h2-h4</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ovs-ofctl add-flow s2 in_port=2,dl_vlan=2000,actions=output:1</span><br><span class="line">ovs-ofctl add-flow s2 in_port=1,dl_vlan=2000,actions=output:2</span><br><span class="line">ovs-ofctl add-flow s3 in_port=2,actions=mod_vlan_vid:2000,output:3</span><br><span class="line">ovs-ofctl add-flow s3 in_port=3,dl_vlan=2000,actions=strip_vlan,output:2</span><br><span class="line">ovs-ofctl add-flow s4 in_port=2,actions=mod_vlan_vid:2000,output:3</span><br><span class="line">ovs-ofctl add-flow s4 in_port=3,dl_vlan=2000,actions=strip_vlan,output:2</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>ovs</tag>
        <tag>network</tag>
      </tags>
  </entry>
  <entry>
    <title>西班牙申根签证快速攻略</title>
    <url>/2019/08/15/spain-visa/</url>
    <content><![CDATA[<h2 id="适用对象"><a class="markdownIt-Anchor" href="#适用对象"></a> 适用对象</h2>
<ol>
<li>北京领区</li>
<li>在职人员</li>
<li>旅游签证</li>
<li>2019年</li>
</ol>
<blockquote>
<p><strong>小提醒</strong></p>
<ul>
<li>签证中心只收<strong>现金</strong></li>
<li>据签证中心工作人员介绍，周一和周五人最多，其他时间都还好</li>
<li>只需一张照片，但多带几张总不坏</li>
<li>流水余额取决于旅行时间，最少3W吧</li>
</ul>
</blockquote>
<a id="more"></a>
<h2 id="主要网站"><a class="markdownIt-Anchor" href="#主要网站"></a> 主要网站</h2>
<p>西班牙签证申请中心：<a href="https://china.blsspainvisa.com/chinese/index.php" target="_blank" rel="noopener">https://china.blsspainvisa.com/chinese/index.php</a></p>
<h2 id="流程"><a class="markdownIt-Anchor" href="#流程"></a> 流程</h2>
<ol>
<li>准备资料</li>
<li>预约</li>
<li>前往签证中心</li>
<li>坐等快递</li>
</ol>
<h2 id="资料清单"><a class="markdownIt-Anchor" href="#资料清单"></a> 资料清单</h2>
<h3 id="官网文件"><a class="markdownIt-Anchor" href="#官网文件"></a> 官网文件</h3>
<blockquote>
<p>来源：<a href="https://china.blsspainvisa.com/chinese/index.php" target="_blank" rel="noopener">西班牙签证申请中心官网</a></p>
<p>获取：首页 -&gt; 签证类型 -&gt; 短期 -&gt; 旅游。或直接点击<a href="https://china.blsspainvisa.com/chinese/short_term_visa_tourism.php" target="_blank" rel="noopener">这里</a></p>
</blockquote>
<ol>
<li>检查清单（Checklist）</li>
<li>签证申请表</li>
<li>知悉声明</li>
</ol>
<h3 id="准备文件"><a class="markdownIt-Anchor" href="#准备文件"></a> 准备文件</h3>
<p>相关填写及说明参看后续章节</p>
<blockquote>
<p>准备文件均来源于<strong>检查清单</strong>中</p>
</blockquote>
<h4 id="工作相关必须"><a class="markdownIt-Anchor" href="#工作相关必须"></a> 工作相关（必须）</h4>
<ol>
<li>公司营业执照复应件，需盖章</li>
<li>在职证明（中文，英文各一份），可参看<a href="#%E5%9C%A8%E8%81%8C%E8%AF%81%E6%98%8E%E6%A8%A1%E7%89%88">在职证明模版</a>
<ol>
<li>任职公司的地址、电话及传真号码</li>
<li>任职公司签字人的姓名和职务</li>
<li>申请人姓名、职务、收入及工作年限</li>
</ol>
</li>
</ol>
<h4 id="旅行资料必须"><a class="markdownIt-Anchor" href="#旅行资料必须"></a> 旅行资料（必须）</h4>
<ol>
<li>完整旅行计划</li>
<li>全部机票预订单</li>
<li>所有住宿证明</li>
<li>旅行保险（投保金额至少30000 欧元或等值的人民币）</li>
</ol>
<h4 id="身份证明必须"><a class="markdownIt-Anchor" href="#身份证明必须"></a> 身份证明（必须）</h4>
<ol>
<li>护照原件（如有旧护照，一并提供）</li>
<li><strong>整本</strong>护照复印件（首页需要复印两张）</li>
<li>户口本原件</li>
<li>户口本所有页复印件</li>
<li>照片</li>
</ol>
<h4 id="收入类必须"><a class="markdownIt-Anchor" href="#收入类必须"></a> 收入类（必须）</h4>
<ol>
<li>工资卡3-6个月的流水，无需存款证明</li>
<li>收入证明（包含于在职证明）</li>
</ol>
<h4 id="辅助资料非必须"><a class="markdownIt-Anchor" href="#辅助资料非必须"></a> 辅助资料（非必须）</h4>
<ol>
<li>房产证及复印件</li>
<li>机动车产权证</li>
</ol>
<h2 id="预约"><a class="markdownIt-Anchor" href="#预约"></a> 预约</h2>
<p>在西班牙签证申请中心官网： 申请预约 -&gt; BLS签证中心 -&gt; 网上预约，或直接点击<a href="https://china.blsspainvisa.com/chinese/book_appointment.php" target="_blank" rel="noopener">这里</a></p>
<h3 id="预约表单填写"><a class="markdownIt-Anchor" href="#预约表单填写"></a> 预约表单填写</h3>
<p><strong>基本信息</strong></p>
<img src="/2019/08/15/spain-visa/booking_1.png" class="" title="Booking form">
<p><strong>预约申请表</strong></p>
<img src="/2019/08/15/spain-visa/booking_table.png" class="" title="Booking Table">
<p><strong>预约确认信</strong></p>
<blockquote>
<p>预约完成后，注意保存预约确认信，可打印也可保存在手机上</p>
</blockquote>
<img src="/2019/08/15/spain-visa/booking_confirm.png" class="" title="Confirm">
<h2 id="前往签证中心"><a class="markdownIt-Anchor" href="#前往签证中心"></a> 前往签证中心</h2>
<h3 id="地址"><a class="markdownIt-Anchor" href="#地址"></a> 地址</h3>
<blockquote>
<p>签证中心楼下并没有明显的标示</p>
</blockquote>
<p>北京市朝阳区新源里16号琨莎中心 1号楼1006室</p>
<h3 id="费用"><a class="markdownIt-Anchor" href="#费用"></a> 费用</h3>
<blockquote>
<p>签证中心当前只收现金</p>
</blockquote>
<ol>
<li>签证费：469</li>
<li>服务费：121</li>
<li>快递费：60</li>
</ol>
<h3 id="流程-2"><a class="markdownIt-Anchor" href="#流程-2"></a> 流程</h3>
<ol>
<li>排队</li>
<li>前台检查资料，填写快递单</li>
<li>拿号</li>
<li>递交材料</li>
<li>缴费</li>
<li>录指纹+拍照</li>
</ol>
<h3 id="回执"><a class="markdownIt-Anchor" href="#回执"></a> 回执</h3>
<p>离开签证中心时，你手里应该有：</p>
<ol>
<li>缴费回执（上含受理号）</li>
<li>一张护照首页复印件（上含受理号）</li>
<li>其他文件原件（如户口本、房产证等）</li>
<li>快递单照片（没有原件）</li>
</ol>
<h2 id="坐等快递"><a class="markdownIt-Anchor" href="#坐等快递"></a> 坐等快递</h2>
<p>提交完所有资料后，你只需要在家等待签证的快递，是否通过，已经由不得你了。</p>
<h3 id="查询进度"><a class="markdownIt-Anchor" href="#查询进度"></a> 查询进度</h3>
<p>可以登陆<a href="https://china.blsspainvisa.com/chinese/index.php" target="_blank" rel="noopener">西班牙签证申请中心官网</a>，通过<strong>受理号</strong>在线查询您的申请</p>
<img src="/2019/08/15/spain-visa/status.png" class="" title="Status">
<h2 id="在职证明模版"><a class="markdownIt-Anchor" href="#在职证明模版"></a> 在职证明模版</h2>
<blockquote>
<p>在职证明需要有公司名称、地址、电话并加盖公章</p>
</blockquote>
<h3 id="中文"><a class="markdownIt-Anchor" href="#中文"></a> 中文</h3>
<p>兹证明<strong>张三</strong>，护照号：<strong>E12345678</strong>，自<strong>xxxx/xx/xx</strong>日入职至今，现在我司任职<strong>xxx</strong>，月收入税前人民币：<strong>xxxx</strong>元，大写： <strong>xxxx</strong>。经公司批准，他将于<strong>xxxx/xx/xx</strong>至<strong>xxxx/xx/xx</strong>休假。旅行期间的费用由他本人承担。</p>
<p>他的假期期间，我公司将保留他的职务。贵处如需要其他信息，请随时联系我们。如果他的签证申请能顺利通过，我们将非常感激。</p>
<h3 id="英文"><a class="markdownIt-Anchor" href="#英文"></a> 英文</h3>
<p>Employment Certificate</p>
<p>To Spain Visa Application Center:</p>
<p>This is to certify that <strong>SAN ZHANG</strong>(Passport No.: <strong>E12345678</strong>) works for <strong>xxxxxxxx Co., Ltd</strong>. Since <strong>xxxx/xx/xx</strong> till present. He has been allowed for a leave from <strong>xxxx/xx/xx</strong> to <strong>xxxx/xx/xx</strong>. His position is <strong>xxxxxxxx</strong> and average monthly pre-tax salary is <strong>xxxxx</strong> RMB. All costs relating to his trip will be covered by himself.</p>
<p>We will keep his position during his leave. Meanwhile, we guarantee that during this trip he will abide laws of your country and be back as scheduled. If any other information is needed, please feel free to contact us. It will be grateful if his visa is issued successfully.</p>
<p><strong>最后，祝君好运</strong></p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>旅行</tag>
        <tag>visa</tag>
      </tags>
  </entry>
  <entry>
    <title>国内源安装k8s——Ubuntu</title>
    <url>/2020/05/19/ubuntu-install-k8s-aliyun/</url>
    <content><![CDATA[<ul>
<li>阿里云源</li>
<li>Ubuntu20.04</li>
<li>master + slave</li>
</ul>
<a id="more"></a>
<h2 id="安装docker"><a class="markdownIt-Anchor" href="#安装docker"></a> 安装docker</h2>
<p>分别在两个node上安装docker-ce</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get update </span><br><span class="line">$ apt-get -y install apt-transport-https ca-certificates curl software-properties-common</span><br><span class="line">$ curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</span><br><span class="line">$ add-apt-repository <span class="string">"deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu <span class="variable">$(lsb_release -cs)</span> stable"</span></span><br><span class="line">$ apt update</span><br><span class="line">$ apt-get -y install docker-ce</span><br></pre></td></tr></table></figure>
<h2 id="安装kubeadmkubectlkubelet"><a class="markdownIt-Anchor" href="#安装kubeadmkubectlkubelet"></a> 安装kubeadm，kubectl，kubelet</h2>
<p>分别在两个node上安装</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt-get update &amp;&amp; apt-get install -y apt-transport-https</span><br><span class="line">$ curl https://mirrors.aliyun.com/kubernetes/apt/doc/apt-key.gpg | apt-key add - </span><br><span class="line">$ cat &lt;&lt;EOF &gt;/etc/apt/sources.list.d/kubernetes.list</span><br><span class="line">deb https://mirrors.aliyun.com/kubernetes/apt/ kubernetes-xenial main</span><br><span class="line">EOF</span><br><span class="line">$ apt-get update</span><br><span class="line">$ apt-get install -y kubelet kubeadm kubectl</span><br></pre></td></tr></table></figure>
<h2 id="初始化master节点"><a class="markdownIt-Anchor" href="#初始化master节点"></a> 初始化master节点</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubeadm init --pod-network-cidr=172.172.0.0/16 --image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure>
<p>安装成功后，会有如下信息：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">"kubectl apply -f [podnetwork].yaml"</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">Then you can join any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm join 10.160.18.180:6443 --token 5xxosi.3du1z15pevcvnyyx \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:4cc4977482e04ac0ca845bf3520a6a5fa8a0cf6ac8233e734a47e0250c259f73</span><br></pre></td></tr></table></figure>
<p>根据提示，执行</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">$ sudo cp -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">$ sudo chown $(id -u):$(id -g) <span class="variable">$HOME</span>/.kube/config</span><br></pre></td></tr></table></figure>
<h2 id="安装flannel"><a class="markdownIt-Anchor" href="#安装flannel"></a> 安装flannel</h2>
<p>参考： <a href="https://github.com/coreos/flannel" target="_blank" rel="noopener">https://github.com/coreos/flannel</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br></pre></td></tr></table></figure>
<h2 id="安装dashboard"><a class="markdownIt-Anchor" href="#安装dashboard"></a> 安装dashboard</h2>
<p>参考：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="noopener">https://github.com/kubernetes/dashboard</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.0/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>
<h4 id="修改dashboard配置"><a class="markdownIt-Anchor" href="#修改dashboard配置"></a> 修改dashboard配置</h4>
<p>修改<code>spec</code>中的<code>type</code>为<code>NodePort</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n kubernetes-dashboard edit service kubernetes-dashboard</span><br><span class="line">.......</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: 10.101.212.193</span><br><span class="line">  externalTrafficPolicy: Cluster</span><br><span class="line">  ports:</span><br><span class="line">  - nodePort: 32609</span><br><span class="line">    port: 443</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8443</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: kubernetes-dashboard</span><br><span class="line">  sessionAffinity: None</span><br><span class="line">  <span class="built_in">type</span>: NodePort</span><br></pre></td></tr></table></figure>
<p>修改成功后，查看port信息</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n kubernetes-dashboard get service kubernetes-dashboard</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.101.212.193   &lt;none&gt;        443:32609/TCP   27m</span><br></pre></td></tr></table></figure>
<p><strong>现在，可以通过<code>https://&lt;master-ip&gt;:&lt;NodePort&gt;</code>（这里的port是32609）来访问dashboard了</strong></p>
<p>虽然页面已经展示出来了，但需要使用token或Kubeconfig才能访问</p>
<h4 id="创建sample-user"><a class="markdownIt-Anchor" href="#创建sample-user"></a> 创建sample-user</h4>
<h5 id="创建服务账号"><a class="markdownIt-Anchor" href="#创建服务账号"></a> 创建服务账号</h5>
<p>新建<code>dashboard-adminuser.yaml</code>并写入：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl apply -f dashboard-adminuser.yaml</span><br></pre></td></tr></table></figure>
<h5 id="创建clusterrolebinding"><a class="markdownIt-Anchor" href="#创建clusterrolebinding"></a> 创建ClusterRoleBinding</h5>
<p>新建<code>cluster-role-binding.yaml</code>并写入：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubetcl apply -f cluster-role-binding.yaml</span><br></pre></td></tr></table></figure>
<h5 id="获取token"><a class="markdownIt-Anchor" href="#获取token"></a> 获取token</h5>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk <span class="string">'&#123;print $1&#125;'</span>)</span><br><span class="line">Name:         admin-user-token-jmggp</span><br><span class="line">Namespace:    kubernetes-dashboard</span><br><span class="line">Labels:       &lt;none&gt;</span><br><span class="line">Annotations:  kubernetes.io/service-account.name: admin-user</span><br><span class="line">              kubernetes.io/service-account.uid: 58210c16-0fac-438c-8867-d0a3e7b950b9</span><br><span class="line"></span><br><span class="line">Type:  kubernetes.io/service-account-token</span><br><span class="line"></span><br><span class="line">Data</span><br><span class="line">====</span><br><span class="line">ca.crt:     1025 bytes</span><br><span class="line">namespace:  20 bytes</span><br><span class="line">token:      eyJhbGciOiJSUzI1NiIsImtpZCI6IlhTSnlXMUhXTlNnUmd4MlVMTzdtbm14YVdiSzNUdjk4UnVoZ3RRbUFXZGsifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLWptZ2dwIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiI1ODIxMGMxNi0wZmFjLTQzOGMtODg2Ny1kMGEzZTdiOTUwYjkiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.F4TKNO_6Guu-vcLUtELUOhRI2dGMcZ3V1et2evono_a6f-TvCR9c4pbyYCnRdCG6_MumTmyE5W1g3zHioVnb5TgnGwfmAfIWLltwwLEOxOdLfO7oqM8zrYfzZnIH16SoOZQYMU7xIk5MhE5WN265n8Q2kpDMraf0L06_nqNy1pq8h9eaX0QIntosl4fmf9KVew0geLCKbknEwpnzGGfSCcKLLgE7a45ACWwStJiL29t69gcKJ6ze33MXpA5_irk2nKkavXbKEk7ejapgYK66nOxJnDKgbNVDcBP47xHrPjGeeupB6bw6uUMWxA6z4kJUTVRepk6yTMGVDPzB9Muicw</span><br></pre></td></tr></table></figure>
<p><strong>现在，可以使用token登录Dashboard了</strong></p>
<h2 id="slave节点加入集群"><a class="markdownIt-Anchor" href="#slave节点加入集群"></a> slave节点加入集群</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubeadm join 10.160.18.180:6443 --token 5xxosi.3du1z15pevcvnyyx \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:4cc4977482e04ac0ca845bf3520a6a5fa8a0cf6ac8233e734a47e0250c259f73</span><br></pre></td></tr></table></figure>
<h3 id="问题及解决方案"><a class="markdownIt-Anchor" href="#问题及解决方案"></a> 问题及解决方案</h3>
<h4 id="docker-cgroup-driver问题"><a class="markdownIt-Anchor" href="#docker-cgroup-driver问题"></a> docker cgroup driver问题</h4>
<p><strong>问题日志</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[WARNING IsDockerSystemdCheck]: detected <span class="string">"cgroupfs"</span> as the Docker cgroup driver. The recommended driver is <span class="string">"systemd"</span>. Please follow the guide at https://kubernetes.io/docs/setup/cri/</span><br></pre></td></tr></table></figure>
<p><strong>解决方法</strong></p>
<ol>
<li>在<code>/etc/docker/</code>下创建<code>daemon.json</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat &gt; /etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"exec-opts"</span>: [<span class="string">"native.cgroupdriver=systemd"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>重启docker进程</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl restart docker</span><br><span class="line">$ systemctl status docker</span><br></pre></td></tr></table></figure>
<h4 id="swap问题"><a class="markdownIt-Anchor" href="#swap问题"></a> swap问题</h4>
<p><strong>问题日志</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[ERROR Swap]: running with swap on is not supported. Please <span class="built_in">disable</span> swap</span><br></pre></td></tr></table></figure>
<p><strong>解决方法</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ swapoff -a</span><br><span class="line"><span class="comment"># 在所有node上执行</span></span><br></pre></td></tr></table></figure>
<p>但这只是暂时关闭了swap，重启node后，就会再次打开。需要修改<code>/etc/fstab</code>，在swap那行加上<code>#</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#UUID=4eeb5155-41f9-4478-a420-2beb4290a721 none            swap    sw              0       0</span></span><br></pre></td></tr></table></figure>
<h3 id="node处于notready状态"><a class="markdownIt-Anchor" href="#node处于notready状态"></a> Node处于NotReady状态</h3>
<p>node处于NotReady状态的原因有很多。可以一步一步处理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get nodes</span><br><span class="line">NAME    STATUS   ROLES    AGE     VERSION</span><br><span class="line">node1   Ready    master   4h56m   v1.18.2</span><br><span class="line">node2   NotReady    &lt;none&gt;   4h6m    v1.18.2</span><br></pre></td></tr></table></figure>
<p>先查看错误原因：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl get pod -n kube-system</span><br><span class="line">NAME                            READY   STATUS                  RESTARTS   AGE</span><br><span class="line">coredns-7ff77c879f-2k7rw        1/1     Running                 1          4h47m</span><br><span class="line">coredns-7ff77c879f-q76jr        1/1     Running                 1          4h47m</span><br><span class="line">etcd-node1                      1/1     Running                 2          4h47m</span><br><span class="line">kube-apiserver-node1            1/1     Running                 2          4h47m</span><br><span class="line">kube-controller-manager-node1   1/1     Running                 2          4h47m</span><br><span class="line">kube-flannel-ds-amd64-2jn8n     0/1     Init:ImagePullBackOff   0          3h49m</span><br><span class="line">kube-flannel-ds-amd64-ftpxl     1/1     Running                 1          3h49m</span><br><span class="line">kube-proxy-5q8wp                1/1     Running                 2          4h47m</span><br><span class="line">kube-proxy-wfcjq                0/1     ContainerCreating       0          5m46s</span><br><span class="line">kube-scheduler-node1            1/1     Running                 2          4h47m</span><br></pre></td></tr></table></figure>
<p>k8s有些服务会在各个节点上启动，比如这里的proxy，flannel。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ kubectl describe pod -n kube-system kube-flannel-ds-amd64-2jn8n</span><br><span class="line">.....</span><br><span class="line">Events:</span><br><span class="line">  Type     Reason                  Age                    From            Message</span><br><span class="line">  ----     ------                  ----                   ----            -------</span><br><span class="line">  Normal   Pulling                 6m51s                  kubelet, node2  Pulling image <span class="string">"quay.io/coreos/flannel:v0.12.0-amd64"</span></span><br><span class="line">  Warning  Failed                  5m48s                  kubelet, node2  Failed to pull image <span class="string">"quay.io/coreos/flannel:v0.12.0-amd64"</span>: rpc error: code = Unknown desc = Error response from daemon: Get https://quay.io/v2/coreos/flannel/manifests/v0.12.0-amd64: received unexpected HTTP status: 500 Internal Server Error</span><br><span class="line">  Warning  Failed                  5m48s                  kubelet, node2  Error: ErrImagePull</span><br><span class="line">  Normal   BackOff                 5m47s                  kubelet, node2  Back-off pulling image <span class="string">"quay.io/coreos/flannel:v0.12.0-amd64"</span></span><br><span class="line">  Warning  Failed                  5m47s                  kubelet, node2  Error: ImagePullBackOff</span><br><span class="line">  Normal   Pulling                 5m36s (x2 over 5m51s)  kubelet, node2  Pulling image <span class="string">"quay.io/coreos/flannel:v0.12.0-amd64"</span></span><br></pre></td></tr></table></figure>
<p>最常见的是ImagePull失败。比如master node上镜像拉取正常，而其他节点拉取失败。</p>
<h4 id="解决方法"><a class="markdownIt-Anchor" href="#解决方法"></a> 解决方法</h4>
<h5 id="1-在slave节点上手工拉取镜像"><a class="markdownIt-Anchor" href="#1-在slave节点上手工拉取镜像"></a> 1. 在slave节点上手工拉取镜像</h5>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ docker pull quay.io/coreos/flannel:v0.12.0-amd64</span><br></pre></td></tr></table></figure>
<h5 id="2-将master节点上的镜像导入slave节点"><a class="markdownIt-Anchor" href="#2-将master节点上的镜像导入slave节点"></a> 2. 将master节点上的镜像导入slave节点</h5>
<ul>
<li>查看master节点上的镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(master)$ docker images</span><br><span class="line">REPOSITORY                                                        TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">kubernetesui/dashboard                                            v2.0.0              8b32422733b3        3 weeks ago         222MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-proxy                v1.18.2             0d40868643c6        4 weeks ago         117MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-scheduler            v1.18.2             a3099161e137        4 weeks ago         95.3MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-apiserver            v1.18.2             6ed75ad404bd        4 weeks ago         173MB</span><br><span class="line">registry.aliyuncs.com/google_containers/kube-controller-manager   v1.18.2             ace0a8c17ba9        4 weeks ago         162MB</span><br><span class="line">kubernetesui/metrics-scraper                                      v1.0.4              86262685d9ab        7 weeks ago         36.9MB</span><br><span class="line">quay.io/coreos/flannel                                            v0.12.0-amd64       4e9f801d2217        2 months ago        52.8MB</span><br><span class="line">registry.aliyuncs.com/google_containers/pause                     3.2                 80d28bedfe5d        3 months ago        683kB</span><br><span class="line">registry.aliyuncs.com/google_containers/coredns                   1.6.7               67da37a9a360        3 months ago        43.8MB</span><br><span class="line">registry.aliyuncs.com/google_containers/etcd                      3.4.3-0             303ce5db0e90        6 months ago        288MB</span><br></pre></td></tr></table></figure>
<ul>
<li>将镜像导出为文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(master)$ docker save quay.io/coreos/flannel  &gt; flannel.tar</span><br></pre></td></tr></table></figure>
<ul>
<li>将文件传输到slave节点上</li>
<li>slave节点上导入镜像</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(slave)$ docker load &lt; flannel.tar</span><br><span class="line">256a7af3acb1: Loading layer [==================================================&gt;]  5.844MB/5.844MB</span><br><span class="line">d572e5d9d39b: Loading layer [==================================================&gt;]  10.37MB/10.37MB</span><br><span class="line">57c10be5852f: Loading layer [==================================================&gt;]  2.249MB/2.249MB</span><br><span class="line">7412f8eefb77: Loading layer [==================================================&gt;]  35.26MB/35.26MB</span><br><span class="line">05116c9ff7bf: Loading layer [==================================================&gt;]   5.12kB/5.12kB</span><br><span class="line">Loaded image: quay.io/coreos/flannel:v0.12.0-amd64</span><br></pre></td></tr></table></figure>
<p><strong>Now， all is OK</strong></p>
]]></content>
      <categories>
        <category>k8s</category>
      </categories>
      <tags>
        <tag>docker</tag>
        <tag>Kubernetes</tag>
      </tags>
  </entry>
  <entry>
    <title>美签记录</title>
    <url>/2018/07/30/us-visa/</url>
    <content><![CDATA[<p>记第一次拿到十年美签</p>
<h1 id="时间"><a class="markdownIt-Anchor" href="#时间"></a> 时间</h1>
<ul>
<li>提交DS160: 2018-07-08</li>
<li>预约面签时间: 2018-07-27 前面排队人太多</li>
<li>Issued: 2018-07-30</li>
<li>护照已从领事馆那边收回，目前正在安排运送: 2018-07-30</li>
<li>收到护照: 2018-08-02</li>
</ul>
<h4 id="持续时间"><a class="markdownIt-Anchor" href="#持续时间"></a> 持续时间</h4>
<ul>
<li>面签持续时间：1分钟不到</li>
<li>AP持续时间：2个工作日</li>
<li>Issued到送到苏州：3个工作日</li>
</ul>
<h1 id="面签问题"><a class="markdownIt-Anchor" href="#面签问题"></a> 面签问题</h1>
<ol>
<li>你去美国干什么？</li>
<li>要去美国多久？</li>
<li>你是做什么工作的？</li>
<li>你们公司是做什么的？</li>
<li>你是一个人去么？</li>
</ol>
<p>“你通过了！”</p>
]]></content>
      <categories>
        <category>旅行</category>
      </categories>
      <tags>
        <tag>visa</tag>
      </tags>
  </entry>
  <entry>
    <title>sqlalchemy连接docker的mysql问题记录</title>
    <url>/2018/08/15/sqlalchemy-mysql-docker/</url>
    <content><![CDATA[<p>又开始鼓捣flask+mysql了 👶</p>
<p>不成想，又一次踩了好多雷 😂</p>
<p>有一种打怪升级的感觉</p>
<a id="more"></a>
<h3 id="环境说明"><a class="markdownIt-Anchor" href="#环境说明"></a> 环境说明</h3>
<ol>
<li>Mac+flask</li>
<li>docker+mysql</li>
</ol>
<h3 id="问题1-create_engine报错"><a class="markdownIt-Anchor" href="#问题1-create_engine报错"></a> 问题1 create_engine报错</h3>
<ul>
<li>错误信息</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>engine = create_engine(<span class="string">'mysql+mysqldb://root:123456@localhost/beta_monitor'</span>)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"/Users/bqi/venv/beta-monitor/lib/python2.7/site-packages/sqlalchemy/engine/__init__.py"</span>, line <span class="number">424</span>, <span class="keyword">in</span> create_engine</span><br><span class="line">    <span class="keyword">return</span> strategy.create(*args, **kwargs)</span><br><span class="line">  File <span class="string">"/Users/bqi/venv/beta-monitor/lib/python2.7/site-packages/sqlalchemy/engine/strategies.py"</span>, line <span class="number">81</span>, <span class="keyword">in</span> create</span><br><span class="line">    dbapi = dialect_cls.dbapi(**dbapi_args)</span><br><span class="line">  File <span class="string">"/Users/bqi/venv/beta-monitor/lib/python2.7/site-packages/sqlalchemy/dialects/mysql/mysqldb.py"</span>, line <span class="number">102</span>, <span class="keyword">in</span> dbapi</span><br><span class="line">    <span class="keyword">return</span> __import__(<span class="string">'MySQLdb'</span>)</span><br><span class="line">ImportError: No module named MySQLdb</span><br></pre></td></tr></table></figure>
<ul>
<li>问题原因</li>
</ul>
<p>没有安装python的mysql包，需要安装<code>mysql-python</code>和/或<code>mysqlclient</code>，然后就遇到了第二个问题</p>
<h3 id="问题2-pip-install-mysql-python失败"><a class="markdownIt-Anchor" href="#问题2-pip-install-mysql-python失败"></a> 问题2 <code>pip install mysql-python</code>失败</h3>
<ul>
<li>错误信息</li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">⇒ pip install mysql-python</span><br><span class="line">Collecting mysql-python</span><br><span class="line">  Downloading https://files.pythonhosted.org/packages/a5/e9/51b544da85a36a68debe7a7091f068d802fc515a3a202652828c73453cad/MySQL-python-1.2.5.zip (108kB)</span><br><span class="line">    100% |████████████████████████████████| 112kB 153kB/s</span><br><span class="line">    Complete output from command python setup.py egg_info:</span><br><span class="line">    sh: mysql_config: command not found</span><br><span class="line">    Traceback (most recent call last):</span><br><span class="line">      File "&lt;string&gt;", line 1, in &lt;module&gt;</span><br><span class="line">      File "/private/var/folders/3z/tqw46wwj7xb1d2ftp578x5vm0000gn/T/pip-install-ViJMnc/mysql-python/setup.py", line 17, in &lt;module&gt;</span><br><span class="line">        metadata, options = get_config()</span><br><span class="line">      File "setup_posix.py", line 43, in get_config</span><br><span class="line">        libs = mysql_config("libs_r")</span><br><span class="line">      File "setup_posix.py", line 25, in mysql_config</span><br><span class="line">        raise EnvironmentError("%s not found" % (mysql_config.path,))</span><br><span class="line">    EnvironmentError: mysql_config not found</span><br><span class="line"></span><br><span class="line">    ----------------------------------------</span><br><span class="line">Command "python setup.py egg_info" failed with error code 1 in /private/var/folders/3z/tqw46wwj7xb1d2ftp578x5vm0000gn/T/pip-install-ViJMnc/mysql-python/</span><br></pre></td></tr></table></figure>
<ul>
<li>问题原因</li>
</ul>
<p><code>mysql_config</code>不存在，原来是系统必须安装mysql客户端</p>
<ul>
<li>解决方法 <code>brew install mysql</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">⇒ brew install mysql</span><br><span class="line">Updating Homebrew...</span><br><span class="line">==&gt; Downloading https://homebrew.bintray.com/bottles/mysql-5.7.22.high_sierra.bottle.tar.gz</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">####################################################################### 100.0%</span></span></span><br><span class="line">==&gt; Pouring mysql-5.7.22.high_sierra.bottle.tar.gz</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<h3 id="问题3-连接mysql服务器失败"><a class="markdownIt-Anchor" href="#问题3-连接mysql服务器失败"></a> 问题3 连接mysql服务器失败</h3>
<ul>
<li>错误信息 <code>Authentication plugin 'caching_sha2_password' cannot be loaded</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span>engine = create_engine(<span class="string">'mysql+mysqldb://root:123456@127.0.0.1/beta_monitor'</span>)</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>connection = engine.connect()</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">  File <span class="string">"&lt;stdin&gt;"</span>, line <span class="number">1</span>, <span class="keyword">in</span> &lt;module&gt;</span><br><span class="line">  File <span class="string">"/Users/bqi/venv/beta-monitor/lib/python2.7/site-packages/sqlalchemy/engine/base.py"</span>, line <span class="number">2102</span>, <span class="keyword">in</span> connect</span><br><span class="line">    <span class="keyword">return</span> self._connection_cls(self, **kwargs)</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">  File <span class="string">"/Users/bqi/venv/beta-monitor/lib/python2.7/site-packages/MySQLdb/__init__.py"</span>, line <span class="number">81</span>, <span class="keyword">in</span> Connect</span><br><span class="line">    <span class="keyword">return</span> Connection(*args, **kwargs)</span><br><span class="line">  File <span class="string">"/Users/bqi/venv/beta-monitor/lib/python2.7/site-packages/MySQLdb/connections.py"</span>, line <span class="number">193</span>, <span class="keyword">in</span> __init__</span><br><span class="line">    super(Connection, self).__init__(*args, **kwargs2)</span><br><span class="line">sqlalchemy.exc.OperationalError: (_mysql_exceptions.OperationalError) (<span class="number">2059</span>, <span class="string">"Authentication plugin 'caching_sha2_password' cannot be loaded: dlopen(/usr/local/Cellar/mysql/5.7.22/lib/plugin/caching_sha2_password.so, 2): image not found"</span>) (Background on this error at: http://sqlalche.me/e/e3q8)</span><br></pre></td></tr></table></figure>
<ul>
<li>问题原因</li>
</ul>
<p>上网查了一通，似乎说从某个版本开始，mysql用了一种认证方式导致问题。根据解决方法看，更换了认证方式就可以了</p>
<ul>
<li>解决方法</li>
</ul>
<ol>
<li>用docker启动mysql时增加参数 <code>--default-authentication-plugin=mysql_native_password</code></li>
</ol>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">~|⇒ docker run -p 3306:3306 -d -e MYSQL_ROOT_PASSWORD=123456 -e MYSQL_DATABASE=beta_monitor -e MYSQL_USER=test -e MYSQL_PASSWORD=123456 mysql --default-authentication-plugin=mysql_native_password</span><br><span class="line">d8f5e623dc595df19b9d6cce52780381b625c1565622f5867f2ad3aeafdca499</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>如果安装在服务器上，则在my.cnf中修改相关配置</li>
</ol>
<ul>
<li>测试</li>
</ul>
<ol>
<li>本地连接测试</li>
</ol>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">~|⇒ mysql -utest -p123456 -h 127.0.0.1</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 2013 (HY000): Lost connection to MySQL server at &#39;reading initial communication packet&#39;, system error: 0</span><br><span class="line">~|⇒ mysql -utest -p -h 127.0.0.1</span><br><span class="line">Enter password:</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 8</span><br><span class="line">Server version: 8.0.12 MySQL Community Server - GPL</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2018, Oracle and&#x2F;or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and&#x2F;or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &#39;help;&#39; or &#39;\h&#39; for help. Type &#39;\c&#39; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; quit</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>通过<code>connection = engine.connect()</code>无异常</li>
</ol>
<blockquote>
<p>作为一个暗夜精灵玩家，强烈谴责希尔瓦纳斯烧了我老家的卑劣行径，暴雪怎么洗也没用</p>
</blockquote>
]]></content>
      <categories>
        <category>python</category>
      </categories>
      <tags>
        <tag>python</tag>
        <tag>sqlalchemy</tag>
        <tag>flask</tag>
      </tags>
  </entry>
  <entry>
    <title>Ubuntu16.04 VPP环境搭建</title>
    <url>/2018/11/15/vpp-setup/</url>
    <content><![CDATA[<h1 id="环境"><a class="markdownIt-Anchor" href="#环境"></a> 环境</h1>
<h2 id="环境准备"><a class="markdownIt-Anchor" href="#环境准备"></a> 环境准备</h2>
<ol>
<li>VmWare虚拟环境</li>
<li>Host需求：2cpu，4G内存，3块网卡</li>
<li>Ubuntu16.04</li>
</ol>
<h2 id="拓扑"><a class="markdownIt-Anchor" href="#拓扑"></a> 拓扑</h2>
<p>搭建典型的c2s拓扑</p>
<a id="more"></a>
<img src="/2018/11/15/vpp-setup/vpp_setup_topo.png" class="" title="topo">
<ul>
<li>通过vsphere创建两个虚拟交换机</li>
<li>host1的第二个接口与vpp的第二个接口连在同一个交换机上</li>
<li>host2的第二个接口与vpp的第三个接口连在同一个交换机上</li>
</ul>
<h2 id="vpp安装先决条件"><a class="markdownIt-Anchor" href="#vpp安装先决条件"></a> VPP安装先决条件</h2>
<ol>
<li>Ubuntu安装git（git默认安装）</li>
<li>Ubuntu安装dpdk，并绑定PCI的另外两个接口到dpdk</li>
</ol>
<h1 id="安装"><a class="markdownIt-Anchor" href="#安装"></a> 安装</h1>
<p>官方文档提供了多种安装方式，并且推荐使用vagrant包，由于这里使用的是虚拟环境，则使用直接安装的方式</p>
<h2 id="获取源码"><a class="markdownIt-Anchor" href="#获取源码"></a> 获取源码</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ git <span class="built_in">clone</span> https://gerrit.fd.io/r/vpp</span><br></pre></td></tr></table></figure>
<h2 id="安装vpp"><a class="markdownIt-Anchor" href="#安装vpp"></a> 安装vpp</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">cd</span> vpp</span><br></pre></td></tr></table></figure>
<ul>
<li>Step1</li>
</ul>
<p>可以先执行一下<code>make</code>查看可以执行哪些操作</p>
<ul>
<li>Step2 - make</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make build-release</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">by executing <span class="string">"make install-dep"</span></span><br><span class="line"></span><br><span class="line">Makefile:262: recipe <span class="keyword">for</span> target <span class="string">'/root/vpp/build-root/.deps.ok'</span> failed</span><br><span class="line">make: *** [/root/vpp/build-root/.deps.ok] Error 1</span><br></pre></td></tr></table></figure>
<p>如果遇到以上错误，则意味着缺少依赖包</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make install-dep</span><br></pre></td></tr></table></figure>
<p>依赖包安装完成后，再次执行<code>make build-release</code></p>
<ul>
<li>Step3 - Build deb包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ make pkg-deb</span><br></pre></td></tr></table></figure>
<ul>
<li>Step4 - 安装VPP packages</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ dpkg -i /vpp/build-root/*.deb</span><br></pre></td></tr></table></figure>
<p>中间可能会遇到<code>vpp-api-python</code>的错误，使用apt安装后重新安装packages</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ apt install vpp-api-python</span><br></pre></td></tr></table></figure>
<h1 id="配置"><a class="markdownIt-Anchor" href="#配置"></a> 配置</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mkdir -p /etc/vpp</span><br><span class="line">cp ./build-root/deb/debian/vpp/etc/vpp/startup.conf /etc/vpp/</span><br><span class="line">cp ./build-root/deb/debian/vpp/etc/sysctl.d/80-vpp.conf /etc/sysctl.d/</span><br></pre></td></tr></table></figure>
<p>修改<code>/etc/vpp/startup.conf</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">unix &#123;</span><br><span class="line">  nodaemon</span><br><span class="line">  <span class="built_in">log</span> /var/<span class="built_in">log</span>/vpp/vpp.log</span><br><span class="line">  full-coredump</span><br><span class="line">  <span class="comment">#cli-listen /run/vpp/cli.sock</span></span><br><span class="line">  cli-listen 0.0.0.0:5002</span><br><span class="line">  gid vpp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">api-trace &#123;</span><br><span class="line">  on</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">api-segment &#123;</span><br><span class="line">  gid vpp</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">socksvr &#123;</span><br><span class="line">  default</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cpu &#123;</span><br><span class="line">    main-core 0</span><br><span class="line">    workers 2</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dpdk &#123;</span><br><span class="line">    dev 0000:0b:00.0 &#123;num-rx-queues 2&#125;</span><br><span class="line">    dev 0000:13:00.0 &#123;num-rx-queues 2&#125;</span><br><span class="line">    num-mbufs 128000</span><br><span class="line">    socket-mem 1024,1024</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    path /root/vpp/build-root/install-vpp-native/vpp/lib/vpp_plugins</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="启动vpp"><a class="markdownIt-Anchor" href="#启动vpp"></a> 启动VPP</h1>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ service vpp start</span><br></pre></td></tr></table></figure>
<p>查看状态</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ systemctl status vpp.service</span><br><span class="line">● vpp.service - vector packet processing engine</span><br><span class="line">   Loaded: loaded (/lib/systemd/system/vpp.service; enabled; vendor preset: enabled)</span><br><span class="line">   Active: active (running) since Thu 2018-11-15 16:00:09 CST; 4min 52s ago</span><br><span class="line">  Process: 19959 ExecStopPost=/bin/rm -f /dev/shm/db /dev/shm/global_vm /dev/shm/vpe-api (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 19985 ExecStartPre=/sbin/modprobe uio_pci_generic (code=exited, status=0/SUCCESS)</span><br><span class="line">  Process: 19981 ExecStartPre=/bin/rm -f /dev/shm/db /dev/shm/global_vm /dev/shm/vpe-api (code=exited, status=0/SUCCESS)</span><br><span class="line"> Main PID: 19989 (vpp_main)</span><br><span class="line">    Tasks: 6</span><br><span class="line">   Memory: 55.9M</span><br><span class="line">      CPU: 9min 46.890s</span><br><span class="line">   CGroup: /system.slice/vpp.service</span><br><span class="line">           └─19989 /usr/bin/vpp -c /etc/vpp/startup.conf</span><br><span class="line"></span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: load_one_vat_plugin:67: Loaded plugin: nat_test_plugin.so</span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: load_one_vat_plugin:67: Loaded plugin: lb_test_plugin.so</span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: load_one_vat_plugin:67: Loaded plugin: gtpu_test_plugin.so</span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: load_one_vat_plugin:67: Loaded plugin: avf_test_plugin.so</span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: load_one_vat_plugin:67: Loaded plugin: acl_test_plugin.so</span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: load_one_vat_plugin:67: Loaded plugin: memif_test_plugin.so</span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: load_one_vat_plugin:67: Loaded plugin: stn_test_plugin.so</span><br><span class="line">Nov 15 16:00:09 fdio vpp[19989]: /usr/bin/vpp[19989]: dpdk: EAL init args: -c 7 -n 4 --huge-dir /run/vpp/hugepages --file-prefix vpp -w 0000:0b:00.0 -w 0000:13:00.0 --master-lcor</span><br><span class="line">Nov 15 16:00:09 fdio /usr/bin/vpp[19989]: dpdk: EAL init args: -c 7 -n 4 --huge-dir /run/vpp/hugepages --file-prefix vpp -w 0000:0b:00.0 -w 0000:13:00.0 --master-lcore 0 --socket</span><br><span class="line">Nov 15 16:00:10 fdio vnet[19989]: dpdk_ipsec_process:1015: not enough DPDK crypto resources, default to OpenSSL</span><br></pre></td></tr></table></figure>
<p>虽然有警告信息，但似乎不影响使用</p>
<h1 id="测试"><a class="markdownIt-Anchor" href="#测试"></a> 测试</h1>
<blockquote>
<p>根据<code>startup.conf</code>中的配置不同，选择不同的连接vpp方式</p>
</blockquote>
<h2 id="登陆vpp-cli"><a class="markdownIt-Anchor" href="#登陆vpp-cli"></a> 登陆VPP CLI</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ telnet 127.0.0.1 5002</span><br><span class="line">Trying 127.0.0.1...</span><br><span class="line">Connected to 127.0.0.1.</span><br><span class="line">Escape character is <span class="string">'^]'</span>.</span><br><span class="line">    _______    _        _   _____  ___</span><br><span class="line"> __/ __/ _ \  (_)__    | | / / _ \/ _ \</span><br><span class="line"> _/ _// // / / / _ \   | |/ / ___/ ___/</span><br><span class="line"> /_/ /____(_)_/\___/   |___/_/  /_/</span><br><span class="line"></span><br><span class="line">vpp<span class="comment"># show interface</span></span><br><span class="line">              Name               Idx    State  MTU (L3/IP4/IP6/MPLS)     Counter          Count</span><br><span class="line">GigabitEthernet13/0/0             2     down         9000/0/0/0</span><br><span class="line">GigabitEthernetb/0/0              1     down         9000/0/0/0</span><br><span class="line">local0                            0     down          0/0/0/0</span><br><span class="line">vpp<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="开启端口"><a class="markdownIt-Anchor" href="#开启端口"></a> 开启端口</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vpp<span class="comment"># set interface state GigabitEthernet13/0/0 up</span></span><br><span class="line">vpp<span class="comment"># set interface state GigabitEthernetb/0/0 up</span></span><br><span class="line">vpp<span class="comment"># show interface</span></span><br><span class="line">              Name               Idx    State  MTU (L3/IP4/IP6/MPLS)     Counter          Count</span><br><span class="line">GigabitEthernet13/0/0             2      up          9000/0/0/0     rx packets                     1</span><br><span class="line">                                                                    rx bytes                      60</span><br><span class="line">                                                                    drops                          1</span><br><span class="line">                                                                    ip4                            1</span><br><span class="line">GigabitEthernetb/0/0              1      up          9000/0/0/0     rx packets                     4</span><br><span class="line">                                                                    rx bytes                     240</span><br><span class="line">                                                                    drops                          4</span><br><span class="line">                                                                    ip4                            1</span><br><span class="line">local0                            0     down          0/0/0/0</span><br><span class="line">vpp<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="配置为switch模式"><a class="markdownIt-Anchor" href="#配置为switch模式"></a> 配置为switch模式</h2>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vpp<span class="comment"># set interface l2 bridge GigabitEthernet13/0/0 1</span></span><br><span class="line">vpp<span class="comment"># set interface l2 bridge GigabitEthernetb/0/0 1</span></span><br><span class="line">vpp<span class="comment"># show bridge-domain</span></span><br><span class="line">  BD-ID   Index   BSN  Age(min)  Learning  U-Forwrd   UU-Flood   Flooding  ARP-Term   BVI-Intf</span><br><span class="line">    1       1      0     off        on        on       flood        on       off        N/A</span><br></pre></td></tr></table></figure>
<h2 id="测试连通性"><a class="markdownIt-Anchor" href="#测试连通性"></a> 测试连通性</h2>
<ul>
<li>c2s</li>
</ul>
<ol>
<li>Host1: 192.168.0.2/24</li>
<li>Host2: 192.168.0.3/24</li>
</ol>
<p>通过host1 ping host2</p>
<ul>
<li>配置loopback口测试连通性</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vpp<span class="comment"># create loopback interface</span></span><br><span class="line">loop0</span><br><span class="line">vpp<span class="comment"># set interface ip address loop0 192.168.0.1/24</span></span><br><span class="line">vpp<span class="comment"># set interface state loop0 up</span></span><br><span class="line">vpp<span class="comment"># set interface l2 bridge loop0 1 bvi</span></span><br><span class="line">vpp<span class="comment"># show bridge-domain</span></span><br><span class="line">  BD-ID   Index   BSN  Age(min)  Learning  U-Forwrd   UU-Flood   Flooding  ARP-Term   BVI-Intf</span><br><span class="line">    1       1      0     off        on        on       flood        on       off       loop0</span><br><span class="line">vpp<span class="comment"># ping 192.168.0.2</span></span><br><span class="line">116 bytes from 192.168.0.2: icmp_seq=2 ttl=64 time=.8704 ms</span><br><span class="line">116 bytes from 192.168.0.2: icmp_seq=3 ttl=64 time=.2564 ms</span><br><span class="line">116 bytes from 192.168.0.2: icmp_seq=4 ttl=64 time=.2653 ms</span><br><span class="line">116 bytes from 192.168.0.2: icmp_seq=5 ttl=64 time=.3413 ms</span><br><span class="line"></span><br><span class="line">Statistics: 5 sent, 4 received, 20% packet loss</span><br></pre></td></tr></table></figure>
<p><code>set interface l2 bridge loop0 1 bvi</code>中的<strong>bvi</strong>意味着这个接口将用来接收、发送以及转发该bridge domain的报文</p>
]]></content>
      <categories>
        <category>network</category>
      </categories>
      <tags>
        <tag>network</tag>
        <tag>vpp</tag>
      </tags>
  </entry>
</search>
